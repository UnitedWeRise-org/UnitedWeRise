<!DOCTYPE html>
<html>
<head>
    <title>Auth Debug Test</title>
</head>
<body>
    <h1>Authentication Debug Test</h1>
    <div id="results"></div>
    
    <script>
        const API_BASE = 'https://unitedwerise-backend.wonderfulpond-f8a8271f.eastus.azurecontainerapps.io/api';
        
        async function debugAuth() {
            const results = document.getElementById('results');
            let log = '';
            
            // Check localStorage
            const storedToken = localStorage.getItem('authToken');
            const storedUser = localStorage.getItem('currentUser');
            
            log += `<h3>localStorage Status:</h3>`;
            log += `<p><strong>authToken:</strong> ${storedToken ? 'EXISTS (length: ' + storedToken.length + ')' : 'NOT FOUND'}</p>`;
            log += `<p><strong>currentUser:</strong> ${storedUser ? 'EXISTS' : 'NOT FOUND'}</p>`;
            
            if (!storedToken) {
                log += `<p style="color: red;"><strong>NO TOKEN FOUND - This is why login persistence fails!</strong></p>`;
                results.innerHTML = log;
                return;
            }
            
            // Test each endpoint
            log += `<h3>API Endpoint Tests:</h3>`;
            
            // Test batch/initialize
            try {
                const response = await fetch(`${API_BASE}/batch/initialize`, {
                    headers: { 'Authorization': `Bearer ${storedToken}` }
                });
                const data = await response.json();
                log += `<p><strong>/batch/initialize:</strong> ${response.status} - ${JSON.stringify(data).substring(0, 100)}...</p>`;
            } catch (error) {
                log += `<p><strong>/batch/initialize:</strong> ERROR - ${error.message}</p>`;
            }
            
            // Test auth/me
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${storedToken}` }
                });
                const data = await response.json();
                log += `<p><strong>/auth/me:</strong> ${response.status} - ${JSON.stringify(data).substring(0, 100)}...</p>`;
            } catch (error) {
                log += `<p><strong>/auth/me:</strong> ERROR - ${error.message}</p>`;
            }
            
            // Test users/profile
            try {
                const response = await fetch(`${API_BASE}/users/profile`, {
                    headers: { 'Authorization': `Bearer ${storedToken}` }
                });
                const data = await response.json();
                log += `<p><strong>/users/profile:</strong> ${response.status} - ${JSON.stringify(data).substring(0, 100)}...</p>`;
            } catch (error) {
                log += `<p><strong>/users/profile:</strong> ERROR - ${error.message}</p>`;
            }
            
            results.innerHTML = log;
        }
        
        // Run debug on page load
        debugAuth();
    </script>
</body>
</html>