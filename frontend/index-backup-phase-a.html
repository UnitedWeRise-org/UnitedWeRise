<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="build-time" content="2025-08-21T21:15:00.000Z">
    <meta name="version" content="1.1.0">
    <meta name="last-updated" content="2025-08-21T21:15:00.000Z">
    
    <!-- SEO Meta Tags -->
    <title>United We Rise - Unite Communities, Empower Democracy</title>
    <meta name="description" content="United We Rise is a revolutionary social platform connecting communities with their elected officials. Join the movement for transparent democracy, civic engagement, and positive change.">
    <meta name="keywords" content="civic engagement, democracy, community platform, elected officials, political transparency, social change, grassroots movement, voting, elections, community organizing">
    <meta name="author" content="United We Rise">
    <meta name="robots" content="index, follow">
    <meta name="language" content="English">
    <meta name="revisit-after" content="7 days">
    <link rel="canonical" href="https://www.unitedwerise.org/">
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://www.unitedwerise.org/">
    <meta property="og:title" content="United We Rise - Unite Communities, Empower Democracy">
    <meta property="og:description" content="Join the movement for transparent democracy. Connect with your community and elected officials on United We Rise.">
    <meta property="og:image" content="https://www.unitedwerise.org/images/og-image.jpg">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:site_name" content="United We Rise">
    <meta property="og:locale" content="en_US">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://www.unitedwerise.org/">
    <meta name="twitter:title" content="United We Rise - Unite Communities, Empower Democracy">
    <meta name="twitter:description" content="Join the movement for transparent democracy. Connect with your community and elected officials.">
    <meta name="twitter:image" content="https://www.unitedwerise.org/images/og-image.jpg">
    
    <!-- Additional SEO -->
    <meta name="theme-color" content="#002868">
    <meta name="msapplication-TileColor" content="#002868">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" />
    
    <!-- Application CSS -->
    <link rel="stylesheet" href="src/styles/main.css">
    <link rel="stylesheet" href="src/styles/profile.css">
    <link rel="stylesheet" href="src/styles/search.css">
    <link rel="stylesheet" href="src/styles/map.css">
    <link rel="stylesheet" href="src/styles/modals.css">
    <link rel="stylesheet" href="src/styles/messaging.css">
    <link rel="stylesheet" href="src/styles/posts.css">
    <link rel="stylesheet" href="src/styles/candidate-system.css">
    <link rel="stylesheet" href="src/styles/badges.css">
    <link rel="stylesheet" href="src/styles/quests.css">
    <link rel="stylesheet" href="src/styles/badge-vault.css">
    <link rel="stylesheet" href="src/styles/elections-system.css">
    <link rel="stylesheet" href="src/styles/officials-system.css">
    <link rel="stylesheet" href="src/styles/trending-system.css">
    <link rel="stylesheet" href="src/styles/post-component.css">
    <link rel="stylesheet" href="src/styles/responsive.css">
    
    <!-- External JavaScript - Heavy libraries loaded on-demand -->
    <!-- Map libraries now loaded via smart-loader when needed -->
    <!-- <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script> -->
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <!-- Performance & Optimization Utilities (Load First) -->
    <script src="src/utils/performance.js"></script>
    <script src="src/utils/error-handler.js"></script>
    <script src="src/utils/advanced-caching.js"></script>
    <script src="src/utils/smart-loader.js"></script>

    <!-- Core Application JavaScript - Modern ES6 Module System -->
    <script type="module" src="src/js/main.js"></script>

    <!-- Legacy utility scripts that aren't yet converted to modules -->
    <script src="src/js/api-manager.js"></script>
    <script src="src/js/reputation-badges.js"></script>
    <script src="src/js/force-optimization.js"></script>
    <script src="js/posting.js"></script>

    <!-- Performance initialization moved to main.js -->

    
    <script src="src/components/AddressForm.js"></script>
    <script src="src/components/VerificationFlow.js"></script>
    <script src="src/components/ContentReporting.js"></script>
    <script src="src/components/CandidateSystem.js"></script>
    <!-- ✅ PostComponent.js removed - already loaded via ES6 module in main.js -->
    <script src="src/components/QuestProgressTracker.js"></script>
    <script src="src/components/BadgeVault.js"></script>
    <script src="src/components/UserCard.js"></script>
    <!-- ✅ ES6 MODULES: Profile, PostComponent, backend-integration, map-maplibre, relationship-utils now loaded via main.js -->

    <!-- Legacy integration scripts (not yet converted to ES6 modules) -->
    <script src="src/integrations/candidate-system-integration.js"></script>
    <script src="src/integrations/officials-system-integration.js"></script>
    <script src="src/integrations/elections-system-integration.js"></script>
    <script src="src/integrations/trending-system-integration.js"></script>
    <script src="src/js/mobile-navigation.js"></script>
    <script src="src/js/map-dummy-data.js"></script>
    <script src="src/components/user-relationship-display.js"></script>
    <!-- donation-system.js now loaded via ES6 modules in main.js -->
    <script src="js/adminDebugger.js"></script>
    <script src="src/js/deployment-status.js"></script>
    <script src="src/js/legal-modal.js"></script>
    
    <!-- Structured Data for SEO -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Organization",
        "name": "United We Rise",
        "alternateName": "UWR",
        "url": "https://www.unitedwerise.org",
        "logo": "https://www.unitedwerise.org/images/logo.png",
        "description": "United We Rise is a revolutionary social platform connecting communities with their elected officials for transparent democracy and civic engagement.",
        "sameAs": [
            "https://twitter.com/unitedwerise",
            "https://facebook.com/unitedwerise",
            "https://instagram.com/unitedwerise"
        ],
        "contactPoint": {
            "@type": "ContactPoint",
            "telephone": "+1-800-UWR-RISE",
            "contactType": "customer support",
            "availableLanguage": "English"
        },
        "address": {
            "@type": "PostalAddress",
            "addressCountry": "US"
        },
        "nonprofitStatus": "501(c)(3)",
        "foundingDate": "2024",
        "keywords": "civic engagement, democracy, community platform, political transparency, grassroots movement"
    }
    </script>
    
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "WebSite",
        "url": "https://www.unitedwerise.org",
        "name": "United We Rise",
        "description": "Connect with your community and elected officials for transparent democracy",
        "potentialAction": {
            "@type": "SearchAction",
            "target": "https://www.unitedwerise.org/search?q={search_term_string}",
            "query-input": "required name=search_term_string"
        }
    }
    </script>
</head>
<body>
    <!-- Page Loading Spinner -->
    <div id="page-loading-overlay" class="page-loading-overlay">
        <div class="page-loading-content">
            <div class="page-loading-spinner"></div>
            <p class="page-loading-text">Loading United We Rise...</p>
        </div>
    </div>

    <div class="top-bar">
        <div class="top-bar-left">
            <input class="search desktop-search" type="search" placeholder="Search Name or Location" id="searchInput" autocomplete="off" autocapitalize="off" spellcheck="false">
        </div>
        
        <div class="top-bar-center">
            <div class="site-title-container" data-action="navigate-home" title="United We Rise - Home">
                <span class="site-title-left">United</span>
                <div class="logo">
                    <img src="UWR Logo on Circle.png" alt="United We Rise" class="logo-circle">
                </div>
                <span class="site-title-right">We Ris<span class="rise-e">e<span class="beta-badge">Beta</span></span></span>
            </div>
        </div>
        
        <div class="top-bar-right">
            <!-- Desktop/Tablet Navigation -->
            <div class="desktop-nav">
                <givebutter-widget id="p75ZaL" class="donation-widget"></givebutter-widget>
                <a href="#" class="nav-link" data-modal-about>About UWR</a>
                <div id="notificationSection" class="notification-section" style="display: none;">
                    <button data-action="toggle-notifications" class="notification-btn">
                        <span class="notification-icon">🔔</span>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                </div>
                <div id="authSection">
                    <button data-action="open-auth-login" class="login-btn">Login</button>
                </div>
                <div id="userSection" class="user-info" style="display: none;">
                    <span id="userGreeting" style="display: none;"></span>
                </div>
            </div>
            
            <!-- Mobile Search Icon -->
            <button class="mobile-search-btn" style="display: none;">
                <span class="search-icon">🔍</span>
            </button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authTitle">Login</h2>
                <button data-action="close-auth-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="loginPassword" required>
                            <button type="button" class="password-toggle" data-password-toggle data-target="loginPassword">👁️</button>
                        </div>
                    </div>
                    <div class="form-group" id="totpField" style="display: none;">
                        <label for="loginTOTP">Two-Factor Authentication Code</label>
                        <input type="text" id="loginTOTP" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
                        <small style="color: #666; font-size: 0.8rem;">Enter the 6-digit code from your authenticator app</small>
                    </div>
                    <button class="btn" data-action="handle-login" id="loginButton">Login</button>
                    
                    <div class="oauth-divider">
                        <span>Or continue with</span>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button class="oauth-btn google-btn" data-auth-google>
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Google
                        </button>
                        <!-- Microsoft and Apple OAuth temporarily disabled -->
                        <!--
                        <button class="oauth-btn microsoft-btn" data-auth-microsoft>
                            Microsoft
                        </button>
                        <button class="oauth-btn apple-btn" data-auth-apple>
                            Apple  
                        </button>
                        -->
                    </div>
                    
                    <div class="auth-switch">
                        <a data-action="switch-to-register">Don't have an account? Sign up</a>
                    </div>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <div class="password-input-container">
                            <input type="email" id="registerEmail" required>
                            <div class="password-status" id="email-status" style="display: none;">✓</div>
                            <div class="password-status" id="email-error" style="display: none; color: #e74c3c;">❌</div>
                        </div>
                        <div class="availability-message" id="email-message" style="display: none; font-size: 0.8rem; margin-top: 0.25rem;"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <div class="password-input-container">
                            <input type="text" id="registerUsername" required>
                            <div class="password-status" id="username-status" style="display: none;">✓</div>
                            <div class="password-status" id="username-error" style="display: none; color: #e74c3c;">❌</div>
                        </div>
                        <div class="availability-message" id="username-message" style="display: none; font-size: 0.8rem; margin-top: 0.25rem;"></div>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="registerPassword" required>
                            <button type="button" class="password-toggle" data-password-toggle data-target="registerPassword">👁️</button>
                            <div class="password-status" id="password-status">✓</div>
                        </div>
                        <div class="password-requirements" id="password-requirements" style="display: none;">
                            <div class="requirement" id="req-length">• At least 8 characters</div>
                            <div class="requirement" id="req-uppercase">• One uppercase letter</div>
                            <div class="requirement" id="req-lowercase">• One lowercase letter</div>
                            <div class="requirement" id="req-number">• One number</div>
                            <div class="requirement" id="req-special">• One special character</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="registerFirstName">First Name</label>
                        <input type="text" id="registerFirstName">
                    </div>
                    <div class="form-group">
                        <label for="registerLastName">Last Name</label>
                        <input type="text" id="registerLastName">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="termsAgreement" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="#" data-action="open-legal-terms">Terms of Service</a>
                            and <a href="#" data-action="open-legal-privacy">Privacy Policy</a>
                        </label>
                    </div>
                    <div class="form-group">
                        <!-- Use production key with proper domain (test.unitedwerise.com) -->
                        <div class="h-captcha" data-sitekey="9c5af3a8-5066-446c-970e-1c18d9fe8d9e" data-callback="onHCaptchaCallback" id="hcaptcha-register"></div>
                    </div>
                    <button class="btn" data-action="handle-register">Sign Up</button>
                    
                    <div class="oauth-divider">
                        <span>Or continue with</span>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button class="oauth-btn google-btn" data-auth-google>
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Google
                        </button>
                        <!-- Microsoft and Apple OAuth temporarily disabled -->
                        <!--
                        <button class="oauth-btn microsoft-btn" data-auth-microsoft>
                            Microsoft
                        </button>
                        <button class="oauth-btn apple-btn" data-auth-apple>
                            Apple  
                        </button>
                        -->
                    </div>
                    
                    <div class="auth-switch">
                        <a data-action="switch-to-login">Already have an account? Login</a>
                    </div>
                </div>
                
                <div id="authMessage"></div>
            </div>
        </div>
    </div>

    <!-- Legal Documents Modal -->
    <div id="legalModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="legalTitle">Legal Documents</h2>
                <button data-action="close-legal-modal" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="legalContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- About United We Rise Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>About United We Rise</h2>
                <button data-modal-close="about" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Hero Section -->
                <div style="text-align: center; margin-bottom: 2rem; padding: 2rem; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 8px;">
                    <img src="UWR Logo on Circle.png" alt="United We Rise" style="width: 80px; height: 80px; margin-bottom: 1rem;">
                    <h3 style="color: #2c3e50; margin-bottom: 0.5rem; font-size: 1.8rem;">Democratizing Democracy, Together.</h3>
                    <p style="color: #5a6c7d; max-width: 500px; margin: 0 auto;">United We Rise exists to break down the barriers that keep everyday people from engaging in politics.</p>
                </div>

                <!-- Our Mission -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #2c3e50; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">Our Mission</h4>
                    <p style="font-size: 1.1rem; line-height: 1.6;">We empower communities to connect directly with representatives, discover grassroots candidates, and build a transparent, accountable democracy.</p>
                </div>

                <!-- Why I Started This -->
                <div style="margin-bottom: 2rem; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #4b5c09;">
                    <h4 style="color: #2c3e50; margin-top: 0;">Why I Started This</h4>
                    <p style="line-height: 1.6; margin-bottom: 1rem;">I reached a point where the growing sense of nihilism was overwhelming — it felt like no one was doing anything to change the system. Everyone was waiting for someone else.</p>
                    
                    <p style="line-height: 1.6; margin-bottom: 1rem;">The problem was obvious: big money dominates our politics. From mainstream media deciding who is "electable," to donors holding politicians' ears, ordinary people had no way to compete in that arena.</p>
                    
                    <p style="line-height: 1.6; margin-bottom: 1rem;"><strong>So I built my own.</strong></p>
                    
                    <p style="line-height: 1.6; margin-bottom: 1rem;">United We Rise is a place where I don't have to care who pays the most. Every candidate can be discovered. Every idea can be weighed on its merits. And every voter can get the information they need to choose leaders who will actually improve their lives.</p>
                    
                    <p style="line-height: 1.6; font-style: italic;">I'm not a web developer. United We Rise was built by me over many long hours using AI. It isn't perfect yet — but I'm committed to making it better every day. If you stick with me, if you use it and share it, we can turn this into the pre-eminent social media source for political information and change. Together, we can make democracy work again.</p>
                </div>

                <!-- Our Principles -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #2c3e50; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">Our Principles</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🛡️</div>
                            <strong style="color: #2c3e50;">Integrity</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">No ads. No corporate sponsors. No data sales.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🗽</div>
                            <strong style="color: #2c3e50;">Independence</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Built and funded by users, not investors.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🔍</div>
                            <strong style="color: #2c3e50;">Transparency</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Donor disclosures and open governance.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">⚖️</div>
                            <strong style="color: #2c3e50;">Equity</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Centering underrepresented voices and grassroots candidates.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">🤝</div>
                            <strong style="color: #2c3e50;">Accessibility</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Always free to use.</p>
                        </div>
                    </div>
                </div>

                <!-- Radical Transparency -->
                <div style="margin-bottom: 2rem; background: #e8f5e9; padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #2c3e50; margin-top: 0;">Radical Transparency</h4>
                    <p style="line-height: 1.6;">We will always be free, and we only accept donations from users. We refuse ads, corporate money, and profit motives. To back that up, we are committed to donor disclosure, so you always know who supports us. Our independence is non-negotiable.</p>
                </div>

                <!-- How It Works -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #2c3e50; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">How It Works</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; position: relative;">
                            <span style="position: absolute; top: 5px; right: 5px; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">BETA</span>
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🗺️</div>
                            <strong>Geographic Social Graph</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Connects you first to your own community and representatives.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">💬</div>
                            <strong>Direct Representative Messaging</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Makes your voice harder to ignore.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; position: relative;">
                            <span style="position: absolute; top: 5px; right: 5px; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">BETA</span>
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">🤖</div>
                            <strong>AI-Powered Topic Discovery</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Helps you find balanced perspectives on the issues that matter.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">⭐</div>
                            <strong>Reputation-Based Moderation</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Builds a healthier civic space without corporate algorithms.</p>
                        </div>
                    </div>
                </div>

                <!-- Be Part of It -->
                <div style="margin-bottom: 2rem; text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Be Part of It</h4>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem; font-weight: bold;">This platform is only as powerful as the people who use it.</p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button data-modal-action="join-community" style="background: #4b5c09; color: white; padding: 0.75rem 2rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
                            Join the Community
                        </button>
                        <button data-modal-action="support-mission" style="background: white; color: #4b5c09; padding: 0.75rem 2rem; border: 2px solid #4b5c09; border-radius: 4px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
                            Support Our Mission
                        </button>
                    </div>
                    
                    <button data-modal-action="volunteer-skills" style="background: none; border: none; color: #4b5c09; text-decoration: underline; font-size: 0.9rem; cursor: pointer; padding: 0;">Volunteer your skills</button>
                </div>

                <div style="border-top: 1px solid #dee2e6; padding-top: 1rem; text-align: center; color: #6c757d; font-size: 0.9rem;">
                    <p><strong>United We Rise</strong> - Democratizing Democracy, Together<br>
                    Operated by People United for Peaceful Revolution, Inc. 501(c)(3)<br>
                    Built by users, for users, with radical transparency at our core</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Volunteer Modal -->
    <div id="volunteerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" data-modal-close="volunteer">&times;</span>
            <div id="volunteerModalContent">
                <div style="padding: 2rem; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #2c3e50; margin-bottom: 1.5rem; text-align: center;">Volunteer Your Skills</h2>
                    
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <p style="font-size: 1.1rem; line-height: 1.6; color: #495057; margin: 0;">
                            Help us build a platform that truly serves democracy. Whether you're a developer, designer, writer, organizer, or have other skills to offer, there's a place for you in our movement.
                        </p>
                    </div>

                    <form id="volunteerForm" style="margin-bottom: 1.5rem;">
                        <div id="emailSection" style="margin-bottom: 1.5rem; display: none;">
                            <label for="volunteerEmail" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Email Address:</label>
                            <input type="email" id="volunteerEmail" name="volunteerEmail" required 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                                   placeholder="your.email@example.com">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label for="volunteerMessage" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Tell us about your skills and how you'd like to help:</label>
                            <textarea id="volunteerMessage" name="volunteerMessage" required maxlength="800" rows="6"
                                     style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                                     placeholder="I'm a [your expertise] and I'd like to help with [specific area]. My background includes..."></textarea>
                            <div style="text-align: right; margin-top: 0.5rem; font-size: 0.9rem; color: #6c757d;">
                                <span id="charCount">0</span>/800 characters
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button type="submit" id="volunteerSubmitBtn" 
                                    style="background: #4b5c09; color: white; padding: 0.75rem 2rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
                                Send Volunteer Inquiry
                            </button>
                        </div>
                    </form>

                    <div style="text-align: center; color: #6c757d; font-size: 0.9rem; line-height: 1.4;">
                        <p>Your message will be reviewed by our team and we'll get back to you soon.<br>
                        Thank you for wanting to be part of democratizing democracy!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="thumbs">
                <div class="thumb" data-nav-toggle="feed" title="My Feed" id="feedThumb">📰 <span class="label">My Feed</span></div>
                <div class="thumb" data-nav-toggle="trending" title="Trending">🔥 <span class="label">Trending</span></div>
                <div class="thumb" data-nav-toggle="panel-upcoming" title="Upcoming Contests">📅 <span class="label">Upcoming</span></div>
                <div class="thumb" data-nav-toggle="panel-officials" title="My Elected Officials">🏛️ <span class="label">Officials</span></div>
                <div class="thumb" data-nav-toggle="map" title="Show Map" id="mapThumb">🗺️ <span class="label">Map</span></div>
                <div class="thumb" data-nav-toggle="messages" title="Messages" id="messagesThumb">💬 <span class="label">Messages</span></div>
                <div class="thumb" data-action="open-donation" title="Support Our Mission" id="donationThumb">💝 <span class="label">Donate</span></div>
                <div class="thumb" data-nav-toggle="organizing" title="Civic Organizing" id="organizingThumb" style="display: none;">📋 <span class="label">Organize</span></div>
                <div class="thumb" data-action="toggle-profile" title="My Profile" id="profileThumb">👤 <span class="label">My Profile</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="thumb logout-thumb" data-nav-toggle="logout" title="Logout" id="logoutThumb" style="display: none;">
                    🚪 <span class="label">Logout</span>
                </div>
            </div>
        </div>
        <!-- Sidebar Toggle Button (on the edge) -->
        <button id="toggleSidebar" class="sidebar-toggle-edge" title="Expand Sidebar">
            <span class="arrow-icon">▶</span>
        </button>
        <div class="main" id="mainContent">
            <!-- Content will be dynamically inserted here -->
            <div class="welcome-content">
                <h1>Welcome to United We Rise</h1>
                <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                <p>We are still in active development. We are excited for you to join us, and if you see anything that needs addressing, just write it as a post</p>

                <!-- Quest Progress Container (shows when user is logged in) -->
                <div id="quest-progress-container" style="display: none;"></div>

                <!-- Quick Access Buttons for Authenticated Users -->
                <div id="user-quick-actions" class="quick-actions" style="display: none;">
                    <button class="quick-action-btn badge-vault-btn" data-nav-action="show-badge-vault" title="Manage your badge collection">
                        <span class="action-icon">🏆</span>
                        <span class="action-label">Badge Vault</span>
                    </button>
                    <button class="quick-action-btn quests-btn" data-nav-action="scroll-to-quests" title="View your civic challenges">
                        <span class="action-icon">🎯</span>
                        <span class="action-label">Daily Quests</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="search-container" id="searchContainer" style="display: none;">
        <div class="search-header">
            <h3 style="margin: 0; color: #4b5c09;">Search Results</h3>
            <button id="closeSearchBtn" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
        </div>
        
        <!-- Enhanced Search Filters -->
        <div class="search-filters" style="padding: 1rem; border-bottom: 1px solid #eee; background: #f9f9f9;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="all" checked>
                    All
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="users">
                    👤 Users
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="posts">
                    📝 Posts
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="officials">
                    🏛️ Officials
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="candidates">
                    🗳️ Candidates
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="topics">
                    🏷️ Topics
                </label>
            </div>
            
            <!-- Advanced Filters -->
            <div id="advancedFilters" style="margin-top: 1rem; display: none;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <!-- Location Filter -->
                    <select id="locationFilter" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Locations</option>
                        <option value="local">My District</option>
                        <option value="state">My State</option>
                        <option value="national">National</option>
                    </select>
                    
                    <!-- Time Filter -->
                    <select id="timeFilter" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Time</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    
                    <!-- Topic Filter -->
                    <select id="topicFilter" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Topics</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="economy">Economy</option>
                        <option value="education">Education</option>
                        <option value="environment">Environment</option>
                        <option value="immigration">Immigration</option>
                        <option value="civil-rights">Civil Rights</option>
                        <option value="foreign-policy">Foreign Policy</option>
                        <option value="gun-policy">Gun Policy</option>
                        <option value="local-issues">Local Issues</option>
                    </select>
                </div>
            </div>
            
            <button id="advancedFiltersToggle" style="background: none; border: none; color: #4b5c09; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem;">
                <span id="advancedFiltersToggle">▼ Advanced Filters</span>
            </button>
        </div>
        
        <div class="search-results" id="globalSearchResults">
            <div style="text-align: center; color: #666; padding: 2rem;">
                Start typing to search across users, posts, officials, and topics
            </div>
        </div>
    </div>

    <div id="panel-trending" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Trending</span>
            <button data-nav-action="close-trending">X</button>
        </div>
        <div class="panel-body">
            <div id="trendingContent">
                <details><summary>Local</summary>
                    <ul>
                        <li><a href="#" data-nav-action="open-detail" data-detail-title="Zoning Issue" data-detail-level="2">Generic Zoning Issue</a></li>
                        <li><a href="#" data-nav-action="open-detail" data-detail-title="School District Issue" data-detail-level="2">Generic School District Issue</a></li>
                    </ul>
                </details>
                <details><summary>State</summary>
                    <ul>
                        <li><a href="#" data-nav-action="open-detail" data-detail-title="State Tax Issue" data-detail-level="2">Generic State Tax Issue</a></li>
                    </ul>
                </details>
                <details><summary>National</summary>
                    <ul>
                        <li><a href="#" data-nav-action="open-detail" data-detail-title="Immigration Issue" data-detail-level="2">Generic Immigration Issue</a></li>
                        <li><a href="#" data-nav-action="open-detail" data-detail-title="Foreign Policy Issue" data-detail-level="2">Generic Foreign Policy Issue</a></li>
                    </ul>
                </details>
            </div>
        </div>
    </div>

    <!-- DEPRECATED: panel-myfeed removed - My Feed now populates in main content area per CLAUDE.md documentation -->

    <div id="panel-upcoming" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Upcoming Contests</span>
            <button data-nav-action="close-upcoming">X</button>
        </div>
        <div class="panel-body">
            <details><summary>Local</summary>
                <ul>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="Mayor" data-detail-level="2">Mayor</a></li>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="City Council" data-detail-level="2">City Council</a></li>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="School Board" data-detail-level="2">School Board</a></li>
                </ul>
            </details>
            <details><summary>State</summary>
                <ul>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="Governor" data-detail-level="2">Governor</a></li>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="State Senate" data-detail-level="2">State Senate</a></li>
                </ul>
            </details>
            <details><summary>National</summary>
                <ul>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="President" data-detail-level="2">President</a></li>
                    <li><a href="#" data-nav-action="open-detail" data-detail-title="U.S. House" data-detail-level="2">U.S. House</a></li>
                </ul>
            </details>
        </div>
    </div>

    <div id="panel-officials" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Find Representatives</span>
            <button data-nav-action="close-officials">X</button>
        </div>
        <div class="panel-body">
            <div id="officialsContent">
                <p>Enter any address to find elected representatives.</p>
            </div>
        </div>
    </div>


    <div id="detail-panel" class="detail-panel hidden" data-offset="2">
        <div class="panel-header">
            <span id="detail-title">Detail</span>
            <button data-action="close-detail">X</button>
        </div>
        <div class="panel-body">
            <p id="detail-content">Placeholder content for selected topic.</p>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messagesContainer" class="messages-container">
        <div class="messages-header">
            <span>Messages</span>
            <button data-action="toggle-messages" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="messages-body" id="messagesBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading conversations...</p>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div id="profilePanel" class="profile-panel">
        <div class="profile-header">
            <span>My Profile</span>
            <button data-action="toggle-profile" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="profile-body" id="profileBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading profile...</p>
            </div>
        </div>
    </div>

    <!-- Trending Updates Panel (under collapsed map) -->
    <div id="trendingUpdates" class="trending-updates">
        <div class="trending-updates-header">
            <span>🔥 Trending Now</span>
            <button class="trending-expand-btn" data-action="toggle-trending-expansion" id="trendingExpandBtn">More</button>
        </div>
        <div class="trending-updates-body" id="trendingUpdatesBody">
            <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">
                Loading trending topics...
            </div>
        </div>
    </div>

    <!-- Map Container (hidden initially) -->
    <div id="mapContainer" style="display: none;">
        <!-- Map Loading State (overlay) -->
        <div id="mapLoadingState" class="map-loading-state">
            <div class="map-loading-spinner"></div>
            <div class="map-loading-text">Loading Map...</div>
        </div>
        
        <div class="map-action-buttons">
            <!-- Main button row -->
            <div class="zoom-buttons-group">
                <button class="map-action-btn" data-action="toggle-map-view" data-view="national">National</button>
                <button class="map-action-btn" data-action="toggle-map-view" data-view="state">State</button>
                <button class="map-action-btn" data-action="toggle-map-view" data-view="local">Local</button>
                <button class="map-action-btn control-btn primary" id="mapToggleBtn">Collapse</button>
                <button class="map-action-btn control-btn close-btn" data-action="close-map">×</button>
            </div>
            
            <!-- Layer dropdown toggle - positioned relative to button group -->
            <div class="map-layer-dropdown">
                <button class="layer-dropdown-btn" data-action="toggle-layer-dropdown">
                    Layers ▼
                </button>
                <div class="layer-dropdown-content" id="layerDropdown">
                    <label class="layer-toggle">
                        <input type="checkbox" checked data-action="toggle-map-layer" data-layer="trending">
                        <span class="layer-icon">💬</span>
                        <span>Trending</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked data-action="toggle-map-layer" data-layer="events">
                        <span class="layer-icon">📅</span>
                        <span>Events</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked data-action="toggle-map-layer" data-layer="news">
                        <span class="layer-icon">📰</span>
                        <span>News</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked data-action="toggle-map-layer" data-layer="civic">
                        <span class="layer-icon">🏛️</span>
                        <span>Civic</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked data-action="toggle-map-layer" data-layer="community">
                        <span class="layer-icon">👥</span>
                        <span>Community</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <!-- MOTD Panel (Message of the Day) -->
    <div id="motd-panel" style="display: none;">
        <button id="motd-close-btn">&times;</button>
        <div id="motd-content" style="text-align: left; margin: 0 10px;">
            <div id="motd-title" style="font-weight: bold; margin-bottom: 8px; color: #5A534A;"></div>
            <div id="motd-body" style="color: #5A534A; line-height: 1.4;"></div>
        </div>
    </div>

    <script>
        // API Configuration - Use centralized config
        const API_BASE = window.API_CONFIG ? window.API_CONFIG.BASE_URL : 'https://api.unitedwerise.org/api';
        let currentUser = null;
        let addressForm = null;
        
        // DISABLED: Let unified auth manager handle initialization
        // Initialize currentUser from localStorage if available (for page refresh persistence)
        // try {
        //     const storedUser = localStorage.getItem('currentUser');
        //     if (storedUser) {
        //         currentUser = JSON.parse(storedUser);
        //         window.currentUser = currentUser; // Ensure global access
        //         console.log('✅ Restored user from localStorage:', currentUser.firstName || currentUser.email);
        //     }
        // } catch (error) {
        //     console.warn('⚠️ Failed to restore user from localStorage:', error);
        //     localStorage.removeItem('currentUser'); // Clear corrupted data
        // }
        
        // Utility function to fix auth-related localStorage issues without clearing everything
        // fixAuthStorageIssues() moved to /src/handlers/civic-handlers.js
        // Available globally via window.fixAuthStorageIssues for console debugging

        // Setup collapse button handler function
        // setupCollapseButton function moved to NavigationHandlers module

        // setupCloseButton function moved to NavigationHandlers module

        // Setup sidebar map button handler function
        // setupSidebarMapButton function moved to NavigationHandlers module

        // Map functions moved to /src/handlers/map-handlers.js
        // - toggleMapLayer(), toggleLayerDropdown(), toggleMapView()

        // Check for existing auth on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Declare variables that are used later in the script
            let trendingRefreshInterval = null;

            // Map and location tracking variables (must be declared before any functions use them)
            let mapInstance = null;
            let currentLocation = null;
            let currentZoomLevel = 'national'; // Track current zoom level (default to match radio button)
            let boundaryManager = null;

            // Expose map variables globally for cross-module access
            window.currentZoomLevel = currentZoomLevel;
            window.currentLocation = currentLocation;
            window.boundaryManager = boundaryManager;

            // Use new optimized initialization system
            if (typeof adminDebugLog !== 'undefined') {
                adminDebugLog('AppInit', 'Starting optimized app initialization...');
            }
            initializeApp().then(result => {
                if (typeof adminDebugLog !== 'undefined') {
                    adminDebugLog('AppInit', 'App initialization complete', result);
                }
                
                // Setup civic organizing sidebar monitoring
                setupCivicOrganizingSidebarMonitoring();
                
                // Initialize mobile navigation system
                if (typeof initMobileNavigation !== 'undefined') {
                    initMobileNavigation();
                    if (typeof adminDebugLog !== 'undefined') {
                        adminDebugLog('Mobile', 'Mobile navigation initialized');
                    }
                }
            }).catch(error => {
                console.error('💥 App initialization failed:', error);
            });

            // Map initialization is now handled by map-maplibre.js to avoid conflicts
            console.log('Map initialization delegated to map-maplibre.js script');
            
            // Setup collapse button handler (runs regardless of map system)
            setupCollapseButton();
            
            // Setup close button handler 
            setupCloseButton();
            
            // Setup sidebar map button handler
            setupSidebarMapButton();

            // Load and show MOTD if available
            loadMOTD();

            // Start trending refresh interval
            startTrendingRefresh();
        });

        // Authentication Functions
        // 🔐 SECURITY MIGRATION STATUS: Core auth infrastructure migrated to httpOnly cookies
        // - Primary auth now uses cookies + CSRF tokens (XSS protected)
        // - window.apiCall() and adminApiCall() functions fully support cookies
        // - OAuth flows updated to cookie-based auth
        // - Legacy authToken variables maintained for transition compatibility
        // - Individual component functions may still reference authToken but will work via updated API layer
        // verifyAndSetUser() moved to /src/modules/core/auth/session.js

        // openAuthModal moved to /src/modules/core/auth/modal.js

        // closeAuthModal moved to /src/modules/core/auth/modal.js

        // switchToLogin moved to /src/modules/core/auth/modal.js

        // switchToRegister moved to /src/modules/core/auth/modal.js

        // clearAuthForm moved to /src/modules/core/auth/modal.js

        // handleLogin moved to /src/modules/core/auth/modal.js

        // handleRegister() moved to /src/modules/core/auth/modal.js

        // refreshUserDataIfNeeded() moved to /src/modules/core/auth/session.js

        // setUserLoggedIn() moved to /src/modules/core/auth/session.js
        // Now exposed globally by session.js module

        // Function to set the local currentUser variable from external systems
        window.setCurrentUser = function(user) {
            console.log('🔧 setCurrentUser called with:', user?.username || user?.email || 'null user');
            currentUser = user;
            window.currentUser = user;
            console.log('🔧 Local currentUser now set to:', currentUser?.username || 'null');
        };

        // setUserLoggedOut() moved to /src/modules/core/auth/session.js
        // Now exposed globally by session.js module

        // updateRadioButtonAvailability() moved to /src/handlers/civic-handlers.js

        // logout() moved to /src/modules/core/auth/session.js

        // showAuthMessage() moved to /src/modules/core/auth/modal.js

        // Modal Functions moved to /src/handlers/modal-handlers.js
        // - openAboutModal() and closeAboutModal()
        // - openVolunteerModal() and closeVolunteerModal()
        // - Click-outside-to-close functionality
        // - Volunteer form submission handler

        // OAuth Authentication Functions moved to /src/handlers/auth-handlers.js

        // handleGoogleCredentialResponse moved to /src/handlers/auth-handlers.js

        // handleMicrosoftLogin moved to /src/handlers/auth-handlers.js

        // handleAppleLogin moved to /src/handlers/auth-handlers.js

        // OAuth Debugging and Testing Functions moved to /src/handlers/auth-handlers.js

        // OAuth SDK Loading Functions moved to /src/handlers/auth-handlers.js

        // loadUserContent() moved to /src/handlers/civic-handlers.js

        // loadElectedOfficials() moved to /src/handlers/civic-handlers.js

        // updateOfficialsPanel() moved to /src/handlers/civic-handlers.js
        // openDetail() moved to /src/handlers/civic-handlers.js
        // closeDetail() moved to /src/handlers/civic-handlers.js

        // Panel management functions moved to NavigationHandlers module

        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleSidebar');
            const arrow = document.querySelector('.arrow-icon');
            
            sidebar.classList.toggle('expanded');
            
            // Update arrow direction and tooltip based on sidebar state
            if (sidebar.classList.contains('expanded')) {
                arrow.textContent = '◀'; // Arrow pointing left when expanded (to collapse)
                toggleButton.title = 'Collapse Sidebar';
                console.log('Sidebar expanded - arrow should point left');
            } else {
                arrow.textContent = '▶'; // Arrow pointing right when collapsed (to expand)
                toggleButton.title = 'Expand Sidebar';
                console.log('Sidebar collapsed - arrow should point right');
            }
        });

        // Set initial arrow state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleSidebar');
            const arrow = document.querySelector('.arrow-icon');
            
            if (sidebar && toggleButton && arrow) {
                if (sidebar.classList.contains('expanded')) {
                    arrow.textContent = '◀';
                    toggleButton.title = 'Collapse Sidebar';
                } else {
                    arrow.textContent = '▶';
                    toggleButton.title = 'Expand Sidebar';
                }
                console.log('Initial sidebar state set');
            }
        });

        // Map initialization - Toggle between Leaflet and MapLibre
        const USE_MAPLIBRE = true; // Set to false to use Leaflet during migration
        
        // initializeMap() moved to /src/handlers/map-handlers.js
        // Includes nested functions: createTopicPopup(), updateLeafletMapTopics(), showRandomPopups()

        // initializeMapLibreLocal() moved to /src/handlers/map-handlers.js

        // MOTD dismiss handler
        document.getElementById('motd-close-btn').addEventListener('click', function() {
            dismissCurrentMOTD();
        });

        // API Response Cache
        const apiCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes for general API calls
        const REPRESENTATIVES_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes for representatives (they don't change often)

        // API Helper Functions - Wrapper for legacy caching
        async function apiCall(endpoint, options = {}) {
            // Check if api-manager.js is loaded
            if (!window.apiManager || typeof window.apiManager.request !== 'function') {
                console.error('API Manager not loaded yet. Please ensure api-manager.js is loaded.');
                throw new Error('API Manager not initialized');
            }

            // Preserve legacy caching behavior for backward compatibility
            const isGet = !options.method || options.method === 'GET';
            const bypassCache = options.bypassCache;

            if (isGet && !bypassCache) {
                const cacheKey = `${endpoint}${currentUser ? `_${currentUser.id.substring(0, 10)}` : ''}`;
                const cached = apiCache.get(cacheKey);

                // Use longer cache duration for representatives data
                const cacheDuration = endpoint.includes('representatives') || endpoint.includes('officials')
                    ? REPRESENTATIVES_CACHE_DURATION
                    : CACHE_DURATION;

                if (cached && (Date.now() - cached.timestamp) < cacheDuration) {
                    console.log(`Using cached API response for ${endpoint} (${Math.round((Date.now() - cached.timestamp) / 1000)}s old)`);
                    return cached.data;
                }
            }

            try {
                // DELEGATE TO UNIFIED API CLIENT from api-manager.js
                const response = await window.apiManager.request(endpoint, options);
                
                // The apiClient already returns a structured response with parsed data
                // Transform it to match the legacy apiCall format for backward compatibility
                const result = {
                    ok: response.ok || response.success || false,
                    status: response.status || (response.ok ? 200 : 500),
                    data: response.data || response || null
                };
                
                // Cache GET responses
                if (isGet && !bypassCache && result.ok) {
                    const cacheKey = `${endpoint}${currentUser ? `_${currentUser.id.toString().substring(0, 10)}` : ''}`;
                    apiCache.set(cacheKey, {
                        timestamp: Date.now(),
                        data: result
                    });
                    
                    // Clean old cache entries periodically
                    if (apiCache.size > 100) {
                        const cutoff = Date.now() - Math.max(CACHE_DURATION, REPRESENTATIVES_CACHE_DURATION);
                        for (const [key, value] of apiCache.entries()) {
                            if (value.timestamp < cutoff) {
                                apiCache.delete(key);
                            }
                        }
                    }
                }

                return result;
            } catch (networkError) {
                console.error('Network error:', networkError);
                return {
                    ok: false,
                    status: 0,
                    data: { error: 'Network error. Please check your connection.' }
                };
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    await performSearch(query);
                }
            }
        });

        async function performSearch(query) {
            try {
                console.log('🔍 Search debug - calling:', `/search/unified?q=${encodeURIComponent(query)}&types=users`);
                const response = await window.apiCall(`/search/unified?q=${encodeURIComponent(query)}&types=users`);
                console.log('🔍 Search response:', response);
                
                if (response && (response.success || response.users || response.ok)) {
                    // Only use the global search results container, not the feed area
                    const users = response.data?.users || response.users || [];
                    console.log('🔍 Search users found:', users);
                    displayGlobalSearchResults(users);
                } else {
                    console.error('Search failed - response structure:', response);
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function displaySearchResults(users, query) {
            const mainContent = document.getElementById('mainContent');
            
            if (users.length === 0) {
                mainContent.innerHTML = `
                    <h1>Search Results</h1>
                    <p>No users found for "${query}"</p>
                `;
                return;
            }

            let html = `
                <h1>Search Results for "${query}"</h1>
                <div style="display: grid; gap: 1rem;">
            `;

            users.forEach(user => {
                const profileType = user.politicalProfileType || 'CITIZEN';
                const typeEmoji = {
                    'CANDIDATE': '🗳️',
                    'ELECTED_OFFICIAL': '🏛️',
                    'POLITICAL_ORG': '🏢',
                    'CITIZEN': '👤'
                }[profileType];

                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">${typeEmoji}</span>
                            <div>
                                <strong>${user.firstName || ''} ${user.lastName || ''}</strong>
                                ${user.verified ? '<span style="color: #1976d2;">✓</span>' : ''}
                                <br>
                                <small style="color: #666;">@${user.username}</small>
                            </div>
                        </div>
                        ${user.bio ? `<p style="margin: 0.5rem 0; color: #555;">${user.bio}</p>` : ''}
                        ${user.office ? `<p style="margin: 0.25rem 0; font-style: italic;">${user.office}</p>` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                            ${user.followersCount} followers
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            mainContent.innerHTML = html;
        }

        // MOTD Functions moved to /src/handlers/content-handlers.js
        // - loadMOTD(), displayMOTD(), generateDismissalToken()
        // - dismissCurrentMOTD() function and MOTD state management

        // Load trending topics for the trending panel (AI-powered)
        async function loadTrendingPosts() {
            try {
                // Try AI topic discovery first, fallback to posts if needed
                let response;
                try {
                    response = await window.apiCall('/topic-navigation/trending?limit=20');
                    if (response.ok && response.data.topics && response.data.topics.length > 0) {
                        updateTrendingTopicsPanel(response.data.topics);
                        return;
                    }
                } catch (topicError) {
                    console.log('AI topics unavailable for sidebar, falling back to posts:', topicError.message);
                }
                
                // Fallback to post-based trending for sidebar
                response = await window.apiCall('/feed/trending');
                
                if (response.ok) {
                    updateTrendingPanel(response.data.posts);
                } else {
                    console.error('Failed to load trending content:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load trending content:', error);
            }
        }
        
        // Enhanced function to render AI topics in the sidebar trending panel
        function updateTrendingTopicsPanel(topics) {
            const content = document.getElementById('trendingContent');
            
            if (!content) return;
            
            if (topics.length === 0) {
                content.innerHTML = '<p>No trending topics available.</p>';
                return;
            }
            
            let html = '<div class="trending-topics-list">';
            
            topics.forEach((topic, index) => {
                const isFeature = index === 0;
                const timeAgo = getTimeAgo(new Date(topic.createdAt || Date.now()));
                
                html += `
                    <div class="trending-topic-card" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;" onclick="enterTopicMode('${topic.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='none'">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.2rem;">${isFeature ? '🔥' : '🏷️'}</span>
                            <div style="font-weight: bold; font-size: 1rem; flex: 1; color: #333;">${topic.title}</div>
                            ${isFeature ? '<span style="background: #ff6b35; color: white; padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.7rem; font-weight: 500;">TRENDING</span>' : ''}
                        </div>
                        
                        <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.75rem; line-height: 1.4;">
                            ${(topic.summary || 'Discussion topic').substring(0, 150)}${topic.summary && topic.summary.length > 150 ? '...' : ''}
                        </div>
                        
                        ${topic.prevailingPosition ? `
                            <div style="background: #f8f9fa; border-left: 3px solid #28a745; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 0.25rem;">📍 PREVAILING POSITION</div>
                                <div style="font-size: 0.85rem; color: #555;">${topic.prevailingPosition.substring(0, 120)}${topic.prevailingPosition.length > 120 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        
                        ${topic.leadingCritique ? `
                            <div style="background: #f8f9fa; border-left: 3px solid #dc3545; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 0.25rem;">⚡ LEADING CRITIQUE</div>
                                <div style="font-size: 0.85rem; color: #555;">${topic.leadingCritique.substring(0, 120)}${topic.leadingCritique.length > 120 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #666; padding-top: 0.5rem; border-top: 1px solid #f0f0f0;">
                            <span>💬 ${topic.postCount} posts • 👥 ${topic.participantCount} people</span>
                            <span>${timeAgo}</span>
                        </div>
                        
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); enterTopicMode('${topic.id}')" style="background: #ff6b35; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#e55a2b'" onmouseout="this.style.background='#ff6b35'">
                                💬 Enter Discussion
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Auto-refresh trending posts
        // trendingRefreshInterval declared at top of DOMContentLoaded handler

        function startTrendingRefresh() {
            // Load initial trending updates (but don't spam if backend isn't ready)
            setTimeout(() => loadTrendingUpdates(), 2000);
            
            // Refresh trending every 50 seconds (new posts roll in at top, old ones roll off bottom)
            trendingRefreshInterval = setInterval(() => {
                // Only refresh if trending panel is visible
                if (document.getElementById('trendingUpdates').classList.contains('show')) {
                    loadTrendingUpdates();
                }
            }, 50000);
        }

        function stopTrendingRefresh() {
            if (trendingRefreshInterval) {
                clearInterval(trendingRefreshInterval);
                trendingRefreshInterval = null;
            }
        }

        // Load trending topics for the mini panel under map (AI-powered)
        async function loadTrendingUpdates() {
            try {
                // Check if backend is reachable first
                const healthCheck = await fetch(`${API_BASE.replace('/api', '')}/health`);
                if (!healthCheck.ok) {
                    console.log('Backend not available, skipping trending updates');
                    return;
                }

                // Get user's current geographic scope
                const scope = getCurrentGeographicScope(); // 'national', 'state', or 'local'

                // Try AI topic aggregation with dual-vector clustering
                let response;
                try {
                    response = await window.apiCall(`/trending/topics?scope=${scope}&limit=7`);
                    if (response.ok && response.data.topics && response.data.topics.length > 0) {
                        updateTrendingTopicsPanel(response.data.topics);
                        
                        // Show the panel when there's content
                        const panel = document.getElementById('trendingUpdates');
                        panel.classList.add('show');
                        return;
                    }
                } catch (topicError) {
                    console.log('AI topics unavailable, falling back to posts:', topicError.message);
                }
                
                // Fallback to post-based trending if AI aggregation fails
                response = await window.apiCall('/feed/trending?limit=20');
                
                if (response.ok) {
                    updateTrendingUpdatesPanel(response.data.posts);
                    
                    // Show the panel when there's content
                    const panel = document.getElementById('trendingUpdates');
                    if (response.data.posts.length > 0) {
                        panel.classList.add('show');
                    }
                } else {
                    console.log('No trending content available yet');
                }
            } catch (error) {
                console.log('Trending updates not available:', error.message);
                // Silently fail - don't spam console with errors
            }
        }

        let allTrendingPosts = [];
        let allTrendingTopics = [];
        let trendingExpanded = false;
        let displayMode = 'topics'; // 'topics' or 'posts'
        let currentTopicMode = null; // Track if user is in topic-filtered mode

        // Helper function to get current geographic scope
        function getCurrentGeographicScope() {
            // Check if user has a preferred scope setting or use national as default
            return localStorage.getItem('geographicScope') || 'national';
        }

        // Topic mode functions
        async function enterTopicMode(topicId) {
            try {
                const topic = allTrendingTopics.find(t => t.id === topicId);
                if (!topic) {
                    console.error('Topic not found:', topicId);
                    return;
                }

                // Fetch posts for this topic
                const response = await window.apiCall(`/trending/topics/${topicId}/posts?limit=20&stance=all`);
                
                if (response.ok) {
                    currentTopicMode = {
                        topicId,
                        topic: response.data.topic,
                        posts: response.data.posts
                    };

                    // Update My Feed to show topic-filtered posts
                    displayTopicFilteredFeed(response.data.topic, response.data.posts);
                    
                    // Update trending panel to show topic mode indicator
                    updateTrendingWithTopicMode();
                    
                    // Show topic mode header in My Feed
                    showTopicModeHeader(response.data.topic);

                } else {
                    console.error('Failed to fetch topic posts');
                }
            } catch (error) {
                console.error('Error entering topic mode:', error);
            }
        }
        
        // Make globally accessible for map bubbles
        window.enterTopicMode = enterTopicMode;
        window.exitTopicMode = exitTopicMode;

        function exitTopicMode() {
            currentTopicMode = null;
            
            // Clear topic mode header
            const header = document.getElementById('topicModeHeader');
            if (header) {
                header.remove();
            }
            
            // Reload normal My Feed
            loadMyFeed();
            
            // Refresh trending panel
            loadTrendingUpdates();
        }

        function showTopicModeHeader(topic) {
            // Remove any existing topic header
            const existingHeader = document.getElementById('topicModeHeader');
            if (existingHeader) {
                existingHeader.remove();
            }

            // Create new topic mode header
            const feedContainer = document.getElementById('myFeedPosts') || document.getElementById('mainContent');
            if (feedContainer) {
                const header = document.createElement('div');
                header.id = 'topicModeHeader';
                header.innerHTML = `
                    <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">📍</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">Viewing: ${topic.title}</h3>
                            </div>
                            <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">✕ Exit Topic Mode</button>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <div style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px;">
                                <strong>For (${topic.supportPercentage}%):</strong> ${topic.supportSummary}
                            </div>
                            <div style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px;">
                                <strong>Against (${topic.opposePercentage}%):</strong> ${topic.opposeSummary}
                            </div>
                        </div>
                    </div>
                `;
                feedContainer.insertBefore(header, feedContainer.firstChild);
            }
        }

        function displayTopicFilteredFeed(topic, posts) {
            const feedContainer = document.getElementById('myFeedPosts') || document.getElementById('mainContent');
            if (!feedContainer) return;

            // Clear existing posts (except the topic header)
            const existingPosts = feedContainer.querySelectorAll('.post-container, .feed-post');
            existingPosts.forEach(post => post.remove());

            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    
                    // Add stance indicator
                    if (post.stance) {
                        const stanceIndicator = document.createElement('div');
                        stanceIndicator.style.cssText = `
                            position: absolute; 
                            top: 10px; 
                            right: 10px; 
                            padding: 0.2rem 0.5rem; 
                            border-radius: 4px; 
                            font-size: 0.7rem; 
                            font-weight: bold;
                            ${post.stance === 'support' ? 'background: rgba(40, 167, 69, 0.1); color: #28a745; border: 1px solid #28a745;' : 
                              post.stance === 'oppose' ? 'background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid #dc3545;' : 
                              'background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 1px solid #6c757d;'}
                        `;
                        stanceIndicator.textContent = post.stance === 'support' ? 'Supporting' : 
                                                    post.stance === 'oppose' ? 'Opposing' : 'Neutral';
                        
                        postElement.style.position = 'relative';
                        postElement.appendChild(stanceIndicator);
                    }
                    
                    feedContainer.appendChild(postElement);
                });
            } else {
                const noPostsMessage = document.createElement('div');
                noPostsMessage.style.cssText = 'text-align: center; color: #666; padding: 2rem; background: white; border-radius: 8px; margin: 1rem 0;';
                noPostsMessage.innerHTML = `
                    <h3>No posts found for this topic</h3>
                    <p>Be the first to share your thoughts on "${topic.title}"!</p>
                    <button onclick="exitTopicMode()" style="background: #ff6b35; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">View All Posts</button>
                `;
                feedContainer.appendChild(noPostsMessage);
            }
        }

        // Enhanced function to display AI-aggregated topics with dual-vector stance info
        function updateTrendingTopicsPanel(topics) {
            allTrendingTopics = topics;
            displayMode = 'topics';
            const body = document.getElementById('trendingUpdatesBody');
            
            if (topics.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayTopics = trendingExpanded ? topics : topics.slice(0, 5);
            let html = '';
            
            displayTopics.forEach((topic, index) => {
                const isFeature = index === 0;
                
                // Create percentage bar visualization
                const supportPct = topic.support?.percentage || 50;
                const opposePct = topic.oppose?.percentage || 50;
                
                html += `
                    <div class="trending-item topic-item" onclick="enterTopicMode('${topic.id}')" style="cursor: pointer; padding: 0.8rem; border-bottom: 1px solid #eee; transition: background 0.2s;">
                        <div class="topic-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 6px;">
                            <span style="font-size: 1.1rem;">${isFeature ? '🔥' : '💭'}</span>
                            <div style="font-weight: bold; font-size: 0.9rem; flex: 1; color: #333;">${topic.title}</div>
                            ${isFeature ? '<span style="background: #ff6b35; color: white; padding: 0.15rem 0.35rem; border-radius: 6px; font-size: 0.65rem; font-weight: bold;">HOT</span>' : ''}
                        </div>
                        
                        <!-- Sentiment Bar -->
                        <div style="margin: 8px 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="flex: 1; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; position: relative;">
                                    <div style="position: absolute; left: 0; top: 0; height: 100%; background: #28a745; width: ${supportPct}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-size: 0.75rem; color: #666; min-width: 60px;">${supportPct}% | ${opposePct}%</span>
                            </div>
                        </div>
                        
                        <!-- Stance Summaries -->
                        ${topic.support?.summary ? `
                            <div style="margin: 6px 0; padding: 6px 8px; background: rgba(40, 167, 69, 0.08); border-radius: 4px; border-left: 2px solid #28a745;">
                                <div style="font-size: 0.75rem; color: #155724;">
                                    <strong>For:</strong> ${topic.support.summary.substring(0, 80)}${topic.support.summary.length > 80 ? '...' : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${topic.oppose?.summary ? `
                            <div style="margin: 6px 0; padding: 6px 8px; background: rgba(220, 53, 69, 0.08); border-radius: 4px; border-left: 2px solid #dc3545;">
                                <div style="font-size: 0.75rem; color: #721c24;">
                                    <strong>Against:</strong> ${topic.oppose.summary.substring(0, 80)}${topic.oppose.summary.length > 80 ? '...' : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Metadata -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 0.7rem; color: #888;">
                                💬 ${topic.totalPosts || (topic.support?.postCount + topic.oppose?.postCount) || 0} posts
                                ${topic.geographicScope ? ` • 📍 ${topic.geographicScope}` : ''}
                            </span>
                            ${topic.state || topic.city ? `
                                <span style="font-size: 0.65rem; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">
                                    ${topic.city || topic.state}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
            
            // Add hover effect
            body.querySelectorAll('.topic-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f8f9fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
        }

        function updateTrendingUpdatesPanel(posts) {
            allTrendingPosts = posts;
            displayMode = 'posts';
            const body = document.getElementById('trendingUpdatesBody');
            
            if (posts.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayPosts = trendingExpanded ? posts : posts.slice(0, 5);
            let html = '';
            
            displayPosts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                const preview = post.content.length > 80 ? post.content.substring(0, 80) + '...' : post.content;
                
                html += `
                    <div class="trending-item">
                        <div style="font-weight: bold; margin-bottom: 2px; font-size: 0.85rem;">@${post.author.username}</div>
                        <div style="margin-bottom: 4px;">${preview}</div>
                        <div style="color: #666; font-size: 0.75rem; margin-bottom: 4px;">
                            <span style="cursor: pointer; margin-right: 8px;" onclick="likeTrendingPost('${post.id}')">❤️ ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 8px;" onclick="showTrendingCommentBox('${post.id}')">💬 Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; margin-right: 8px; color: #4b5c09;" onclick="viewComments('${post.id}')">👁️ ${post.commentsCount}</span>` : ''}
                            <span>${timeAgo}</span>
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 50px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical; font-size: 0.8rem;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-size: 0.8rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
        }

        function toggleTrendingExpansion() {
            const panel = document.getElementById('trendingUpdates');
            const btn = document.getElementById('trendingExpandBtn');
            
            trendingExpanded = !trendingExpanded;
            
            if (trendingExpanded) {
                panel.classList.add('expanded');
                btn.textContent = 'Less';
            } else {
                panel.classList.remove('expanded');
                btn.textContent = 'More';
            }
            
            updateTrendingUpdatesPanel(allTrendingPosts);
        }

        // toggleTrendingPanel function moved to NavigationHandlers module
        
        // NEW: Topic Mode Functions for My Feed Integration
        async function enterTopicMode(topicId) {
            try {
                console.log(`Entering topic mode: ${topicId}`);
                
                // Store previous feed state if not already in topic mode
                if (!currentTopicMode) {
                    // Cache current My Feed state
                    const currentFeed = document.getElementById('feedContent');
                    if (currentFeed) {
                        window.cachedFeedState = currentFeed.innerHTML;
                    }
                }
                
                const response = await window.apiCall(`/topic-navigation/enter/${topicId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: 30 })
                });
                
                if (response.ok && response.data.success) {
                    currentTopicMode = {
                        topicId: topicId,
                        topic: response.data.topic,
                        posts: response.data.posts
                    };
                    
                    // Update My Feed with topic-filtered content
                    updateMyFeedWithTopic(response.data.topic, response.data.posts);
                    
                    // Update trending panel to show exit option
                    updateTrendingWithTopicMode();
                    
                    console.log(`✅ Entered topic: ${response.data.topic.title}`);
                } else {
                    console.error('Failed to enter topic mode:', response.data?.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error entering topic mode:', error);
            }
        }
        
        async function exitTopicMode() {
            try {
                console.log('Exiting topic mode...');
                
                const response = await window.apiCall('/topic-navigation/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok && response.data.success) {
                    currentTopicMode = null;
                    
                    // Restore cached feed or load fresh algorithm feed
                    if (window.cachedFeedState) {
                        const feedContent = document.getElementById('feedContent');
                        if (feedContent) {
                            feedContent.innerHTML = window.cachedFeedState;
                        }
                        delete window.cachedFeedState;
                    } else {
                        // Load fresh algorithm feed
                        if (typeof loadMyFeed === 'function') {
                            loadMyFeed();
                        }
                    }
                    
                    // Reset trending panel to normal state
                    loadTrendingUpdates();
                    
                    console.log('✅ Returned to main algorithm feed');
                } else {
                    console.error('Failed to exit topic mode:', response.data?.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error exiting topic mode:', error);
                // Force reset on error
                currentTopicMode = null;
                if (typeof loadMyFeed === 'function') {
                    loadMyFeed();
                }
                loadTrendingUpdates();
            }
        }
        
        function updateMyFeedWithTopic(topic, posts) {
            const feedContent = document.getElementById('feedContent');
            if (!feedContent) return;
            
            let html = `
                <div class="topic-mode-indicator">
                    <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">🏷️</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">${topic.title}</h3>
                            </div>
                            <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">← Exit Topic</button>
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${topic.summary}</div>
                        ${topic.prevailingPosition ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; border-left: 3px solid rgba(255,255,255,0.5);">
                                <strong>📍 Main Position:</strong> ${topic.prevailingPosition}
                            </div>
                        ` : ''}
                        ${topic.leadingCritique ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; border-left: 3px solid rgba(255,255,255,0.5);">
                                <strong>⚡ Leading Critique:</strong> ${topic.leadingCritique}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="topic-posts-feed">
            `;
            
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const timeAgo = getTimeAgo(new Date(post.createdAt));
                    html += `
                        <div class="post-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #ff6b35; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">
                                    ${post.author.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">@${post.author.username}</div>
                                    <div style="color: #666; font-size: 0.8rem;">${timeAgo}</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 0.75rem; line-height: 1.4;">${post.content}</div>
                            <div style="display: flex; gap: 1rem; padding-top: 0.5rem; border-top: 1px solid #f0f0f0; font-size: 0.85rem; color: #666;">
                                <span style="cursor: pointer;" onclick="likePost('${post.id}')">❤️ ${post.likesCount || 0}</span>
                                <span style="cursor: pointer;">💬 ${post.commentsCount || 0}</span>
                                <span style="cursor: pointer;">🔄 Share</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="text-align: center; color: #666; padding: 2rem;">No posts found for this topic.</div>';
            }
            
            html += '</div>';
            feedContent.innerHTML = html;
        }
        
        function updateTrendingWithTopicMode() {
            const body = document.getElementById('trendingUpdatesBody');
            if (!body || !currentTopicMode) return;
            
            const topic = currentTopicMode.topic;
            
            body.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: bold; font-size: 0.85rem;">🏷️ TOPIC MODE</span>
                        <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Exit</button>
                    </div>
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 0.25rem;">${topic.title}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">${topic.postCount} posts • ${topic.participantCount} participants</div>
                </div>
                <div style="text-align: center; padding: 0.5rem; color: #666; font-size: 0.8rem;">
                    My Feed is now filtered by this topic.<br>
                    <a href="#" onclick="loadTrendingUpdates(); return false;" style="color: #ff6b35; text-decoration: none;">View other trending topics</a>
                </div>
            `;
        }
        
        // Map Integration Functions - Sync AI Topics with Map Bubbles
        let mapTopicCache = [];
        let lastMapTopicUpdate = 0;
        let lastMapTopicScope = 'national';
        const MAP_TOPIC_CACHE_DURATION = 45000; // 45 seconds (3 topics x 15 seconds each)
        
        // Fetch and cycle AI topics for map display
        async function updateMapTopics() {
            try {
                const now = Date.now();
                
                // Check if we need to refresh the cache or if scope changed
                const currentScope = currentZoomLevel || 'national';
                if (now - lastMapTopicUpdate > MAP_TOPIC_CACHE_DURATION || mapTopicCache.length === 0 || lastMapTopicScope !== currentScope) {
                    const response = await window.apiCall(`/trending/map-topics?count=9&scope=${currentScope}`); // Get 9 topics for current scope
                    
                    if (response.ok && response.data.topics) {
                        mapTopicCache = response.data.topics;
                        lastMapTopicUpdate = now;
                        lastMapTopicScope = currentScope;
                        console.log(`Updated map topic cache with ${mapTopicCache.length} topics for ${currentScope} scope`);
                    }
                }
                
                // Get current set of 3 topics to display (rotating every 15 seconds)
                return getCurrentMapTopics();
                
            } catch (error) {
                console.error('Error updating map topics:', error);
                return [];
            }
        }
        
        // Get the current 3 topics to display on map (cycles every 15 seconds)
        function getCurrentMapTopics() {
            if (mapTopicCache.length === 0) return [];
            
            // Calculate which slice of 3 topics to show based on time
            const cycleIndex = Math.floor(Date.now() / 15000) % Math.max(1, Math.ceil(mapTopicCache.length / 3));
            const startIndex = cycleIndex * 3;
            const endIndex = Math.min(startIndex + 3, mapTopicCache.length);
            
            return mapTopicCache.slice(startIndex, endIndex);
        }
        
        // Convert AI topics to map bubble format with geographic distribution
        function convertTopicsToMapBubbles(aiTopics) {
            if (!aiTopics || aiTopics.length === 0) return [];
            
            // Predefined coordinates for major US cities - AI topics get distributed across these
            const cityCoords = [
                { coords: [40.7128, -74.0060], city: 'NYC', weight: 1.0 },
                { coords: [34.0522, -118.2437], city: 'Los Angeles', weight: 0.9 },
                { coords: [41.8781, -87.6298], city: 'Chicago', weight: 0.8 },
                { coords: [29.7604, -95.3698], city: 'Houston', weight: 0.7 },
                { coords: [47.6062, -122.3321], city: 'Seattle', weight: 0.6 },
                { coords: [39.7392, -104.9903], city: 'Denver', weight: 0.5 },
                { coords: [33.4484, -112.0740], city: 'Phoenix', weight: 0.5 },
                { coords: [25.7617, -80.1918], city: 'Miami', weight: 0.4 },
                { coords: [32.7767, -96.7970], city: 'Dallas', weight: 0.4 },
                { coords: [42.3601, -71.0589], city: 'Boston', weight: 0.4 },
                { coords: [38.9072, -77.0369], city: 'Washington DC' },
                { coords: [37.7749, -122.4194], city: 'San Francisco' },
                { coords: [39.9526, -75.1652], city: 'Philadelphia' },
                { coords: [30.2672, -97.7431], city: 'Austin' },
                { coords: [39.7391, -104.9903], city: 'Colorado Springs' }
            ];
            
            const mapBubbles = [];
            let coordIndex = 0;
            
            aiTopics.forEach((topic, index) => {
                const coord = cityCoords[coordIndex % cityCoords.length];
                coordIndex++;
                
                // Create bubble text from new topic data structure
                let bubbleText = `💭 ${topic.title}`;
                
                // Add stance percentages
                if (topic.supportPercentage && topic.opposePercentage) {
                    bubbleText += ` (${topic.supportPercentage}% vs ${topic.opposePercentage}%)`;
                }
                
                // Add geographic scope indicator
                if (topic.geographicScope) {
                    const scopeIcon = topic.geographicScope === 'local' ? '🏘️' : 
                                    topic.geographicScope === 'state' ? '🏛️' : '🌎';
                    bubbleText += ` ${scopeIcon}`;
                }
                
                mapBubbles.push({
                    coords: coord.coords,
                    text: bubbleText,
                    city: coord.city,
                    topicId: topic.id,
                    priority: index < 3 ? 'high' : 'normal', // Top 3 get higher priority
                    aiTopic: true, // Flag to distinguish from static topics
                    supportPercentage: topic.supportPercentage,
                    opposePercentage: topic.opposePercentage,
                    geographicScope: topic.geographicScope
                });
            });
            
            return mapBubbles;
        }
        
        // Enhanced function to update map with AI topics
        async function updateMapWithTrendingTopics() {
            try {
                // Check if we need to refresh the topic cache
                const now = Date.now();
                if (mapTopicCache.length > 0 && (now - lastMapTopicUpdate) < MAP_TOPIC_CACHE_DURATION) {
                    console.log('Using cached map topics');
                    return mapTopicCache;
                }
                
                // Fetch latest AI topics using new aggregation API
                const response = await window.apiCall('/trending/map-topics?count=12');
                if (response.ok && response.data.topics && response.data.topics.length > 0) {
                    const aiTopics = response.data.topics;
                    const mapBubbles = convertTopicsToMapBubbles(aiTopics);
                    
                    // Update cache
                    mapTopicCache = mapBubbles;
                    lastMapTopicUpdate = now;
                    
                    // Update the map if available
                    if (window.updateMapTopics && typeof window.updateMapTopics === 'function') {
                        console.log('Updating map with AI-generated topics...');
                        window.updateMapTopics(mapBubbles);
                    } else if (window.map && window.map.updateTopics) {
                        console.log('Updating map topics via map.updateTopics...');
                        window.map.updateTopics(mapBubbles);
                    } else {
                        console.log('Map topic update method not available, topics cached for next map init');
                    }
                    
                    return mapBubbles;
                } else {
                    console.log('AI topics unavailable for map, using fallback');
                    return getFallbackMapTopics();
                }
            } catch (error) {
                console.error('Failed to update map with trending topics:', error);
                return getFallbackMapTopics();
            }
        }
        
        // Fallback to static topics if AI topics are unavailable
        function getFallbackMapTopics() {
            return [
                { coords: [40.7128, -74.0060], text: '🏛️ NYC discussing local election reforms', city: 'NYC', priority: 'normal' },
                { coords: [34.0522, -118.2437], text: '🚗 California EV subsidy debates heating up', city: 'Los Angeles', priority: 'normal' },
                { coords: [41.8781, -87.6298], text: '⚖️ Chicago criminal justice reform discussions', city: 'Chicago', priority: 'normal' },
                { coords: [29.7604, -95.3698], text: '🗳️ Texas open primary initiatives gaining support', city: 'Houston', priority: 'normal' },
                { coords: [47.6062, -122.3321], text: '🌳 Seattle green zoning community organizing', city: 'Seattle', priority: 'normal' },
                { coords: [39.7392, -104.9903], text: '🏡 Denver housing-first policy debates', city: 'Denver', priority: 'normal' }
            ];
        }
        
        // Integration with trending system - call this when topics are loaded
        function syncMapWithTrendingTopics() {
            updateMapWithTrendingTopics();
        }
        
        // Enhanced loadTrendingUpdates to sync with map
        const originalLoadTrendingUpdates = loadTrendingUpdates;
        loadTrendingUpdates = async function() {
            await originalLoadTrendingUpdates();
            
            // After loading trending topics, sync with map
            setTimeout(() => {
                syncMapWithTrendingTopics();
            }, 500); // Small delay to ensure trending updates are complete
        };
        
        // NEW: Geographic Layering System with Balanced Timing
        let geographicTopicTimer = null;
        let lastGeographicTopicTime = 0;
        const GEOGRAPHIC_TOPIC_INTERVAL = 50000; // 50 seconds (45-60 range)
        
        // Enhanced geographic distribution based on zoom level and user location
        function getGeographicLayeredTopics(aiTopics, zoomLevel = 'national') {
            if (!aiTopics || aiTopics.length === 0) return [];
            
            const userState = currentUser?.state || null;
            const userCity = currentUser?.city || null;
            
            const layeredTopics = [];
            let topicIndex = 0;
            
            // Determine topic distribution based on zoom level
            switch (zoomLevel) {
                case 'national':
                    // National view: Primarily national topics, with periodic state/local injection
                    const nationalTopics = aiTopics.filter((_, index) => index < 10); // Top 10 as national
                    
                    // Every 45-60 seconds, inject state/local topics
                    const now = Date.now();
                    const shouldInjectLocal = (now - lastGeographicTopicTime) > GEOGRAPHIC_TOPIC_INTERVAL;
                    
                    if (shouldInjectLocal && aiTopics.length > 10) {
                        // Inject 2-3 topics as "state/local" with user's geographic context
                        const localTopics = aiTopics.slice(10, 13).map((topic, index) => ({
                            ...topic,
                            geographicContext: userState ? `${userState} Local` : 'Regional',
                            localPriority: true
                        }));
                        
                        layeredTopics.push(...localTopics);
                        lastGeographicTopicTime = now;
                        console.log('Injected local topics for national view');
                    }
                    
                    layeredTopics.push(...nationalTopics.map(topic => ({
                        ...topic,
                        geographicContext: 'National'
                    })));
                    break;
                    
                case 'state':
                    // State view: Mix of state-specific and national topics
                    layeredTopics.push(...aiTopics.map(topic => ({
                        ...topic,
                        geographicContext: userState || 'State'
                    })));
                    break;
                    
                case 'local':
                    // Local view: Focus on local and regional topics
                    layeredTopics.push(...aiTopics.map(topic => ({
                        ...topic,
                        geographicContext: userCity ? `${userCity}, ${userState}` : 'Local'
                    })));
                    break;
            }
            
            return layeredTopics;
        }
        
        // Enhanced convertTopicsToMapBubbles with geographic layering
        const originalConvertTopicsToMapBubbles = convertTopicsToMapBubbles;
        convertTopicsToMapBubbles = function(aiTopics, zoomLevel = null) {
            const effectiveZoomLevel = zoomLevel || currentZoomLevel || 'national';
            const layeredTopics = getGeographicLayeredTopics(aiTopics, effectiveZoomLevel);
            
            if (!layeredTopics || layeredTopics.length === 0) return [];
            
            // Get appropriate coordinates based on zoom level
            const coordSets = getCoordinatesByZoomLevel(effectiveZoomLevel);
            const mapBubbles = [];
            let coordIndex = 0;
            
            layeredTopics.forEach((topic, index) => {
                const coord = coordSets[coordIndex % coordSets.length];
                coordIndex++;
                
                // Enhanced bubble text with geographic context
                let bubbleText = `${topic.localPriority ? '📍' : '🏷️'} ${topic.title}`;
                
                // Add geographic context indicator
                if (topic.geographicContext && topic.geographicContext !== 'National') {
                    bubbleText += ` [${topic.geographicContext}]`;
                }
                
                // Add brief description if available
                if (topic.summary && topic.summary.length > 0) {
                    const shortSummary = topic.summary.length > 60 
                        ? topic.summary.substring(0, 60) + '...' 
                        : topic.summary;
                    bubbleText += ` - ${shortSummary}`;
                }
                
                // Add engagement indicator for top topics or local priority
                if (index < 3 || topic.localPriority) {
                    bubbleText += ` (${topic.postCount} posts${topic.localPriority ? ', local interest' : ''})`;
                }
                
                mapBubbles.push({
                    coords: coord.coords,
                    text: bubbleText,
                    city: coord.city,
                    topicId: topic.id,
                    priority: topic.localPriority ? 'local' : (index < 3 ? 'high' : 'normal'),
                    geographicContext: topic.geographicContext,
                    aiTopic: true
                });
            });
            
            return mapBubbles;
        };
        
        // Get appropriate coordinate sets based on zoom level
        function getCoordinatesByZoomLevel(zoomLevel) {
            const nationalCoords = [
                { coords: [40.7128, -74.0060], city: 'NYC' },
                { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                { coords: [41.8781, -87.6298], city: 'Chicago' },
                { coords: [29.7604, -95.3698], city: 'Houston' },
                { coords: [47.6062, -122.3321], city: 'Seattle' },
                { coords: [39.7392, -104.9903], city: 'Denver' },
                { coords: [33.4484, -112.0740], city: 'Phoenix' },
                { coords: [25.7617, -80.1918], city: 'Miami' },
                { coords: [32.7767, -96.7970], city: 'Dallas' },
                { coords: [42.3601, -71.0589], city: 'Boston' },
                { coords: [38.9072, -77.0369], city: 'Washington DC' },
                { coords: [37.7749, -122.4194], city: 'San Francisco' }
            ];
            
            const stateCoords = getUserStateCoordinates();
            const localCoords = getUserLocalCoordinates();
            
            switch (zoomLevel) {
                case 'state':
                    return stateCoords.length > 0 ? stateCoords : nationalCoords.slice(0, 8);
                case 'local':
                    return localCoords.length > 0 ? localCoords : nationalCoords.slice(0, 6);
                case 'national':
                default:
                    return nationalCoords;
            }
        }
        
        // Get coordinates relevant to user's state
        function getUserStateCoordinates() {
            if (!currentUser?.state) return [];
            
            // Major cities by state (sample)
            const stateCityMap = {
                'CA': [
                    { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                    { coords: [37.7749, -122.4194], city: 'San Francisco' },
                    { coords: [32.7157, -117.1611], city: 'San Diego' }
                ],
                'TX': [
                    { coords: [29.7604, -95.3698], city: 'Houston' },
                    { coords: [32.7767, -96.7970], city: 'Dallas' },
                    { coords: [30.2672, -97.7431], city: 'Austin' }
                ],
                'NY': [
                    { coords: [40.7128, -74.0060], city: 'NYC' },
                    { coords: [42.3584, -75.3890], city: 'Albany' },
                    { coords: [43.0481, -76.1474], city: 'Syracuse' }
                ],
                'FL': [
                    { coords: [25.7617, -80.1918], city: 'Miami' },
                    { coords: [28.5383, -81.3792], city: 'Orlando' },
                    { coords: [30.4383, -84.2807], city: 'Tallahassee' }
                ]
            };
            
            return stateCityMap[currentUser.state] || [];
        }
        
        // Get coordinates relevant to user's local area
        function getUserLocalCoordinates() {
            if (!currentUser?.city || !currentUser?.state) return [];
            
            // For local view, create coordinates around user's area
            // This would ideally use real local coordinates
            const userLat = parseFloat(currentUser.latitude) || 39.8283;
            const userLng = parseFloat(currentUser.longitude) || -98.5795;
            
            // Generate nearby coordinates (simplified approach)
            const localCoords = [];
            for (let i = 0; i < 6; i++) {
                const offsetLat = (Math.random() - 0.5) * 0.5; // ~25 mile radius
                const offsetLng = (Math.random() - 0.5) * 0.5;
                
                localCoords.push({
                    coords: [userLat + offsetLat, userLng + offsetLng],
                    city: `${currentUser.city} Area ${i + 1}`
                });
            }
            
            return localCoords;
        }
        
        // Start geographic topic balancing timer
        function startGeographicTopicBalancing() {
            if (geographicTopicTimer) {
                clearInterval(geographicTopicTimer);
            }
            
            geographicTopicTimer = setInterval(() => {
                // Only inject local topics when viewing national level
                if (currentZoomLevel === 'national') {
                    console.log('Geographic topic balancing - refreshing for local injection');
                    syncMapWithTrendingTopics();
                }
            }, GEOGRAPHIC_TOPIC_INTERVAL);
        }
        
        // Initialize geographic balancing on page load
        document.addEventListener('DOMContentLoaded', () => {
            startGeographicTopicBalancing();
        });

        function openFullTrending() {
            // This function kept for compatibility but now just expands in place
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function viewTrendingPost(postId) {
            // For now, just expand the trending if not already expanded
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function updateTrendingPanel(posts) {
            const content = document.getElementById('trendingContent');
            
            if (posts.length === 0) {
                content.innerHTML = '<p>No trending posts available.</p>';
                return;
            }

            let html = '<div>';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                html += `
                    <div data-post-id="${post.id}" style="margin-bottom: 1rem; padding: 0.75rem; border-left: 3px solid #4b5c09; background: #f9f9f9; border-radius: 4px; transition: all 0.3s ease;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                            @${post.author.username} • ${timeAgo}
                        </div>
                        <div style="margin-bottom: 0.5rem;">${post.content}</div>
                        <div style="font-size: 0.8rem; color: #888;">
                            <span style="cursor: pointer; margin-right: 10px;" onclick="likeTrendingPost('${post.id}')">❤️ ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 10px;" onclick="showTrendingCommentBox('${post.id}')">💬 Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; color: #4b5c09;" onclick="viewComments('${post.id}')">👁️ View ${post.commentsCount}</span>` : ''}
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }

        // Override existing togglePanel to load live data
        const originalTogglePanel = window.togglePanel;
        window.togglePanel = function(name) {
            const panel = document.getElementById(`panel-${name}`);
            const wasHidden = panel.classList.contains('hidden');
            
            originalTogglePanel(name);
            
            // Load live data when panels are opened (not when closed)
            if (wasHidden) {
                if (name === 'trending') {
                    loadTrendingPosts();
                } else if (name === 'officials' && currentUser) {
                    loadUserContent();
                }
            }
        };

        // Messages Functions
        // toggleMessages function moved to NavigationHandlers module

        async function loadConversations() {
            if (!currentUser) return;

            try {
                const response = await window.apiCall('/messages/conversations');
                
                if (response.ok) {
                    displayConversations(response.data.conversations);
                } else {
                    document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Failed to load conversations</p>';
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
                document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Error loading conversations</p>';
            }
        }

        async function displayConversations(conversations) {
            const body = document.getElementById('messagesBody');
            
            if (!currentUser) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view messages</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="showNewConversationForm()" style="width: 100%; padding: 0.5vh; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-bottom: 0.5vh;">
                        + New Conversation
                    </button>
                    <button onclick="showFriendsList()" style="width: 100%; padding: 0.5vh; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        👥 Message Friends
                    </button>
                </div>
            `;
            
            if (conversations.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>No conversations yet</p>
                        <p style="font-size: 0.9rem;">Start your first conversation with a friend!</p>
                    </div>
                `;
            } else {
                conversations.forEach(conv => {
                    const participant = conv.participants[0];
                    const timeAgo = conv.lastMessageAt ? getTimeAgo(new Date(conv.lastMessageAt)) : '';
                    
                    html += `
                        <div class="conversation-item" onclick="openConversation('${conv.id}', '${participant.username}')">
                            <div class="user-avatar">${(participant.firstName?.[0] || participant.username[0]).toUpperCase()}</div>
                            <div class="conversation-info">
                                <div class="conversation-name">${participant.firstName || participant.username}</div>
                                <div class="conversation-preview">${conv.lastMessageContent || 'No messages yet'} ${timeAgo ? '• ' + timeAgo : ''}</div>
                            </div>
                        </div>
                    `;
                });
            }

            body.innerHTML = html;
        }

        function showNewConversationForm() {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">←</button>
                    <span style="font-weight: bold;">New Conversation</span>
                </div>
                
                <div style="padding: 1rem; text-align: center;">
                    <div style="color: #666; margin-bottom: 1rem;">
                        <p>To start a new conversation, use the search bar at the top of the page to find users.</p>
                        <p style="font-size: 0.9rem;">Search results will include options to message, follow, and add as friend.</p>
                    </div>
                    <button onclick="document.getElementById('searchInput').focus(); openSearch();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Open Search
                    </button>
                </div>
            `;
            
            // Focus on search input
            setTimeout(() => {
                document.getElementById('userSearchInput')?.focus();
            }, 100);
        }


        async function startConversationWithUser(userId, username) {
            try {
                const response = await window.apiCall('/messages/conversations', {
                    method: 'POST',
                    body: JSON.stringify({ participantId: userId })
                });

                if (response.ok) {
                    // Open the conversation
                    openConversation(response.data.conversation.id, username);
                } else {
                    alert('Failed to start conversation');
                }
            } catch (error) {
                console.error('Failed to start conversation:', error);
                alert('Error starting conversation');
            }
        }

        async function openConversation(conversationId, username) {
            try {
                // Load messages for this conversation
                const response = await window.apiCall(`/messages/conversations/${conversationId}/messages`);
                
                if (response.ok) {
                    showConversationView(conversationId, username, response.data.messages);
                } else {
                    alert('Failed to load conversation');
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
                alert('Error loading conversation');
            }
        }

        function showConversationView(conversationId, username, messages) {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">←</button>
                    <div class="user-avatar" style="margin-right: 0.5rem;">${username[0].toUpperCase()}</div>
                    <span style="font-weight: bold;">${username}</span>
                </div>
                
                <div id="messagesArea" style="height: 250px; overflow-y: auto; padding: 0.5rem; background: white;">
                    ${messages.length === 0 ? 
                        '<div style="text-align: center; padding: 2rem; color: #666;">No messages yet. Start the conversation!</div>' :
                        messages.map(msg => `
                            <div style="margin-bottom: 0.75rem; ${msg.sender.id === currentUser?.id ? 'text-align: right;' : ''}">
                                <div style="display: inline-block; max-width: 80%; padding: 0.5rem 0.75rem; border-radius: 12px; ${
                                    msg.sender.id === currentUser?.id ? 
                                    'background: #4b5c09; color: white;' : 
                                    'background: #f0f0f0; color: black;'
                                }">
                                    <div style="font-size: 0.9rem;">${msg.content}</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.8;">
                                        ${msg.sender.id === currentUser?.id ? '' : msg.sender.username + ' • '}${new Date(msg.createdAt).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                
                <div style="display: flex; padding: 1vh; border-top: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <input 
                        type="text" 
                        id="messageInput-${conversationId}" 
                        placeholder="Type a message..." 
                        style="flex: 1; padding: 0.5vh; border: 1px solid #ddd; border-radius: 20px; margin-right: 0.5rem; outline: none;"
                        data-messaging-action="handle-message-keypress" data-conversation-id="${conversationId}"
                    >
                    <button 
                        data-messaging-action="send-message" data-conversation-id="${conversationId}" 
                        style="background: #4b5c09; color: white; border: none; padding: 0.5vh 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem;"
                    >
                        Send
                    </button>
                </div>
            `;
            
            // Scroll to bottom of messages
            setTimeout(() => {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById(`messageInput-${conversationId}`)?.focus();
            }, 100);
        }

        function backToConversations() {
            loadConversations();
        }

        function handleMessageKeyPress(event, conversationId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(conversationId);
            }
        }

        async function sendMessage(conversationId) {
            const input = document.getElementById(`messageInput-${conversationId}`);
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                const response = await window.apiCall(`/messages/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    input.value = '';
                    // Refresh the conversation to show the new message
                    const username = document.querySelector('#messagesBody span[style*="font-weight: bold"]')?.textContent;
                    if (username) {
                        openConversation(conversationId, username);
                    }
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Error sending message');
            }
        }

        // Profile Functions - Updated to use main content area
        function toggleProfile() {
            // Use the new My Profile component instead of the old side panel
            showProfile();
        }



        // Function to show default view when all windows are closed
        // showDefaultView function moved to NavigationHandlers module
        window.toggleProfile = toggleProfile; // Make globally accessible

        // toggleMyFeed function moved to NavigationHandlers module

        // Function to show My Feed in main content area (like Profile)
        async function showMyFeedInMain() {
            console.log('🎯 Showing My Feed in main content area');
            
            // Hide Civic Organizing container if open
            const civicOrganizing = document.querySelector('.civic-organizing-container');
            if (civicOrganizing) {
                civicOrganizing.style.display = 'none';
            }
            
            // Hide other main view systems
            const electionsView = document.querySelector('.elections-main-view');
            if (electionsView) {
                electionsView.style.display = 'none';
            }
            
            const officialsView = document.querySelector('.officials-main-view');
            if (officialsView) {
                officialsView.style.display = 'none';
            }
            
            const candidatesView = document.querySelector('.candidates-main-view');
            if (candidatesView) {
                candidatesView.style.display = 'none';
            }
            
            // Check if user is authenticated (using window.currentUser since tokens are httpOnly)
            if (!window.currentUser) {
                console.log('❌ No authenticated user, showing login prompt');
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your feed</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }
            
            console.log('✅ Authenticated user found for My Feed:', window.currentUser.username);

            // Hide other content
            closeAllPanels();
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            
            // Show My Feed in main content area
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="my-feed">
                    <div class="sticky-composer-wrapper">
                        <div class="quick-post-composer">
                            <textarea id="feedPostContent" placeholder="What's on your mind?" style="width: 100%; min-height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            <div style="text-align: right; margin-top: 0.25rem; margin-bottom: 0.25rem;">
                                <span id="feedPostCharCount" style="font-size: 0.85rem; color: #6c757d;">0/500</span>
                                <span id="sectionIndicator" style="display: none; margin-left: 10px; font-size: 0.85rem; color: #1da1f2;">Section 1</span>
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <label for="feedMediaUpload" style="background: #666; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem;">
                                        📷 Add Media
                                        <input type="file" id="feedMediaUpload" multiple accept="image/*,video/*" style="display: none;" data-action="handle-post-media-upload">
                                    </label>
                                    <div id="feedMediaPreview" style="margin-top: 0.5rem;"></div>
                                </div>
                                <div>
                                    <button onclick="createPostFromFeed()" class="btn">Post</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="myFeedPosts" style="margin-top: 1rem; min-height: 400px; height: calc(100vh - 300px); overflow-y: auto;">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>Loading your personalized feed...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Load the posts with error handling
            try {
                await loadMyFeedPosts();
            } catch (error) {
                console.error('❌ Error loading My Feed posts:', error);
                const feedContainer = document.getElementById('myFeedPosts');
                if (feedContainer) {
                    feedContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p>Error loading feed. Please refresh the page.</p>
                            <button onclick="showMyFeedInMain()" class="btn">Retry</button>
                        </div>
                    `;
                }
            }
            
            // Setup infinite scroll for My Feed (with safety check)
            try {
                if (typeof setupMyFeedInfiniteScroll === 'function') {
                    setupMyFeedInfiniteScroll();
                } else {
                    console.warn('⚠️ setupMyFeedInfiniteScroll function not available');
                }
            } catch (error) {
                console.error('❌ Error setting up infinite scroll:', error);
            }
            
            // Character counter - only shows when approaching max limit
            const feedPostTextarea = document.getElementById('feedPostContent');
            const feedCharCount = document.getElementById('feedPostCharCount');
            const sectionIndicator = document.getElementById('sectionIndicator');
            
            if (feedPostTextarea && feedCharCount) {
                // Function to update character count
                function updateCharCounter() {
                    const text = feedPostTextarea.value;
                    const charCount = text.length;
                    
                    // Hide section indicator (no longer needed)
                    if (sectionIndicator) {
                        sectionIndicator.style.display = 'none';
                    }
                    
                    // Only show counter when approaching 5000 char limit
                    if (charCount >= 4900) {
                        feedCharCount.style.display = 'inline';
                        feedCharCount.textContent = `${charCount}/5000`;
                        
                        if (charCount > 5000) {
                            feedCharCount.style.color = '#dc3545'; // Red
                            feedCharCount.style.fontWeight = 'bold';
                        } else {
                            feedCharCount.style.color = '#ffc107'; // Orange warning
                            feedCharCount.style.fontWeight = 'bold';
                        }
                    } else {
                        // Hide counter when under 4900
                        feedCharCount.style.display = 'none';
                    }
                }
                
                // Initial count
                updateCharCounter();
                
                // Update on input
                feedPostTextarea.addEventListener('input', updateCharCounter);
            }
            
            // Apply background if user has one
            if (currentUser && currentUser.backgroundImage) {
                applyUserBackground(currentUser.backgroundImage);
            }
        }
        // toggleMyFeed is already exported globally from navigation-handlers.js

        // Make function globally available
        window.showMyFeedInMain = showMyFeedInMain;

        // Load posts for My Feed in main area
        async function loadMyFeedPosts() {
            console.log('🔄 Loading My Feed posts...');
            
            // Ensure user is authenticated (using currentUser since tokens are httpOnly)
            if (!currentUser) {
                console.error('❌ No authenticated user for My Feed');
                document.getElementById('myFeedPosts').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p>Please log in to view your feed.</p>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }
            
            try {
                console.log('🌐 Making API call to /feed/');
                const response = await window.apiCall('/feed/?limit=15', {
                    method: 'GET'
                });
                
                console.log('📦 My Feed API Response:', response);
                
                // Handle different response formats
                let posts = null;
                if (response && response.posts) {
                    // Direct posts array
                    posts = response.posts;
                } else if (response && response.data && response.data.posts) {
                    // Wrapped in data object
                    posts = response.data.posts;
                } else if (response && response.ok && response.data && response.data.posts) {
                    // Double wrapped
                    posts = response.data.posts;
                }
                
                if (posts && Array.isArray(posts) && posts.length > 0) {
                    console.log(`✅ Found ${posts.length} posts for My Feed`);
                    // Reset offset for initial load
                    currentFeedOffset = posts.length;
                    hasMorePosts = true; // Reset for new feed
                    displayMyFeedPosts(posts);
                } else {
                    console.log('📝 No posts found in My Feed');
                    const feedContainer = document.getElementById('myFeedPosts');
                    if (feedContainer) {
                        feedContainer.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <p>No posts in your feed yet. Follow some users to see their posts here!</p>
                                <p><small>Start by exploring trending topics or searching for users to follow.</small></p>
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('❌ Feed loading error:', error);
                const feedContainer = document.getElementById('myFeedPosts');
                if (feedContainer) {
                    feedContainer.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p>Unable to load your feed. Please try again.</p>
                            <p><small>Error: ${error.message}</small></p>
                            <button onclick="loadMyFeedPosts()" class="btn">Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Display posts in My Feed
        function displayMyFeedPosts(posts, appendMode = false) {
            const container = document.getElementById('myFeedPosts');
            
            if (!container) {
                console.error('❌ My Feed container not found');
                return;
            }
            
            if (!posts || posts.length === 0) {
                if (!appendMode) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No posts in your feed yet. Follow some users to see their posts here!</p>
                        </div>
                    `;
                }
                return;
            }
            
            console.log(`🎯 ${appendMode ? 'Appending' : 'Displaying'} ${posts.length} posts in My Feed`);
            
            // Use the existing displayPosts function with fallback
            try {
                if (typeof displayPosts === 'function') {
                    displayPosts(posts, 'myFeedPosts', appendMode);
                } else {
                    console.warn('⚠️ displayPosts function not available, using fallback');
                    displayMyFeedPostsFallback(posts, container, appendMode);
                }
            } catch (error) {
                console.error('❌ Error displaying posts:', error);
                displayMyFeedPostsFallback(posts, container, appendMode);
            }
        }
        
        // Fallback display function for My Feed
        function displayMyFeedPostsFallback(posts, container, appendMode = false) {
            console.log(`🔧 Using fallback display for My Feed (${appendMode ? 'append' : 'replace'} mode)`);
            
            let html = '';
            posts.forEach(post => {
                html += `
                    <div class="post-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <strong>${post.author?.firstName || post.author?.username || 'Anonymous'}</strong>
                            <span style="color: #666; margin-left: 0.5rem; font-size: 0.9rem;">
                                ${post.createdAt ? new Date(post.createdAt).toLocaleDateString() : ''}
                            </span>
                        </div>
                        <div style="margin-bottom: 1rem;">${post.content || ''}</div>
                        ${post.photos && post.photos.length > 0 ? `
                            <div style="margin-bottom: 1rem;">
                                ${post.photos.map(photo => `
                                    <img src="${photo.url}" alt="Post image"
                                         style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 0.5rem; display: block;"
                                         onclick="window.open('${photo.url}', '_blank')">
                                `).join('')}
                            </div>
                        ` : ''}
                        <div style="color: #666; font-size: 0.9rem;">
                            👍 ${post.likesCount || 0} likes • 💬 ${post.commentsCount || 0} comments
                        </div>
                    </div>
                `;
            });
            
            if (appendMode) {
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }

        // DEPRECATED - Panel-based My Feed implementation removed

        // DEPRECATED - Panel-based feed functions removed

        // DEPRECATED - Panel scroll handler removed

        // Variables for infinite scroll functionality
        let isLoadingMorePosts = false;
        let hasMorePosts = true;
        let currentFeedOffset = 0; // Track total posts loaded

        // Load more posts for infinite scroll (corrected implementation for main content area)
        async function loadMoreMyFeedPosts() {
            if (isLoadingMorePosts || !hasMorePosts) return;
            
            isLoadingMorePosts = true;
            const container = document.getElementById('myFeedPosts');
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'feed-loading';
            loadingDiv.innerHTML = 'Loading more posts...';
            container.appendChild(loadingDiv);

            try {
                // Use offset-based pagination
                console.log(`🔄 Loading more My Feed posts... (offset: ${currentFeedOffset})`);
                const response = await window.apiCall(`/feed/?limit=15&offset=${currentFeedOffset}`, {
                    method: 'GET'
                });

                console.log('📦 Load more response:', response);
                
                // Handle different response formats (same as main load)
                let posts = null;
                if (response && response.posts) {
                    posts = response.posts;
                } else if (response && response.data && response.data.posts) {
                    posts = response.data.posts;
                } else if (response && response.ok && response.data && response.data.posts) {
                    posts = response.data.posts;
                }
                
                // Remove loading indicator
                container.removeChild(loadingDiv);

                if (!posts || posts.length === 0) {
                    hasMorePosts = false;
                    const endDiv = document.createElement('div');
                    endDiv.className = 'feed-end-indicator';
                    endDiv.style.cssText = 'text-align: center; padding: 1rem; color: #666; font-style: italic;';
                    endDiv.innerHTML = "You're all caught up! 🎉";
                    container.appendChild(endDiv);
                    return;
                }

                // Append new posts to existing feed (pagination now supported)
                console.log(`✅ Appending ${posts.length} more posts (total offset: ${currentFeedOffset})`);
                displayMyFeedPosts(posts, true); // true = append mode
                currentFeedOffset += posts.length; // Increment offset by number of posts loaded
                
                // Check if backend indicates more posts available
                if (response.pagination && response.pagination.hasMore === false) {
                    hasMorePosts = false;
                    console.log('📝 Backend indicates no more posts available');
                }

            } catch (error) {
                console.error('❌ Error loading more posts:', error);
                
                // Remove loading indicator
                if (container.contains(loadingDiv)) {
                    container.removeChild(loadingDiv);
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'feed-error';
                errorDiv.style.cssText = 'text-align: center; padding: 1rem;';
                errorDiv.innerHTML = `
                    <p style="color: #666; margin-bottom: 0.5rem;">Failed to refresh feed.</p>
                    <button onclick="loadMoreMyFeedPosts()" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Retry</button>
                `;
                container.appendChild(errorDiv);
            }

            isLoadingMorePosts = false;
        }

        // Scroll event listener for infinite scroll on My Feed
        function setupMyFeedInfiniteScroll() {
            const myFeedContainer = document.getElementById('myFeedPosts');
            if (myFeedContainer) {
                console.log('✅ Setting up infinite scroll for My Feed');
                myFeedContainer.addEventListener('scroll', () => {
                    // Skip if already loading
                    if (isLoadingMorePosts || !hasMorePosts) {
                        return;
                    }
                    
                    const { scrollTop, scrollHeight, clientHeight } = myFeedContainer;
                    const distanceFromBottom = scrollHeight - (scrollTop + clientHeight);
                    
                    // Only trigger at the very bottom to prevent multiple requests
                    if (distanceFromBottom <= 50) {
                        console.log('🔄 Infinite scroll triggered - loading more posts');
                        loadMoreMyFeedPosts();
                    }
                });
            } else {
                console.warn('⚠️ myFeedPosts container not found for infinite scroll setup');
            }
        }

        // New function to show My Feed - personalized feed based on who user follows
        async function showMyFeed() {
            // Use the correct main content area implementation
            showMyFeedInMain();
        }


        // Global variable to store selected media for post
        // Media upload functions are now handled by the my-feed module
        // The my-feed module exports: attachMediaToPost, handlePostMediaUpload, clearMediaAttachment
        // These are available globally via window.attachMediaToPost, etc.

        // Posting functions are now handled by the my-feed module
        // The my-feed module exports: createPostFromTextarea, createPostFromFeed
        // These are available globally via window.createPostFromTextarea, etc.

        // REMOVED: createThreadedPost function - no longer needed with automatic splitting
        // The backend now handles splitting content >500 chars into content + extendedContent
        
        // REMOVED: Old threaded post function
        /* async function createThreadedPost(content) {
            const textarea = document.getElementById('feedPostContent');
            const separator = '--- Continue ---';
            
            // Split content by separator
            const parts = content.split(separator);
            if (parts.length !== 2) {
                alert('Invalid thread structure');
                return false;
            }
            
            const mainContent = parts[0].trim();
            const continuationContent = parts[1].trim();
            
            // Validate lengths
            if (mainContent.length > 500) {
                alert('First section exceeds 500 characters. Please shorten it.');
                return false;
            }
            
            if (continuationContent.length > 5000) {
                alert('Continuation exceeds 5000 characters. Please shorten it.');
                return false;
            }
            
            if (mainContent.length === 0 || continuationContent.length === 0) {
                alert('Both sections must contain content.');
                return false;
            }

            // Get media attachment (only applies to first post)
            const mediaId = window.currentMediaId || null;

            try {
                // Create main post
                const result = await createPostPublic(mainContent, { 
                    mediaId,
                    refreshFeed: false // Don't refresh until we're done
                });

                if (!result.success) {
                    throw new Error('Failed to create main post: ' + result.error);
                }

                const postId = result.post.id;
                
                // Track this as a post with continuation
                if (!window.postsWithContinuation) window.postsWithContinuation = new Set();
                window.postsWithContinuation.add(postId);
                
                // Create continuation comment (NOT nested - parentId: null)
                const response = await window.apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        content: continuationContent,
                        parentId: null // Keep at layer 0
                    })
                });

                if (!response.ok || !response.data.comment) {
                    const errorMsg = response.data?.error || response.data?.message || 'Failed to create continuation comment';
                    throw new Error(errorMsg);
                }

                // Success - clear the textarea and reset state
                textarea.value = '';
                window.threadBreakPosition = null;
                
                // Clear media attachment
                if (window.currentMediaId) {
                    window.currentMediaId = null;
                    const mediaPreview = document.getElementById('media-preview');
                    if (mediaPreview) mediaPreview.style.display = 'none';
                }
                
                // Refresh feed to show the new post
                if (typeof showMyFeedInMain === 'function') {
                    showMyFeedInMain();
                }
                
                return true;

            } catch (error) {
                console.error('Threaded post creation error:', error);
                alert('Error creating threaded post: ' + error.message);
                return false;
            }
        } */
        
        // REMOVED: addThreadBreak function - no longer needed
        /* function addThreadBreak() {
            const textarea = document.getElementById('feedPostContent');
            if (!textarea) return;
            
            // Check if we already have a break
            if (window.threadBreakPosition !== null) {
                alert('You can only have one continuation. The continuation can be up to 5000 characters.');
                return;
            }
            
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            // Insert separator
            const separator = '\n\n--- Continue ---\n\n';
            textarea.value = textBefore + separator + textAfter;
            
            // Store break position
            window.threadBreakPosition = cursorPos;
            
            // Position cursor after separator
            const newCursorPos = cursorPos + separator.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            // Trigger character counter update
            textarea.dispatchEvent(new Event('input'));
            textarea.dispatchEvent(new Event('click'));
        } */

        // REMOVED: createPostWithContinuation function - replaced by automatic backend splitting
        /* async function createPostWithContinuation() {
            const textarea = document.getElementById('feedPostContent');
            if (!textarea) return false;

            const fullContent = textarea.value.trim();
            if (!fullContent) return false;
            
            // Split content at 500 characters, finding the last space before the limit
            let splitIndex = 500;
            if (fullContent.length > 500) {
                // Find the last space before 500 characters to avoid breaking words
                const lastSpaceIndex = fullContent.lastIndexOf(' ', 500);
                if (lastSpaceIndex > 400) { // Don't go too far back
                    splitIndex = lastSpaceIndex;
                }
            }
            
            const mainContent = fullContent.substring(0, splitIndex).trim();
            const continuationContent = fullContent.substring(splitIndex).trim();
            
            // Get media attachment if any (only apply to main post)
            const mediaId = window.currentMediaId || null;
            
            try {
                // Create the main post
                const result = await createPostPublic(mainContent, { 
                    mediaId,
                    refreshFeed: false // Don't refresh yet, we need to add comment first
                });

                if (result && result.success) {
                    const postId = result.post.id;
                    
                    // Mark this post as truncated for UI display
                    if (!window.truncatedPosts) {
                        window.truncatedPosts = new Set();
                    }
                    window.truncatedPosts.add(postId);
                    
                    // Clear the form
                    textarea.value = '';
                    const charCount = document.getElementById('feedPostCharCount');
                    if (charCount) charCount.textContent = '0/500';
                    
                    // Hide continue button and hint
                    const continueBtn = document.getElementById('continueInCommentBtn');
                    const continueHint = document.getElementById('continueInCommentHint');
                    if (continueBtn) continueBtn.style.display = 'none';
                    if (continueHint) continueHint.style.display = 'none';
                    
                    // Clear media
                    window.currentMediaId = null;
                    const mediaPreview = document.getElementById('feedMediaPreview');
                    if (mediaPreview) mediaPreview.style.display = 'none';
                    
                    // Add the continuation as a comment
                    if (continuationContent) {
                        await addCommentToPost(postId, continuationContent);
                    }
                    
                    // Refresh feed
                    if (typeof loadMoreMyFeedPosts === 'function') {
                        showMyFeedInMain();
                    }
                    
                    return true;
                } else {
                    alert('Error creating post: ' + (result.error || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('Post continuation creation error:', error);
                alert('Error creating post with continuation');
                return false;
            }
        } */
        
        // REMOVED: addCommentToPost helper - no longer needed for continuations
        /* async function addCommentToPost(postId, content) {
            try {
                const response = await window.apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: { content }
                });
                
                if (!response.ok) {
                    console.error('Error adding continuation comment:', response.data);
                    // Don't show alert for comment error - main post was successful
                }
            } catch (error) {
                console.error('Error adding continuation comment:', error);
                // Don't show alert for comment error - main post was successful
            }
        } */

        async function loadUserProfile() {
            if (!currentUser) {
                document.getElementById('profileBody').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view your profile</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }

            try {
                console.log('Loading user profile...');
                const response = await window.apiCall('/users/profile');
                
                console.log('Profile response:', response);
                
                if (response.ok) {
                    const data = response.data;
                    displayUserProfile(data.user);
                } else {
                    const errorMsg = response.data?.error || 'Failed to load profile';
                    document.getElementById('profileBody').innerHTML = `<p style="color: #d32f2f;">Error: ${errorMsg}</p>`;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                document.getElementById('profileBody').innerHTML = '<p style="color: #d32f2f;">Network error loading profile</p>';
            }
        }






        async function uploadVerificationDocs() {
            const fileInput = document.getElementById('verificationDocs');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            // In a real implementation, you would upload these files to your server
            // For now, we'll just simulate the upload
            alert(`${files.length} document(s) selected for upload. In a real implementation, these would be uploaded to the server for review.`);
            
            // Update verification status to pending after upload
            // This would normally be handled by the server after successful upload
        }


        async function saveProfile() {
            // Validate address form first
            if (addressForm && !addressForm.validate()) {
                alert('Please fix address form errors before saving');
                return;
            }

            const profileData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                bio: document.getElementById('editBio').value,
                website: document.getElementById('editWebsite').value
            };

            // Get address data from the address form
            const addressData = addressForm ? addressForm.getData() : {};
            
            // Get political profile data
            const politicalType = document.getElementById('editPoliticalType').value;
            const politicalData = {
                streetAddress: addressData.streetAddress || '',
                city: addressData.city || '',
                state: addressData.state || '',
                zipCode: addressData.zipCode || '',
                politicalProfileType: politicalType
            };

            // Add political-specific fields based on type
            if (politicalType === 'CANDIDATE') {
                // Political party field removed - UnitedWeRise focuses on ideas over party politics
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                // Political party field removed - UnitedWeRise focuses on ideas over party politics
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.officialTitle = document.getElementById('editOfficialTitle')?.value || '';
                
                const termStart = document.getElementById('editTermStart')?.value;
                const termEnd = document.getElementById('editTermEnd')?.value;
                if (termStart) politicalData.termStart = new Date(termStart).toISOString();
                if (termEnd) politicalData.termEnd = new Date(termEnd).toISOString();
            } else if (politicalType === 'POLITICAL_ORG') {
                politicalData.office = document.getElementById('editOffice')?.value || ''; // Using office field for org type
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            }

            try {
                // Update basic profile
                const profileResponse = await window.apiCall('/users/profile', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });

                // Update political/address info
                const politicalResponse = await window.apiCall('/political/profile', {
                    method: 'PUT',
                    body: JSON.stringify(politicalData)
                });
                
                console.log('Political profile update response:', politicalResponse.status);

                if (profileResponse.ok && politicalResponse.ok) {
                    // Refresh profile display (loadUserProfile will fetch latest data)
                    loadUserProfile(); // Switch back to view mode
                    
                    // Show different messages based on political type change
                    if (politicalType !== 'CITIZEN' && (currentUser.politicalProfileType === 'CITIZEN' || currentUser.verificationStatus === 'PENDING')) {
                        alert('Profile updated successfully! Your political profile will need to be verified by our team. Please upload verification documents if you haven\'t already.');
                    } else {
                        alert('Profile updated successfully!');
                    }
                } else {
                    alert('Failed to update profile. Please try again.');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Trending-specific like and comment functions
        async function likeTrendingPost(postId) {
            if (!currentUser) {
                alert('Please log in to like posts');
                return;
            }

            try {
                const response = await window.apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Just update the like count in place, don't refresh whole panel
                    updateLikeCount(postId, data.liked);
                }
            } catch (error) {
                console.error('Failed to like trending post:', error);
            }
        }




        async function addTrendingComment(postId) {
            const content = document.getElementById(`trending-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await window.apiCall(`/posts/${postId}/comments`, {
                    method: 'POST'
                });

                if (response.ok) {
                    hideTrendingCommentBox(postId);
                    // Just update the comment count, don't refresh whole panel
                    updateCommentCount(postId);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }




        async function addComment(postId) {
            const content = document.getElementById(`comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await window.apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    hideCommentBox(postId);
                    // Reload posts to show updated comment count
                    loadUserPosts();
                    // Also refresh trending if that's open
                    if (!document.getElementById('panel-trending').classList.contains('hidden')) {
                        loadTrendingPosts();
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        // Legacy createPost() function removed - unused (no postContent element exists)
        // All posting now handled by frontend/js/posting.js unified system

        // NOTE: createPostPublic is now provided by frontend/js/posting.js
        // Removed redundant implementation to consolidate posting systems

        async function loadUserPosts() {
            if (!currentUser) return;

            try {
                const response = await window.apiCall('/posts/me');
                
                if (response.ok) {
                    // Store posts for later display when feed view is shown
                    window.userPostsCache = response.data.posts;
                } else {
                    console.error('Failed to load user posts:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }



        async function likePost(postId, event) {
            console.log('🔍 Like post debug:', {
                windowCurrentUser: window.currentUser,
                userStateModule: window.userState?.current,
                localStorageUser: localStorage.getItem('currentUser')
            });
            
            // Check both user state sources for authentication
            const user = window.currentUser || window.userState?.current;
            if (!user) {
                alert('Please log in to like posts');
                return;
            }

            // Find the like button element
            const likeElement = event ? event.target.closest('[onclick*="likePost"]') : document.querySelector(`[onclick*="likePost('${postId}'"]`);
            if (!likeElement) return;

            try {
                const response = await window.apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update the UI immediately
                    if (likeElement.tagName === 'BUTTON') {
                        // For button-style like elements (in feed)
                        const countSpan = likeElement.querySelector('span:last-child') || likeElement;
                        const currentCount = parseInt(countSpan.textContent) || 0;
                        const newCount = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
                        
                        // Update the display
                        likeElement.innerHTML = `<span>${data.liked ? '❤️' : '👍'}</span> ${newCount}`;
                    } else if (likeElement.classList.contains('post-action')) {
                        // For span-style like elements (in profile)
                        const currentCount = parseInt(likeElement.textContent.match(/\d+/)?.[0] || '0');
                        const newCount = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
                        likeElement.innerHTML = `${data.liked ? '❤️' : '👍'} ${newCount}`;
                    }
                    
                    // Add visual feedback
                    likeElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        likeElement.style.transform = '';
                    }, 200);
                }
            } catch (error) {
                console.error('Failed to like post:', error);
                alert('Failed to like post. Please try again.');
            }
        }

        async function viewComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // If comments are already visible, hide them
            if (commentsContainer && commentsContainer.style.display === 'block') {
                commentsContainer.style.display = 'none';
                return;
            }

            try {
                // Load comments
                const response = await window.apiCall(`/posts/${postId}/comments?limit=50`);
                if (!response.ok) {
                    alert('Failed to load comments');
                    return;
                }
                const data = response.data;

                showCommentsInline(postId, data.comments);
            } catch (error) {
                console.error('Failed to load comments:', error);
                alert('Network error. Please try again.');
            }
        }



        async function addInlineComment(postId) {
            const content = document.getElementById(`inline-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await window.apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    // Refresh the comments display
                    viewComments(postId);
                    
                    // Update comment counts in main feeds
                    updateCommentCount(postId);
                } else {
                    const error = response.data || {};
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }


        // Duplicate removed - using the one defined earlier

        // 🎯 OPTIMIZED: Check follow status from cached data (NO API CALLS!)
        function renderFollowButton(userId, containerElement) {
            if (!currentUser || userId === currentUser.id) return '';
            
            try {
                // Get follow status from CACHED data - instant, no API call!
                const status = getCachedRelationshipStatus(userId);
                const isFollowing = status.isFollowing;
                
                const buttonHtml = `
                    <button onclick="toggleFollow('${userId}', this)" 
                        data-user-id="${userId}"
                        data-following="${isFollowing}"
                        style="padding: 0.25rem 0.5rem; background: ${isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        ${isFollowing ? 'Following' : 'Follow'}
                    </button>
                `;
                
                return buttonHtml;
            } catch (error) {
                console.error('Error loading cached follow status:', error);
                return `
                    <button onclick="toggleFollow('${userId}', this)" 
                        data-user-id="${userId}"
                        data-following="false"
                        style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Follow
                    </button>
                `;
            }
        }


        /**
         * ENHANCED SEARCH SYSTEM
         * Comprehensive search across users, posts, officials, topics with advanced filtering
         */

        // Global search state
        let currentSearchQuery = '';
        let currentSearchResults = {
            users: [],
            posts: [],
            officials: [],
            topics: []
        };

        // Search functionality moved to SearchHandlers ES6 module






        // Search display functions moved to SearchHandlers ES6 module

        // Display all search results with category sections
        function displayAllSearchResults() {
            const resultsContainer = document.getElementById('globalSearchResults');
            const { users, posts, officials, topics } = currentSearchResults;
            
            // Separate candidates from officials
            const candidates = officials ? officials.filter(o => o.politicalProfileType === 'CANDIDATE') : [];
            const actualOfficials = officials ? officials.filter(o => o.politicalProfileType === 'ELECTED_OFFICIAL') : [];
            
            const totalResults = users.length + posts.length + candidates.length + actualOfficials.length + topics.length;
            
            if (totalResults === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">🔍</div>
                        <h3>No Results Found</h3>
                        <p>Try different keywords or adjust your filters</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="padding: 1rem; border-bottom: 1px solid #eee; background: #f9f9f9; font-weight: bold; color: #4b5c09;">
                    Found ${totalResults} results for "${currentSearchQuery}"
                </div>
            `;

            // Display each category with results
            if (users.length > 0) {
                html += renderSearchSection('👤 Users', users, renderUserResult);
            }
            if (candidates.length > 0) {
                html += renderSearchSection('🗳️ Candidates', candidates, renderCandidateResult);
            }
            if (actualOfficials.length > 0) {
                html += renderSearchSection('🏛️ Officials', actualOfficials, renderOfficialResult);
            }
            if (posts.length > 0) {
                html += renderSearchSection('📝 Posts', posts, renderPostResult);
            }
            if (topics.length > 0) {
                html += renderSearchSection('🏷️ Topics', topics, renderTopicResult);
            }

            resultsContainer.innerHTML = html;
        }

        // Display filtered results for a specific type
        function displayFilteredSearchResults(type) {
            const resultsContainer = document.getElementById('globalSearchResults');
            let results = currentSearchResults[type];
            
            // Handle separation of candidates and officials
            if (type === 'officials') {
                results = currentSearchResults.officials ? currentSearchResults.officials.filter(o => o.politicalProfileType === 'ELECTED_OFFICIAL') : [];
            } else if (type === 'candidates') {
                results = currentSearchResults.officials ? currentSearchResults.officials.filter(o => o.politicalProfileType === 'CANDIDATE') : [];
            }
            
            if (results.length === 0) {
                const typeLabels = {
                    users: '👤 Users',
                    posts: '📝 Posts', 
                    officials: '🏛️ Officials',
                    candidates: '🗳️ Candidates',
                    topics: '🏷️ Topics'
                };
                
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">🔍</div>
                        <h3>No ${typeLabels[type]} Found</h3>
                        <p>Try different keywords or remove filters</p>
                    </div>
                `;
                return;
            }

            const renderFunctions = {
                users: renderUserResult,
                posts: renderPostResult,
                officials: renderOfficialResult,
                candidates: renderCandidateResult,
                topics: renderTopicResult
            };

            let html = results.map(result => renderFunctions[type](result)).join('');
            resultsContainer.innerHTML = html;
        }

        // Helper function to render search sections
        function renderSearchSection(title, results, renderFunction) {
            return `
                <div style="background: #f5f5f5; padding: 0.5rem 1rem; font-weight: bold; color: #4b5c09; border-bottom: 1px solid #ddd;">
                    ${title} (${results.length})
                </div>
                ${results.slice(0, 5).map(result => renderFunction(result)).join('')}
                ${results.length > 5 ? `
                    <div style="padding: 0.5rem 1rem; text-align: center; color: #666; font-size: 0.9rem; border-bottom: 1px solid #eee;">
                        +${results.length - 5} more results...
                    </div>
                ` : ''}
            `;
        }

        // Render individual result types
        function renderUserResult(user) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="openUserProfile('${user.id}', '${user.username}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div class="user-avatar" style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                        <div style="color: #666; font-size: 0.9rem;">@${user.username}</div>
                        <div style="color: #666; font-size: 0.8rem;">${user.followersCount || 0} followers${user.state ? ` • ${user.state}` : ''}${user.district ? ` • District ${user.district}` : ''}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        ${user.verified ? '<span style="color: #1d9bf0; margin-right: 0.5rem;">✓</span>' : ''}
                        ${user.id !== currentUser?.id ? `
                            <button onclick="window.FollowUtils.toggleFollow('${user.id}', ${user.isFollowing || false})" 
                                style="padding: 0.25rem 0.5rem; background: ${user.isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                ${user.isFollowing ? 'Following' : 'Follow'}
                            </button>
                            <button onclick="window.FriendUtils.sendFriendRequest('${user.id}')" 
                                style="padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                Add Friend
                            </button>
                            <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                Message
                            </button>
                        ` : '<span style="color: #666; font-size: 0.8rem;">You</span>'}
                    </div>
                </div>
            `;
        }

        function renderPostResult(post) {
            const timeAgo = getTimeAgo(new Date(post.createdAt));
            return `
                <div class="search-result-item" style="padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="showPostInFeed('${post.id}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <div class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">
                            ${(post.author?.firstName?.[0] || post.author?.username?.[0] || 'U').toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                ${post.author?.firstName ? `${post.author.firstName} ${post.author.lastName || ''}` : post.author?.username || 'Unknown User'}
                                <span style="color: #666; font-weight: normal;">@${post.author?.username || 'unknown'} • ${timeAgo}</span>
                            </div>
                            <div style="color: #333; line-height: 1.4; margin-bottom: 0.5rem;">
                                ${post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content}
                            </div>
                            <div style="color: #666; font-size: 0.8rem; display: flex; gap: 1rem;">
                                <span>❤️ ${post.likesCount || 0}</span>
                                <span>💬 ${post.commentsCount || 0}</span>
                                ${post.topics ? `<span>🏷️ ${post.topics.slice(0, 2).join(', ')}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOfficialResult(official) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="${official.politicalProfileType === 'CANDIDATE' ? `openUserProfile('${official.id}', '${official.username}')` : `showOfficialDetails('${official.id}')`}" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #1976d2; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        🏛️
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${official.name || (official.firstName ? `${official.firstName} ${official.lastName || ''}` : official.username || 'Unknown')}</div>
                        <div style="color: #666; font-size: 0.9rem;">${official.office || official.officialTitle || official.title || 'Office Unknown'} ${official.politicalProfileType === 'ELECTED_OFFICIAL' ? '(Incumbent)' : ''}</div>
                        <div style="color: #666; font-size: 0.8rem;">
                            ${official.party ? `${official.party} • ` : ''}${official.state || official.district || 'Federal'}
                            ${official.chamber ? ` • ${official.chamber}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        <button onclick="viewOfficialProfile('${official.id}')" 
                            style="padding: 0.25rem 0.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            View Profile
                        </button>
                        ${official.contactInfo ? `
                            <button onclick="contactOfficial('${official.id}')" 
                                style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                Contact
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderCandidateResult(candidate) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="openUserProfile('${candidate.id}', '${candidate.username}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        🗳️
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${candidate.firstName ? `${candidate.firstName} ${candidate.lastName || ''}` : candidate.username}</div>
                        <div style="color: #666; font-size: 0.9rem;">${candidate.office || candidate.officialTitle || 'Office Unknown'} Candidate</div>
                        <div style="color: #666; font-size: 0.8rem;">
                            ${candidate.state || 'Location Unknown'}
                            ${candidate.candidateStatus ? ` • ${candidate.candidateStatus}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        <button onclick="openUserProfile('${candidate.id}', '${candidate.username}')" 
                            style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            View Profile
                        </button>
                        ${candidate.isExternallySourced ? `
                            <span style="padding: 0.25rem 0.5rem; background: #17a2b8; color: white; border-radius: 4px; font-size: 0.7rem;">
                                External
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTopicResult(topic) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="enterTopicMode('${topic.id}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #ff9800; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        🏷️
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${topic.name}</div>
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">
                            ${topic.description || 'Political discussion topic'}
                        </div>
                        <div style="color: #666; font-size: 0.8rem; display: flex; gap: 1rem;">
                            <span>📝 ${topic.postCount || 0} posts</span>
                            <span>👥 ${topic.participantCount || 0} participants</span>
                            ${topic.trending ? '<span style="color: #ff9800;">🔥 Trending</span>' : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        <button onclick="enterTopicMode('${topic.id}')" 
                            style="padding: 0.25rem 0.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            View Topic
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * SEARCH RESULT ACTION FUNCTIONS
         * Handle clicks on different types of search results
         */

        // Open user profile (enhanced version)
        async function openUserProfile(userId, username) {
            try {
                closeSearch();
                
                // Show loading state
                const mainContent = document.getElementById('mainContent');
                mainContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading @${username}'s Profile</h2>
                        <p>Loading profile and posts...</p>
                    </div>
                `;

                // Load user's profile using the MyProfile component
                if (window.Profile) {
                    await window.Profile.showUserProfile(userId);
                } else {
                    // Fallback to basic profile view
                    await openUserFeed(userId, username);
                }
                
            } catch (error) {
                console.error('Failed to open user profile:', error);
                showToast('Failed to load user profile');
            }
        }

        // Show specific post in feed
        async function showPostInFeed(postId) {
            try {
                closeSearch();
                
                // Load single post and display in My Feed
                const response = await window.apiCall(`/posts/${postId}`);
                if (response.ok && response.data) {
                    // Show the post in main content
                    showMyFeedInMain();
                    
                    // Highlight the specific post
                    setTimeout(() => {
                        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                        if (postElement) {
                            postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            postElement.style.border = '2px solid #4b5c09';
                            postElement.style.borderRadius = '8px';
                            setTimeout(() => {
                                postElement.style.border = '';
                                postElement.style.borderRadius = '';
                            }, 3000);
                        }
                    }, 1000);
                    
                    showToast('Post found in feed');
                } else {
                    showToast('Post not found or not accessible');
                }
                
            } catch (error) {
                console.error('Failed to show post:', error);
                showToast('Failed to load post');
            }
        }

        // Show official details

        // Enter topic mode (integrate with existing topic navigation)
        async function enterTopicMode(topicId) {
            try {
                closeSearch();
                
                // Use existing topic navigation system if available
                if (window.TopicNavigation && typeof window.TopicNavigation.enterTopic === 'function') {
                    await window.TopicNavigation.enterTopic(topicId);
                    showToast('Viewing topic discussions');
                } else {
                    // Fallback to basic topic view
                    showMyFeedInMain();
                    showToast('Topic mode activated - showing related posts');
                }
                
            } catch (error) {
                console.error('Failed to enter topic mode:', error);
                showToast('Failed to load topic');
            }
        }


        // Legacy function for compatibility
        async function openUserFeed(userId, username) {
            try {
                closeSearch();
                
                // Show loading state
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading @${username}'s Profile</h2>
                        <p>Loading profile and posts...</p>
                    </div>
                `;

                // Load user's profile and posts in parallel
                const [profileResponse, postsResponse] = await Promise.all([
                    window.apiCall(`/users/${userId}`),
                    window.apiCall(`/posts/user/${userId}`)
                ]);
                
                if (profileResponse.ok && postsResponse.ok) {
                    const userProfile = profileResponse.data.user;
                    const posts = postsResponse.data.posts || [];
                    
                    // Create profile header
                    let html = `
                        <div style="background: linear-gradient(135deg, #4b5c09 0%, #6b7f1a 100%); color: white; padding: 2rem; margin-bottom: 1rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">
                                        ${(userProfile.firstName?.[0] || userProfile.username[0]).toUpperCase()}
                                    </div>
                                    <div>
                                        <h1 style="margin: 0; font-size: 1.8rem;">
                                            ${userProfile.firstName ? `${userProfile.firstName} ${userProfile.lastName || ''}` : userProfile.username}
                                            ${userProfile.verified ? '<span style="color: #ffd700; margin-left: 0.5rem;">✓</span>' : ''}
                                        </h1>
                                        <p style="margin: 0.25rem 0; font-size: 1.1rem; opacity: 0.9;">@${userProfile.username}</p>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">
                                            <span><strong>${userProfile.followersCount || 0}</strong> followers</span>
                                            <span><strong>${userProfile.followingCount || 0}</strong> following</span>
                                            <span>Joined ${new Date(userProfile.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="loadTrendingPosts(); showMainFeed();" style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                    Back to Main Feed
                                </button>
                            </div>
                            
                            ${userProfile.bio ? `<div style="margin-bottom: 1rem; font-size: 1rem; line-height: 1.4;">${userProfile.bio}</div>` : ''}
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.9;">
                                ${userProfile.location ? `<span>📍 ${userProfile.location}</span>` : ''}
                                ${userProfile.website ? `<span>🔗 <a href="${userProfile.website}" target="_blank" style="color: #ffd700;">${userProfile.website}</a></span>` : ''}
                            </div>
                            
                            ${userId !== currentUser?.id ? `
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button onclick="toggleFollow('${userId}', this)" 
                                        data-user-id="${userId}"
                                        style="padding: 0.5rem 1rem; background: #fff; color: #4b5c09; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        Follow
                                    </button>
                                    <button onclick="startConversationWithUser('${userId}', '${username}')" 
                                        style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                        Message
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="border-bottom: 2px solid #4b5c09; margin-bottom: 1rem; padding-bottom: 0.5rem;">
                            <h2 style="margin: 0; color: #4b5c09; font-size: 1.3rem;">Posts (${posts.length})</h2>
                        </div>
                    `;
                    
                    if (posts.length === 0) {
                        html += `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <p style="margin: 0; font-size: 1.1rem;">This user hasn't posted anything yet.</p>
                            </div>
                        `;
                    } else {
                        // Render posts
                        posts.forEach(post => {
                            html += `
                                <div class="post-item" data-post-id="${post.id}" style="background: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                        <div style="display: flex; align-items: center;">
                                            <div class="user-avatar" style="margin-right: 0.75rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                                            <div>
                                                <div style="font-weight: bold;">
                                                    ${post.author.firstName ? `${post.author.firstName} ${post.author.lastName || ''}` : post.author.username}
                                                    ${post.author.verified ? '<span style="color: #1d9bf0; margin-left: 0.25rem;">✓</span>' : ''}
                                                </div>
                                                <div style="color: #666; font-size: 0.9rem;">@${post.author.username} • ${new Date(post.createdAt).toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                        <div style="color: #666; font-size: 0.8rem;">${new Date(post.createdAt).toLocaleTimeString()}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem; line-height: 1.5;">
                                        ${post.content}
                                    </div>
                                    
                                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post image" style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem;">` : ''}
                                    
                                    <div style="display: flex; gap: 1rem; color: #666; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 0.75rem;">
                                        <button onclick="likePost('${post.id}', event)" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>${post.isLiked ? '❤️' : '👍'}</span> <span>${post.likesCount || 0}</span>
                                        </button>
                                        <button onclick="toggleComments('${post.id}')" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>💬</span> ${post.commentsCount || 0}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    feedElement.innerHTML = html;
                } else {
                    feedElement.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h2>Error Loading Profile</h2>
                            <p style="color: #d32f2f;">Unable to load @${username}'s profile and posts</p>
                            <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Back to Main Feed
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user feed:', error);
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Network Error</h2>
                        <p style="color: #d32f2f;">Unable to load @${username}'s profile</p>
                        <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Back to Main Feed
                        </button>
                    </div>
                `;
            }
        }


        async function addFriend(userId) {
            console.log('Adding friend:', userId);
            // TODO: Implement friend request functionality
        }

        // Map zoom and location functionality variables now declared at top of DOMContentLoaded handler

        // Boundary management class
        class BoundaryManager {
            constructor(map) {
                this.map = map;
                this.layers = new Map();
                this.cache = new Map();
                this.loadLocalCache();
            }
            
            // Load cached boundary data from localStorage
            loadLocalCache() {
                try {
                    const cached = localStorage.getItem('boundaryCache');
                    if (cached) {
                        const parsedCache = JSON.parse(cached);
                        // Check if cache is less than 30 days old
                        const cacheAge = Date.now() - (parsedCache.timestamp || 0);
                        if (cacheAge < 30 * 24 * 60 * 60 * 1000) { // 30 days
                            Object.entries(parsedCache.data || {}).forEach(([key, value]) => {
                                this.cache.set(key, value);
                            });
                            console.log(`Loaded ${this.cache.size} cached boundaries from localStorage`);
                        } else {
                            localStorage.removeItem('boundaryCache');
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load boundary cache:', error);
                    localStorage.removeItem('boundaryCache');
                }
            }
            
            // Save boundary cache to localStorage
            saveLocalCache() {
                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: Object.fromEntries(this.cache)
                    };
                    localStorage.setItem('boundaryCache', JSON.stringify(cacheData));
                } catch (error) {
                    console.warn('Failed to save boundary cache:', error);
                }
            }
            
            async loadBoundary(type, identifier, state) {
                const key = `${type}-${state}-${identifier || 'state'}`;
                
                // Check cache first
                if (this.cache.has(key)) {
                    console.log(`Using cached boundary for ${key}`);
                    this.displayBoundary(key, this.cache.get(key), type);
                    return;
                }
                
                // Try multiple sources for boundary data
                const sources = [
                    // Primary source - raw GitHub content (more reliable)
                    {
                        name: 'GitHub raw',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/states/${state}/shape.geojson`;
                            }
                        }
                    },
                    // Fallback to theunitedstates.io (if SSL issue is fixed)
                    {
                        name: 'theunitedstates.io',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://theunitedstates.io/districts/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://theunitedstates.io/districts/states/${state}/shape.geojson`;
                            }
                        }
                    }
                ];
                
                for (const source of sources) {
                    try {
                        const url = source.getUrl(type, state, identifier);
                        if (!url) continue;
                        
                        console.log(`Fetching boundary data from ${source.name}: ${url}`);
                        
                        const response = await fetch(url, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (!response.ok) {
                            console.warn(`HTTP ${response.status} from ${source.name}`);
                            continue;
                        }
                        
                        const geojsonData = await response.json();
                        
                        // Cache the data in memory and localStorage
                        this.cache.set(key, geojsonData);
                        this.saveLocalCache();
                        
                        console.log(`Successfully loaded boundary from ${source.name}`);
                        
                        // Display boundary
                        this.displayBoundary(key, geojsonData, type);
                        return;
                        
                    } catch (error) {
                        console.warn(`Failed to load boundary from ${source.name}:`, error);
                        continue;
                    }
                }
                
                console.error(`Failed to load ${type} boundary from all sources for ${key}`);
            }
            
            displayBoundary(key, geojsonData, type) {
                // Remove existing layer if present
                this.removeBoundary(key);
                
                const style = type === 'district' ? {
                    color: '#ff6b35',
                    weight: 3,
                    opacity: 0.8,
                    fillColor: '#ff6b35',
                    fillOpacity: 0.1
                } : {
                    color: '#4b5c09',
                    weight: 2,
                    opacity: 0.6,
                    fillColor: '#4b5c09',
                    fillOpacity: 0.05
                };
                
                const layer = L.geoJSON(geojsonData, { style }).addTo(this.map);
                this.layers.set(key, layer);
                console.log(`${type} boundary loaded and displayed`);
            }
            
            removeBoundary(key) {
                if (this.layers.has(key)) {
                    this.map.removeLayer(this.layers.get(key));
                    this.layers.delete(key);
                }
            }
            
            clearAll() {
                this.layers.forEach(layer => this.map.removeLayer(layer));
                this.layers.clear();
            }
        }

        function setMapInstance(map) {
            mapInstance = map;
            boundaryManager = new BoundaryManager(map);
            
            // Try to get user location, with fallback
            setTimeout(() => {
                if (currentUser && currentUser.state) {
                    getCurrentUserLocation();
                } else {
                    currentLocation = { lat: 37.8283, lng: -98.5795 }; // Center of US
                }
            }, 500); // Wait for user data to load
        }

        async function getCurrentUserLocation() {
            try {
                if (currentUser && currentUser.zipCode && currentUser.state) {
                    // Use user's stored address for location
                    const address = currentUser.city ? 
                        `${currentUser.city}, ${currentUser.state} ${currentUser.zipCode}` :
                        `${currentUser.zipCode}, ${currentUser.state}`;
                    
                    const coords = await geocodeLocation(address);
                    if (coords) {
                        currentLocation = coords;
                        // Only set zoom level if we're not at national level (to avoid moving away from default)
                        if (currentZoomLevel !== 'national') {
                            await setZoomLevel(currentZoomLevel);
                        }
                        
                        // Load representative data to get district info
                        loadElectedOfficials();
                    }
                }
            } catch (error) {
                console.error('Error getting user location:', error);
                currentLocation = { lat: 37.8283, lng: -98.5795 }; // Fallback
            }
        }

        async function geocodeLocation(address) {
            try {
                // Using a free geocoding service - you might want to use your existing Geocod.io API
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        async function geocodeAndZoom() {
            const locationInput = document.getElementById('locationInput');
            const address = locationInput.value.trim();
            
            if (!address) {
                // Use current location if no address provided
                getCurrentUserLocation();
                return;
            }

            const coords = await geocodeLocation(address);
            if (coords) {
                currentLocation = coords;
                // Apply current zoom level to new location
                await setZoomLevel(currentZoomLevel);
            } else {
                alert('Location not found. Please try a different address.');
            }
        }

        async function setZoomLevel(level) {
            if (USE_MAPLIBRE && window.map && window.map.setZoomLevel) {
                // Use MapLibre zoom level method
                window.map.setZoomLevel(level);
                updateRadioButtonState(level);
                return;
            }
            
            if (!mapInstance) return;

            // Original Leaflet implementation
            // Update current zoom level and radio button state
            currentZoomLevel = level;
            updateRadioButtonState(level);

            let zoom, bounds;
            
            // Clear existing boundaries
            if (boundaryManager) {
                boundaryManager.clearAll();
            }
            
            console.log(`Setting zoom level: ${level}`);
            console.log(`Current user:`, currentUser);
            console.log(`Current user state: ${currentUser?.state}, district: ${currentUser?.district}`);
            console.log(`Current location:`, currentLocation);
            
            switch(level) {
                case 'national':
                    // Show national view - different zoom levels for expanded vs collapsed
                    const isCollapsed = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsed ? 3 : 5;
                    mapInstance.setView([37.8283, -98.5795], zoom); // Center of US
                    console.log(`Set to national view (zoom: ${zoom}, collapsed: ${isCollapsed})`);
                    // No boundaries at national level
                    break;
                    
                case 'state':
                    // Zoom to show state and surrounding areas - adjust zoom for map size
                    const isCollapsedState = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedState ? 5 : 7;
                    
                    console.log(`STATE ZOOM: Checking if currentUser.state exists:`, currentUser?.state);
                    
                    if (currentUser && currentUser.state) {
                        console.log(`Flying to state geographic center for: ${currentUser.state}`);
                        // Get state center coordinates and fly there
                        const stateCenter = await getStateCenterCoordinates(currentUser.state);
                        console.log(`State center result:`, stateCenter);
                        if (stateCenter) {
                            console.log(`Flying to state center: ${stateCenter.lat}, ${stateCenter.lng} with zoom ${zoom}`);
                            mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            console.log(`Map setView called successfully`);
                            
                            // Load state boundary
                            if (boundaryManager) {
                                console.log(`Loading state boundary for: ${currentUser.state}`);
                                boundaryManager.loadBoundary('state', null, currentUser.state);
                            }
                        } else {
                            console.log('State center not found, using US center fallback');
                            mapInstance.setView([37.8283, -98.5795], zoom);
                        }
                    } else {
                        console.log('ERROR: No user state info available - this should not happen for State zoom!');
                        console.log('Current user object:', currentUser);
                        // DO NOT fall back to US center for State zoom - that's wrong!
                        console.error('State zoom requested but no state data available');
                    }
                    break;
                    
                case 'local':
                    // Zoom to user's actual address - adjust zoom for map size
                    const isCollapsedLocal = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedLocal ? 9 : 11;
                    
                    console.log(`LOCAL ZOOM: Checking user address data - zipCode: ${currentUser?.zipCode}, city: ${currentUser?.city}, state: ${currentUser?.state}`);
                    
                    if (currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state) {
                        // Build address from user profile
                        let userAddress = '';
                        if (currentUser.streetAddress && currentUser.city) {
                            userAddress = `${currentUser.streetAddress}, ${currentUser.city}, ${currentUser.state}`;
                            if (currentUser.zipCode) userAddress += ` ${currentUser.zipCode}`;
                        } else if (currentUser.city) {
                            userAddress = `${currentUser.city}, ${currentUser.state}`;
                        } else if (currentUser.zipCode) {
                            userAddress = `${currentUser.zipCode}, ${currentUser.state}`;
                        }
                        
                        console.log(`Flying to user's address: ${userAddress}`);
                        
                        // Geocode the user's address and fly there
                        const addressCoords = await geocodeLocation(userAddress);
                        console.log(`Address geocoding result:`, addressCoords);
                        if (addressCoords) {
                            console.log(`Flying to address coordinates: ${addressCoords.lat}, ${addressCoords.lng} with zoom ${zoom}`);
                            mapInstance.setView([addressCoords.lat, addressCoords.lng], zoom);
                            console.log(`Map setView called for address successfully`);
                            
                            // Load district boundary if we have district info
                            if (boundaryManager && currentUser.district) {
                                console.log(`Loading district boundary: ${currentUser.state}-${currentUser.district}`);
                                boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                            }
                        } else {
                            console.log('Address geocoding failed, using state center fallback');
                            // Fallback to state center
                            const stateCenter = await getStateCenterCoordinates(currentUser.state);
                            if (stateCenter) {
                                mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            } else {
                                mapInstance.setView([37.8283, -98.5795], zoom);
                            }
                        }
                    } else {
                        console.log('ERROR: No user address info available - this should not happen for Local zoom!');
                        console.log('User address fields:', {
                            streetAddress: currentUser?.streetAddress,
                            city: currentUser?.city,
                            state: currentUser?.state,
                            zipCode: currentUser?.zipCode
                        });
                        // DO NOT fall back to US center for Local zoom - that's wrong!
                        console.error('Local zoom requested but no address data available');
                    }
                    break;
            }
        }
        
        // updateRadioButtonState() moved to /src/handlers/civic-handlers.js

        // Helper function to get state center coordinates
        async function getStateCenterCoordinates(stateAbbr) {
            // State center coordinates (approximate geographic centers)
            const stateCenters = {
                'AL': { lat: 32.806671, lng: -86.791130 },
                'AK': { lat: 61.370716, lng: -152.404419 },
                'AZ': { lat: 33.729759, lng: -111.431221 },
                'AR': { lat: 34.969704, lng: -92.373123 },
                'CA': { lat: 36.116203, lng: -119.681564 },
                'CO': { lat: 39.059811, lng: -105.311104 },
                'CT': { lat: 41.597782, lng: -72.755371 },
                'DE': { lat: 39.318523, lng: -75.507141 },
                'FL': { lat: 27.766279, lng: -81.686783 },
                'GA': { lat: 33.040619, lng: -83.643074 },
                'HI': { lat: 21.094318, lng: -157.498337 },
                'ID': { lat: 44.240459, lng: -114.478828 },
                'IL': { lat: 40.349457, lng: -88.986137 },
                'IN': { lat: 39.849426, lng: -86.258278 },
                'IA': { lat: 42.011539, lng: -93.210526 },
                'KS': { lat: 38.526600, lng: -96.726486 },
                'KY': { lat: 37.668140, lng: -84.670067 },
                'LA': { lat: 31.169546, lng: -91.867805 },
                'ME': { lat: 44.693947, lng: -69.381927 },
                'MD': { lat: 39.063946, lng: -76.802101 },
                'MA': { lat: 42.230171, lng: -71.530106 },
                'MI': { lat: 43.326618, lng: -84.536095 },
                'MN': { lat: 45.694454, lng: -93.900192 },
                'MS': { lat: 32.741646, lng: -89.678696 },
                'MO': { lat: 38.456085, lng: -92.288368 },
                'MT': { lat: 47.097633, lng: -110.362566 },
                'NE': { lat: 41.492537, lng: -99.901813 },
                'NV': { lat: 38.313515, lng: -117.055374 },
                'NH': { lat: 43.452492, lng: -71.563896 },
                'NJ': { lat: 40.298904, lng: -74.521011 },
                'NM': { lat: 34.840515, lng: -106.248482 },
                'NY': { lat: 42.165726, lng: -74.948051 },
                'NC': { lat: 35.630066, lng: -79.806419 },
                'ND': { lat: 47.528912, lng: -99.784012 },
                'OH': { lat: 40.388783, lng: -82.764915 },
                'OK': { lat: 35.565342, lng: -96.928917 },
                'OR': { lat: 44.572021, lng: -122.070938 },
                'PA': { lat: 40.590752, lng: -77.209755 },
                'RI': { lat: 41.680893, lng: -71.51178 },
                'SC': { lat: 33.856892, lng: -80.945007 },
                'SD': { lat: 44.299782, lng: -99.438828 },
                'TN': { lat: 35.747845, lng: -86.692345 },
                'TX': { lat: 31.054487, lng: -97.563461 },
                'UT': { lat: 40.150032, lng: -111.862434 },
                'VT': { lat: 44.045876, lng: -72.710686 },
                'VA': { lat: 37.769337, lng: -78.169968 },
                'WA': { lat: 47.400902, lng: -121.490494 },
                'WV': { lat: 38.491226, lng: -80.954570 },
                'WI': { lat: 44.268543, lng: -89.616508 },
                'WY': { lat: 42.755966, lng: -107.302490 }
            };
            
            return stateCenters[stateAbbr.toUpperCase()] || null;
        }

        // Helper function to get district center coordinates
        async function getDistrictCenterCoordinates(stateAbbr, districtNumber) {
            try {
                // Try to fetch the district boundary data to calculate center
                const url = `https://theunitedstates.io/districts/cds/2012/${stateAbbr.toUpperCase()}-${districtNumber}/shape.geojson`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const geojsonData = await response.json();
                    
                    // Calculate the center of the district from its geometry
                    const center = calculateGeometryCenter(geojsonData);
                    if (center) {
                        console.log(`District center calculated: ${center.lat}, ${center.lng}`);
                        return center;
                    }
                }
                
                console.warn(`Could not fetch district boundary for ${stateAbbr}-${districtNumber}`);
                return null;
            } catch (error) {
                console.error('Error getting district center:', error);
                return null;
            }
        }

        // Helper function to calculate the center of a GeoJSON geometry
        function calculateGeometryCenter(geojsonData) {
            try {
                if (!geojsonData.features || geojsonData.features.length === 0) {
                    return null;
                }
                
                let totalLat = 0;
                let totalLng = 0;
                let pointCount = 0;
                
                geojsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'Polygon') {
                        const coordinates = feature.geometry.coordinates[0]; // First ring (exterior)
                        coordinates.forEach(coord => {
                            totalLng += coord[0];
                            totalLat += coord[1];
                            pointCount++;
                        });
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            const coordinates = polygon[0]; // First ring of each polygon
                            coordinates.forEach(coord => {
                                totalLng += coord[0];
                                totalLat += coord[1];
                                pointCount++;
                            });
                        });
                    }
                });
                
                if (pointCount > 0) {
                    return {
                        lat: totalLat / pointCount,
                        lng: totalLng / pointCount
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error calculating geometry center:', error);
                return null;
            }
        }

        // Initialize location input with user's address if available
        function updateLocationPlaceholder() {
            setTimeout(() => {
                if (currentUser && currentUser.city && currentUser.state) {
                    const locationInput = document.getElementById('locationInput');
                    if (locationInput) {
                        locationInput.placeholder = `${currentUser.city}, ${currentUser.state}`;
                    }
                }
            }, 100);
        }

        // Call when user data is loaded
        window.addEventListener('load', () => {
            setTimeout(updateLocationPlaceholder, 1000);
        });

        // togglePasswordVisibility moved to /src/handlers/auth-handlers.js

        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            const isValid = Object.values(requirements).every(req => req);
            const hasContent = password.length > 0;
            
            // Show/hide requirements based on focus and content
            const reqContainer = document.getElementById('password-requirements');
            const statusIndicator = document.getElementById('password-status');
            
            if (hasContent && !isValid) {
                // Show detailed requirements when typing but not valid
                reqContainer.style.display = 'block';
                statusIndicator.style.display = 'none';
            } else if (isValid) {
                // Show green checkmark when valid, hide requirements
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'block';
            } else {
                // Hide both when empty
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'none';
            }

            // Update individual requirement indicators
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-uppercase', requirements.uppercase);
            updateRequirement('req-lowercase', requirements.lowercase);
            updateRequirement('req-number', requirements.number);
            updateRequirement('req-special', requirements.special);

            return isValid;
        }

        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (element) {
                if (met) {
                    element.classList.add('met');
                    element.textContent = element.textContent.replace('• ', '');
                } else {
                    element.classList.remove('met');
                    if (!element.textContent.startsWith('• ')) {
                        element.textContent = '• ' + element.textContent.replace('✓ ', '');
                    }
                }
            }
        }

        // Real-time availability checking
        let usernameCheckTimeout;
        let emailCheckTimeout;

        async function checkUsername(username) {
            if (!username || username.length < 3) {
                document.getElementById('username-status').style.display = 'none';
                document.getElementById('username-error').style.display = 'none';
                document.getElementById('username-message').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/auth/check-username`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                const data = await response.json();

                if (data.available) {
                    document.getElementById('username-status').style.display = 'block';
                    document.getElementById('username-error').style.display = 'none';
                    document.getElementById('username-message').innerHTML = '<span style="color: #27ae60;">Username is available</span>';
                    document.getElementById('username-message').style.display = 'block';
                } else {
                    document.getElementById('username-status').style.display = 'none';
                    document.getElementById('username-error').style.display = 'block';
                    document.getElementById('username-message').innerHTML = '<span style="color: #e74c3c;">Username is already taken</span>';
                    document.getElementById('username-message').style.display = 'block';
                }
            } catch (error) {
                console.log('Username check failed:', error);
                document.getElementById('username-status').style.display = 'none';
                document.getElementById('username-error').style.display = 'none';
                document.getElementById('username-message').style.display = 'none';
            }
        }

        async function checkEmail(email) {
            if (!email || !email.includes('@')) {
                document.getElementById('email-status').style.display = 'none';
                document.getElementById('email-error').style.display = 'none';
                document.getElementById('email-message').style.display = 'none';
                return;
            }

            try {
                const response = await fetch(`${API_CONFIG.BASE_URL}/auth/check-email`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });
                const data = await response.json();

                if (data.available) {
                    document.getElementById('email-status').style.display = 'block';
                    document.getElementById('email-error').style.display = 'none';
                    document.getElementById('email-message').innerHTML = '<span style="color: #27ae60;">Email is available</span>';
                    document.getElementById('email-message').style.display = 'block';
                } else {
                    document.getElementById('email-status').style.display = 'none';
                    document.getElementById('email-error').style.display = 'block';
                    document.getElementById('email-message').innerHTML = '<span style="color: #e74c3c;">Email is already registered</span>';
                    document.getElementById('email-message').style.display = 'block';
                }
            } catch (error) {
                console.log('Email check failed:', error);
                document.getElementById('email-status').style.display = 'none';
                document.getElementById('email-error').style.display = 'none';
                document.getElementById('email-message').style.display = 'none';
            }
        }

        // Add real-time validation
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('registerPassword');
            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    validatePassword(this.value);
                });
            }

            const usernameField = document.getElementById('registerUsername');
            if (usernameField) {
                usernameField.addEventListener('input', function() {
                    clearTimeout(usernameCheckTimeout);
                    usernameCheckTimeout = setTimeout(() => {
                        checkUsername(this.value);
                    }, 500); // Debounce for 500ms
                });
            }

            const emailField = document.getElementById('registerEmail');
            if (emailField) {
                emailField.addEventListener('input', function() {
                    clearTimeout(emailCheckTimeout);
                    emailCheckTimeout = setTimeout(() => {
                        checkEmail(this.value);
                    }, 500); // Debounce for 500ms
                });
            }
        });

        // Debug hCaptcha loading
        function checkHCaptchaStatus() {
            const widget = document.getElementById('hcaptcha-register');
            const hasIframe = widget && widget.querySelector('iframe');
            const widgetId = widget ? widget.getAttribute('data-hcaptcha-widget-id') : null;
            let response = null;
            
            try {
                if (window.hcaptcha && window.hcaptcha.getResponse) {
                    if (widgetId) {
                        response = window.hcaptcha.getResponse(widgetId);
                    } else {
                        response = window.hcaptcha.getResponse();
                    }
                }
            } catch (error) {
                console.log('hCaptcha getResponse error:', error.message);
            }
            
            console.log('hCaptcha status:', {
                loaded: typeof window.hcaptcha !== 'undefined',
                widgetExists: widget !== null,
                hasIframe: hasIframe !== null,
                widgetId: widgetId,
                sitekey: document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey'),
                currentResponse: response ? 'has response' : 'no response',
                responseLength: response ? response.length : 0,
                domain: window.location.hostname
            });
        }

        // Global hCaptcha callback function
        window.onHCaptchaCallback = function(token) {
            console.log('hCaptcha completed successfully!', { tokenLength: token ? token.length : 0 });
            // Store the token in a global variable for easy access
            window.hCaptchaToken = token;
        };

        // Check hCaptcha after page load (let it auto-render)
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkHCaptchaStatus();
                // No manual rendering needed - hCaptcha script auto-renders widgets with data-sitekey
                console.log('Relying on hCaptcha auto-render via data-sitekey attribute');
            }, 2000);
        });

        // ========================================
        // Background Image Functionality
        // ========================================

        async function handleBackgroundImageSelect(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Please select an image smaller than 5MB');
                return;
            }

            try {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('backgroundPreview');
                    if (preview) {
                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.textContent = '';
                    }
                };
                reader.readAsDataURL(file);

                // Upload the image
                const formData = new FormData();
                formData.append('backgroundImage', file);

                const response = await window.apiCall('/users/background-image', {
                    method: 'POST',
                    body: formData,
                    skipContentType: true
                });

                if (response.ok) {
                    console.log('✅ Background image uploaded successfully');
                    
                    // Update current user data
                    if (currentUser) {
                        currentUser.backgroundImage = response.data.backgroundImage;
                    }
                    
                    // Apply the background to current views
                    applyUserBackground(response.data.backgroundImage);
                    
                    // Show success message
                    showToast('Background image updated successfully!');
                    
                } else {
                    alert('Failed to upload background image: ' + (response.data?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Background image upload error:', error);
                alert('Failed to upload background image. Please try again.');
            }
        }

        async function removeBackgroundImage() {
            if (!confirm('Are you sure you want to remove your background image?')) {
                return;
            }

            try {
                const response = await window.apiCall('/users/background-image', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('✅ Background image removed successfully');
                    
                    // Update current user data
                    if (currentUser) {
                        currentUser.backgroundImage = null;
                    }
                    
                    // Remove background from current views
                    applyUserBackground(null);
                    
                    // Update preview
                    const preview = document.getElementById('backgroundPreview');
                    if (preview) {
                        preview.style.backgroundImage = '';
                        preview.textContent = 'No background set';
                    }
                    
                    // Show success message
                    showToast('Background image removed successfully!');
                    
                } else {
                    alert('Failed to remove background image: ' + (response.data?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Background image removal error:', error);
                alert('Failed to remove background image. Please try again.');
            }
        }

        function applyUserBackground(backgroundImageUrl) {
            // Apply to My Profile
            const myProfileElements = document.querySelectorAll('.my-profile');
            myProfileElements.forEach(element => {
                if (backgroundImageUrl) {
                    element.style.backgroundImage = `url(${backgroundImageUrl})`;
                    element.classList.add('has-background');
                } else {
                    element.style.backgroundImage = '';
                    element.classList.remove('has-background');
                }
            });

            // Apply to My Feed main content area (corrected per documentation)
            const myFeedContent = document.getElementById('myFeedPosts');
            if (myFeedContent) {
                if (backgroundImageUrl) {
                    myFeedContent.style.backgroundImage = `url(${backgroundImageUrl})`;
                    myFeedContent.classList.add('has-background');
                } else {
                    myFeedContent.style.backgroundImage = '';
                    myFeedContent.classList.remove('has-background');
                }
            }
        }

        function applyBackgroundForUser(user) {
            // Function to apply background when viewing another user's profile
            if (user && user.backgroundImage) {
                // Apply to user profile elements
                const profileElements = document.querySelectorAll('.user-profile, .profile-view');
                profileElements.forEach(element => {
                    element.style.backgroundImage = `url(${user.backgroundImage})`;
                    element.classList.add('has-background');
                });
            }
        }

        // Initialize background on app load
        function initializeUserBackground() {
            if (currentUser && currentUser.backgroundImage) {
                applyUserBackground(currentUser.backgroundImage);
            }
        }

        // Call this when user data is loaded
        window.addEventListener('userDataLoaded', initializeUserBackground);

        // ============================================================================
        // NOTIFICATION SYSTEM - Handles friend requests, likes, comments, etc.
        // ============================================================================
        

        // Simple toast notification function
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification show';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Toggle notifications dropdown
        async function toggleNotifications() {
            if (!currentUser) {
                alert('Please log in to view notifications');
                return;
            }

            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (!notificationDropdown) {
                // Create notification dropdown if it doesn't exist
                createNotificationDropdown();
            }
            
            if (notificationDropdownOpen) {
                closeNotifications();
            } else {
                await openNotifications();
            }
        }


        // Open notifications dropdown
        async function openNotifications() {
            notificationDropdownOpen = true;
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = 'block';
            dropdown.innerHTML = '<div style="padding: 1rem; text-align: center;">Loading notifications...</div>';
            
            try {
                await fetchNotifications();
                displayNotifications();
            } catch (error) {
                console.error('Error fetching notifications:', error);
                dropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: #d32f2f;">Failed to load notifications</div>';
            }
        }


        // Fetch notifications from API
        async function fetchNotifications() {
            const response = await window.apiCall('/notifications', {
                method: 'GET'
            });
            
            if (response.ok) {
                notificationsCache = response.data.notifications || [];
                updateNotificationBadge();
                return notificationsCache;
            } else {
                throw new Error('Failed to fetch notifications');
            }
        }




        // 🎯 OPTIMIZED: Batch mark all notifications as read (1 API call instead of N calls)
        async function markAllNotificationsRead() {
            try {
                const unreadNotifications = notificationsCache.filter(n => !n.read);
                if (unreadNotifications.length === 0) return;
                
                const notificationIds = unreadNotifications.map(n => n.id);
                
                // Use batch endpoint instead of individual calls
                const response = await window.apiCall('/notifications/mark-read-batch', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notificationIds })
                });
                
                if (response.ok) {
                    // Update local cache
                    notificationsCache = notificationsCache.map(n => 
                        notificationIds.includes(n.id) ? { ...n, read: true } : n
                    );
                    
                    // Update UI
                    displayNotifications();
                    updateNotificationBadge();
                    
                    showToast(`${response.data.updatedCount} notifications marked as read`);
                } else {
                    showToast('Failed to mark notifications as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showToast('Error marking notifications as read', 'error');
            }
        }

        // Handle notification click
        async function handleNotificationClick(notificationId, type) {
            // Mark as read
            try {
                await window.apiCall(`/notifications/${notificationId}/read`, {
                    method: 'PUT'
                });
                
                // Update UI
                const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.classList.remove('unread');
                    notificationItem.style.background = '';
                    notificationItem.style.fontWeight = 'normal';
                }
                
                // Update local cache
                notificationsCache = notificationsCache.map(n => 
                    n.id === notificationId ? { ...n, read: true } : n
                );
                
                // Update badge
                updateNotificationBadge();
                
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }

            // Handle different notification types
            switch (type) {
                case 'friend_request':
                    // Open friend requests view
                    showFriendRequestsPanel();
                    break;
                case 'friend_accepted':
                    // Could open their profile or friends list
                    break;
                case 'post_like':
                case 'post_comment':
                    // Could open the specific post
                    break;
                case 'admin_message':
                case 'ADMIN_MESSAGE':
                    // Open My Profile on Messages tab
                    if (window.myProfile) {
                        showProfile();
                        setTimeout(() => {
                            window.myProfile.switchTab('messages');
                        }, 100);
                    }
                    break;
                // Add more cases as needed
            }
            
            closeNotifications();
        }





        // Global functions for push-based message refresh
        window.triggerAdminRefresh = function() {
            console.log('🔄 Triggering admin refresh...');
            // Refresh admin dashboard if profiles tab is active
            if (typeof loadCandidateProfiles === 'function' && 
                document.getElementById('profilesTab')?.classList.contains('active')) {
                loadCandidateProfiles();
            }
            // Refresh notifications
            if (currentUser && typeof fetchNotifications === 'function') {
                fetchNotifications().catch(console.error);
            }
        };

        window.triggerCandidateRefresh = function(candidateId) {
            console.log('🔄 Triggering candidate refresh for:', candidateId);
            // Refresh candidate messages if they're on messages tab
            if (window.myProfile && 
                window.myProfile.currentTab === 'messages' &&
                typeof window.myProfile.loadCandidateMessages === 'function') {
                window.myProfile.loadCandidateMessages();
            }
            // Refresh notifications
            if (currentUser && typeof fetchNotifications === 'function') {
                fetchNotifications().catch(console.error);
            }
        };


        // Close notifications when clicking outside
        document.addEventListener('click', (event) => {
            if (notificationDropdownOpen) {
                const notificationSection = document.getElementById('notificationSection');
                if (notificationSection && !notificationSection.contains(event.target)) {
                    closeNotifications();
                }
            }
        });

        // ============================================================================
        // FRIEND REQUESTS PANEL - Shows pending friend requests for easy management
        // ============================================================================

        // Show friend requests panel

        /**
         * FRIEND STATUS INDICATORS SYSTEM
         * Displays friend status throughout the site: posts, profiles, user lists
         */


        // OPTIMIZED: Check friend status from cached data (NO API CALLS!)
        function getCachedRelationshipStatus(userId) {
            if (!window.userRelationships) {
                // Try to load from localStorage if not in memory
                const cached = localStorage.getItem('userRelationships');
                if (cached) {
                    window.userRelationships = JSON.parse(cached);
                } else {
                    return { isFriend: false, isFollowing: false, isFollower: false };
                }
            }

            return {
                isFriend: window.userRelationships.friends?.includes(userId) || false,
                requestSent: window.userRelationships.friendRequests?.sent?.includes(userId) || false,
                requestReceived: window.userRelationships.friendRequests?.received?.includes(userId) || false,
                isFollowing: window.userRelationships.following?.includes(userId) || false,
                isFollower: window.userRelationships.followers?.includes(userId) || false
                // TODO: Add isBlocked when blocking system is implemented
            };
        }

        // Add friend status indicators to post headers (NO API CALLS!)
        function addFriendStatusToPost(postElement, authorId) {
            if (!authorId || authorId === window.currentUser?.id) return;

            try {
                // Get status from CACHED data - instant, no API call!
                const status = getCachedRelationshipStatus(authorId);
                
                // Find the post header where we'll add the status
                const postHeader = postElement.querySelector('.post-header small');
                if (!postHeader) return;

                // Determine which status to show (priority: friend > follow > none)
                let displayStatus = null;
                if (status.isFriend) {
                    displayStatus = 'friends';
                } else if (status.requestSent) {
                    displayStatus = 'request_sent';
                } else if (status.requestReceived) {
                    displayStatus = 'request_received';
                } else if (status.isFollowing) {
                    displayStatus = 'following';
                }

                if (displayStatus) {
                    const badge = createFriendStatusBadge(authorId, displayStatus, 'small');
                    postHeader.insertAdjacentHTML('beforeend', badge);
                }
            } catch (error) {
                // Should never happen now since we're using cached data
                console.warn('Failed to add friend status to post:', error);
            }
        }

        // Enhanced post display with friend status indicators (NO API CALLS!)
        async function displayPostsWithFriendStatus(posts, containerId = 'postsFeed', appendMode = false) {
            // First display posts normally
            displayPostsFallback(posts, containerId, appendMode);
            
            // Then add friend status indicators
            const container = document.getElementById(containerId);
            if (!container) return;

            const postElements = container.querySelectorAll('.post-item');
            
            // Process all posts instantly - no API calls needed!
            const batchSize = 10;
            for (let i = 0; i < posts.length; i += batchSize) {
                const batch = posts.slice(i, i + batchSize);
                const promises = batch.map((post, index) => {
                    const postElement = postElements[i + index];
                    if (postElement && post.author) {
                        return addFriendStatusToPost(postElement, post.author.id);
                    }
                });
                
                await Promise.all(promises);
                
                // Small delay between batches to prevent API rate limiting
                if (i + batchSize < posts.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }

        // Create comprehensive user relationship display component
        async function createUserRelationshipDisplay(userId, size = 'medium', inline = false) {
            if (!userId || userId === window.currentUser?.id) return '';

            try {
                const status = await window.RelationshipUtils.getCombinedStatus(userId);
                
                const containerStyle = inline 
                    ? 'display: inline-flex; align-items: center; gap: 0.5rem;'
                    : 'display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;';

                let html = `<div class="user-relationship-display" style="${containerStyle}">`;

                // Friend status and button
                if (status.friend.isFriend) {
                    html += createFriendStatusBadge(userId, 'friends', size);
                    html += `<button onclick="window.FriendUtils.removeFriend('${userId}')" 
                                    class="btn btn-outline-danger btn-sm" style="margin-left: 0.5rem;">
                                Remove Friend
                             </button>`;
                } else if (status.friend.friendshipStatus === 'request_sent') {
                    html += createFriendStatusBadge(userId, 'request_sent', size);
                } else if (status.friend.friendshipStatus === 'request_received') {
                    html += createFriendStatusBadge(userId, 'request_received', size);
                    html += `<button onclick="window.FriendUtils.acceptFriendRequest('${userId}')" 
                                    class="btn btn-success btn-sm" style="margin-left: 0.5rem;">
                                Accept
                             </button>
                             <button onclick="window.FriendUtils.rejectFriendRequest('${userId}')" 
                                    class="btn btn-outline-secondary btn-sm">
                                Decline
                             </button>`;
                } else {
                    // No friend relationship - show add friend button
                    html += `<button onclick="window.FriendUtils.sendFriendRequest('${userId}')" 
                                    class="btn btn-outline-primary btn-sm">
                                Add Friend
                             </button>`;
                }

                // Follow status (if not friends)
                if (!status.friend.isFriend) {
                    if (status.follow.isFollowing) {
                        html += createFriendStatusBadge(userId, 'following', size);
                        html += `<button onclick="window.FollowUtils.unfollowUser('${userId}')" 
                                        class="btn btn-outline-secondary btn-sm" style="margin-left: 0.25rem;">
                                    Unfollow
                                 </button>`;
                    } else {
                        html += `<button onclick="window.FollowUtils.followUser('${userId}')" 
                                        class="btn btn-primary btn-sm" style="margin-left: 0.25rem;">
                                    Follow
                                 </button>`;
                    }
                }

                // Message button for friends
                if (status.friend.isFriend) {
                    html += `<button onclick="openMessageWith('${userId}')" 
                                    class="btn btn-outline-primary btn-sm" style="margin-left: 0.25rem;">
                                💬 Message
                             </button>`;
                }

                html += '</div>';
                return html;

            } catch (error) {
                console.warn('Failed to create user relationship display:', error);
                return '';
            }
        }

        // Add relationship display to user profiles
        async function addRelationshipDisplayToProfile(profileContainer, userId) {
            if (!profileContainer || !userId || userId === window.currentUser?.id) return;

            const relationshipHtml = await createUserRelationshipDisplay(userId, 'large', false);
            if (relationshipHtml) {
                profileContainer.insertAdjacentHTML('beforeend', relationshipHtml);
            }
        }

        // Add friend status to existing posts (NO API CALLS - uses cached data!)
        function addFriendStatusToExistingPosts(containerId, posts) {
            const container = document.getElementById(containerId);
            if (!container || !posts) return;

            const postElements = container.querySelectorAll('.post-item, [data-post-id]');
            
            // Process all posts instantly - no API calls or batching needed!
            posts.forEach((post, index) => {
                const postElement = postElements[index];
                if (postElement && post.author && post.author.id !== window.currentUser?.id) {
                    // Instantly add status from cached data
                    addFriendStatusToPost(postElement, post.author.id);
                }
            });
        }

        // Enhanced messaging system functions for friends

        function backToConversations() {
            loadConversations();
        }

        /**
         * FRIEND ACTIVITY & ONLINE STATUS SYSTEM
         * Shows when friends were last active and online indicators
         */

        // Create online status indicator
        function createOnlineStatusIndicator(lastActiveAt, size = 'small') {
            if (!lastActiveAt) return '';
            
            const now = new Date();
            const lastActive = new Date(lastActiveAt);
            const minutesAgo = Math.floor((now - lastActive) / (1000 * 60));
            
            let status, color, text;
            
            if (minutesAgo < 5) {
                status = 'online';
                color = '#4caf50';
                text = 'Online';
            } else if (minutesAgo < 30) {
                status = 'recent';
                color = '#ff9800';
                text = `${minutesAgo}m ago`;
            } else if (minutesAgo < 1440) { // Less than 24 hours
                const hoursAgo = Math.floor(minutesAgo / 60);
                status = 'away';
                color = '#666';
                text = `${hoursAgo}h ago`;
            } else {
                const daysAgo = Math.floor(minutesAgo / 1440);
                status = 'offline';
                color = '#ccc';
                text = `${daysAgo}d ago`;
            }
            
            const dotSize = size === 'small' ? '8px' : size === 'medium' ? '10px' : '12px';
            const fontSize = size === 'small' ? '0.7rem' : size === 'medium' ? '0.8rem' : '0.9rem';
            
            return `
                <span class="online-status online-status-${status}" style="display: inline-flex; align-items: center; font-size: ${fontSize}; color: ${color};">
                    <span style="width: ${dotSize}; height: ${dotSize}; background: ${color}; border-radius: 50%; margin-right: 0.25rem; display: inline-block;"></span>
                    ${text}
                </span>
            `;
        }

        // Enhanced friends list with activity status
        function displayFriendsForMessaging(friends) {
            const container = document.getElementById('friendsListContainer');
            
            if (friends.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">👥</div>
                        <h3>No Friends Yet</h3>
                        <p>Add friends to start messaging them!</p>
                        <button onclick="document.getElementById('searchInput').focus(); backToConversations();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                            Find Friends
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort friends by activity (most recent first)
            const sortedFriends = friends.sort((a, b) => {
                const userA = a.user1Id === window.currentUser?.id ? a.user2 : a.user1;
                const userB = b.user1Id === window.currentUser?.id ? b.user2 : b.user1;
                
                const lastActiveA = userA.lastActiveAt ? new Date(userA.lastActiveAt) : new Date(0);
                const lastActiveB = userB.lastActiveAt ? new Date(userB.lastActiveAt) : new Date(0);
                
                return lastActiveB - lastActiveA;
            });
            
            let html = '<div class="friends-list">';
            
            sortedFriends.forEach(friend => {
                const user = friend.user1Id === window.currentUser?.id ? friend.user2 : friend.user1;
                const onlineStatus = createOnlineStatusIndicator(user.lastActiveAt, 'small');
                
                html += `
                    <div class="friend-item" onclick="openMessageWith('${user.id}')" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">
                        <div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; margin-right: 1rem; position: relative;">
                            ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                            ${user.lastActiveAt && (new Date() - new Date(user.lastActiveAt)) < 300000 ? 
                                '<div style="position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background: #4caf50; border-radius: 50%; border: 2px solid white;"></div>' : 
                                ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">
                                ${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}
                            </div>
                            <div style="color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>@${user.username}</span>
                                ${onlineStatus}
                            </div>
                        </div>
                        <div style="color: #4b5c09; font-size: 1.2rem;">💬</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }


        // Update user activity (call this when user is active)
        async function updateUserActivity() {
            if (!window.currentUser) return;
            
            try {
                await window.window.apiCall('/users/activity', {
                    method: 'POST',
                    body: JSON.stringify({ timestamp: new Date().toISOString() })
                });
            } catch (error) {
                // Silently fail - activity tracking is not critical
                console.debug('Failed to update user activity:', error);
            }
        }

        // Auto-update activity every 2 minutes when user is active
        let activityTimer = null;
        
        function startActivityTracking() {
            if (activityTimer) clearInterval(activityTimer);
            
            // Update immediately
            updateUserActivity();
            
            // Then update every 2 minutes
            activityTimer = setInterval(updateUserActivity, 120000);
            
            // Track user interactions
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, () => {
                    // Throttle to once per minute max
                    if (!window.lastActivityUpdate || (Date.now() - window.lastActivityUpdate) > 60000) {
                        window.lastActivityUpdate = Date.now();
                        updateUserActivity();
                    }
                }, { passive: true });
            });
        }

        // Integrated messaging system for friends
        async function openMessageWith(userId) {
            try {
                console.log('Opening message with friend:', userId);
                
                // Get user info first to have their username
                const userResponse = await window.window.apiCall(`/users/profile/${userId}`);
                if (!userResponse || !userResponse.username) {
                    showToast('Failed to load user information');
                    return;
                }
                
                const username = userResponse.username;
                
                // Check if they're actually friends first
                const friendStatus = await window.FriendUtils.getFriendStatus(userId);
                if (!friendStatus.isFriend) {
                    showToast('You can only message friends. Send a friend request first!');
                    return;
                }
                
                // Open the messages container if not already open
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer.style.display === 'none' || !messagesContainer.style.display) {
                    messagesContainer.style.display = 'block';
                }
                
                // Start conversation with the friend
                await startConversationWithUser(userId, username);
                
                console.log(`✅ Opened conversation with friend: ${username}`);
                
            } catch (error) {
                console.error('Failed to open message with friend:', error);
                showToast('Failed to open conversation');
            }
        }

        // Start activity tracking when user logs in
        window.addEventListener('load', () => {
            if (window.currentUser) {
                setTimeout(startActivityTracking, 2000);
            }
        });

        /**
         * CIVIC ORGANIZING SYSTEM
         * Petition creation, event organization, and civic engagement tools
         */

        // Core organizing functions
        // openCivicOrganizing function moved to NavigationHandlers module

        function closeCivicOrganizing() {
            document.getElementById('civicOrganizingContainer').style.display = 'none';
            showDefaultView();
        }
        
        function updateCivicOrganizingForSidebarState() {
            const sidebar = document.querySelector('#sidebar');
            const civicContainer = document.querySelector('.civic-organizing-container');
            
            if (sidebar && civicContainer) {
                const isExpanded = sidebar.classList.contains('expanded');
                civicContainer.classList.toggle('sidebar-expanded', isExpanded);
            }
        }
        
        // Setup sidebar monitoring for civic organizing
        function setupCivicOrganizingSidebarMonitoring() {
            const sidebar = document.querySelector('#sidebar');
            if (sidebar) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            updateCivicOrganizingForSidebarState();
                        }
                    });
                });
                
                observer.observe(sidebar, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }
        }

        function showDefaultOrganizingView() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🏛️</div>
                    <h3>Welcome to Civic Organizing</h3>
                    <p>Create petitions, organize events, and mobilize your community for positive change.</p>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button onclick="showPetitionCreator()" style="padding: 1rem 2rem; background: #4b5c09; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            Start a Petition
                        </button>
                        <button onclick="showEventCreator()" style="padding: 1rem 2rem; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            Organize an Event
                        </button>
                    </div>
                </div>
            `;
        }

        // Petition Creation System
        function showPetitionCreator() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div class="civic-form">
                    <h2 style="text-align: center; color: #4b5c09; margin-bottom: 2rem;">📝 Create a Petition</h2>
                    
                    <form id="petitionForm" data-civic-action="submit-petition">
                        <div class="form-group">
                            <label for="petitionType">Petition Type</label>
                            <select id="petitionType" required>
                                <option value="">Select petition type</option>
                                <option value="petition">Petition (Request Action)</option>
                                <option value="referendum">Referendum (Propose Policy)</option>
                            </select>
                            <div class="help-text">Petitions request action, referendums propose specific policy changes</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionTitle">Title</label>
                            <input type="text" id="petitionTitle" required maxlength="100" 
                                   placeholder="Clear, compelling title for your petition">
                            <div class="help-text">Keep it clear and action-oriented (max 100 characters)</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionDescription">Description</label>
                            <textarea id="petitionDescription" required maxlength="2000" 
                                      placeholder="Explain the issue, why it matters, and what action you're requesting..."></textarea>
                            <div class="help-text">Provide context and compelling reasons (max 2000 characters)</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionTarget">Target Officials/Organization</label>
                            <input type="text" id="petitionTarget" required 
                                   placeholder="e.g., Mayor Johnson, City Council, Department of Education">
                            <div class="help-text">Who has the power to act on this petition?</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionCategory">Issue Category</label>
                            <select id="petitionCategory" required>
                                <option value="">Select category</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="environment">Environment</option>
                                <option value="transportation">Transportation</option>
                                <option value="housing">Housing</option>
                                <option value="public-safety">Public Safety</option>
                                <option value="economic-development">Economic Development</option>
                                <option value="civil-rights">Civil Rights</option>
                                <option value="government-reform">Government Reform</option>
                                <option value="local-issues">Local Issues</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="petitionScope">Geographic Scope</label>
                            <select id="petitionScope" required>
                                <option value="">Select scope</option>
                                <option value="neighborhood">Neighborhood</option>
                                <option value="city">City</option>
                                <option value="county">County</option>
                                <option value="state">State</option>
                                <option value="federal">Federal</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="signatureGoal">Signature Goal</label>
                            <select id="signatureGoal" required>
                                <option value="">Select goal</option>
                                <option value="100">100 signatures</option>
                                <option value="500">500 signatures</option>
                                <option value="1000">1,000 signatures</option>
                                <option value="5000">5,000 signatures</option>
                                <option value="10000">10,000 signatures</option>
                                <option value="custom">Custom amount</option>
                            </select>
                            <input type="number" id="customGoal" style="display: none; margin-top: 0.5rem;" 
                                   placeholder="Enter custom goal" min="1" max="1000000">
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="showDefaultOrganizingView()" 
                                    style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Create Petition
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Add custom goal toggle
            document.getElementById('signatureGoal').addEventListener('change', function() {
                const customInput = document.getElementById('customGoal');
                if (this.value === 'custom') {
                    customInput.style.display = 'block';
                    customInput.required = true;
                } else {
                    customInput.style.display = 'none';
                    customInput.required = false;
                }
            });
        }

        // Event Creation System
        function showEventCreator() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div class="civic-form">
                    <h2 style="text-align: center; color: #1976d2; margin-bottom: 2rem;">📅 Organize an Event</h2>
                    
                    <form id="eventForm" data-civic-action="submit-event">
                        <div class="form-group">
                            <label for="eventType">Event Type</label>
                            <select id="eventType" required>
                                <option value="">Select event type</option>
                                <optgroup label="Electoral Events">
                                    <option value="voter-registration">Voter Registration Drive</option>
                                    <option value="candidate-forum">Candidate Forum</option>
                                    <option value="election-watch">Election Watch Party</option>
                                    <option value="poll-worker-training">Poll Worker Training</option>
                                </optgroup>
                                <optgroup label="Civic Engagement">
                                    <option value="town-hall">Town Hall</option>
                                    <option value="city-council">City Council Meeting</option>
                                    <option value="public-hearing">Public Hearing</option>
                                    <option value="community-forum">Community Forum</option>
                                </optgroup>
                                <optgroup label="Organizing Activities">
                                    <option value="petition-drive">Petition Signature Drive</option>
                                    <option value="volunteer-recruitment">Volunteer Recruitment</option>
                                    <option value="issue-education">Issue Education Session</option>
                                    <option value="community-service">Community Service</option>
                                </optgroup>
                                <optgroup label="Educational Events">
                                    <option value="civics-workshop">Civics Workshop</option>
                                    <option value="candidate-meetgreet">Candidate Meet & Greet</option>
                                    <option value="ballot-education">Ballot Measure Education</option>
                                    <option value="other">Other</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventTitle">Event Title</label>
                            <input type="text" id="eventTitle" required maxlength="100" 
                                   placeholder="Clear, descriptive title for your event">
                        </div>

                        <div class="form-group">
                            <label for="eventDescription">Description</label>
                            <textarea id="eventDescription" required maxlength="1500" 
                                      placeholder="Describe the event, agenda, speakers, and what attendees can expect..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate" required min="${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div class="form-group">
                            <label for="eventTime">Time</label>
                            <input type="time" id="eventTime" required>
                        </div>

                        <div class="form-group">
                            <label for="eventDuration">Duration (hours)</label>
                            <select id="eventDuration" required>
                                <option value="">Select duration</option>
                                <option value="0.5">30 minutes</option>
                                <option value="1">1 hour</option>
                                <option value="1.5">1.5 hours</option>
                                <option value="2">2 hours</option>
                                <option value="3">3 hours</option>
                                <option value="4">4 hours</option>
                                <option value="8">All day</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventLocation">Location</label>
                            <input type="text" id="eventLocation" required 
                                   placeholder="Address, venue name, or 'Online/Virtual'">
                            <div class="help-text">Include full address for in-person events</div>
                        </div>

                        <div class="form-group">
                            <label for="eventCapacity">Expected Attendance</label>
                            <select id="eventCapacity" required>
                                <option value="">Select expected size</option>
                                <option value="10">Small (5-15 people)</option>
                                <option value="25">Medium (15-50 people)</option>
                                <option value="75">Large (50-100 people)</option>
                                <option value="200">Very Large (100+ people)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventCategory">Issue Focus</label>
                            <select id="eventCategory" required>
                                <option value="">Select primary focus</option>
                                <option value="general-civic">General Civic Engagement</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="environment">Environment</option>
                                <option value="transportation">Transportation</option>
                                <option value="housing">Housing</option>
                                <option value="public-safety">Public Safety</option>
                                <option value="economic-development">Economic Development</option>
                                <option value="civil-rights">Civil Rights</option>
                                <option value="election-process">Election Process</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="showDefaultOrganizingView()" 
                                    style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Create Event
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // Petition and Event Submission Functions
        async function submitPetition(event) {
            event.preventDefault();
            
            // Map frontend values to backend enum values
            const categoryMap = {
                'healthcare': 'HEALTHCARE',
                'education': 'EDUCATION',
                'environment': 'ENVIRONMENT',
                'transportation': 'TRANSPORTATION',
                'housing': 'HOUSING',
                'public-safety': 'PUBLIC_SAFETY',
                'economic-development': 'ECONOMY',
                'civil-rights': 'CIVIL_RIGHTS',
                'government-reform': 'GOVERNMENT_REFORM',
                'local-issues': 'OTHER',
                'other': 'OTHER'
            };

            const scopeMap = {
                'neighborhood': 'LOCAL',
                'city': 'LOCAL',
                'county': 'COUNTY',
                'state': 'STATE',
                'federal': 'NATIONAL'
            };

            const targetOfficials = document.getElementById('petitionTarget').value
                .split(',')
                .map(official => official.trim())
                .filter(official => official.length > 0);

            const signatureGoal = document.getElementById('signatureGoal').value === 'custom' 
                ? parseInt(document.getElementById('customGoal').value)
                : parseInt(document.getElementById('signatureGoal').value);

            const formData = {
                title: document.getElementById('petitionTitle').value,
                description: document.getElementById('petitionDescription').value,
                petitionType: document.getElementById('petitionType').value.toUpperCase(),
                category: categoryMap[document.getElementById('petitionCategory').value],
                geographicScope: scopeMap[document.getElementById('petitionScope').value],
                targetOfficials: targetOfficials,
                signatureGoal: signatureGoal
            };

            try {
                const response = await window.apiCall('/civic/petitions', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.ok && response.data.success) {
                    showToast('Petition created successfully!');
                    showMyOrganizing(); // Show user's organizing activities
                } else {
                    const errorMsg = response.data?.error || 'Failed to create petition. Please try again.';
                    showToast(errorMsg);
                }
            } catch (error) {
                console.error('Error creating petition:', error);
                showToast('Network error. Please check your connection.');
            }
        }

        async function submitEvent(event) {
            event.preventDefault();
            
            // Map frontend values to backend enum values
            const eventTypeMap = {
                'voter-registration': 'VOTER_REGISTRATION',
                'candidate-forum': 'CANDIDATE_FORUM',
                'election-watch': 'COMMUNITY_MEETING',
                'poll-worker-training': 'WORKSHOP',
                'town-hall': 'TOWN_HALL',
                'city-council': 'COMMUNITY_MEETING',
                'public-hearing': 'COMMUNITY_MEETING',
                'community-forum': 'ISSUE_FORUM',
                'petition-drive': 'PETITION_DRIVE',
                'volunteer-recruitment': 'VOLUNTEER_DRIVE',
                'issue-education': 'EDUCATIONAL_SEMINAR',
                'community-service': 'OTHER',
                'civics-workshop': 'WORKSHOP',
                'candidate-meetgreet': 'COMMUNITY_MEETING',
                'ballot-education': 'EDUCATIONAL_SEMINAR',
                'other': 'OTHER'
            };

            const categoryMap = {
                'general-civic': 'CIVIC_ENGAGEMENT',
                'healthcare': 'ADVOCACY',
                'education': 'ADVOCACY',
                'environment': 'ADVOCACY',
                'transportation': 'ADVOCACY',
                'housing': 'ADVOCACY',
                'public-safety': 'ADVOCACY',
                'economic-development': 'ADVOCACY',
                'civil-rights': 'ADVOCACY',
                'election-process': 'ELECTORAL'
            };

            // Combine date and time
            const dateStr = document.getElementById('eventDate').value;
            const timeStr = document.getElementById('eventTime').value;
            const scheduledDate = new Date(`${dateStr}T${timeStr}`);

            // Calculate end date based on duration
            const duration = parseFloat(document.getElementById('eventDuration').value);
            const endDate = new Date(scheduledDate.getTime() + duration * 60 * 60 * 1000);

            const capacity = parseInt(document.getElementById('eventCapacity').value);

            const formData = {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                eventType: eventTypeMap[document.getElementById('eventType').value],
                category: categoryMap[document.getElementById('eventCategory').value] || 'CIVIC_ENGAGEMENT',
                scheduledDate: scheduledDate.toISOString(),
                endDate: endDate.toISOString(),
                location: {
                    address: document.getElementById('eventLocation').value,
                    city: currentUser?.city || 'Unknown',
                    state: currentUser?.state || 'Unknown'
                },
                capacity: capacity > 0 ? capacity : null,
                organizerInfo: {
                    name: currentUser?.firstName ? `${currentUser.firstName} ${currentUser.lastName || ''}`.trim() : currentUser?.username || 'Anonymous',
                    contact: currentUser?.email || 'Contact via platform',
                    organization: 'United We Rise Community'
                },
                rsvpRequired: false
            };

            try {
                const response = await window.apiCall('/civic/events', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.ok && response.data.success) {
                    showToast('Event created successfully!');
                    showMyOrganizing(); // Show user's organizing activities
                } else {
                    const errorMsg = response.data?.error || 'Failed to create event. Please try again.';
                    showToast(errorMsg);
                }
            } catch (error) {
                console.error('Error creating event:', error);
                showToast('Network error. Please check your connection.');
            }
        }

        // Civic Browser with Smart Filtering
        function showCivicBrowser() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #ff9800; margin-bottom: 2rem;">🔍 Find Civic Events & Petitions</h2>
                    
                    <!-- Smart Filters -->
                    <div class="event-filters">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">📍 Location</label>
                                <select id="locationFilter" data-action="update-civic-results">
                                    <option value="nearby">Near Me (25 miles)</option>
                                    <option value="city">My City</option>
                                    <option value="county">My County</option>
                                    <option value="state">My State</option>
                                    <option value="national">National</option>
                                    <option value="custom">Custom Location</option>
                                </select>
                            </div>
                            
                            <div id="customLocationDiv" style="display: none;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">Enter Location</label>
                                <input type="text" id="customLocation" placeholder="City, State or ZIP">
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">📅 When</label>
                                <select id="timeFilter" data-action="update-civic-results">
                                    <option value="upcoming">Upcoming</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="active">Active Petitions</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">🎯 Type</label>
                                <select id="typeFilter" data-action="update-civic-results">
                                    <option value="all">All Types</option>
                                    <option value="events">Events Only</option>
                                    <option value="petitions">Petitions Only</option>
                                    <option value="voter-registration">Voter Registration</option>
                                    <option value="town-halls">Town Halls</option>
                                    <option value="forums">Forums & Meetings</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">📋 Issue</label>
                                <select id="issueFilter" data-action="update-civic-results">
                                    <option value="">All Issues</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="education">Education</option>
                                    <option value="environment">Environment</option>
                                    <option value="transportation">Transportation</option>
                                    <option value="housing">Housing</option>
                                    <option value="public-safety">Public Safety</option>
                                    <option value="economic-development">Economic Development</option>
                                    <option value="civil-rights">Civil Rights</option>
                                    <option value="election-process">Elections</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Area -->
                    <div id="civicResults">
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <div style="margin-bottom: 1rem;">🔍 Loading civic activities in your area...</div>
                        </div>
                    </div>
                </div>
            `;

            // Add custom location toggle
            document.getElementById('locationFilter').addEventListener('change', function() {
                const customDiv = document.getElementById('customLocationDiv');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                }
                updateCivicResults();
            });

            // Load initial results
            updateCivicResults();
        }

        // Update civic results based on filters
        async function updateCivicResults() {
            const resultsDiv = document.getElementById('civicResults');
            if (!resultsDiv) return;

            resultsDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <div style="margin-bottom: 1rem;">🔍 Searching...</div>
                </div>
            `;

            try {
                // Get filter values
                const filters = {
                    location: document.getElementById('locationFilter')?.value || 'nearby',
                    time: document.getElementById('timeFilter')?.value || 'upcoming',
                    type: document.getElementById('typeFilter')?.value || 'all',
                    issue: document.getElementById('issueFilter')?.value || ''
                };

                // Build API query
                const params = new URLSearchParams(filters);
                const response = await window.apiCall(`/civic/browse?${params.toString()}`);

                if (response.ok && response.data) {
                    displayCivicResults(response.data);
                } else {
                    // Show mock data for now since backend isn't implemented yet
                    displayMockCivicResults(filters);
                }
            } catch (error) {
                console.error('Error loading civic results:', error);
                displayMockCivicResults();
            }
        }

        // Display mock civic results (until backend is implemented)
        function displayMockCivicResults(filters = {}) {
            const resultsDiv = document.getElementById('civicResults');
            if (!resultsDiv) return;

            const mockEvents = [
                {
                    type: 'event',
                    eventType: 'town-hall',
                    title: 'Community Town Hall: Healthcare Access',
                    description: 'Join us for a community discussion about improving healthcare access in our district.',
                    date: '2025-08-20',
                    time: '19:00',
                    location: 'City Hall, 123 Main St',
                    organizer: 'Citizens for Healthcare',
                    attendees: 34,
                    category: 'healthcare'
                },
                {
                    type: 'petition',
                    title: 'Improve Public Transportation Funding',
                    description: 'We petition the city council to increase funding for public transportation to reduce traffic and pollution.',
                    signatures: 847,
                    goal: 1000,
                    target: 'City Council',
                    organizer: 'Green Transit Alliance',
                    category: 'transportation',
                    daysLeft: 12
                },
                {
                    type: 'event',
                    eventType: 'voter-registration',
                    title: 'Voter Registration Drive',
                    description: 'Help register new voters for the upcoming election. All volunteers welcome!',
                    date: '2025-08-18',
                    time: '10:00',
                    location: 'Community Center, 456 Oak Ave',
                    organizer: 'Democracy First',
                    attendees: 12,
                    category: 'election-process'
                }
            ];

            let html = '';
            
            mockEvents.forEach(item => {
                if (item.type === 'event') {
                    html += `
                        <div class="event-item">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="background: #1976d2; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                            📅 ${item.eventType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </span>
                                        <span style="color: #666; font-size: 0.9rem;">${item.category}</span>
                                    </div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #333;">${item.title}</h3>
                                    <p style="margin: 0 0 1rem 0; color: #666; line-height: 1.4;">${item.description}</p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 6px;">
                                <div>
                                    <strong>📅 Date:</strong><br>
                                    ${new Date(item.date).toLocaleDateString()}
                                </div>
                                <div>
                                    <strong>⏰ Time:</strong><br>
                                    ${item.time}
                                </div>
                                <div>
                                    <strong>📍 Location:</strong><br>
                                    ${item.location}
                                </div>
                                <div>
                                    <strong>👥 Attending:</strong><br>
                                    ${item.attendees} people
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="color: #666; font-size: 0.9rem;">
                                    Organized by ${item.organizer}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="rsvpToEvent('${item.title}')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        RSVP
                                    </button>
                                    <button onclick="shareEvent('${item.title}')" style="padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'petition') {
                    const progress = (item.signatures / item.goal) * 100;
                    html += `
                        <div class="petition-item">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="background: #4b5c09; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                            📝 Petition
                                        </span>
                                        <span style="color: #666; font-size: 0.9rem;">${item.category}</span>
                                    </div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #333;">${item.title}</h3>
                                    <p style="margin: 0 0 1rem 0; color: #666; line-height: 1.4;">${item.description}</p>
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: bold;">${item.signatures.toLocaleString()} signatures</span>
                                    <span style="color: #666;">Goal: ${item.goal.toLocaleString()}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                                    ${item.daysLeft} days left • ${(100 - progress).toFixed(0)}% to goal
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="color: #666; font-size: 0.9rem;">
                                    Target: ${item.target} • By ${item.organizer}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="signPetition('${item.title}')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Sign Petition
                                    </button>
                                    <button onclick="sharePetition('${item.title}')" style="padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            if (html === '') {
                html = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">🔍</div>
                        <h3>No Results Found</h3>
                        <p>Try adjusting your filters or create your own event/petition!</p>
                        <div style="margin-top: 2rem;">
                            <button onclick="showPetitionCreator()" style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 1rem;">
                                Start a Petition
                            </button>
                            <button onclick="showEventCreator()" style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Organize an Event
                            </button>
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        // Show user's organizing activities
        function showMyOrganizing() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #666; margin-bottom: 2rem;">📊 My Organizing Activities</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <!-- My Petitions -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #4b5c09; margin-bottom: 1rem;">📝 My Petitions</h3>
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">📝</div>
                                <p>You haven't created any petitions yet.</p>
                                <button onclick="showPetitionCreator()" style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                    Create Your First Petition
                                </button>
                            </div>
                        </div>
                        
                        <!-- My Events -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #1976d2; margin-bottom: 1rem;">📅 My Events</h3>
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">📅</div>
                                <p>You haven't organized any events yet.</p>
                                <button onclick="showEventCreator()" style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                    Organize Your First Event
                                </button>
                            </div>
                        </div>
                        
                        <!-- My Participation -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #ff9800; margin-bottom: 1rem;">🤝 My Participation</h3>
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">🤝</div>
                                <p>Events you've RSVP'd to and petitions you've signed will appear here.</p>
                                <button onclick="showCivicBrowser()" style="padding: 0.75rem 1.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                    Find Events & Petitions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Action functions (placeholders for now)
        function rsvpToEvent(eventTitle) {
            showToast(`RSVP'd to: ${eventTitle}`);
        }

        function shareEvent(eventTitle) {
            if (navigator.share) {
                navigator.share({
                    title: eventTitle,
                    text: `Join me at: ${eventTitle}`,
                    url: window.location.href
                });
            } else {
                showToast('Event sharing feature coming soon!');
            }
        }

        function signPetition(petitionTitle) {
            showToast(`Signed petition: ${petitionTitle}`);
        }

        function sharePetition(petitionTitle) {
            if (navigator.share) {
                navigator.share({
                    title: petitionTitle,
                    text: `Please sign this petition: ${petitionTitle}`,
                    url: window.location.href
                });
            } else {
                showToast('Petition sharing feature coming soon!');
            }
        }

    </script>
    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="#" class="mobile-nav-item mobile-nav-feed active" data-action="mobile-feed">
            <div class="mobile-nav-icon">🏠</div>
            <div>Feed</div>
        </a>
        <a href="#" class="mobile-nav-item" data-action="mobile-search">
            <div class="mobile-nav-icon">🔍</div>
            <div>Search</div>
        </a>
        <a href="#" class="mobile-nav-item" data-action="mobile-map">
            <div class="mobile-nav-icon">🗺️</div>
            <div>Map</div>
        </a>
        <a href="#" class="mobile-nav-item mobile-nav-profile" data-action="mobile-profile"">
            <div class="mobile-nav-icon">👤</div>
            <div>Profile</div>
        </a>
        <a href="#" class="mobile-nav-item mobile-nav-messages" onclick="showMobileMessages()">
            <div class="mobile-nav-icon">💬</div>
            <div>Messages</div>
        </a>
    </nav>

    <!-- Mobile Map Close Button -->
    <button class="mobile-map-close" onclick="hideMobileMap()">✕ Close Map</button>

    <!-- Civic Organizing System -->
    <div class="civic-organizing-container" id="civicOrganizingContainer" style="display: none;">
        <div class="organizing-header">
            <h3 style="margin: 0; color: #4b5c09;">📋 Civic Organizing</h3>
            <button onclick="closeCivicOrganizing()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
        </div>
        
        <!-- Organizing Navigation -->
        <div class="organizing-nav" style="padding: 1rem; border-bottom: 1px solid #eee; background: #f9f9f9;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <button onclick="showPetitionCreator()" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    📝 Create Petition
                </button>
                <button onclick="showEventCreator()" style="padding: 0.5rem 1rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    📅 Organize Event
                </button>
                <button onclick="showCivicBrowser()" style="padding: 0.5rem 1rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    🔍 Find Events
                </button>
                <button onclick="showMyOrganizing()" style="padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    📊 My Activities
                </button>
            </div>
        </div>
        
        <div class="organizing-content" id="organizingContent">
            <div style="text-align: center; color: #666; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🏛️</div>
                <h3>Welcome to Civic Organizing</h3>
                <p>Create petitions, organize events, and mobilize your community for positive change.</p>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                    <button onclick="showPetitionCreator()" style="padding: 1rem 2rem; background: #4b5c09; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Start a Petition
                    </button>
                    <button onclick="showEventCreator()" style="padding: 1rem 2rem; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Organize an Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Authentication System -->
    <script src="js/unifiedAuth.js"></script>
    
    <!-- MODULAR JAVASCRIPT SYSTEM -->
    <!-- ES6 modules for modern architecture - replaces inline JavaScript -->
    <script type="module">
        import { initializeModules, testModularFunctionality } from './src/modules/module-loader.js';
        
        console.log('🚀 Loading modular JavaScript system...');
        
        // Hide page loading overlay and initialize modules when DOM is ready
        function hidePageLoadingOverlay() {
            const overlay = document.getElementById('page-loading-overlay');
            if (overlay) {
                overlay.classList.add('hidden');
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                initializeModules();

                // Hide page loading spinner after modules are loaded
                setTimeout(() => {
                    hidePageLoadingOverlay();
                }, 1000);

                // Run diagnostics in development
                if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
                    setTimeout(testModularFunctionality, 2000);
                }
            });
        } else {
            initializeModules();

            setTimeout(() => {
                hidePageLoadingOverlay();
            }, 1000);

            if (window.location.hostname === 'localhost' || window.location.hostname.includes('dev')) {
                setTimeout(testModularFunctionality, 2000);
            }
        }
    </script>
</body>
</html>