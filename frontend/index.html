<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="build-time" content="2025-08-14T01:04:43.173Z">
    <meta name="version" content="1.0.0">
    <meta name="last-updated" content="2025-08-14T01:04:43.173Z">
    <title>United We Rise - Demo</title>
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" />
    
    <!-- Application CSS -->
    <link rel="stylesheet" href="src/styles/main.css">
    <link rel="stylesheet" href="src/styles/search.css">
    <link rel="stylesheet" href="src/styles/map.css">
    <link rel="stylesheet" href="src/styles/modals.css">
    <link rel="stylesheet" href="src/styles/messaging.css">
    <link rel="stylesheet" href="src/styles/posts.css">
    <link rel="stylesheet" href="src/styles/candidate-system.css">
    <link rel="stylesheet" href="src/styles/elections-system.css">
    <link rel="stylesheet" href="src/styles/officials-system.css">
    <link rel="stylesheet" href="src/styles/trending-system.css">
    <link rel="stylesheet" href="src/styles/post-component.css">
    <link rel="stylesheet" href="src/styles/responsive.css">
    
    <!-- External JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    
    <!-- Application JavaScript -->
    <script src="src/js/api-manager.js"></script>
    <script src="src/js/app-initialization.js"></script>
    <script src="src/js/force-optimization.js"></script>
    
    <!-- Inline Optimization Override (Backup) -->
    <script>
    // Emergency inline optimization override
    console.log('üö® Inline optimization override loading...');
    
    // Check if main scripts loaded
    setTimeout(() => {
        if (!window.apiManager || !window.appInitializer) {
            console.log('‚ùå Main optimization scripts failed to load, using emergency override');
            
            // Create minimal API manager
            window.apiCall = async (endpoint, options = {}) => {
                const API_BASE = 'https://unitedwerise-backend.wonderfulpond-f8a8271f.eastus.azurecontainerapps.io/api';
                const url = endpoint.startsWith('http') ? endpoint : `${API_BASE}${endpoint}`;
                
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (window.authToken) {
                    headers['Authorization'] = `Bearer ${window.authToken}`;
                }
                
                console.log('üåê Emergency API Request:', endpoint);
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers,
                    body: options.body ? JSON.stringify(options.body) : undefined
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            };
            
            // initializeApp will be provided by app-initialization.js
            console.log('üîß Deferring to app-initialization.js for auth logic');
            
            console.log('‚úÖ Emergency optimization override ready');
        } else {
            console.log('‚úÖ Main optimization scripts loaded successfully');
        }
    }, 500);
    </script>
    
    <script src="src/components/AddressForm.js"></script>
    <script src="src/components/VerificationFlow.js"></script>
    <script src="src/components/ContentReporting.js"></script>
    <script src="src/components/CandidateSystem.js"></script>
    <script src="src/components/PostComponent.js"></script>
    <script src="src/components/MyProfile.js"></script>
    <script src="src/integrations/backend-integration.js"></script>
    <script src="src/integrations/candidate-system-integration.js"></script>
    <script src="src/integrations/officials-system-integration.js"></script>
    <script src="src/integrations/elections-system-integration.js"></script>
    <script src="src/integrations/trending-system-integration.js"></script>
    <script src="src/js/mobile-navigation.js"></script>
    <script src="src/js/map-maplibre.js"></script>
    <script src="src/js/google-address-autocomplete.js"></script>
    <script src="src/js/relationship-utils.js"></script>
    <script src="src/components/user-relationship-display.js"></script>
    <!-- Inline Reputation System (Critical Path) -->
    <script>
        // Essential reputation badge functions
        function getReputationBadge(score) {
            if (score >= 95) {
                return { color: 'green', text: 'Trusted', class: 'reputation-badge-green', show: true };
            } else if (score >= 50) {
                return { color: null, text: null, class: null, show: false };
            } else if (score >= 30) {
                return { color: 'yellow', text: 'Mixed', class: 'reputation-badge-yellow', show: true };
            } else {
                return { color: 'brown', text: 'Low Trust', class: 'reputation-badge-brown', show: true };
            }
        }
        
        function createReputationBadgeElement(score, options = {}) {
            const badge = getReputationBadge(score);
            if (!badge.show) return null;
            
            const element = document.createElement('span');
            element.className = `reputation-badge ${badge.class}`;
            element.textContent = badge.text;
            element.title = `Reputation: ${score}/100`;
            return element;
        }
        
        // Basic integration with posts
        function addReputationBadgeToPost(postElement, reputation) {
            if (!postElement || reputation === undefined) return;
            
            const authorElement = postElement.querySelector('.post-author-name, .post-author, .comment-author');
            if (authorElement && !authorElement.querySelector('.reputation-badge')) {
                const badgeElement = createReputationBadgeElement(reputation);
                if (badgeElement) {
                    authorElement.appendChild(badgeElement);
                }
            }
        }
        
        // Global reputation functions
        window.ReputationBadges = {
            getReputationBadge,
            createReputationBadgeElement,
            addReputationBadgeToPost: addReputationBadgeToPost,
            updateAllPostBadges: function() {
                document.querySelectorAll('[data-author-reputation]').forEach(post => {
                    const reputation = parseInt(post.getAttribute('data-author-reputation'));
                    if (reputation) {
                        addReputationBadgeToPost(post, reputation);
                    }
                });
            },
            updateProfileBadge: function(reputation) {
                const profileElement = document.querySelector('.my-profile .profile-header, .user-profile .profile-header');
                if (profileElement && !profileElement.querySelector('.reputation-badge')) {
                    const badgeElement = createReputationBadgeElement(reputation);
                    if (badgeElement) {
                        profileElement.appendChild(badgeElement);
                    }
                }
            }
        };
        
        console.log('üèÜ Reputation badge system loaded (inline)');
    </script>
    <script src="src/js/deployment-status.js"></script>
    <script src="src/js/legal-modal.js"></script>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <input class="search desktop-search" type="text" placeholder="Search Name or Location" id="searchInput" onfocus="openSearch()" oninput="performGlobalSearch(this.value)">
        </div>
        
        <div class="top-bar-center">
            <div class="logo">United We Rise</div>
        </div>
        
        <div class="top-bar-right">
            <!-- Desktop/Tablet Navigation -->
            <div class="desktop-nav">
                <givebutter-widget id="p75ZaL" class="donation-widget"></givebutter-widget>
                <a href="#" class="nav-link">About UWR</a>
                <div id="notificationSection" class="notification-section" style="display: none;">
                    <button onclick="toggleNotifications()" class="notification-btn">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                </div>
                <div id="authSection">
                    <button onclick="openAuthModal('login')" class="login-btn">Login</button>
                </div>
                <div id="userSection" class="user-info" style="display: none;">
                    <span id="userGreeting" style="display: none;"></span>
                </div>
            </div>
            
            <!-- Mobile Search Icon -->
            <button class="mobile-search-btn" onclick="toggleMobileSearch()" style="display: none;">
                <span class="search-icon">üîç</span>
            </button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authTitle">Login</h2>
                <button onclick="closeAuthModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button class="btn" onclick="handleLogin()">Login</button>
                    <div class="auth-switch">
                        <a onclick="switchToRegister()">Don't have an account? Sign up</a>
                    </div>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="registerPassword" required>
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('registerPassword')">üëÅÔ∏è</button>
                            <div class="password-status" id="password-status">‚úì</div>
                        </div>
                        <div class="password-requirements" id="password-requirements" style="display: none;">
                            <div class="requirement" id="req-length">‚Ä¢ At least 8 characters</div>
                            <div class="requirement" id="req-uppercase">‚Ä¢ One uppercase letter</div>
                            <div class="requirement" id="req-lowercase">‚Ä¢ One lowercase letter</div>
                            <div class="requirement" id="req-number">‚Ä¢ One number</div>
                            <div class="requirement" id="req-special">‚Ä¢ One special character</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="registerFirstName">First Name</label>
                        <input type="text" id="registerFirstName">
                    </div>
                    <div class="form-group">
                        <label for="registerLastName">Last Name</label>
                        <input type="text" id="registerLastName">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="termsAgreement" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="#" onclick="openLegalModal('terms'); return false;">Terms of Service</a> 
                            and <a href="#" onclick="openLegalModal('privacy'); return false;">Privacy Policy</a>
                        </label>
                    </div>
                    <div class="form-group">
                        <!-- Use production key with proper domain (test.unitedwerise.com) -->
                        <div class="h-captcha" data-sitekey="9c5af3a8-5066-446c-970e-1c18d9fe8d9e" data-callback="onHCaptchaCallback" id="hcaptcha-register"></div>
                    </div>
                    <button class="btn" onclick="handleRegister()">Sign Up</button>
                    <div class="auth-switch">
                        <a onclick="switchToLogin()">Already have an account? Login</a>
                    </div>
                </div>
                
                <div id="authMessage"></div>
            </div>
        </div>
    </div>

    <!-- Legal Documents Modal -->
    <div id="legalModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="legalTitle">Legal Documents</h2>
                <button onclick="closeLegalModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="legalContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="thumbs">
                <div class="thumb" onclick="toggleMyFeed()" title="My Feed" id="feedThumb" style="display: none;">üì∞ <span class="label">My Feed</span></div>
                <div class="thumb" onclick="toggleTrendingPanel()" title="Trending">üî• <span class="label">Trending</span></div>
                <div class="thumb" onclick="togglePanel('upcoming')" title="Upcoming Contests">üìÖ <span class="label">Upcoming</span></div>
                <div class="thumb" onclick="togglePanel('officials')" title="My Elected Officials">üèõÔ∏è <span class="label">Officials</span></div>
                <div class="thumb" onclick="window.map && window.map.showMap ? window.map.showMap() : showMapFromSidebar()" title="Show Map" id="mapThumb" style="display: none;">üó∫Ô∏è <span class="label">Map</span></div>
                <div class="thumb" onclick="toggleMessages()" title="Messages" id="messagesThumb">üí¨ <span class="label">Messages</span></div>
                <div class="thumb" onclick="toggleMyProfile()" title="My Profile" id="profileThumb" style="display: none;">üë§ <span class="label">My Profile</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="thumb logout-thumb" onclick="logout()" title="Logout" id="logoutThumb" style="display: none;">
                    üö™ <span class="label">Logout</span>
                </div>
            </div>
        </div>
        <!-- Sidebar Toggle Button (on the edge) -->
        <button id="toggleSidebar" class="sidebar-toggle-edge" title="Expand Sidebar">
            <span class="arrow-icon">‚ñ∂</span>
        </button>
        <div class="main" id="mainContent">
            <!-- Content will be dynamically inserted here -->
            <div class="welcome-content">
                <h1>Welcome to United We Rise</h1>
                <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
            </div>
        </div>
    </div>

    <div class="search-container" id="searchContainer" style="display: none;">
        <div class="search-header">
            <h3 style="margin: 0; color: #4b5c09;">Search Results</h3>
            <button onclick="closeSearch()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        <div class="search-results" id="globalSearchResults">
            <div style="text-align: center; color: #666; padding: 2rem;">
                Start typing to search for users
            </div>
        </div>
    </div>

    <div id="panel-trending" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Trending</span>
            <button onclick="closePanel('trending')">X</button>
        </div>
        <div class="panel-body">
            <div id="trendingContent">
                <details><summary>Local</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('Zoning Issue', 2)">Generic Zoning Issue</a></li>
                        <li><a href="#" onclick="openDetail('School District Issue', 2)">Generic School District Issue</a></li>
                    </ul>
                </details>
                <details><summary>State</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('State Tax Issue', 2)">Generic State Tax Issue</a></li>
                    </ul>
                </details>
                <details><summary>National</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('Immigration Issue', 2)">Generic Immigration Issue</a></li>
                        <li><a href="#" onclick="openDetail('Foreign Policy Issue', 2)">Generic Foreign Policy Issue</a></li>
                    </ul>
                </details>
            </div>
        </div>
    </div>

    <div id="panel-myfeed" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>My Feed</span>
            <button onclick="closePanel('myfeed')">X</button>
        </div>
        <div class="panel-body" style="padding: 0; overflow: hidden;">
            <div id="myFeedContent" style="height: 100%; overflow-y: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none;">
                <div style="text-align: center; padding: 2rem; color: #666;">
                    <p>Loading your personalized feed...</p>
                </div>
            </div>
        </div>
    </div>

    <div id="panel-upcoming" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Upcoming Contests</span>
            <button onclick="closePanel('upcoming')">X</button>
        </div>
        <div class="panel-body">
            <details><summary>Local</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('Mayor', 2)">Mayor</a></li>
                    <li><a href="#" onclick="openDetail('City Council', 2)">City Council</a></li>
                    <li><a href="#" onclick="openDetail('School Board', 2)">School Board</a></li>
                </ul>
            </details>
            <details><summary>State</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('Governor', 2)">Governor</a></li>
                    <li><a href="#" onclick="openDetail('State Senate', 2)">State Senate</a></li>
                </ul>
            </details>
            <details><summary>National</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('President', 2)">President</a></li>
                    <li><a href="#" onclick="openDetail('U.S. House', 2)">U.S. House</a></li>
                </ul>
            </details>
        </div>
    </div>

    <div id="panel-officials" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Find Representatives</span>
            <button onclick="closePanel('officials')">X</button>
        </div>
        <div class="panel-body">
            <div id="officialsContent">
                <p>Enter any address to find elected representatives.</p>
            </div>
        </div>
    </div>

    <div id="detail-panel" class="detail-panel hidden" data-offset="2">
        <div class="panel-header">
            <span id="detail-title">Detail</span>
            <button onclick="closeDetail()">X</button>
        </div>
        <div class="panel-body">
            <p id="detail-content">Placeholder content for selected topic.</p>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messagesContainer" class="messages-container">
        <div class="messages-header">
            <span>Messages</span>
            <button onclick="toggleMessages()" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="messages-body" id="messagesBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading conversations...</p>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div id="profilePanel" class="profile-panel">
        <div class="profile-header">
            <span>My Profile</span>
            <button onclick="toggleProfile()" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="profile-body" id="profileBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading profile...</p>
            </div>
        </div>
    </div>

    <!-- Trending Updates Panel (under collapsed map) -->
    <div id="trendingUpdates" class="trending-updates">
        <div class="trending-updates-header">
            <span>üî• Trending Now</span>
            <button class="trending-expand-btn" onclick="toggleTrendingExpansion()" id="trendingExpandBtn">More</button>
        </div>
        <div class="trending-updates-body" id="trendingUpdatesBody">
            <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">
                Loading trending topics...
            </div>
        </div>
    </div>

    <!-- Map Container (hidden initially) -->
    <div id="mapContainer" style="display: none;">
        <!-- Map Loading State (overlay) -->
        <div id="mapLoadingState" class="map-loading-state">
            <div class="map-loading-spinner"></div>
            <div class="map-loading-text">Loading Map...</div>
        </div>
        
        <div class="map-action-buttons">
            <!-- Main button row -->
            <div class="zoom-buttons-group">
                <button class="map-action-btn" onclick="toggleMapView('national')">National</button>
                <button class="map-action-btn" onclick="toggleMapView('state')">State</button>
                <button class="map-action-btn" onclick="toggleMapView('local')">Local</button>
                <button class="map-action-btn control-btn primary" id="mapToggleBtn">Collapse</button>
                <button class="map-action-btn control-btn close-btn" onclick="window.map && window.map.closeMap ? window.map.closeMap() : closeMap()">√ó</button>
            </div>
            
            <!-- Layer dropdown toggle - positioned relative to button group -->
            <div class="map-layer-dropdown">
                <button class="layer-dropdown-btn" onclick="toggleLayerDropdown()">
                    Layers ‚ñº
                </button>
                <div class="layer-dropdown-content" id="layerDropdown">
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('trending')" data-layer="trending">
                        <span class="layer-icon">üí¨</span>
                        <span>Trending</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('events')" data-layer="events">
                        <span class="layer-icon">üìÖ</span>
                        <span>Events</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('news')" data-layer="news">
                        <span class="layer-icon">üì∞</span>
                        <span>News</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('civic')" data-layer="civic">
                        <span class="layer-icon">üèõÔ∏è</span>
                        <span>Civic</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('community')" data-layer="community">
                        <span class="layer-icon">üë•</span>
                        <span>Community</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <!-- CTA Panel -->
    <div id="google-cta-panel">
        <button onclick="this.parentElement.style.display='none'">&times;</button>
        <div style="text-align: left; margin: 0 10px;">
            <p style="margin: 0 0 8px 0; color: #5A534A; line-height: 1.4;">UnitedWeRise is a nonprofit platform connecting candidates directly with voters.</p>
            <p style="margin: 0 0 8px 0; color: #5A534A; line-height: 1.4;">No party machines. No corporate money.</p>
            <p style="margin: 0 0 8px 0; color: #5A534A; line-height: 1.4;">Together, we can elect leaders who actually represent us, not the Elites.</p>
            <p style="margin: 0 0 16px 0; color: #5A534A; line-height: 1.4;">Join the movement to reclaim democracy, because UnitedWeRise!</p>
        </div>
    </div>

    <script>
        // API Configuration - Environment-based
        const API_BASE = (window.location.hostname === 'localhost' || 
                         window.location.hostname === '127.0.0.1' || 
                         window.location.protocol === 'file:')
            ? 'http://localhost:3001/api' 
            : 'https://unitedwerise-backend.wonderfulpond-f8a8271f.eastus.azurecontainerapps.io/api';
        let currentUser = null;
        let authToken = null;
        let addressForm = null;
        
        // Utility function to fix auth-related localStorage issues without clearing everything
        function fixAuthStorageIssues() {
            console.log('üîß Fixing auth storage issues...');
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            
            // Reset UI to logged out state
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('userGreeting').textContent = '';
            
            console.log('‚úÖ Auth storage cleared. Please log in again.');
            return 'Auth storage cleared. Please refresh the page and log in again.';
        }
        
        // Make function available in console for easy debugging
        window.fixAuthStorageIssues = fixAuthStorageIssues;

        // Setup collapse button handler function
        function setupCollapseButton() {
            console.log('üîß Setting up collapse button handler...');
            
            // Wait for DOM elements to be available
            setTimeout(() => {
                const mapContainer = document.getElementById('mapContainer');
                const toggleBtn = document.getElementById('mapToggleBtn');
                
                console.log('üîç mapContainer found:', !!mapContainer);
                console.log('üîç toggleBtn found:', !!toggleBtn);
                
                if (toggleBtn && mapContainer) {
                    // Remove any existing listeners
                    toggleBtn.replaceWith(toggleBtn.cloneNode(true));
                    const newToggleBtn = document.getElementById('mapToggleBtn');
                    
                    // Add click handler
                    newToggleBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        console.log('üî• COLLAPSE BUTTON CLICKED!');
                        
                        // Debug current state
                        const isCollapsed = mapContainer.classList.contains('collapsed');
                        console.log('üîç Current collapsed state:', isCollapsed);
                        console.log('üîç mapContainer classes before:', mapContainer.className);
                        console.log('üîç mapContainer computed width before:', getComputedStyle(mapContainer).width);
                        
                        // Hide bubbles before transition
                        if (window.map && window.map.hideBubbles) {
                            window.map.hideBubbles();
                        }
                        
                        // Toggle the class
                        mapContainer.classList.toggle('collapsed');
                        const newIsCollapsed = mapContainer.classList.contains('collapsed');
                        
                        // Debug after toggle
                        console.log('üîç mapContainer classes after:', mapContainer.className);
                        console.log('üîç mapContainer computed width after:', getComputedStyle(mapContainer).width);
                        
                        // Update button text
                        newToggleBtn.textContent = isCollapsed ? 'Collapse' : 'Expand';
                        
                        // Visual feedback
                        newToggleBtn.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            newToggleBtn.style.transform = '';
                        }, 150);
                        
                        console.log(`‚úÖ Map should now be ${isCollapsed ? 'expanded' : 'collapsed'}`);
                        
                        // Force a style recalculation
                        mapContainer.offsetHeight; // Trigger reflow
                        
                        // Adjust map for new container size with appropriate zoom
                        if (window.map && window.map.adjustForContainerState) {
                            window.map.adjustForContainerState(newIsCollapsed);
                        }
                        
                        // Show bubbles after transition completes
                        if (window.map && window.map.showBubbles) {
                            window.map.showBubbles();
                        }
                    }, false);
                    
                    console.log('‚úÖ Collapse button handler attached successfully');
                } else {
                    console.error('‚ùå Could not find button or container elements');
                }
            }, 2000); // Wait 2 seconds for map to fully load
        }

        // Setup close button handler function
        function setupCloseButton() {
            console.log('üîß Setting up close button handler...');
            
            setTimeout(() => {
                const closeBtn = document.querySelector('.map-action-btn.close-btn');
                console.log('üîç closeBtn found:', !!closeBtn);
                
                if (closeBtn) {
                    // Remove existing onclick and replace with proper handler
                    closeBtn.removeAttribute('onclick');
                    closeBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        console.log('üî• CLOSE BUTTON CLICKED!');
                        
                        if (window.map && window.map.closeMap) {
                            console.log('‚úÖ Calling window.map.closeMap()');
                            window.map.closeMap();
                        } else {
                            console.log('‚ö†Ô∏è Fallback: hiding map container directly');
                            const mapContainer = document.getElementById('mapContainer');
                            if (mapContainer) {
                                mapContainer.style.display = 'none';
                                localStorage.setItem('mapClosed', 'true');
                                
                                // Show sidebar button
                                const mapThumb = document.getElementById('mapThumb');
                                if (mapThumb) {
                                    mapThumb.style.display = 'block';
                                }
                            }
                        }
                    });
                    
                    console.log('‚úÖ Close button handler attached successfully');
                } else {
                    console.error('‚ùå Could not find close button element');
                }
            }, 2000);
        }

        // Setup sidebar map button handler function
        function setupSidebarMapButton() {
            console.log('üîß Setting up sidebar map button handler...');
            
            const mapThumb = document.getElementById('mapThumb');
            console.log('üîç mapThumb found:', !!mapThumb);
            
            if (mapThumb) {
                // Remove existing onclick and replace with proper handler
                mapThumb.removeAttribute('onclick');
                mapThumb.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    console.log('üî• SIDEBAR MAP BUTTON CLICKED!');
                    
                    if (window.map && window.map.showMap) {
                        console.log('‚úÖ Calling window.map.showMap()');
                        window.map.showMap();
                    } else {
                        console.log('‚ö†Ô∏è Fallback: showing map container directly');
                        const mapContainer = document.getElementById('mapContainer');
                        if (mapContainer) {
                            mapContainer.style.display = 'block';
                            localStorage.removeItem('mapClosed');
                            
                            // Hide sidebar button
                            mapThumb.style.display = 'none';
                            
                            console.log('‚úÖ Map restored via fallback method');
                        }
                    }
                });
                
                console.log('‚úÖ Sidebar map button handler attached successfully');
            } else {
                console.error('‚ùå Could not find sidebar map button element');
            }
        }

        // Map layer toggle function
        function toggleMapLayer(layerName) {
            console.log(`üîß Toggling map layer: ${layerName}`);
            
            if (window.map && typeof window.map.toggleLayer === 'function') {
                window.map.toggleLayer(layerName);
            } else {
                console.warn('Map layer toggle not available - map may not be initialized yet');
            }
        }

        // Layer dropdown toggle function
        function toggleLayerDropdown() {
            const dropdown = document.getElementById('layerDropdown');
            const btn = document.querySelector('.layer-dropdown-btn');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                btn.textContent = 'Layers ‚ñº';
            } else {
                dropdown.classList.add('show');
                btn.textContent = 'Layers ‚ñ≤';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('layerDropdown');
            const dropdownContainer = document.querySelector('.map-layer-dropdown');
            
            if (dropdown && dropdownContainer && !dropdownContainer.contains(event.target)) {
                dropdown.classList.remove('show');
                const btn = document.querySelector('.layer-dropdown-btn');
                if (btn) btn.textContent = 'Layers ‚ñº';
            }
        });

        // Map view toggle function
        function toggleMapView(jurisdiction) {
            console.log(`üîß Switching map view to: ${jurisdiction}`);
            
            // Update active button styling
            const buttons = document.querySelectorAll('.zoom-buttons-group .map-action-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase() === jurisdiction.toLowerCase()) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (window.map && typeof window.map.setJurisdiction === 'function') {
                window.map.setJurisdiction(jurisdiction);
            } else {
                console.warn('Map jurisdiction change not available - map may not be initialized yet');
            }
        }

        // Check for existing auth on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load GiveButter widget
            const givebutterScript = document.createElement("script");
            givebutterScript.src = "https://widgets.givebutter.com/latest.umd.cjs?acct=rfuBvOJ14QTerl5N&p=other";
            givebutterScript.async = true;
            document.head.appendChild(givebutterScript);

            // Use new optimized initialization system
            console.log('üöÄ Starting optimized app initialization...');
            initializeApp().then(result => {
                console.log('‚úÖ App initialization complete:', result);
            }).catch(error => {
                console.error('üí• App initialization failed:', error);
            });

            // Map initialization is now handled by map-maplibre.js to avoid conflicts
            console.log('Map initialization delegated to map-maplibre.js script');
            
            // Setup collapse button handler (runs regardless of map system)
            setupCollapseButton();
            
            // Setup close button handler 
            setupCloseButton();
            
            // Setup sidebar map button handler
            setupSidebarMapButton();

            // Show CTA panel if not dismissed
            if (!localStorage.getItem('panelClosed')) {
                document.getElementById('google-cta-panel').style.display = 'block';
            }

            // Start trending refresh interval
            startTrendingRefresh();
        });

        // Authentication Functions
        async function verifyAndSetUser() {
            try {
                console.log('Verifying token with /auth/me...');
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Auth verification response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Auth verification successful:', data.user);
                    
                    // Only set user logged in if we actually have user data
                    if (data.user && data.user.id) {
                        setUserLoggedIn(data.user);
                    } else {
                        console.warn('Invalid user data received:', data);
                        // Clear invalid session
                        localStorage.removeItem('authToken');
                        authToken = null;
                        // Ensure UI shows logged out state
                        setUserLoggedOut();
                    }
                } else {
                    // Token is invalid
                    console.log('Token invalid, removing from storage');
                    localStorage.removeItem('authToken');
                    authToken = null;
                    // Ensure UI shows logged out state
                    setUserLoggedOut();
                }
            } catch (error) {
                console.error('Auth verification failed:', error);
                localStorage.removeItem('authToken');
                authToken = null;
                // Ensure UI shows logged out state
                setUserLoggedOut();
            }
        }

        function openAuthModal(mode = 'login') {
            document.getElementById('authModal').style.display = 'block';
            if (mode === 'login') {
                switchToLogin();
            } else {
                switchToRegister();
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearAuthForm();
        }

        function switchToLogin() {
            document.getElementById('authTitle').textContent = 'Login';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearAuthForm();
        }

        function switchToRegister() {
            document.getElementById('authTitle').textContent = 'Sign Up';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearAuthForm();
        }

        function clearAuthForm() {
            document.getElementById('authMessage').innerHTML = '';
            // Clear all form inputs
            document.querySelectorAll('#authModal input').forEach(input => input.value = '');
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    setUserLoggedIn(data.user);
                    closeAuthModal();
                    showAuthMessage('Login successful!', 'success');
                } else {
                    showAuthMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage('Network error. Please try again.', 'error');
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            
            
            // Get hCaptcha response
            let hcaptchaResponse = null;
            try {
                if (window.hcaptcha) {
                    const widget = document.getElementById('hcaptcha-register');
                    const hasIframe = widget && widget.querySelector('iframe');
                    
                    console.log('hCaptcha check before registration:', {
                        widget: widget ? 'exists' : 'missing',
                        iframe: hasIframe ? 'exists' : 'missing',
                        hcaptchaLoaded: typeof window.hcaptcha !== 'undefined'
                    });
                    
                    hcaptchaResponse = window.hcaptcha.getResponse();
                    console.log('hCaptcha response length:', hcaptchaResponse ? hcaptchaResponse.length : 0);
                }
            } catch (e) {
                console.error('hCaptcha getResponse error:', e);
            }

            if (!email || !username || !password) {
                showAuthMessage('Email, username, and password are required', 'error');
                return;
            }

            // Check terms agreement checkbox
            const termsAgreement = document.getElementById('termsAgreement');
            if (!termsAgreement || !termsAgreement.checked) {
                showAuthMessage('You must agree to the Terms of Service and Privacy Policy to continue', 'error');
                return;
            }
            
            // Skip hCaptcha entirely for local development
            const isLocalDev = window.location.protocol === 'file:' || 
                             window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1';

            if (!isLocalDev && !hcaptchaResponse) {
                showAuthMessage('Please complete the captcha verification by clicking the checkbox above', 'error');
                return;
            }
            
            // Validate password
            if (!validatePassword(password)) {
                showAuthMessage('Password must meet all requirements', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email, 
                        username, 
                        password, 
                        firstName, 
                        lastName, 
                        hcaptchaToken: hcaptchaResponse || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    setUserLoggedIn(data.user);
                    closeAuthModal();
                    showAuthMessage('Registration successful!', 'success');
                } else {
                    showAuthMessage(data.error || 'Registration failed', 'error');
                    // Reset hCaptcha on error
                    if (window.hcaptcha) {
                        window.hcaptcha.reset();
                    }
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthMessage('Network error. Please try again.', 'error');
                // Reset hCaptcha on error
                if (window.hcaptcha) {
                    window.hcaptcha.reset();
                }
            }
        }

        async function refreshUserDataIfNeeded(user) {
            // If user data is missing firstName, refresh it from the backend
            if (!user.firstName && authToken) {
                console.log('User data missing firstName, refreshing...');
                try {
                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const freshUser = await response.json();
                        console.log('Refreshed user data:', freshUser);
                        
                        // Update localStorage with fresh data
                        localStorage.setItem('currentUser', JSON.stringify(freshUser));
                        
                        return freshUser;
                    }
                } catch (error) {
                    console.warn('Could not refresh user data:', error);
                }
            }
            return user;
        }

        async function setUserLoggedIn(user) {
            // Safety check - don't process if no user data
            if (!user || !user.id) {
                console.error('Invalid user data passed to setUserLoggedIn:', user);
                setUserLoggedOut();
                return;
            }
            
            // Refresh user data if needed
            const refreshedUser = await refreshUserDataIfNeeded(user);
            currentUser = refreshedUser;
            
            // Store user data in localStorage for persistence
            localStorage.setItem('currentUser', JSON.stringify(refreshedUser));
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'flex';
            
            // More robust greeting with multiple fallbacks
            const displayName = refreshedUser.firstName || refreshedUser.username || 'User';
            console.log('üîç Setting greeting - firstName:', refreshedUser.firstName, 'username:', refreshedUser.username, 'displayName:', displayName);
            const greetingElement = document.getElementById('userGreeting');
            if (greetingElement) {
                greetingElement.textContent = `Hello, ${displayName}!`;
                greetingElement.style.display = 'inline'; // Show the greeting span
                console.log('‚úÖ Greeting set to:', greetingElement.textContent, 'visible:', greetingElement.style.display);
                
                // Debug: Check if anything clears this immediately
                setTimeout(() => {
                    console.log('üîç Greeting after 100ms:', greetingElement.textContent, 'visible:', greetingElement.style.display);
                }, 100);
                setTimeout(() => {
                    console.log('üîç Greeting after 1s:', greetingElement.textContent, 'visible:', greetingElement.style.display);
                }, 1000);
            }
            
            // Address info will be loaded by loadUserContent()
            
            // Show user-specific sidebar options
            document.getElementById('messagesThumb').style.display = 'block';
            document.getElementById('profileThumb').style.display = 'block';
            document.getElementById('feedThumb').style.display = 'block';
            // Note: postComposer is now part of feed view, not a standalone element
            document.getElementById('logoutThumb').style.display = 'block';
            
            // Load user-specific content
            loadUserContent();
            loadUserPosts();
            
            // Show My Feed by default in main content area
            showMyFeedInMain();
        }
        
        function setUserLoggedOut() {
            currentUser = null;
            authToken = null;
            
            // Reset UI to logged out state
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            const greetingElement = document.getElementById('userGreeting');
            if (greetingElement) {
                greetingElement.textContent = '';
                greetingElement.style.display = 'none'; // Hide the greeting span
            }
            
            // Hide user-specific sidebar options
            document.getElementById('messagesThumb').style.display = 'none';
            document.getElementById('profileThumb').style.display = 'none';
            document.getElementById('feedThumb').style.display = 'none';
            document.getElementById('logoutThumb').style.display = 'none';
            
            // Reset main content to welcome message
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="welcome-content">
                        <h1>Welcome to United We Rise</h1>
                        <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                    </div>
                `;
            }
        }


        // Enable/disable radio buttons based on available location data
        function updateRadioButtonAvailability() {
            const stateRadio = document.querySelector('input[name="zoomLevel"][value="state"]');
            const localRadio = document.querySelector('input[name="zoomLevel"][value="local"]');
            const stateLabel = stateRadio?.parentElement;
            const localLabel = localRadio?.parentElement;
            
            // Check if user has location data
            const hasState = currentUser && currentUser.state;
            const hasAddress = currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state;
            
            // Enable/disable state radio
            if (stateRadio && stateLabel) {
                stateRadio.disabled = !hasState;
                stateLabel.style.opacity = hasState ? '1' : '0.5';
                stateLabel.style.cursor = hasState ? 'pointer' : 'not-allowed';
            }
            
            // Enable/disable local radio
            if (localRadio && localLabel) {
                localRadio.disabled = !hasAddress;
                localLabel.style.opacity = hasAddress ? '1' : '0.5';
                localLabel.style.cursor = hasAddress ? 'pointer' : 'not-allowed';
            }
            
            console.log(`Radio button availability - State: ${hasState}, Local: ${hasAddress}`);
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            
            // Use the new centralized logout function
            setUserLoggedOut();
            
            // Hide additional elements
            document.getElementById('messagesContainer').style.display = 'none';
            document.getElementById('profilePanel').style.display = 'none';
            
            // Reset panels to default content
            resetPanelsToDefault();
            
            // Reset main content
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="welcome-content">
                        <h1>Welcome to United We Rise</h1>
                        <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                    </div>
                `;
            }
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        async function loadUserContent() {
            // Load user's elected officials if they have an address
            try {
                const response = await apiCall('/users/profile');

                if (response.ok) {
                    const data = response.data;
                    
                    // UPDATE: Merge the complete profile data into currentUser
                    if (data.user) {
                        // Debug: Check what's in the profile data
                        console.log('üîç Profile data before merge:', data.user);
                        console.log('üîç currentUser before merge:', currentUser);
                        
                        // Only merge non-null values to avoid overwriting good data with undefined
                        const mergedUser = { ...currentUser };
                        for (const [key, value] of Object.entries(data.user)) {
                            if (value !== null && value !== undefined) {
                                mergedUser[key] = value;
                            }
                        }
                        currentUser = mergedUser;
                        console.log('User profile data merged into currentUser:', currentUser);
                        
                        // Re-update the greeting if it got cleared
                        const displayName = currentUser.firstName || currentUser.username || 'User';
                        const greetingElement = document.getElementById('userGreeting');
                        if (greetingElement) {
                            greetingElement.textContent = `Hello, ${displayName}!`;
                            console.log('üîß Re-set greeting after profile merge to:', greetingElement.textContent);
                        }
                        
                        // Update radio button availability now that we have address data
                        updateRadioButtonAvailability();
                        
                        // Load representatives if we have address
                        if (data.user.zipCode && data.user.state) {
                            loadElectedOfficials(data.user.zipCode, data.user.state);
                        }
                        
                        // Update map location if we have address
                        if (mapInstance && currentUser.state) {
                            getCurrentUserLocation();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load user content:', error);
            }
        }

        async function loadElectedOfficials(zipCode, state) {
            try {
                const response = await apiCall('/political/representatives');
                
                if (response.ok && response.data) {
                    const representatives = response.data.representatives;
                    updateOfficialsPanel(representatives);
                    
                    // Extract district information for boundary loading
                    console.log('Representatives data received:', representatives);
                    
                    if (representatives && representatives.federal) {
                        console.log('Federal representatives:', representatives.federal);
                        
                        const districtRep = representatives.federal.find(rep => 
                            rep.office && rep.office.includes('Representative')
                        );
                        
                        console.log('Found district rep:', districtRep);
                        
                        if (districtRep) {
                            let districtNumber = null;
                            let stateAbbr = null;
                            
                            // First try to use the district field directly
                            if (districtRep.district) {
                                console.log('District field found:', districtRep.district);
                                
                                // District field might be like "IL-10" or just "10"  
                                const districtMatch = districtRep.district.match(/(?:(\w{2})-)?(\d+)/);
                                if (districtMatch) {
                                    stateAbbr = districtMatch[1] || (currentUser && currentUser.state);
                                    districtNumber = districtMatch[2];
                                }
                            }
                            
                            // Fallback: try to extract from office title
                            if (!districtNumber && districtRep.office) {
                                console.log('Fallback: parsing office title:', districtRep.office);
                                const officeMatch = districtRep.office.match(/(\w{2})-(\d+)/);
                                if (officeMatch) {
                                    stateAbbr = officeMatch[1];
                                    districtNumber = officeMatch[2];
                                }
                            }
                            
                            if (districtNumber && stateAbbr) {
                                // Store district info for boundary loading
                                if (!currentUser) currentUser = {};
                                currentUser.district = districtNumber;
                                currentUser.state = stateAbbr;
                                
                                console.log(`District info extracted: ${currentUser.state}-${currentUser.district}`);
                                
                                // Load boundary if currently at local zoom
                                if (currentZoomLevel === 'local' && boundaryManager && currentLocation) {
                                    console.log('Loading district boundary...');
                                    boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                                }
                            } else {
                                console.warn('Could not extract district information from representative data');
                            }
                        } else {
                            console.warn('No district representative found in federal representatives');
                        }
                    } else {
                        console.warn('No federal representatives found in response');
                    }
                } else {
                    console.log('No representatives data available yet - may need address in profile');
                }
            } catch (error) {
                console.error('Failed to load representatives:', error);
            }
        }

        function updateOfficialsPanel(representatives) {
            const content = document.getElementById('officialsContent');
            
            // Check if representatives object has any data
            const totalReps = (representatives.federal || []).length + 
                            (representatives.state || []).length + 
                            (representatives.local || []).length;
            
            if (totalReps === 0) {
                content.innerHTML = '<p>No representatives found. Please add your complete address in your profile.</p>';
                return;
            }

            let html = '<div>';
            
            // Federal representatives
            if (representatives.federal && representatives.federal.length > 0) {
                html += '<h4>Federal Representatives</h4>';
                representatives.federal.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                ${rep.photoUrl ? `<img src="${rep.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + rep.name.charAt(0) + '</div>'}
                                <div>
                                    <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                                    <em>${rep.office}</em>
                                </div>
                            </div>
                            ${rep.phones && rep.phones.length > 0 ? `<div>üìû ${rep.phones[0]}</div>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `<div>üåê <a href="${rep.urls[0]}" target="_blank">Website</a></div>` : ''}
                            ${rep.social && rep.social.twitter ? `<div>üê¶ @${rep.social.twitter}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // State representatives
            if (representatives.state && representatives.state.length > 0) {
                html += '<h4>State Representatives</h4>';
                representatives.state.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                ${rep.photoUrl ? `<img src="${rep.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #6B8E23; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + rep.name.charAt(0) + '</div>'}
                                <div>
                                    <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                                    <em>${rep.office}</em>
                                </div>
                            </div>
                            ${rep.phones && rep.phones.length > 0 ? `<div>üìû ${rep.phones[0]}</div>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `<div>üåê <a href="${rep.urls[0]}" target="_blank">Website</a></div>` : ''}
                        </div>
                    `;
                });
            }
            
            // Local representatives
            if (representatives.local && representatives.local.length > 0) {
                html += '<h4>Local Representatives</h4>';
                representatives.local.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f0f8f0;">
                            <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                            <em>${rep.office}</em><br>
                            ${rep.phones && rep.phones.length > 0 ? `üìû ${rep.phones[0]}<br>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `üåê <a href="${rep.urls[0]}" target="_blank">Website</a>` : ''}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function resetPanelsToDefault() {
            document.getElementById('officialsContent').innerHTML = '<p>Please log in and set your address to see your elected officials.</p>';
        }

        // Existing panel functions
        function togglePanel(name) {
            const panel = document.getElementById(`panel-${name}`);
            const isHidden = panel.classList.contains('hidden');
            
            if (isHidden) {
                // Panel is hidden, show it (close others first)
                closeAllPanels();
                panel.classList.remove('hidden');
            } else {
                // Panel is visible, hide it and show default view
                panel.classList.add('hidden');
                showDefaultView();
            }
        }

        function closePanel(name) {
            document.getElementById(`panel-${name}`).classList.add('hidden');
        }

        function closeAllPanels() {
            document.querySelectorAll('.info-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('detail-panel').classList.add('hidden');
        }

        function openDetail(title, offset) {
            const panel = document.getElementById('detail-panel');
            document.getElementById('detail-title').innerText = title;
            document.getElementById('detail-content').innerText = `Placeholder content for ${title}.`;
            panel.dataset.offset = offset;
            panel.classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.add('hidden');
        }

        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleSidebar');
            const arrow = document.querySelector('.arrow-icon');
            
            sidebar.classList.toggle('expanded');
            
            // Update arrow direction and tooltip based on sidebar state
            if (sidebar.classList.contains('expanded')) {
                arrow.textContent = '‚óÄ'; // Arrow pointing left when expanded (to collapse)
                toggleButton.title = 'Collapse Sidebar';
                console.log('Sidebar expanded - arrow should point left');
            } else {
                arrow.textContent = '‚ñ∂'; // Arrow pointing right when collapsed (to expand)
                toggleButton.title = 'Expand Sidebar';
                console.log('Sidebar collapsed - arrow should point right');
            }
        });

        // Set initial arrow state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleSidebar');
            const arrow = document.querySelector('.arrow-icon');
            
            if (sidebar && toggleButton && arrow) {
                if (sidebar.classList.contains('expanded')) {
                    arrow.textContent = '‚óÄ';
                    toggleButton.title = 'Collapse Sidebar';
                } else {
                    arrow.textContent = '‚ñ∂';
                    toggleButton.title = 'Expand Sidebar';
                }
                console.log('Initial sidebar state set');
            }
        });

        // Map initialization - Toggle between Leaflet and MapLibre
        const USE_MAPLIBRE = true; // Set to false to use Leaflet during migration
        
        function initializeMap() {
            if (USE_MAPLIBRE) {
                // Use new MapLibre implementation
                initializeMapLibreLocal();
                return;
            }
            
            // Original Leaflet implementation (fallback)
            const map = L.map('map', {
                center: [37.8283, -98.5795],
                zoom: 5,
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                tap: false,
                touchZoom: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '', // Remove attribution
                subdomains: 'abcd',
            }).addTo(map);

            // Dynamic topics array - will be updated with AI-generated content
            let topics = [
                { coords: [40.7128, -74.0060], text: 'üì¢ Rent control in NYC gaining momentum!' },
                { coords: [34.0522, -118.2437], text: 'üöó EV subsidies debated in California legislature.' },
                { coords: [41.8781, -87.6298], text: '‚öñÔ∏è Chicago voters discuss criminal justice reform.' },
                { coords: [29.7604, -95.3698], text: 'üó≥Ô∏è Texas push for open primaries gaining traction.' },
                { coords: [47.6062, -122.3321], text: 'üå≥ Seattle community organizing for green zoning laws.' },
                { coords: [39.7392, -104.9903], text: 'üè° Denver debates housing-first initiatives.' },
                { coords: [33.4484, -112.0740], text: 'üöÅ Phoenix drone delivery regulations spark debate.' },
                { coords: [25.7617, -80.1918], text: 'üèñÔ∏è Miami climate resiliency bonds trending.' },
                { coords: [32.7767, -96.7970], text: 'üíº Dallas campaign finance reform gaining traction.' },
                { coords: [42.3601, -71.0589], text: 'üìö Boston pushes universal childcare ballot measure.' }
            ];
            
            // Enhanced popup creation with topic mode integration
            function createTopicPopup(topicData, map) {
                const popupOptions = {
                    closeButton: false,
                    autoClose: false,
                    closeOnClick: false,
                    autoPan: false
                };
                
                let popupContent = topicData.text;
                
                // Add click functionality for AI topics
                if (topicData.topicId) {
                    popupContent += `<br><div style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: rgba(255,107,53,0.9); color: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-align: center;" onclick="enterTopicMode('${topicData.topicId}')">üí¨ Join Discussion</div>`;
                }
                
                const popup = L.popup(popupOptions)
                    .setLatLng(topicData.coords)
                    .setContent(popupContent)
                    .openOn(map);
                    
                return popup;
            }
            
            // Function to update Leaflet map topics dynamically
            function updateLeafletMapTopics(newTopics) {
                if (newTopics && newTopics.length > 0) {
                    topics = newTopics.map(bubble => ({
                        coords: bubble.coords,
                        text: bubble.text,
                        topicId: bubble.topicId || null,
                        priority: bubble.priority || 'normal'
                    }));
                    console.log('Updated Leaflet map topics with', topics.length, 'AI-generated topics');
                }
            }
            
            // Make update function globally accessible
            window.updateMapTopics = updateLeafletMapTopics;

            let usedTopics = new Map();

            function showRandomPopups() {
                const count = Math.floor(Math.random() * 2) + 1;
                const now = Date.now();

                const availableTopics = topics.filter(t => {
                    const lastShown = usedTopics.has(t.text) ? usedTopics.get(t.text) : 0;
                    return now - lastShown > 180000;
                });

                const shuffled = availableTopics.sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, count);

                selected.forEach(topic => {
                    const popup = createTopicPopup(topic, map);

                    usedTopics.set(topic.text, now);
                    setTimeout(() => map.closePopup(popup), 30000);
                });

                const nextDelay = Math.floor(Math.random() * 3000) + 13000;
                setTimeout(showRandomPopups, nextDelay);
            }

            showRandomPopups();


            // Set map instance for zoom controls
            setMapInstance(map);

            return map;
        }

        // MapLibre initialization function
        function initializeMapLibreLocal() {
            console.log('initializeMapLibreLocal() called');
            
            // Set loading start time for minimum loading duration
            window.mapLoadStartTime = Date.now();
            
            // CRITICAL FIX: Show the map container BEFORE initializing MapLibre
            // MapLibre needs the container to be visible to measure dimensions correctly
            const mapContainer = document.getElementById('mapContainer');
            const loadingState = document.getElementById('mapLoadingState');
            
            console.log('Showing map container for MapLibre initialization...');
            if (mapContainer && loadingState) {
                // Hide loading state and show map container immediately
                loadingState.classList.add('hidden');
                mapContainer.style.display = 'block';
                console.log('Map container is now visible');
            }
            
            // Initialize MapLibre through the class in map-maplibre.js
            console.log('üîç Checking for external initializeMapLibre function...');
            console.log('üîç typeof window.initializeMapLibre:', typeof window.initializeMapLibre);
            console.log('üîç window.initializeMapLibre === initializeMapLibreLocal?', window.initializeMapLibre === initializeMapLibreLocal);
            console.log('üîç window.initializeMapLibre !== initializeMapLibreLocal?', window.initializeMapLibre !== initializeMapLibreLocal);
            
            if (typeof window.initializeMapLibre === 'function' && window.initializeMapLibre !== initializeMapLibreLocal) {
                console.log('‚úÖ Found external initializeMapLibre function, calling it...');
                window.initializeMapLibre();
            } else {
                console.error('‚ùå External initializeMapLibre function not found - map-maplibre.js may not have loaded correctly');
                
                // Fallback: Initialize directly if the function isn't available
                if (typeof UWRMapLibre !== 'undefined') {
                    console.log('UWRMapLibre class found, initializing directly...');
                    const mapInstance = new UWRMapLibre('map');
                    mapInstance.initialize().then(map => {
                        console.log('Direct MapLibre initialization complete');
                        
                        // Create window.map object manually since initializeMapLibre() wasn't called
                        window.map = {
                            // Wrapper methods for Leaflet compatibility
                            setView: (center, zoom) => mapInstance.setView(center, zoom),
                            invalidateSize: () => mapInstance.invalidateSize(),
                            closePopup: () => mapInstance.closeAllPopups(),
                            fitBounds: (bounds) => mapInstance.fitBounds(bounds),
                            // New MapLibre-specific methods
                            toggleCollapsed: () => {
                                console.log('window.map.toggleCollapsed called');
                                return mapInstance.toggleCollapsed();
                            },
                            closeMap: () => mapInstance.closeMap(),
                            showMap: () => mapInstance.showMap(),
                            // Transition methods for smooth bubble handling
                            hideBubbles: () => mapInstance.hideAllBubblesDuringTransition(),
                            showBubbles: () => mapInstance.showAllBubblesAfterTransition(),
                            // Map container state adjustment
                            adjustForContainerState: (isCollapsed) => mapInstance.adjustForContainerState(isCollapsed),
                            setZoomLevel: (level) => {
                                mapInstance.setZoomLevel(level);
                                // Update button states
                                updateMapViewButtons(level);
                            },
                            geocodeAndZoom: () => mapInstance.geocodeAndZoom(),
                            // Layer management system
                            toggleLayer: (layerName) => mapInstance.toggleLayer(layerName),
                            setJurisdiction: (jurisdiction) => mapInstance.setJurisdiction(jurisdiction),
                            // MapLibre instance for advanced use
                            _maplibre: map,
                            _uwrMap: mapInstance
                        };
                        
                        console.log('window.map object created with adjustForContainerState:', !!window.map.adjustForContainerState);
                    }).catch(error => {
                        console.error('Direct MapLibre initialization failed:', error);
                    });
                } else {
                    console.error('UWRMapLibre class not found - falling back to Leaflet');
                    // Fall back to Leaflet if MapLibre fails completely
                    USE_MAPLIBRE = false;
                    initializeMap();
                }
            }
        }

        // Close CTA panel permanently
        document.getElementById('google-cta-panel').querySelector('button').addEventListener('click', function() {
            localStorage.setItem('panelClosed', 'true');
        });

        // API Response Cache
        const apiCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes for general API calls
        const REPRESENTATIVES_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes for representatives (they don't change often)

        // API Helper Functions
        async function apiCall(endpoint, options = {}) {
            // Check cache for GET requests (unless explicitly bypassing cache)
            const isGet = !options.method || options.method === 'GET';
            const bypassCache = options.bypassCache;
            
            if (isGet && !bypassCache) {
                const cacheKey = `${endpoint}${authToken ? `_${authToken.substring(0, 10)}` : ''}`;
                const cached = apiCache.get(cacheKey);
                
                // Use longer cache duration for representatives data
                const cacheDuration = endpoint.includes('representatives') || endpoint.includes('officials') 
                    ? REPRESENTATIVES_CACHE_DURATION 
                    : CACHE_DURATION;
                
                if (cached && (Date.now() - cached.timestamp) < cacheDuration) {
                    console.log(`Using cached API response for ${endpoint} (${Math.round((Date.now() - cached.timestamp) / 1000)}s old)`);
                    return cached.data;
                }
            }
            
            const config = {
                headers: {
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            // Only set Content-Type to application/json if body is not FormData
            // FormData should set its own Content-Type with proper boundary
            if (!options.skipContentType && !(config.body instanceof FormData)) {
                config.headers['Content-Type'] = 'application/json';
            }
            
            // Remove custom options before fetch
            delete config.bypassCache;
            delete config.skipContentType;

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                // Create a response object with ok status and parsed data
                const result = {
                    ok: response.ok,
                    status: response.status,
                    data: null
                };

                // Try to parse JSON response
                try {
                    const text = await response.text();
                    if (text) {
                        result.data = JSON.parse(text);
                    }
                } catch (parseError) {
                    console.warn('Failed to parse JSON response:', parseError);
                    result.data = { error: 'Invalid response format' };
                }
                
                // Cache GET responses
                if (isGet && !bypassCache && result.ok) {
                    const cacheKey = `${endpoint}${authToken ? `_${authToken.substring(0, 10)}` : ''}`;
                    apiCache.set(cacheKey, {
                        timestamp: Date.now(),
                        data: result
                    });
                    
                    // Clean old cache entries periodically
                    if (apiCache.size > 100) {
                        const cutoff = Date.now() - Math.max(CACHE_DURATION, REPRESENTATIVES_CACHE_DURATION);
                        for (const [key, value] of apiCache.entries()) {
                            if (value.timestamp < cutoff) {
                                apiCache.delete(key);
                            }
                        }
                    }
                }

                return result;
            } catch (networkError) {
                console.error('Network error:', networkError);
                return {
                    ok: false,
                    status: 0,
                    data: { error: 'Network error. Please check your connection.' }
                };
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    await performSearch(query);
                }
            }
        });

        async function performSearch(query) {
            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                
                if (response.ok) {
                    // Only use the global search results container, not the feed area
                    displayGlobalSearchResults(response.data.users);
                } else {
                    console.error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function displaySearchResults(users, query) {
            const mainContent = document.getElementById('mainContent');
            
            if (users.length === 0) {
                mainContent.innerHTML = `
                    <h1>Search Results</h1>
                    <p>No users found for "${query}"</p>
                `;
                return;
            }

            let html = `
                <h1>Search Results for "${query}"</h1>
                <div style="display: grid; gap: 1rem;">
            `;

            users.forEach(user => {
                const profileType = user.politicalProfileType || 'CITIZEN';
                const typeEmoji = {
                    'CANDIDATE': 'üó≥Ô∏è',
                    'ELECTED_OFFICIAL': 'üèõÔ∏è',
                    'POLITICAL_ORG': 'üè¢',
                    'CITIZEN': 'üë§'
                }[profileType];

                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">${typeEmoji}</span>
                            <div>
                                <strong>${user.firstName || ''} ${user.lastName || ''}</strong>
                                ${user.verified ? '<span style="color: #1976d2;">‚úì</span>' : ''}
                                <br>
                                <small style="color: #666;">@${user.username}</small>
                            </div>
                        </div>
                        ${user.bio ? `<p style="margin: 0.5rem 0; color: #555;">${user.bio}</p>` : ''}
                        ${user.office ? `<p style="margin: 0.25rem 0; font-style: italic;">${user.office}</p>` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                            ${user.followersCount} followers
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            mainContent.innerHTML = html;
        }

        // Load trending topics for the trending panel (AI-powered)
        async function loadTrendingPosts() {
            try {
                // Try AI topic discovery first, fallback to posts if needed
                let response;
                try {
                    response = await apiCall('/topic-navigation/trending?limit=20');
                    if (response.ok && response.data.topics && response.data.topics.length > 0) {
                        updateTrendingTopicsPanel(response.data.topics);
                        return;
                    }
                } catch (topicError) {
                    console.log('AI topics unavailable for sidebar, falling back to posts:', topicError.message);
                }
                
                // Fallback to post-based trending for sidebar
                response = await apiCall('/feed/trending');
                
                if (response.ok) {
                    updateTrendingPanel(response.data.posts);
                } else {
                    console.error('Failed to load trending content:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load trending content:', error);
            }
        }
        
        // Enhanced function to render AI topics in the sidebar trending panel
        function updateTrendingTopicsPanel(topics) {
            const content = document.getElementById('trendingContent');
            
            if (!content) return;
            
            if (topics.length === 0) {
                content.innerHTML = '<p>No trending topics available.</p>';
                return;
            }
            
            let html = '<div class="trending-topics-list">';
            
            topics.forEach((topic, index) => {
                const isFeature = index === 0;
                const timeAgo = getTimeAgo(new Date(topic.createdAt || Date.now()));
                
                html += `
                    <div class="trending-topic-card" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;" onclick="enterTopicMode('${topic.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='none'">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.2rem;">${isFeature ? 'üî•' : 'üè∑Ô∏è'}</span>
                            <div style="font-weight: bold; font-size: 1rem; flex: 1; color: #333;">${topic.title}</div>
                            ${isFeature ? '<span style="background: #ff6b35; color: white; padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.7rem; font-weight: 500;">TRENDING</span>' : ''}
                        </div>
                        
                        <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.75rem; line-height: 1.4;">
                            ${(topic.summary || 'Discussion topic').substring(0, 150)}${topic.summary && topic.summary.length > 150 ? '...' : ''}
                        </div>
                        
                        ${topic.prevailingPosition ? `
                            <div style="background: #f8f9fa; border-left: 3px solid #28a745; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 0.25rem;">üìç PREVAILING POSITION</div>
                                <div style="font-size: 0.85rem; color: #555;">${topic.prevailingPosition.substring(0, 120)}${topic.prevailingPosition.length > 120 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        
                        ${topic.leadingCritique ? `
                            <div style="background: #f8f9fa; border-left: 3px solid #dc3545; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 0.25rem;">‚ö° LEADING CRITIQUE</div>
                                <div style="font-size: 0.85rem; color: #555;">${topic.leadingCritique.substring(0, 120)}${topic.leadingCritique.length > 120 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #666; padding-top: 0.5rem; border-top: 1px solid #f0f0f0;">
                            <span>üí¨ ${topic.postCount} posts ‚Ä¢ üë• ${topic.participantCount} people</span>
                            <span>${timeAgo}</span>
                        </div>
                        
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); enterTopicMode('${topic.id}')" style="background: #ff6b35; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#e55a2b'" onmouseout="this.style.background='#ff6b35'">
                                üí¨ Enter Discussion
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Auto-refresh trending posts
        let trendingRefreshInterval = null;

        function startTrendingRefresh() {
            // Load initial trending updates (but don't spam if backend isn't ready)
            setTimeout(() => loadTrendingUpdates(), 2000);
            
            // Refresh trending every 50 seconds (new posts roll in at top, old ones roll off bottom)
            trendingRefreshInterval = setInterval(() => {
                // Only refresh if trending panel is visible
                if (document.getElementById('trendingUpdates').classList.contains('show')) {
                    loadTrendingUpdates();
                }
            }, 50000);
        }

        function stopTrendingRefresh() {
            if (trendingRefreshInterval) {
                clearInterval(trendingRefreshInterval);
                trendingRefreshInterval = null;
            }
        }

        // Load trending topics for the mini panel under map (AI-powered)
        async function loadTrendingUpdates() {
            try {
                // Check if backend is reachable first
                const healthCheck = await fetch(`${API_BASE.replace('/api', '')}/health`);
                if (!healthCheck.ok) {
                    console.log('Backend not available, skipping trending updates');
                    return;
                }

                // Try AI topic discovery first, fallback to posts if needed
                let response;
                try {
                    response = await apiCall('/topic-navigation/trending?limit=15');
                    if (response.ok && response.data.topics && response.data.topics.length > 0) {
                        updateTrendingTopicsPanel(response.data.topics);
                        
                        // Show the panel when there's content
                        const panel = document.getElementById('trendingUpdates');
                        panel.classList.add('show');
                        return;
                    }
                } catch (topicError) {
                    console.log('AI topics unavailable, falling back to posts:', topicError.message);
                }
                
                // Fallback to post-based trending
                response = await apiCall('/feed/trending?limit=20');
                
                if (response.ok) {
                    updateTrendingUpdatesPanel(response.data.posts);
                    
                    // Show the panel when there's content
                    const panel = document.getElementById('trendingUpdates');
                    if (response.data.posts.length > 0) {
                        panel.classList.add('show');
                    }
                } else {
                    console.log('No trending content available yet');
                }
            } catch (error) {
                console.log('Trending updates not available:', error.message);
                // Silently fail - don't spam console with errors
            }
        }

        let allTrendingPosts = [];
        let allTrendingTopics = [];
        let trendingExpanded = false;
        let displayMode = 'topics'; // 'topics' or 'posts'
        let currentTopicMode = null; // Track if user is in topic-filtered mode

        // Enhanced function to handle both AI topics and post fallback
        function updateTrendingTopicsPanel(topics) {
            allTrendingTopics = topics;
            displayMode = 'topics';
            const body = document.getElementById('trendingUpdatesBody');
            
            if (topics.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayTopics = trendingExpanded ? topics : topics.slice(0, 5);
            let html = '';
            
            displayTopics.forEach((topic, index) => {
                const isFeature = index === 0;
                const timeAgo = getTimeAgo(new Date(topic.createdAt || Date.now()));
                const summary = topic.summary || 'Discussion topic';
                
                html += `
                    <div class="trending-item topic-item" onclick="enterTopicMode('${topic.id}')" style="cursor: pointer;">
                        <div class="topic-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 4px;">
                            <span style="font-size: 1.1rem;">${isFeature ? 'üî•' : 'üè∑Ô∏è'}</span>
                            <div style="font-weight: bold; font-size: 0.85rem; flex: 1;">${topic.title}</div>
                            ${isFeature ? '<span style="background: #ff6b35; color: white; padding: 0.2rem 0.4rem; border-radius: 8px; font-size: 0.7rem;">HOT</span>' : ''}
                        </div>
                        <div style="font-size: 0.8rem; color: #555; margin-bottom: 6px; line-height: 1.3;">${summary.substring(0, 120)}${summary.length > 120 ? '...' : ''}</div>
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.75rem; color: #666;">
                            <span>üí¨ ${topic.postCount} posts ‚Ä¢ üë• ${topic.participantCount} people</span>
                            <span>${timeAgo}</span>
                        </div>
                        ${topic.prevailingPosition ? `
                            <div style="margin-top: 6px; padding: 0.4rem; background: #f8f9fa; border-radius: 4px; font-size: 0.75rem; border-left: 2px solid #28a745;">
                                <strong>üìç Main view:</strong> ${topic.prevailingPosition.substring(0, 80)}${topic.prevailingPosition.length > 80 ? '...' : ''}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            body.innerHTML = html;
        }

        function updateTrendingUpdatesPanel(posts) {
            allTrendingPosts = posts;
            displayMode = 'posts';
            const body = document.getElementById('trendingUpdatesBody');
            
            if (posts.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayPosts = trendingExpanded ? posts : posts.slice(0, 5);
            let html = '';
            
            displayPosts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                const preview = post.content.length > 80 ? post.content.substring(0, 80) + '...' : post.content;
                
                html += `
                    <div class="trending-item">
                        <div style="font-weight: bold; margin-bottom: 2px; font-size: 0.85rem;">@${post.author.username}</div>
                        <div style="margin-bottom: 4px;">${preview}</div>
                        <div style="color: #666; font-size: 0.75rem; margin-bottom: 4px;">
                            <span style="cursor: pointer; margin-right: 8px;" onclick="likeTrendingPost('${post.id}')">‚ù§Ô∏è ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 8px;" onclick="showTrendingCommentBox('${post.id}')">üí¨ Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; margin-right: 8px; color: #4b5c09;" onclick="viewComments('${post.id}')">üëÅÔ∏è ${post.commentsCount}</span>` : ''}
                            <span>${timeAgo}</span>
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 50px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical; font-size: 0.8rem;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-size: 0.8rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
        }

        function toggleTrendingExpansion() {
            const panel = document.getElementById('trendingUpdates');
            const btn = document.getElementById('trendingExpandBtn');
            
            trendingExpanded = !trendingExpanded;
            
            if (trendingExpanded) {
                panel.classList.add('expanded');
                btn.textContent = 'Less';
            } else {
                panel.classList.remove('expanded');
                btn.textContent = 'More';
            }
            
            updateTrendingUpdatesPanel(allTrendingPosts);
        }

        function toggleTrendingPanel() {
            const panel = document.getElementById('trendingUpdates');
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
            } else {
                loadTrendingUpdates(); // Load fresh data
                panel.classList.add('show');
            }
        }
        
        // NEW: Topic Mode Functions for My Feed Integration
        async function enterTopicMode(topicId) {
            try {
                console.log(`Entering topic mode: ${topicId}`);
                
                // Store previous feed state if not already in topic mode
                if (!currentTopicMode) {
                    // Cache current My Feed state
                    const currentFeed = document.getElementById('feedContent');
                    if (currentFeed) {
                        window.cachedFeedState = currentFeed.innerHTML;
                    }
                }
                
                const response = await apiCall(`/topic-navigation/enter/${topicId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: 30 })
                });
                
                if (response.ok && response.data.success) {
                    currentTopicMode = {
                        topicId: topicId,
                        topic: response.data.topic,
                        posts: response.data.posts
                    };
                    
                    // Update My Feed with topic-filtered content
                    updateMyFeedWithTopic(response.data.topic, response.data.posts);
                    
                    // Update trending panel to show exit option
                    updateTrendingWithTopicMode();
                    
                    console.log(`‚úÖ Entered topic: ${response.data.topic.title}`);
                } else {
                    console.error('Failed to enter topic mode:', response.data?.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error entering topic mode:', error);
            }
        }
        
        async function exitTopicMode() {
            try {
                console.log('Exiting topic mode...');
                
                const response = await apiCall('/topic-navigation/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok && response.data.success) {
                    currentTopicMode = null;
                    
                    // Restore cached feed or load fresh algorithm feed
                    if (window.cachedFeedState) {
                        const feedContent = document.getElementById('feedContent');
                        if (feedContent) {
                            feedContent.innerHTML = window.cachedFeedState;
                        }
                        delete window.cachedFeedState;
                    } else {
                        // Load fresh algorithm feed
                        if (typeof loadMyFeed === 'function') {
                            loadMyFeed();
                        }
                    }
                    
                    // Reset trending panel to normal state
                    loadTrendingUpdates();
                    
                    console.log('‚úÖ Returned to main algorithm feed');
                } else {
                    console.error('Failed to exit topic mode:', response.data?.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error exiting topic mode:', error);
                // Force reset on error
                currentTopicMode = null;
                if (typeof loadMyFeed === 'function') {
                    loadMyFeed();
                }
                loadTrendingUpdates();
            }
        }
        
        function updateMyFeedWithTopic(topic, posts) {
            const feedContent = document.getElementById('feedContent');
            if (!feedContent) return;
            
            let html = `
                <div class="topic-mode-indicator">
                    <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üè∑Ô∏è</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">${topic.title}</h3>
                            </div>
                            <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">‚Üê Exit Topic</button>
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${topic.summary}</div>
                        ${topic.prevailingPosition ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; border-left: 3px solid rgba(255,255,255,0.5);">
                                <strong>üìç Main Position:</strong> ${topic.prevailingPosition}
                            </div>
                        ` : ''}
                        ${topic.leadingCritique ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; border-left: 3px solid rgba(255,255,255,0.5);">
                                <strong>‚ö° Leading Critique:</strong> ${topic.leadingCritique}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="topic-posts-feed">
            `;
            
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const timeAgo = getTimeAgo(new Date(post.createdAt));
                    html += `
                        <div class="post-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #ff6b35; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">
                                    ${post.author.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">@${post.author.username}</div>
                                    <div style="color: #666; font-size: 0.8rem;">${timeAgo}</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 0.75rem; line-height: 1.4;">${post.content}</div>
                            <div style="display: flex; gap: 1rem; padding-top: 0.5rem; border-top: 1px solid #f0f0f0; font-size: 0.85rem; color: #666;">
                                <span style="cursor: pointer;" onclick="likePost('${post.id}')">‚ù§Ô∏è ${post.likesCount || 0}</span>
                                <span style="cursor: pointer;">üí¨ ${post.commentsCount || 0}</span>
                                <span style="cursor: pointer;">üîÑ Share</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="text-align: center; color: #666; padding: 2rem;">No posts found for this topic.</div>';
            }
            
            html += '</div>';
            feedContent.innerHTML = html;
        }
        
        function updateTrendingWithTopicMode() {
            const body = document.getElementById('trendingUpdatesBody');
            if (!body || !currentTopicMode) return;
            
            const topic = currentTopicMode.topic;
            
            body.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: bold; font-size: 0.85rem;">üè∑Ô∏è TOPIC MODE</span>
                        <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Exit</button>
                    </div>
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 0.25rem;">${topic.title}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">${topic.postCount} posts ‚Ä¢ ${topic.participantCount} participants</div>
                </div>
                <div style="text-align: center; padding: 0.5rem; color: #666; font-size: 0.8rem;">
                    My Feed is now filtered by this topic.<br>
                    <a href="#" onclick="loadTrendingUpdates(); return false;" style="color: #ff6b35; text-decoration: none;">View other trending topics</a>
                </div>
            `;
        }
        
        // NEW: Map Integration Functions - Sync AI Topics with Map Bubbles
        let mapTopicCache = [];
        let lastMapTopicUpdate = 0;
        const MAP_TOPIC_CACHE_DURATION = 120000; // 2 minutes
        
        // Convert AI topics to map bubble format with geographic distribution
        function convertTopicsToMapBubbles(aiTopics) {
            if (!aiTopics || aiTopics.length === 0) return [];
            
            // Predefined coordinates for major US cities - AI topics get distributed across these
            const cityCoords = [
                { coords: [40.7128, -74.0060], city: 'NYC' },
                { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                { coords: [41.8781, -87.6298], city: 'Chicago' },
                { coords: [29.7604, -95.3698], city: 'Houston' },
                { coords: [47.6062, -122.3321], city: 'Seattle' },
                { coords: [39.7392, -104.9903], city: 'Denver' },
                { coords: [33.4484, -112.0740], city: 'Phoenix' },
                { coords: [25.7617, -80.1918], city: 'Miami' },
                { coords: [32.7767, -96.7970], city: 'Dallas' },
                { coords: [42.3601, -71.0589], city: 'Boston' },
                { coords: [38.9072, -77.0369], city: 'Washington DC' },
                { coords: [37.7749, -122.4194], city: 'San Francisco' },
                { coords: [39.9526, -75.1652], city: 'Philadelphia' },
                { coords: [30.2672, -97.7431], city: 'Austin' },
                { coords: [39.7391, -104.9903], city: 'Colorado Springs' }
            ];
            
            const mapBubbles = [];
            let coordIndex = 0;
            
            aiTopics.forEach((topic, index) => {
                const coord = cityCoords[coordIndex % cityCoords.length];
                coordIndex++;
                
                // Create bubble text from topic data
                let bubbleText = `üè∑Ô∏è ${topic.title}`;
                
                // Add brief description if available
                if (topic.summary && topic.summary.length > 0) {
                    const shortSummary = topic.summary.length > 80 
                        ? topic.summary.substring(0, 80) + '...' 
                        : topic.summary;
                    bubbleText += ` - ${shortSummary}`;
                }
                
                // Add engagement indicator for top topics
                if (index < 3) {
                    bubbleText += ` (${topic.postCount} posts active)`;
                }
                
                mapBubbles.push({
                    coords: coord.coords,
                    text: bubbleText,
                    city: coord.city,
                    topicId: topic.id,
                    priority: index < 3 ? 'high' : 'normal', // Top 3 get higher priority
                    aiTopic: true // Flag to distinguish from static topics
                });
            });
            
            return mapBubbles;
        }
        
        // Enhanced function to update map with AI topics
        async function updateMapWithTrendingTopics() {
            try {
                // Check if we need to refresh the topic cache
                const now = Date.now();
                if (mapTopicCache.length > 0 && (now - lastMapTopicUpdate) < MAP_TOPIC_CACHE_DURATION) {
                    console.log('Using cached map topics');
                    return mapTopicCache;
                }
                
                // Fetch latest AI topics
                const response = await apiCall('/topic-navigation/trending?limit=12');
                if (response.ok && response.data.topics && response.data.topics.length > 0) {
                    const aiTopics = response.data.topics;
                    const mapBubbles = convertTopicsToMapBubbles(aiTopics);
                    
                    // Update cache
                    mapTopicCache = mapBubbles;
                    lastMapTopicUpdate = now;
                    
                    // Update the map if available
                    if (window.updateMapTopics && typeof window.updateMapTopics === 'function') {
                        console.log('Updating map with AI-generated topics...');
                        window.updateMapTopics(mapBubbles);
                    } else if (window.map && window.map.updateTopics) {
                        console.log('Updating map topics via map.updateTopics...');
                        window.map.updateTopics(mapBubbles);
                    } else {
                        console.log('Map topic update method not available, topics cached for next map init');
                    }
                    
                    return mapBubbles;
                } else {
                    console.log('AI topics unavailable for map, using fallback');
                    return getFallbackMapTopics();
                }
            } catch (error) {
                console.error('Failed to update map with trending topics:', error);
                return getFallbackMapTopics();
            }
        }
        
        // Fallback to static topics if AI topics are unavailable
        function getFallbackMapTopics() {
            return [
                { coords: [40.7128, -74.0060], text: 'üèõÔ∏è NYC discussing local election reforms', city: 'NYC', priority: 'normal' },
                { coords: [34.0522, -118.2437], text: 'üöó California EV subsidy debates heating up', city: 'Los Angeles', priority: 'normal' },
                { coords: [41.8781, -87.6298], text: '‚öñÔ∏è Chicago criminal justice reform discussions', city: 'Chicago', priority: 'normal' },
                { coords: [29.7604, -95.3698], text: 'üó≥Ô∏è Texas open primary initiatives gaining support', city: 'Houston', priority: 'normal' },
                { coords: [47.6062, -122.3321], text: 'üå≥ Seattle green zoning community organizing', city: 'Seattle', priority: 'normal' },
                { coords: [39.7392, -104.9903], text: 'üè° Denver housing-first policy debates', city: 'Denver', priority: 'normal' }
            ];
        }
        
        // Integration with trending system - call this when topics are loaded
        function syncMapWithTrendingTopics() {
            updateMapWithTrendingTopics();
        }
        
        // Enhanced loadTrendingUpdates to sync with map
        const originalLoadTrendingUpdates = loadTrendingUpdates;
        loadTrendingUpdates = async function() {
            await originalLoadTrendingUpdates();
            
            // After loading trending topics, sync with map
            setTimeout(() => {
                syncMapWithTrendingTopics();
            }, 500); // Small delay to ensure trending updates are complete
        };
        
        // NEW: Geographic Layering System with Balanced Timing
        let geographicTopicTimer = null;
        let lastGeographicTopicTime = 0;
        const GEOGRAPHIC_TOPIC_INTERVAL = 50000; // 50 seconds (45-60 range)
        
        // Enhanced geographic distribution based on zoom level and user location
        function getGeographicLayeredTopics(aiTopics, zoomLevel = 'national') {
            if (!aiTopics || aiTopics.length === 0) return [];
            
            const userState = currentUser?.state || null;
            const userCity = currentUser?.city || null;
            
            const layeredTopics = [];
            let topicIndex = 0;
            
            // Determine topic distribution based on zoom level
            switch (zoomLevel) {
                case 'national':
                    // National view: Primarily national topics, with periodic state/local injection
                    const nationalTopics = aiTopics.filter((_, index) => index < 10); // Top 10 as national
                    
                    // Every 45-60 seconds, inject state/local topics
                    const now = Date.now();
                    const shouldInjectLocal = (now - lastGeographicTopicTime) > GEOGRAPHIC_TOPIC_INTERVAL;
                    
                    if (shouldInjectLocal && aiTopics.length > 10) {
                        // Inject 2-3 topics as "state/local" with user's geographic context
                        const localTopics = aiTopics.slice(10, 13).map((topic, index) => ({
                            ...topic,
                            geographicContext: userState ? `${userState} Local` : 'Regional',
                            localPriority: true
                        }));
                        
                        layeredTopics.push(...localTopics);
                        lastGeographicTopicTime = now;
                        console.log('Injected local topics for national view');
                    }
                    
                    layeredTopics.push(...nationalTopics.map(topic => ({
                        ...topic,
                        geographicContext: 'National'
                    })));
                    break;
                    
                case 'state':
                    // State view: Mix of state-specific and national topics
                    layeredTopics.push(...aiTopics.map(topic => ({
                        ...topic,
                        geographicContext: userState || 'State'
                    })));
                    break;
                    
                case 'local':
                    // Local view: Focus on local and regional topics
                    layeredTopics.push(...aiTopics.map(topic => ({
                        ...topic,
                        geographicContext: userCity ? `${userCity}, ${userState}` : 'Local'
                    })));
                    break;
            }
            
            return layeredTopics;
        }
        
        // Enhanced convertTopicsToMapBubbles with geographic layering
        const originalConvertTopicsToMapBubbles = convertTopicsToMapBubbles;
        convertTopicsToMapBubbles = function(aiTopics, zoomLevel = null) {
            const effectiveZoomLevel = zoomLevel || currentZoomLevel || 'national';
            const layeredTopics = getGeographicLayeredTopics(aiTopics, effectiveZoomLevel);
            
            if (!layeredTopics || layeredTopics.length === 0) return [];
            
            // Get appropriate coordinates based on zoom level
            const coordSets = getCoordinatesByZoomLevel(effectiveZoomLevel);
            const mapBubbles = [];
            let coordIndex = 0;
            
            layeredTopics.forEach((topic, index) => {
                const coord = coordSets[coordIndex % coordSets.length];
                coordIndex++;
                
                // Enhanced bubble text with geographic context
                let bubbleText = `${topic.localPriority ? 'üìç' : 'üè∑Ô∏è'} ${topic.title}`;
                
                // Add geographic context indicator
                if (topic.geographicContext && topic.geographicContext !== 'National') {
                    bubbleText += ` [${topic.geographicContext}]`;
                }
                
                // Add brief description if available
                if (topic.summary && topic.summary.length > 0) {
                    const shortSummary = topic.summary.length > 60 
                        ? topic.summary.substring(0, 60) + '...' 
                        : topic.summary;
                    bubbleText += ` - ${shortSummary}`;
                }
                
                // Add engagement indicator for top topics or local priority
                if (index < 3 || topic.localPriority) {
                    bubbleText += ` (${topic.postCount} posts${topic.localPriority ? ', local interest' : ''})`;
                }
                
                mapBubbles.push({
                    coords: coord.coords,
                    text: bubbleText,
                    city: coord.city,
                    topicId: topic.id,
                    priority: topic.localPriority ? 'local' : (index < 3 ? 'high' : 'normal'),
                    geographicContext: topic.geographicContext,
                    aiTopic: true
                });
            });
            
            return mapBubbles;
        };
        
        // Get appropriate coordinate sets based on zoom level
        function getCoordinatesByZoomLevel(zoomLevel) {
            const nationalCoords = [
                { coords: [40.7128, -74.0060], city: 'NYC' },
                { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                { coords: [41.8781, -87.6298], city: 'Chicago' },
                { coords: [29.7604, -95.3698], city: 'Houston' },
                { coords: [47.6062, -122.3321], city: 'Seattle' },
                { coords: [39.7392, -104.9903], city: 'Denver' },
                { coords: [33.4484, -112.0740], city: 'Phoenix' },
                { coords: [25.7617, -80.1918], city: 'Miami' },
                { coords: [32.7767, -96.7970], city: 'Dallas' },
                { coords: [42.3601, -71.0589], city: 'Boston' },
                { coords: [38.9072, -77.0369], city: 'Washington DC' },
                { coords: [37.7749, -122.4194], city: 'San Francisco' }
            ];
            
            const stateCoords = getUserStateCoordinates();
            const localCoords = getUserLocalCoordinates();
            
            switch (zoomLevel) {
                case 'state':
                    return stateCoords.length > 0 ? stateCoords : nationalCoords.slice(0, 8);
                case 'local':
                    return localCoords.length > 0 ? localCoords : nationalCoords.slice(0, 6);
                case 'national':
                default:
                    return nationalCoords;
            }
        }
        
        // Get coordinates relevant to user's state
        function getUserStateCoordinates() {
            if (!currentUser?.state) return [];
            
            // Major cities by state (sample)
            const stateCityMap = {
                'CA': [
                    { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                    { coords: [37.7749, -122.4194], city: 'San Francisco' },
                    { coords: [32.7157, -117.1611], city: 'San Diego' }
                ],
                'TX': [
                    { coords: [29.7604, -95.3698], city: 'Houston' },
                    { coords: [32.7767, -96.7970], city: 'Dallas' },
                    { coords: [30.2672, -97.7431], city: 'Austin' }
                ],
                'NY': [
                    { coords: [40.7128, -74.0060], city: 'NYC' },
                    { coords: [42.3584, -75.3890], city: 'Albany' },
                    { coords: [43.0481, -76.1474], city: 'Syracuse' }
                ],
                'FL': [
                    { coords: [25.7617, -80.1918], city: 'Miami' },
                    { coords: [28.5383, -81.3792], city: 'Orlando' },
                    { coords: [30.4383, -84.2807], city: 'Tallahassee' }
                ]
            };
            
            return stateCityMap[currentUser.state] || [];
        }
        
        // Get coordinates relevant to user's local area
        function getUserLocalCoordinates() {
            if (!currentUser?.city || !currentUser?.state) return [];
            
            // For local view, create coordinates around user's area
            // This would ideally use real local coordinates
            const userLat = parseFloat(currentUser.latitude) || 39.8283;
            const userLng = parseFloat(currentUser.longitude) || -98.5795;
            
            // Generate nearby coordinates (simplified approach)
            const localCoords = [];
            for (let i = 0; i < 6; i++) {
                const offsetLat = (Math.random() - 0.5) * 0.5; // ~25 mile radius
                const offsetLng = (Math.random() - 0.5) * 0.5;
                
                localCoords.push({
                    coords: [userLat + offsetLat, userLng + offsetLng],
                    city: `${currentUser.city} Area ${i + 1}`
                });
            }
            
            return localCoords;
        }
        
        // Start geographic topic balancing timer
        function startGeographicTopicBalancing() {
            if (geographicTopicTimer) {
                clearInterval(geographicTopicTimer);
            }
            
            geographicTopicTimer = setInterval(() => {
                // Only inject local topics when viewing national level
                if (currentZoomLevel === 'national') {
                    console.log('Geographic topic balancing - refreshing for local injection');
                    syncMapWithTrendingTopics();
                }
            }, GEOGRAPHIC_TOPIC_INTERVAL);
        }
        
        // Initialize geographic balancing on page load
        document.addEventListener('DOMContentLoaded', () => {
            startGeographicTopicBalancing();
        });

        function openFullTrending() {
            // This function kept for compatibility but now just expands in place
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function viewTrendingPost(postId) {
            // For now, just expand the trending if not already expanded
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function updateTrendingPanel(posts) {
            const content = document.getElementById('trendingContent');
            
            if (posts.length === 0) {
                content.innerHTML = '<p>No trending posts available.</p>';
                return;
            }

            let html = '<div>';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                html += `
                    <div data-post-id="${post.id}" style="margin-bottom: 1rem; padding: 0.75rem; border-left: 3px solid #4b5c09; background: #f9f9f9; border-radius: 4px; transition: all 0.3s ease;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                            @${post.author.username} ‚Ä¢ ${timeAgo}
                        </div>
                        <div style="margin-bottom: 0.5rem;">${post.content}</div>
                        <div style="font-size: 0.8rem; color: #888;">
                            <span style="cursor: pointer; margin-right: 10px;" onclick="likeTrendingPost('${post.id}')">‚ù§Ô∏è ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 10px;" onclick="showTrendingCommentBox('${post.id}')">üí¨ Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; color: #4b5c09;" onclick="viewComments('${post.id}')">üëÅÔ∏è View ${post.commentsCount}</span>` : ''}
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }

        // Override existing togglePanel to load live data
        const originalTogglePanel = window.togglePanel;
        window.togglePanel = function(name) {
            const panel = document.getElementById(`panel-${name}`);
            const wasHidden = panel.classList.contains('hidden');
            
            originalTogglePanel(name);
            
            // Load live data when panels are opened (not when closed)
            if (wasHidden) {
                if (name === 'trending') {
                    loadTrendingPosts();
                } else if (name === 'officials' && currentUser) {
                    loadUserContent();
                }
            }
        };

        // Messages Functions
        function toggleMessages() {
            const container = document.getElementById('messagesContainer');
            if (container.style.display === 'none' || !container.style.display) {
                container.style.display = 'block';
                loadConversations();
            } else {
                container.style.display = 'none';
                // Show default view when messages are closed
                showDefaultView();
            }
        }

        async function loadConversations() {
            if (!authToken) return;

            try {
                const response = await apiCall('/messages/conversations');
                
                if (response.ok) {
                    displayConversations(response.data.conversations);
                } else {
                    document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Failed to load conversations</p>';
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
                document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Error loading conversations</p>';
            }
        }

        function displayConversations(conversations) {
            const body = document.getElementById('messagesBody');
            
            if (!authToken) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view messages</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="showNewConversationForm()" style="width: 100%; padding: 0.5vh; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        + New Conversation
                    </button>
                </div>
            `;
            
            if (conversations.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>No conversations yet</p>
                        <p style="font-size: 0.9rem;">Start your first conversation!</p>
                    </div>
                `;
            } else {
                conversations.forEach(conv => {
                    const participant = conv.participants[0];
                    const timeAgo = conv.lastMessageAt ? getTimeAgo(new Date(conv.lastMessageAt)) : '';
                    
                    html += `
                        <div class="conversation-item" onclick="openConversation('${conv.id}', '${participant.username}')">
                            <div class="user-avatar">${(participant.firstName?.[0] || participant.username[0]).toUpperCase()}</div>
                            <div class="conversation-info">
                                <div class="conversation-name">${participant.firstName || participant.username}</div>
                                <div class="conversation-preview">${conv.lastMessageContent || 'No messages yet'} ${timeAgo ? '‚Ä¢ ' + timeAgo : ''}</div>
                            </div>
                        </div>
                    `;
                });
            }

            body.innerHTML = html;
        }

        function showNewConversationForm() {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">‚Üê</button>
                    <span style="font-weight: bold;">New Conversation</span>
                </div>
                
                <div style="padding: 1rem; text-align: center;">
                    <div style="color: #666; margin-bottom: 1rem;">
                        <p>To start a new conversation, use the search bar at the top of the page to find users.</p>
                        <p style="font-size: 0.9rem;">Search results will include options to message, follow, and add as friend.</p>
                    </div>
                    <button onclick="document.getElementById('searchInput').focus(); openSearch();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Open Search
                    </button>
                </div>
            `;
            
            // Focus on search input
            setTimeout(() => {
                document.getElementById('userSearchInput')?.focus();
            }, 100);
        }


        async function startConversationWithUser(userId, username) {
            try {
                const response = await apiCall('/messages/conversations', {
                    method: 'POST',
                    body: JSON.stringify({ participantId: userId })
                });

                if (response.ok) {
                    // Open the conversation
                    openConversation(response.data.conversation.id, username);
                } else {
                    alert('Failed to start conversation');
                }
            } catch (error) {
                console.error('Failed to start conversation:', error);
                alert('Error starting conversation');
            }
        }

        async function openConversation(conversationId, username) {
            try {
                // Load messages for this conversation
                const response = await apiCall(`/messages/conversations/${conversationId}/messages`);
                
                if (response.ok) {
                    showConversationView(conversationId, username, response.data.messages);
                } else {
                    alert('Failed to load conversation');
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
                alert('Error loading conversation');
            }
        }

        function showConversationView(conversationId, username, messages) {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">‚Üê</button>
                    <div class="user-avatar" style="margin-right: 0.5rem;">${username[0].toUpperCase()}</div>
                    <span style="font-weight: bold;">${username}</span>
                </div>
                
                <div id="messagesArea" style="height: 250px; overflow-y: auto; padding: 0.5rem; background: white;">
                    ${messages.length === 0 ? 
                        '<div style="text-align: center; padding: 2rem; color: #666;">No messages yet. Start the conversation!</div>' :
                        messages.map(msg => `
                            <div style="margin-bottom: 0.75rem; ${msg.sender.id === currentUser?.id ? 'text-align: right;' : ''}">
                                <div style="display: inline-block; max-width: 80%; padding: 0.5rem 0.75rem; border-radius: 12px; ${
                                    msg.sender.id === currentUser?.id ? 
                                    'background: #4b5c09; color: white;' : 
                                    'background: #f0f0f0; color: black;'
                                }">
                                    <div style="font-size: 0.9rem;">${msg.content}</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.8;">
                                        ${msg.sender.id === currentUser?.id ? '' : msg.sender.username + ' ‚Ä¢ '}${new Date(msg.createdAt).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                
                <div style="display: flex; padding: 1vh; border-top: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <input 
                        type="text" 
                        id="messageInput-${conversationId}" 
                        placeholder="Type a message..." 
                        style="flex: 1; padding: 0.5vh; border: 1px solid #ddd; border-radius: 20px; margin-right: 0.5rem; outline: none;"
                        onkeypress="handleMessageKeyPress(event, '${conversationId}')"
                    >
                    <button 
                        onclick="sendMessage('${conversationId}')" 
                        style="background: #4b5c09; color: white; border: none; padding: 0.5vh 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem;"
                    >
                        Send
                    </button>
                </div>
            `;
            
            // Scroll to bottom of messages
            setTimeout(() => {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById(`messageInput-${conversationId}`)?.focus();
            }, 100);
        }

        function backToConversations() {
            loadConversations();
        }

        function handleMessageKeyPress(event, conversationId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(conversationId);
            }
        }

        async function sendMessage(conversationId) {
            const input = document.getElementById(`messageInput-${conversationId}`);
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                const response = await apiCall(`/messages/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    input.value = '';
                    // Refresh the conversation to show the new message
                    const username = document.querySelector('#messagesBody span[style*="font-weight: bold"]')?.textContent;
                    if (username) {
                        openConversation(conversationId, username);
                    }
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Error sending message');
            }
        }

        // Profile Functions - Updated to use main content area
        function toggleProfile() {
            // Use the new My Profile component instead of the old side panel
            showMyProfile();
        }

        // New function to show My Profile in main content area
        function showMyProfile() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your profile</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            // Hide all panels and show profile in main content
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            window.myProfile.render('mainContent');
        }

        // New function to toggle My Profile - shows/hides profile window
        function toggleMyProfile() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your profile</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            const mainContent = document.getElementById('mainContent');
            const isProfileCurrentlyShown = mainContent.querySelector('.my-profile') !== null;
            
            if (isProfileCurrentlyShown) {
                // Profile is currently shown, hide it and show default view
                showDefaultView();
            } else {
                // Profile is not shown, show it
                showMyProfile();
            }
        }

        // Function to show default view when all windows are closed
        function showDefaultView() {
            // Hide all side panels
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            closeAllPanels();
            
            // Show My Feed in main content area as default, or map if user is not logged in
            if (authToken) {
                showMyFeedInMain();
            } else {
                // For logged-out users, show the map or welcome screen
                if (window.map && typeof window.map.showMap === 'function') {
                    window.map.showMap();
                } else {
                    // Fallback to welcome screen
                    document.getElementById('mainContent').innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <h2>Welcome to United We Rise</h2>
                            <p>Connect with your community and engage in meaningful political discourse.</p>
                            <button onclick="openAuthModal('login')" class="btn">Log In</button>
                            <button onclick="openAuthModal('register')" class="btn" style="margin-left: 1rem;">Sign Up</button>
                        </div>
                    `;
                }
            }
        }

        // Toggle function for My Feed - shows/hides feed window in main content area
        function toggleMyFeed() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your feed</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            const mainContent = document.getElementById('mainContent');
            const isFeedCurrentlyShown = mainContent.querySelector('.my-feed') !== null;
            
            if (isFeedCurrentlyShown) {
                // Feed is currently shown, hide it and show default view
                showDefaultView();
            } else {
                // Feed is not shown, show it
                showMyFeedInMain();
            }
        }

        // Function to show My Feed in main content area (like Profile)
        async function showMyFeedInMain() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your feed</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            // Hide other content
            closeAllPanels();
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            
            // Show My Feed in main content area
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="my-feed">
                    <div class="sticky-composer-wrapper">
                        <div class="quick-post-composer">
                            <textarea id="feedPostContent" placeholder="What's on your mind?" style="width: 100%; min-height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <label for="feedMediaUpload" style="background: #666; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem;">
                                        üì∑ Add Media
                                        <input type="file" id="feedMediaUpload" multiple accept="image/*,video/*" style="display: none;" onchange="handleFeedMediaUpload(this)">
                                    </label>
                                    <div id="feedMediaPreview" style="margin-top: 0.5rem;"></div>
                                </div>
                                <button onclick="createFeedPost()" class="btn">Post</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="myFeedPosts" style="margin-top: 1rem;">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>Loading your personalized feed...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Load the posts
            await loadMyFeedPosts();
            
            // Apply background if user has one
            if (currentUser && currentUser.backgroundImage) {
                applyUserBackground(currentUser.backgroundImage);
            }
        }

        // Load posts for My Feed in main area
        async function loadMyFeedPosts() {
            try {
                const response = await apiCall('/feed/posts', {
                    method: 'GET'
                });
                
                if (response.ok && response.data.posts) {
                    displayMyFeedPosts(response.data.posts);
                } else {
                    document.getElementById('myFeedPosts').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No posts in your feed yet. Follow some users to see their posts here!</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Feed loading error:', error);
                document.getElementById('myFeedPosts').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p>Unable to load your feed. Please try again.</p>
                        <button onclick="loadMyFeedPosts()" class="btn">Retry</button>
                    </div>
                `;
            }
        }

        // Display posts in My Feed
        function displayMyFeedPosts(posts) {
            const container = document.getElementById('myFeedPosts');
            
            if (!posts || posts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>No posts in your feed yet. Follow some users to see their posts here!</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            posts.forEach(post => {
                html += createPostHTML(post);
            });
            
            container.innerHTML = html;
        }

        // Load content into the My Feed panel
        async function loadMyFeedPanel() {
            const feedContent = document.getElementById('myFeedContent');
            
            try {
                feedContent.innerHTML = `
                    <div class="post-composer" style="margin: 1rem; border-bottom: 1px solid #eee; padding-bottom: 1rem;">
                        <textarea id="panelFeedPostContent" placeholder="What's on your mind?" style="width: 100%; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; resize: vertical; min-height: 80px;"></textarea>
                        <div style="margin-top: 0.5rem; text-align: right;">
                            <button onclick="createPostFromPanel()" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Post</button>
                        </div>
                    </div>
                    <div id="panelFeedPosts">
                        <div class="feed-loading">Loading your personalized feed...</div>
                    </div>
                `;

                // Load feed posts
                await loadFeedPosts('panelFeedPosts');
                
                // Add infinite scroll
                const feedContainer = document.getElementById('myFeedContent');
                feedContainer.addEventListener('scroll', handleFeedScroll);
                
            } catch (error) {
                console.error('Error loading My Feed panel:', error);
                feedContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Unable to load feed. Please try again.</p>
                        <button onclick="loadMyFeedPanel()" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Retry</button>
                    </div>
                `;
            }
        }

        // Variables for infinite scroll
        let currentFeedPage = 1;
        let isLoadingMorePosts = false;
        let hasMorePosts = true;

        // Load feed posts into specified container
        async function loadFeedPosts(containerId, page = 1) {
            try {
                const response = await apiCall('/feed/posts', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const posts = response.posts || [];
                const container = document.getElementById(containerId);
                
                if (page === 1) {
                    // First load - replace content
                    container.innerHTML = '';
                    currentFeedPage = 1;
                    hasMorePosts = true;
                }

                if (posts.length === 0) {
                    if (page === 1) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <p>No posts in your feed yet.</p>
                                <p>Follow some users to see their posts here!</p>
                            </div>
                        `;
                    }
                    hasMorePosts = false;
                    return;
                }

                // Render posts
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    container.appendChild(postElement);
                });

                // Update pagination
                currentFeedPage = page;
                if (posts.length < 10) { // Assuming 10 posts per page
                    hasMorePosts = false;
                }

            } catch (error) {
                console.error('Error loading feed posts:', error);
                const container = document.getElementById(containerId);
                if (page === 1) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>Unable to load feed posts.</p>
                            <button onclick="loadFeedPosts('${containerId}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Retry</button>
                        </div>
                    `;
                }
            }
        }

        // Handle infinite scroll
        function handleFeedScroll(event) {
            if (isLoadingMorePosts || !hasMorePosts) return;

            const element = event.target;
            const threshold = 100; // Load more when 100px from bottom
            
            if (element.scrollTop + element.clientHeight >= element.scrollHeight - threshold) {
                loadMorePosts();
            }
        }

        // Load more posts for infinite scroll
        async function loadMorePosts() {
            if (isLoadingMorePosts || !hasMorePosts) return;
            
            isLoadingMorePosts = true;
            const container = document.getElementById('panelFeedPosts') || document.getElementById('myFeedPosts');
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'feed-loading';
            loadingDiv.innerHTML = 'Loading more posts...';
            container.appendChild(loadingDiv);

            try {
                const nextPage = currentFeedPage + 1;
                const response = await apiCall(`/api/feed/posts?page=${nextPage}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                const posts = response.posts || [];
                
                // Remove loading indicator
                container.removeChild(loadingDiv);

                if (posts.length === 0) {
                    hasMorePosts = false;
                    const endDiv = document.createElement('div');
                    endDiv.className = 'feed-end-indicator';
                    endDiv.innerHTML = "You're all caught up! üéâ";
                    container.appendChild(endDiv);
                    return;
                }

                // Add new posts
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    container.appendChild(postElement);
                });

                currentFeedPage = nextPage;
                if (posts.length < 10) {
                    hasMorePosts = false;
                }

            } catch (error) {
                console.error('Error loading more posts:', error);
                container.removeChild(loadingDiv);
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'feed-loading';
                errorDiv.innerHTML = `
                    <span>Failed to load more posts.</span>
                    <button onclick="loadMorePosts()" style="margin-left: 1rem; background: #4b5c09; color: white; border: none; padding: 0.25rem 0.5rem; border-radius: 3px; cursor: pointer;">Retry</button>
                `;
                container.appendChild(errorDiv);
            }

            isLoadingMorePosts = false;
        }

        // Create post from panel composer
        async function createPostFromPanel() {
            const textarea = document.getElementById('panelFeedPostContent');
            const content = textarea.value.trim();
            
            if (!content) {
                alert('Please enter some content for your post.');
                return;
            }

            try {
                const response = await apiCall('/api/posts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({
                        content: content,
                        isPolitical: false // Can be enhanced later with detection
                    })
                });

                if (response.success) {
                    textarea.value = '';
                    // Refresh the feed
                    await loadFeedPosts('panelFeedPosts');
                    showToast('Post created successfully!', 'success');
                } else {
                    throw new Error(response.error || 'Failed to create post');
                }

            } catch (error) {
                console.error('Error creating post:', error);
                showToast('Failed to create post. Please try again.', 'error');
            }
        }

        // New function to show My Feed - personalized feed based on who user follows
        async function showMyFeed() {
            // Use the correct main content area implementation
            showMyFeedInMain();
        }


        // Global variable to store selected media for post
        let selectedPostMedia = null;

        // Function to trigger media upload
        function attachMediaToPost() {
            document.getElementById('postMediaUpload').click();
        }

        // Function to handle media selection and preview
        async function handlePostMediaUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid image file (JPEG, PNG, WebP, or GIF)');
                input.value = '';
                return;
            }

            // Validate file size (10MB for images, 5MB for GIFs)
            const maxSize = file.type === 'image/gif' ? 5 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                const limitMB = file.type === 'image/gif' ? 5 : 10;
                alert(`File too large. ${file.type === 'image/gif' ? 'GIFs' : 'Images'} must be smaller than ${limitMB}MB`);
                input.value = '';
                return;
            }

            // Store selected file
            selectedPostMedia = file;

            // Show preview
            const previewArea = document.getElementById('mediaPreview');
            const previewContent = previewArea.querySelector('.media-preview-content');
            
            // Create preview element
            const fileURL = URL.createObjectURL(file);
            const isGif = file.type === 'image/gif';
            
            previewContent.innerHTML = `
                <div class="media-item">
                    <img src="${fileURL}" alt="Preview" 
                         style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;">
                    <div class="media-info">
                        <p><strong>${file.name}</strong></p>
                        <p>${isGif ? 'üéûÔ∏è GIF' : 'üì∑ Image'} ‚Ä¢ ${(file.size / 1024 / 1024).toFixed(1)}MB</p>
                    </div>
                </div>
            `;
            
            previewArea.style.display = 'block';
        }

        // Function to clear media attachment
        function clearMediaAttachment() {
            selectedPostMedia = null;
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('postMediaUpload').value = '';
        }

        // Function to create post from feed view
        async function createPostFromFeed() {
            const content = document.getElementById('feedPostContent').value.trim();

            if (!content && !selectedPostMedia) {
                alert('Please enter some content or attach media for your post');
                return;
            }

            try {
                let mediaId = null;

                // Upload media first if selected
                if (selectedPostMedia) {
                    const formData = new FormData();
                    formData.append('photos', selectedPostMedia);
                    formData.append('photoType', 'POST_MEDIA');
                    formData.append('purpose', 'PERSONAL');

                    console.log('üñºÔ∏è Uploading media for post...');
                    const mediaResponse = await apiCall('/photos/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!mediaResponse.ok) {
                        const errorData = mediaResponse.data || {};
                        const errorMessage = errorData.message || errorData.error || 'Failed to upload media';
                        alert(`Media upload failed: ${errorMessage}`);
                        return;
                    }

                    // Get the uploaded photo ID
                    mediaId = mediaResponse.data.photos[0]?.id;
                    console.log('‚úÖ Media uploaded successfully:', mediaId);
                }

                // Create the post
                const postData = { content };
                if (mediaId) {
                    postData.mediaId = mediaId;
                }

                const response = await apiCall('/posts', {
                    method: 'POST',
                    body: JSON.stringify(postData)
                });

                if (response.ok) {
                    // Clear the form
                    document.getElementById('feedPostContent').value = '';
                    clearMediaAttachment();
                    
                    // Refresh the feed to show the new post
                    showMyFeed();
                    
                    console.log('‚úÖ Post created successfully');
                } else {
                    alert('Failed to create post. Please try again.');
                }
            } catch (error) {
                console.error('Post creation error:', error);
                alert('Error creating post. Please check your connection and try again.');
            }
        }

        async function loadUserProfile() {
            if (!authToken) {
                document.getElementById('profileBody').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view your profile</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }

            try {
                console.log('Loading user profile...');
                const response = await apiCall('/users/profile');
                
                console.log('Profile response:', response);
                
                if (response.ok) {
                    const data = response.data;
                    displayUserProfile(data.user);
                } else {
                    const errorMsg = response.data?.error || 'Failed to load profile';
                    document.getElementById('profileBody').innerHTML = `<p style="color: #d32f2f;">Error: ${errorMsg}</p>`;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                document.getElementById('profileBody').innerHTML = '<p style="color: #d32f2f;">Network error loading profile</p>';
            }
        }

        function displayUserProfile(user) {
            const body = document.getElementById('profileBody');
            
            let html = `
                <div class="profile-section">
                    <h3>Basic Information</h3>
                    <p><strong>Username:</strong> @${user.username}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    ${user.firstName ? `<p><strong>Name:</strong> ${user.firstName} ${user.lastName || ''}</p>` : ''}
                    ${user.bio ? `<p><strong>Bio:</strong> ${user.bio}</p>` : ''}
                    ${user.website ? `<p><strong>Website:</strong> <a href="${user.website}" target="_blank">${user.website}</a></p>` : ''}
                </div>

                <div class="profile-section">
                    <h3>Social Stats</h3>
                    <p><strong>Followers:</strong> <a href="#" onclick="showFollowersList('${user.id}')" style="color: #4b5c09; text-decoration: none;">${user.followersCount}</a></p>
                    <p><strong>Following:</strong> <a href="#" onclick="showFollowingList('${user.id}')" style="color: #4b5c09; text-decoration: none;">${user.followingCount}</a></p>
                </div>
            `;

            if (user.politicalProfileType && user.politicalProfileType !== 'CITIZEN') {
                html += `
                    <div class="profile-section">
                        <h3>Political Profile</h3>
                        <p><strong>Type:</strong> ${user.politicalProfileType.replace('_', ' ')}</p>
                        ${user.office ? `<p><strong>Office:</strong> ${user.office}</p>` : ''}
                        ${user.officialTitle ? `<p><strong>Title:</strong> ${user.officialTitle}</p>` : ''}
                        <p><strong>Verification:</strong> ${user.verificationStatus}</p>
                    </div>
                `;
            }

            if (user.streetAddress) {
                html += `
                    <div class="profile-section">
                        <h3>Location</h3>
                        <p>${user.streetAddress}<br>${user.city}, ${user.state} ${user.zipCode}</p>
                    </div>
                `;
            }

            html += `
                <div class="profile-section">
                    <button class="btn" onclick="editProfile()">Edit Profile</button>
                </div>
            `;

            body.innerHTML = html;
        }

        function editProfile() {
            const body = document.getElementById('profileBody');
            
            if (!currentUser) return;
            
            body.innerHTML = `
                <form id="profileEditForm">
                    <div class="profile-section">
                        <h3>Basic Information</h3>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="editFirstName" value="${currentUser.firstName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="editLastName" value="${currentUser.lastName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea id="editBio" style="width: 100%; height: 80px; box-sizing: border-box;">${currentUser.bio || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" id="editWebsite" value="${currentUser.website || ''}">
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Political Profile</h3>
                        <div class="form-group">
                            <label>Profile Type</label>
                            <select id="editPoliticalType" onchange="updatePoliticalFields()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="CITIZEN" ${(currentUser.politicalProfileType || 'CITIZEN') === 'CITIZEN' ? 'selected' : ''}>Citizen</option>
                                <option value="CANDIDATE" ${currentUser.politicalProfileType === 'CANDIDATE' ? 'selected' : ''}>Political Candidate</option>
                                <option value="ELECTED_OFFICIAL" ${currentUser.politicalProfileType === 'ELECTED_OFFICIAL' ? 'selected' : ''}>Elected Official</option>
                                <option value="POLITICAL_ORG" ${currentUser.politicalProfileType === 'POLITICAL_ORG' ? 'selected' : ''}>Political Organization</option>
                            </select>
                        </div>
                        
                        <div id="politicalFieldsContainer">
                            <!-- Political fields will be populated here -->
                        </div>
                        
                        <div id="verificationSection" style="display: none;">
                            <div style="background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #4b5c09;">Political Verification</h4>
                                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                                    Political candidates and elected officials require verification. Upload supporting documents to verify your political status.
                                </p>
                                
                                <div class="form-group">
                                    <label>Current Verification Status</label>
                                    <div style="padding: 0.5rem; background: ${getVerificationStatusColor(currentUser.verificationStatus)}; border-radius: 4px; font-weight: bold;">
                                        ${getVerificationStatusText(currentUser.verificationStatus)}
                                    </div>
                                </div>
                                
                                ${currentUser.verificationStatus === 'PENDING' || currentUser.verificationStatus === 'DENIED' ? `
                                <div class="form-group">
                                    <label>Upload Verification Documents</label>
                                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                                        Upload documents that verify your political status (e.g., filing papers, official campaign documents, government ID with title, etc.)
                                    </p>
                                    <input type="file" id="verificationDocs" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="width: 100%;">
                                    <button type="button" onclick="uploadVerificationDocs()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Upload Documents
                                    </button>
                                </div>
                                ` : ''}
                                
                                ${currentUser.verificationStatus === 'APPROVED' ? `
                                <div style="color: #2e7d32; font-weight: bold;">
                                    ‚úÖ Your political profile has been verified!
                                </div>
                                ` : ''}
                                
                                ${currentUser.verificationStatus === 'DENIED' ? `
                                <div style="color: #d32f2f; font-weight: bold;">
                                    ‚ùå Verification was denied. Please upload additional documentation or contact support.
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Custom Background Image</h3>
                        <div class="background-settings">
                            <p style="color: #666; margin-bottom: 1rem;">
                                Set a custom background image for your Profile and My Feed. This will be visible to others when they view your profile.
                            </p>
                            
                            <div class="background-upload-container">
                                <div class="background-preview" id="backgroundPreview" ${currentUser.backgroundImage ? `style="background-image: url(${currentUser.backgroundImage})"` : ''}>
                                    ${currentUser.backgroundImage ? '' : 'No background set'}
                                </div>
                                
                                <div>
                                    <input type="file" id="backgroundImageFile" accept="image/*" style="display: none;" onchange="handleBackgroundImageSelect(this)">
                                    <button type="button" class="background-upload-btn" onclick="document.getElementById('backgroundImageFile').click()">
                                        Choose Background Image
                                    </button>
                                    ${currentUser.backgroundImage ? `
                                        <button type="button" class="background-remove-btn" onclick="removeBackgroundImage()">
                                            Remove Background
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Address (for finding your elected officials)</h3>
                        <div id="profileAddressForm"></div>
                    </div>
                    
                    <div class="profile-section">
                        <button type="button" class="btn" onclick="saveProfile()">Save Changes</button>
                        <button type="button" class="btn-secondary btn" onclick="cancelEditProfile()">Cancel</button>
                    </div>
                </form>
            `;
            
            // Initialize the address form
            addressForm = createAddressForm({
                containerId: 'profileAddressForm',
                initialValues: {
                    streetAddress: currentUser.streetAddress || '',
                    city: currentUser.city || '',
                    state: currentUser.state || '',
                    zipCode: currentUser.zipCode || ''
                },
                onChange: (data) => {
                    // Address data changed - could trigger validation or auto-save
                    console.log('Address updated:', data);
                },
                required: false
            });
            
            // Initialize political fields
            updatePoliticalFields();
        }

        function getVerificationStatusColor(status) {
            switch(status) {
                case 'APPROVED': return '#e8f5e8';
                case 'DENIED': return '#ffebee';
                case 'PENDING': return '#fff3e0';
                default: return '#f5f5f5';
            }
        }

        function getVerificationStatusText(status) {
            switch(status) {
                case 'APPROVED': return '‚úÖ Verified';
                case 'DENIED': return '‚ùå Verification Denied';
                case 'PENDING': return '‚è≥ Verification Pending';
                case 'NOT_REQUIRED': return 'Not Required';
                default: return 'Unknown';
            }
        }

        function updatePoliticalFields() {
            const politicalType = document.getElementById('editPoliticalType')?.value;
            const container = document.getElementById('politicalFieldsContainer');
            const verificationSection = document.getElementById('verificationSection');
            
            if (!container) return;
            
            let fieldsHtml = '';
            
            if (politicalType === 'CANDIDATE') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Political Party (optional)</label>
                        <input type="text" id="editPoliticalParty" value="${currentUser.politicalParty || ''}" placeholder="e.g., Democratic, Republican, Independent">
                    </div>
                    <div class="form-group">
                        <label>Office Seeking</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., Mayor of Springfield, State Senator District 5">
                    </div>
                    <div class="form-group">
                        <label>Campaign Website (optional)</label>
                        <input type="url" id="editCampaignWebsite" value="${currentUser.campaignWebsite || ''}" placeholder="https://...">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Political Party (optional)</label>
                        <input type="text" id="editPoliticalParty" value="${currentUser.politicalParty || ''}" placeholder="e.g., Democratic, Republican, Independent">
                    </div>
                    <div class="form-group">
                        <label>Current Office</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., Mayor of Springfield, State Senator District 5">
                    </div>
                    <div class="form-group">
                        <label>Official Title</label>
                        <input type="text" id="editOfficialTitle" value="${currentUser.officialTitle || ''}" placeholder="e.g., The Honorable, Mayor, Senator">
                    </div>
                    <div class="form-group">
                        <label>Term Start Date (optional)</label>
                        <input type="date" id="editTermStart" value="${currentUser.termStart ? new Date(currentUser.termStart).toISOString().split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label>Term End Date (optional)</label>
                        <input type="date" id="editTermEnd" value="${currentUser.termEnd ? new Date(currentUser.termEnd).toISOString().split('T')[0] : ''}">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else if (politicalType === 'POLITICAL_ORG') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Organization Type</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., PAC, SuperPAC, Campaign Committee, Party Organization">
                    </div>
                    <div class="form-group">
                        <label>Organization Website (optional)</label>
                        <input type="url" id="editCampaignWebsite" value="${currentUser.campaignWebsite || ''}" placeholder="https://...">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else {
                // CITIZEN - no additional fields needed
                verificationSection.style.display = 'none';
            }
            
            container.innerHTML = fieldsHtml;
        }

        async function uploadVerificationDocs() {
            const fileInput = document.getElementById('verificationDocs');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            // In a real implementation, you would upload these files to your server
            // For now, we'll just simulate the upload
            alert(`${files.length} document(s) selected for upload. In a real implementation, these would be uploaded to the server for review.`);
            
            // Update verification status to pending after upload
            // This would normally be handled by the server after successful upload
        }

        function cancelEditProfile() {
            loadUserProfile(); // Reload the view mode
        }

        async function saveProfile() {
            // Validate address form first
            if (addressForm && !addressForm.validate()) {
                alert('Please fix address form errors before saving');
                return;
            }

            const profileData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                bio: document.getElementById('editBio').value,
                website: document.getElementById('editWebsite').value
            };

            // Get address data from the address form
            const addressData = addressForm ? addressForm.getData() : {};
            
            // Get political profile data
            const politicalType = document.getElementById('editPoliticalType').value;
            const politicalData = {
                streetAddress: addressData.streetAddress || '',
                city: addressData.city || '',
                state: addressData.state || '',
                zipCode: addressData.zipCode || '',
                politicalProfileType: politicalType
            };

            // Add political-specific fields based on type
            if (politicalType === 'CANDIDATE') {
                politicalData.politicalParty = document.getElementById('editPoliticalParty')?.value || '';
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                politicalData.politicalParty = document.getElementById('editPoliticalParty')?.value || '';
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.officialTitle = document.getElementById('editOfficialTitle')?.value || '';
                
                const termStart = document.getElementById('editTermStart')?.value;
                const termEnd = document.getElementById('editTermEnd')?.value;
                if (termStart) politicalData.termStart = new Date(termStart).toISOString();
                if (termEnd) politicalData.termEnd = new Date(termEnd).toISOString();
            } else if (politicalType === 'POLITICAL_ORG') {
                politicalData.office = document.getElementById('editOffice')?.value || ''; // Using office field for org type
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            }

            try {
                // Update basic profile
                const profileResponse = await apiCall('/users/profile', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });

                // Update political/address info
                const politicalResponse = await apiCall('/political/profile', {
                    method: 'PUT',
                    body: JSON.stringify(politicalData)
                });
                
                console.log('Political profile update response:', politicalResponse.status);

                if (profileResponse.ok && politicalResponse.ok) {
                    // Update current user object
                    const updatedProfile = await apiCall('/users/profile');
                    if (updatedProfile.ok) {
                        const data = await updatedProfile.json();
                        currentUser = data.user;
                    }
                    
                    loadUserProfile(); // Switch back to view mode
                    
                    // Show different messages based on political type change
                    if (politicalType !== 'CITIZEN' && (currentUser.politicalProfileType === 'CITIZEN' || currentUser.verificationStatus === 'PENDING')) {
                        alert('Profile updated successfully! Your political profile will need to be verified by our team. Please upload verification documents if you haven\'t already.');
                    } else {
                        alert('Profile updated successfully!');
                    }
                } else {
                    alert('Failed to update profile. Please try again.');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Trending-specific like and comment functions
        async function likeTrendingPost(postId) {
            if (!authToken) {
                alert('Please log in to like posts');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Just update the like count in place, don't refresh whole panel
                    updateLikeCount(postId, data.liked);
                }
            } catch (error) {
                console.error('Failed to like trending post:', error);
            }
        }

        function updateLikeCount(postId, isLiked) {
            // Find the like button for this post and update its count
            const likeButtons = document.querySelectorAll(`[onclick*="likeTrendingPost('${postId}')"]`);
            likeButtons.forEach(button => {
                const currentText = button.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
                const newCount = isLiked ? currentCount + 1 : Math.max(0, currentCount - 1);
                button.innerHTML = `‚ù§Ô∏è ${newCount}`;
            });
        }

        function showTrendingCommentBox(postId) {
            if (!authToken) {
                alert('Please log in to comment');
                return;
            }
            document.getElementById(`trending-comments-${postId}`).style.display = 'block';
        }

        function hideTrendingCommentBox(postId) {
            document.getElementById(`trending-comments-${postId}`).style.display = 'none';
            document.getElementById(`trending-comment-input-${postId}`).value = '';
        }

        async function addTrendingComment(postId) {
            const content = document.getElementById(`trending-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST'
                });

                if (response.ok) {
                    hideTrendingCommentBox(postId);
                    // Just update the comment count, don't refresh whole panel
                    updateCommentCount(postId);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        function updateCommentCount(postId) {
            // Find the comment button for this post and increment its count
            const commentButtons = document.querySelectorAll(`[onclick*="showTrendingCommentBox('${postId}')"]`);
            commentButtons.forEach(button => {
                const currentText = button.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
                const newCount = currentCount + 1;
                button.innerHTML = `üí¨ ${newCount}`;
            });
        }

        // Comment Functions
        function showCommentBox(postId) {
            document.getElementById(`comments-${postId}`).style.display = 'block';
        }

        function hideCommentBox(postId) {
            document.getElementById(`comments-${postId}`).style.display = 'none';
            document.getElementById(`comment-input-${postId}`).value = '';
        }

        async function addComment(postId) {
            const content = document.getElementById(`comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    hideCommentBox(postId);
                    // Reload posts to show updated comment count
                    loadUserPosts();
                    // Also refresh trending if that's open
                    if (!document.getElementById('panel-trending').classList.contains('hidden')) {
                        loadTrendingPosts();
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        // Posts Functions
        async function createPost() {
            const content = document.getElementById('postContent').value.trim();

            if (!content) {
                alert('Please enter some content for your post');
                return;
            }

            try {
                const response = await apiCall('/posts', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        content
                    })
                });

                if (response.ok) {
                    document.getElementById('postContent').value = '';
                    loadUserPosts();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create post');
                }
            } catch (error) {
                console.error('Failed to create post:', error);
                alert('Network error. Please try again.');
            }
        }

        async function loadUserPosts() {
            if (!authToken) return;

            try {
                const response = await apiCall('/posts/me');
                
                if (response.ok) {
                    // Store posts for later display when feed view is shown
                    window.userPostsCache = response.data.posts;
                } else {
                    console.error('Failed to load user posts:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }

        function displayPosts(posts, containerId = 'postsFeed', showHeader = true) {
            const feed = document.getElementById(containerId);
            if (!feed) {
                console.warn('Feed container not found:', containerId);
                return;
            }
            
            if (posts.length === 0) {
                feed.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h2>Your Posts</h2>
                        <p>You haven't posted anything yet. Share your thoughts above!</p>
                    </div>
                `;
                return;
            }

            // Use the standardized PostComponent if available
            if (window.postComponent) {
                let html = showHeader ? '<h2>Your Posts</h2>' : '';
                html += '<div class="posts-list">';
                
                posts.forEach(post => {
                    html += window.postComponent.renderPost(post, {
                        showActions: true,
                        showComments: true,
                        showAuthor: true,
                        showTimestamp: true,
                        compactView: false
                    });
                });
                
                html += '</div>';
                feed.innerHTML = html;
            } else {
                // Fallback to original rendering if PostComponent not available
                displayPostsFallback(posts, containerId, showHeader);
            }
        }

        function displayPostsFallback(posts, containerId, showHeader = true) {
            const feed = document.getElementById(containerId);
            if (!feed) return;

            let html = showHeader ? '<h2>Your Posts</h2>' : '';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                
                html += `
                    <div class="post-item" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="user-avatar">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                            <div>
                                <strong>${post.author.firstName || post.author.username}</strong>
                                ${post.author.verified ? '<span style="color: #1976d2;">‚úì</span>' : ''}
                                <br>
                                <small style="color: #666;">@${post.author.username} ‚Ä¢ ${timeAgo}</small>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-actions">
                            <span class="post-action" onclick="likePost('${post.id}', event)" style="cursor: pointer; transition: transform 0.2s;">
                                ${post.isLiked ? '‚ù§Ô∏è' : 'üëç'} ${post.likesCount || 0}
                            </span>
                            <span class="post-action" onclick="showCommentBox('${post.id}')">
                                üí¨ Add Comment
                            </span>
                            ${post.commentsCount > 0 ? `<span class="post-action" onclick="viewComments('${post.id}')" style="color: #4b5c09;">üëÅÔ∏è View ${post.commentsCount} Comment${post.commentsCount === 1 ? '' : 's'}</span>` : ''}
                        </div>
                        <div id="comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            feed.innerHTML = html;
        }

        async function likePost(postId, event) {
            if (!authToken) {
                alert('Please log in to like posts');
                return;
            }

            // Find the like button element
            const likeElement = event ? event.target.closest('[onclick*="likePost"]') : document.querySelector(`[onclick*="likePost('${postId}'"]`);
            if (!likeElement) return;

            try {
                const response = await apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update the UI immediately
                    if (likeElement.tagName === 'BUTTON') {
                        // For button-style like elements (in feed)
                        const countSpan = likeElement.querySelector('span:last-child') || likeElement;
                        const currentCount = parseInt(countSpan.textContent) || 0;
                        const newCount = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
                        
                        // Update the display
                        likeElement.innerHTML = `<span>${data.liked ? '‚ù§Ô∏è' : 'üëç'}</span> ${newCount}`;
                    } else if (likeElement.classList.contains('post-action')) {
                        // For span-style like elements (in profile)
                        const currentCount = parseInt(likeElement.textContent.match(/\d+/)?.[0] || '0');
                        const newCount = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
                        likeElement.innerHTML = `${data.liked ? '‚ù§Ô∏è' : 'üëç'} ${newCount}`;
                    }
                    
                    // Add visual feedback
                    likeElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        likeElement.style.transform = '';
                    }, 200);
                }
            } catch (error) {
                console.error('Failed to like post:', error);
                alert('Failed to like post. Please try again.');
            }
        }

        async function viewComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // If comments are already visible, hide them
            if (commentsContainer && commentsContainer.style.display === 'block') {
                commentsContainer.style.display = 'none';
                return;
            }

            try {
                // Load comments
                const response = await apiCall(`/posts/${postId}/comments?limit=50`);
                if (!response.ok) {
                    alert('Failed to load comments');
                    return;
                }
                const data = response.data;

                showCommentsInline(postId, data.comments);
            } catch (error) {
                console.error('Failed to load comments:', error);
                alert('Network error. Please try again.');
            }
        }

        function showCommentsInline(postId, comments) {
            let commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // Create comments container if it doesn't exist
            if (!commentsContainer) {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (!postElement) return;
                
                commentsContainer = document.createElement('div');
                commentsContainer.id = `post-comments-${postId}`;
                commentsContainer.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; background: #f9f9f9; border-radius: 8px; padding: 1rem;';
                postElement.appendChild(commentsContainer);
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: #4b5c09;">Comments (${comments.length})</h4>
                    <button onclick="hideComments('${postId}')" style="background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
            `;

            if (comments.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 1rem;">No comments yet</div>';
            } else {
                comments.forEach(comment => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <img src="${comment.user.avatar || '/default-avatar.png'}" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 0.5rem;">
                                <div>
                                    <div style="font-weight: bold; font-size: 0.85rem;">${comment.user.firstName || comment.user.username} ${comment.user.lastName || ''}</div>
                                    <div style="color: #666; font-size: 0.75rem;">@${comment.user.username}</div>
                                </div>
                                ${comment.user.verified ? '<span style="color: #1d9bf0; margin-left: 5px; font-size: 0.8rem;">‚úì</span>' : ''}
                                <div style="margin-left: auto; color: #666; font-size: 0.75rem;">
                                    ${new Date(comment.createdAt).toLocaleString()}
                                </div>
                            </div>
                            <div style="margin-left: 32px; line-height: 1.4;">
                                ${comment.content}
                            </div>
                        </div>
                    `;
                });
            }

            // Add comment form if user is logged in
            if (authToken) {
                html += `
                    <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <textarea id="inline-comment-input-${postId}" placeholder="Add a comment..." style="width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; box-sizing: border-box; resize: vertical; font-family: inherit; font-size: 0.9rem;"></textarea>
                        <div style="margin-top: 0.75rem; text-align: right;">
                            <button onclick="addInlineComment('${postId}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Post Comment</button>
                        </div>
                    </div>
                `;
            }

            commentsContainer.innerHTML = html;
            commentsContainer.style.display = 'block';
        }

        function hideComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            if (commentsContainer) {
                commentsContainer.style.display = 'none';
            }
        }

        async function addInlineComment(postId) {
            const content = document.getElementById(`inline-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    // Refresh the comments display
                    viewComments(postId);
                    
                    // Update comment counts in main feeds
                    updateCommentCount(postId);
                } else {
                    const error = response.data || {};
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }


        // Duplicate removed - using the one defined earlier

        // Check follow status and render appropriate button
        async function renderFollowButton(userId, containerElement) {
            if (!currentUser || userId === currentUser.id) return '';
            
            try {
                const response = await apiCall(`/users/follow-status/${userId}`);
                
                if (response.ok) {
                    const isFollowing = response.data.isFollowing;
                    
                    const buttonHtml = `
                        <button onclick="toggleFollow('${userId}', this)" 
                            data-user-id="${userId}"
                            data-following="${isFollowing}"
                            style="padding: 0.25rem 0.5rem; background: ${isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>
                    `;
                    
                    return buttonHtml;
                } else {
                    return `
                        <button onclick="toggleFollow('${userId}', this)" 
                            data-user-id="${userId}"
                            data-following="false"
                            style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            Follow
                        </button>
                    `;
                }
            } catch (error) {
                console.error('Failed to check follow status:', error);
                return '';
            }
        }

        // Toggle follow/unfollow based on current state
        async function toggleFollow(userId, buttonElement) {
            const isCurrentlyFollowing = buttonElement.dataset.following === 'true';
            
            if (isCurrentlyFollowing) {
                await unfollowUser(userId, buttonElement);
            } else {
                await followUser(userId, buttonElement);
            }
        }

        // Follow/Unfollow functionality
        async function followUser(userId, buttonElement) {
            try {
                const response = await apiCall(`/users/follow/${userId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Update button to show Following state
                    if (buttonElement) {
                        buttonElement.textContent = 'Following';
                        buttonElement.style.background = '#666';
                        buttonElement.dataset.following = 'true';
                    }
                    // Refresh current view if it's profile or user search
                    loadUserProfile();
                } else {
                    alert(response.data?.error || 'Failed to follow user');
                }
            } catch (error) {
                console.error('Failed to follow user:', error);
                alert('Error following user');
            }
        }

        async function unfollowUser(userId, buttonElement) {
            try {
                const response = await apiCall(`/users/follow/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Update button back to Follow state
                    if (buttonElement) {
                        buttonElement.textContent = 'Follow';
                        buttonElement.style.background = '#4b5c09';
                        buttonElement.dataset.following = 'false';
                    }
                    // Refresh current view
                    loadUserProfile();
                } else {
                    alert(response.data?.error || 'Failed to unfollow user');
                }
            } catch (error) {
                console.error('Failed to unfollow user:', error);
                alert('Error unfollowing user');
            }
        }

        async function showFollowersList(userId) {
            try {
                const response = await apiCall(`/users/${userId}/followers`);
                
                if (response.ok) {
                    displayUsersList(response.data.followers, 'Followers');
                } else {
                    alert('Failed to load followers');
                }
            } catch (error) {
                console.error('Failed to load followers:', error);
                alert('Error loading followers');
            }
        }

        async function showFollowingList(userId) {
            try {
                const response = await apiCall(`/users/${userId}/following`);
                
                if (response.ok) {
                    displayUsersList(response.data.following, 'Following');
                } else {
                    alert('Failed to load following list');
                }
            } catch (error) {
                console.error('Failed to load following list:', error);
                alert('Error loading following list');
            }
        }

        function displayUsersList(users, title) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1vh; padding: 1vh; min-height: 2vh;">
                        <h3 style="margin: 0;">${title}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    <div>
                        ${users.length === 0 ? 
                            `<p style="text-align: center; color: #666; padding: 2rem;">No ${title.toLowerCase()} yet</p>` :
                            users.map(user => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center;">
                                        <div class="user-avatar" style="margin-right: 0.75rem;">${(user.firstName?.[0] || user.username[0]).toUpperCase()}</div>
                                        <div>
                                            <div style="font-weight: bold; font-size: 0.9rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                                            <div style="color: #666; font-size: 0.8rem;">@${user.username}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        ${user.id !== currentUser?.id ? `
                                            <button onclick="followUser('${user.id}', this)" 
                                                style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                                Follow
                                            </button>
                                            <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                                style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                                Message
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Global search functionality
        function openSearch() {
            document.getElementById('searchContainer').style.display = 'flex';
            closeAllPanels(); // Close other panels
            document.getElementById('searchInput').focus();
        }

        function closeSearch() {
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('globalSearchResults').innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    Start typing to search for users
                </div>
            `;
        }

        let globalSearchTimeout;
        async function performGlobalSearch(query) {
            clearTimeout(globalSearchTimeout);
            
            if (!query || query.length < 2) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Type at least 2 characters to search
                    </div>
                `;
                return;
            }

            globalSearchTimeout = setTimeout(async () => {
                await executeGlobalSearch(query);
            }, 300);
        }

        async function executeGlobalSearch(query) {
            if (!authToken) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Please log in to search for users
                    </div>
                `;
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}&limit=20`);
                
                if (response.ok) {
                    displayGlobalSearchResults(response.data.users);
                } else {
                    document.getElementById('globalSearchResults').innerHTML = `
                        <div style="text-align: center; color: #d32f2f; padding: 2rem;">
                            Error searching users
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Global search error:', error);
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #d32f2f; padding: 2rem;">
                        Network error occurred
                    </div>
                `;
            }
        }

        async function displayGlobalSearchResults(users) {
            const resultsContainer = document.getElementById('globalSearchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        No users found
                    </div>
                `;
                return;
            }

            let html = '';
            users.forEach(user => {
                html += `
                    <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer;" onclick="openUserFeed('${user.id}', '${user.username}')">
                        <div class="user-avatar" style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                            <div style="color: #666; font-size: 0.9rem;">@${user.username}</div>
                            <div style="color: #666; font-size: 0.8rem;">${user.followersCount} followers${user.state ? ` ‚Ä¢ ${user.state}` : ''}${user.district ? ` ‚Ä¢ District ${user.district}` : ''}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                            ${user.verified ? '<span style="color: #1d9bf0; margin-right: 0.5rem;">‚úì</span>' : ''}
                            ${user.id !== currentUser?.id ? `
                                <button onclick="toggleFollow('${user.id}', this)" 
                                    data-user-id="${user.id}"
                                    data-following="${user.isFollowing || false}"
                                    style="padding: 0.25rem 0.5rem; background: ${user.isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                    ${user.isFollowing ? 'Following' : 'Follow'}
                                </button>
                                <button onclick="addFriend('${user.id}')" 
                                    style="padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                    Add Friend
                                </button>
                                <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                    style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Message
                                </button>
                            ` : '<span style="color: #666; font-size: 0.8rem;">You</span>'}
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        // Open user feed in main area
        async function openUserFeed(userId, username) {
            try {
                closeSearch();
                
                // Show loading state
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading @${username}'s Profile</h2>
                        <p>Loading profile and posts...</p>
                    </div>
                `;

                // Load user's profile and posts in parallel
                const [profileResponse, postsResponse] = await Promise.all([
                    apiCall(`/users/${username}`),
                    apiCall(`/posts/user/${userId}`)
                ]);
                
                if (profileResponse.ok && postsResponse.ok) {
                    const userProfile = profileResponse.data.user;
                    const posts = postsResponse.data.posts || [];
                    
                    // Create profile header
                    let html = `
                        <div style="background: linear-gradient(135deg, #4b5c09 0%, #6b7f1a 100%); color: white; padding: 2rem; margin-bottom: 1rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">
                                        ${(userProfile.firstName?.[0] || userProfile.username[0]).toUpperCase()}
                                    </div>
                                    <div>
                                        <h1 style="margin: 0; font-size: 1.8rem;">
                                            ${userProfile.firstName ? `${userProfile.firstName} ${userProfile.lastName || ''}` : userProfile.username}
                                            ${userProfile.verified ? '<span style="color: #ffd700; margin-left: 0.5rem;">‚úì</span>' : ''}
                                        </h1>
                                        <p style="margin: 0.25rem 0; font-size: 1.1rem; opacity: 0.9;">@${userProfile.username}</p>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">
                                            <span><strong>${userProfile.followersCount || 0}</strong> followers</span>
                                            <span><strong>${userProfile.followingCount || 0}</strong> following</span>
                                            <span>Joined ${new Date(userProfile.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="loadTrendingPosts(); showMainFeed();" style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                    Back to Main Feed
                                </button>
                            </div>
                            
                            ${userProfile.bio ? `<div style="margin-bottom: 1rem; font-size: 1rem; line-height: 1.4;">${userProfile.bio}</div>` : ''}
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.9;">
                                ${userProfile.location ? `<span>üìç ${userProfile.location}</span>` : ''}
                                ${userProfile.website ? `<span>üîó <a href="${userProfile.website}" target="_blank" style="color: #ffd700;">${userProfile.website}</a></span>` : ''}
                            </div>
                            
                            ${userId !== currentUser?.id ? `
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button onclick="toggleFollow('${userId}', this)" 
                                        data-user-id="${userId}"
                                        style="padding: 0.5rem 1rem; background: #fff; color: #4b5c09; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        Follow
                                    </button>
                                    <button onclick="startConversationWithUser('${userId}', '${username}')" 
                                        style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                        Message
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="border-bottom: 2px solid #4b5c09; margin-bottom: 1rem; padding-bottom: 0.5rem;">
                            <h2 style="margin: 0; color: #4b5c09; font-size: 1.3rem;">Posts (${posts.length})</h2>
                        </div>
                    `;
                    
                    if (posts.length === 0) {
                        html += `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <p style="margin: 0; font-size: 1.1rem;">This user hasn't posted anything yet.</p>
                            </div>
                        `;
                    } else {
                        // Render posts
                        posts.forEach(post => {
                            html += `
                                <div class="post-item" data-post-id="${post.id}" style="background: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                        <div style="display: flex; align-items: center;">
                                            <div class="user-avatar" style="margin-right: 0.75rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                                            <div>
                                                <div style="font-weight: bold;">
                                                    ${post.author.firstName ? `${post.author.firstName} ${post.author.lastName || ''}` : post.author.username}
                                                    ${post.author.verified ? '<span style="color: #1d9bf0; margin-left: 0.25rem;">‚úì</span>' : ''}
                                                </div>
                                                <div style="color: #666; font-size: 0.9rem;">@${post.author.username} ‚Ä¢ ${new Date(post.createdAt).toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                        <div style="color: #666; font-size: 0.8rem;">${new Date(post.createdAt).toLocaleTimeString()}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem; line-height: 1.5;">
                                        ${post.content}
                                    </div>
                                    
                                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post image" style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem;">` : ''}
                                    
                                    <div style="display: flex; gap: 1rem; color: #666; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 0.75rem;">
                                        <button onclick="likePost('${post.id}', event)" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>${post.isLiked ? '‚ù§Ô∏è' : 'üëç'}</span> <span>${post.likesCount || 0}</span>
                                        </button>
                                        <button onclick="toggleComments('${post.id}')" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>üí¨</span> ${post.commentsCount || 0}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    feedElement.innerHTML = html;
                } else {
                    feedElement.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h2>Error Loading Profile</h2>
                            <p style="color: #d32f2f;">Unable to load @${username}'s profile and posts</p>
                            <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Back to Main Feed
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user feed:', error);
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Network Error</h2>
                        <p style="color: #d32f2f;">Unable to load @${username}'s profile</p>
                        <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Back to Main Feed
                        </button>
                    </div>
                `;
            }
        }

        function showMainFeed() {
            // Reset to main feed view - could load trending or user's own posts
            loadTrendingPosts();
        }

        async function addFriend(userId) {
            console.log('Adding friend:', userId);
            // TODO: Implement friend request functionality
        }

        // Map zoom and location functionality
        let mapInstance = null;
        let currentLocation = null;
        let currentZoomLevel = 'national'; // Track current zoom level (default to match radio button)
        let boundaryManager = null;

        // Boundary management class
        class BoundaryManager {
            constructor(map) {
                this.map = map;
                this.layers = new Map();
                this.cache = new Map();
                this.loadLocalCache();
            }
            
            // Load cached boundary data from localStorage
            loadLocalCache() {
                try {
                    const cached = localStorage.getItem('boundaryCache');
                    if (cached) {
                        const parsedCache = JSON.parse(cached);
                        // Check if cache is less than 30 days old
                        const cacheAge = Date.now() - (parsedCache.timestamp || 0);
                        if (cacheAge < 30 * 24 * 60 * 60 * 1000) { // 30 days
                            Object.entries(parsedCache.data || {}).forEach(([key, value]) => {
                                this.cache.set(key, value);
                            });
                            console.log(`Loaded ${this.cache.size} cached boundaries from localStorage`);
                        } else {
                            localStorage.removeItem('boundaryCache');
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load boundary cache:', error);
                    localStorage.removeItem('boundaryCache');
                }
            }
            
            // Save boundary cache to localStorage
            saveLocalCache() {
                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: Object.fromEntries(this.cache)
                    };
                    localStorage.setItem('boundaryCache', JSON.stringify(cacheData));
                } catch (error) {
                    console.warn('Failed to save boundary cache:', error);
                }
            }
            
            async loadBoundary(type, identifier, state) {
                const key = `${type}-${state}-${identifier || 'state'}`;
                
                // Check cache first
                if (this.cache.has(key)) {
                    console.log(`Using cached boundary for ${key}`);
                    this.displayBoundary(key, this.cache.get(key), type);
                    return;
                }
                
                // Try multiple sources for boundary data
                const sources = [
                    // Primary source - raw GitHub content (more reliable)
                    {
                        name: 'GitHub raw',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/states/${state}/shape.geojson`;
                            }
                        }
                    },
                    // Fallback to theunitedstates.io (if SSL issue is fixed)
                    {
                        name: 'theunitedstates.io',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://theunitedstates.io/districts/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://theunitedstates.io/districts/states/${state}/shape.geojson`;
                            }
                        }
                    }
                ];
                
                for (const source of sources) {
                    try {
                        const url = source.getUrl(type, state, identifier);
                        if (!url) continue;
                        
                        console.log(`Fetching boundary data from ${source.name}: ${url}`);
                        
                        const response = await fetch(url, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (!response.ok) {
                            console.warn(`HTTP ${response.status} from ${source.name}`);
                            continue;
                        }
                        
                        const geojsonData = await response.json();
                        
                        // Cache the data in memory and localStorage
                        this.cache.set(key, geojsonData);
                        this.saveLocalCache();
                        
                        console.log(`Successfully loaded boundary from ${source.name}`);
                        
                        // Display boundary
                        this.displayBoundary(key, geojsonData, type);
                        return;
                        
                    } catch (error) {
                        console.warn(`Failed to load boundary from ${source.name}:`, error);
                        continue;
                    }
                }
                
                console.error(`Failed to load ${type} boundary from all sources for ${key}`);
            }
            
            displayBoundary(key, geojsonData, type) {
                // Remove existing layer if present
                this.removeBoundary(key);
                
                const style = type === 'district' ? {
                    color: '#ff6b35',
                    weight: 3,
                    opacity: 0.8,
                    fillColor: '#ff6b35',
                    fillOpacity: 0.1
                } : {
                    color: '#4b5c09',
                    weight: 2,
                    opacity: 0.6,
                    fillColor: '#4b5c09',
                    fillOpacity: 0.05
                };
                
                const layer = L.geoJSON(geojsonData, { style }).addTo(this.map);
                this.layers.set(key, layer);
                console.log(`${type} boundary loaded and displayed`);
            }
            
            removeBoundary(key) {
                if (this.layers.has(key)) {
                    this.map.removeLayer(this.layers.get(key));
                    this.layers.delete(key);
                }
            }
            
            clearAll() {
                this.layers.forEach(layer => this.map.removeLayer(layer));
                this.layers.clear();
            }
        }

        function setMapInstance(map) {
            mapInstance = map;
            boundaryManager = new BoundaryManager(map);
            
            // Try to get user location, with fallback
            setTimeout(() => {
                if (currentUser && currentUser.state) {
                    getCurrentUserLocation();
                } else {
                    currentLocation = { lat: 37.8283, lng: -98.5795 }; // Center of US
                }
            }, 500); // Wait for user data to load
        }

        async function getCurrentUserLocation() {
            try {
                if (currentUser && currentUser.zipCode && currentUser.state) {
                    // Use user's stored address for location
                    const address = currentUser.city ? 
                        `${currentUser.city}, ${currentUser.state} ${currentUser.zipCode}` :
                        `${currentUser.zipCode}, ${currentUser.state}`;
                    
                    const coords = await geocodeLocation(address);
                    if (coords) {
                        currentLocation = coords;
                        // Only set zoom level if we're not at national level (to avoid moving away from default)
                        if (currentZoomLevel !== 'national') {
                            await setZoomLevel(currentZoomLevel);
                        }
                        
                        // Load representative data to get district info
                        loadElectedOfficials();
                    }
                }
            } catch (error) {
                console.error('Error getting user location:', error);
                currentLocation = { lat: 37.8283, lng: -98.5795 }; // Fallback
            }
        }

        async function geocodeLocation(address) {
            try {
                // Using a free geocoding service - you might want to use your existing Geocod.io API
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        async function geocodeAndZoom() {
            const locationInput = document.getElementById('locationInput');
            const address = locationInput.value.trim();
            
            if (!address) {
                // Use current location if no address provided
                getCurrentUserLocation();
                return;
            }

            const coords = await geocodeLocation(address);
            if (coords) {
                currentLocation = coords;
                // Apply current zoom level to new location
                await setZoomLevel(currentZoomLevel);
            } else {
                alert('Location not found. Please try a different address.');
            }
        }

        async function setZoomLevel(level) {
            if (USE_MAPLIBRE && window.map && window.map.setZoomLevel) {
                // Use MapLibre zoom level method
                window.map.setZoomLevel(level);
                updateRadioButtonState(level);
                return;
            }
            
            if (!mapInstance) return;

            // Original Leaflet implementation
            // Update current zoom level and radio button state
            currentZoomLevel = level;
            updateRadioButtonState(level);

            let zoom, bounds;
            
            // Clear existing boundaries
            if (boundaryManager) {
                boundaryManager.clearAll();
            }
            
            console.log(`Setting zoom level: ${level}`);
            console.log(`Current user:`, currentUser);
            console.log(`Current user state: ${currentUser?.state}, district: ${currentUser?.district}`);
            console.log(`Current location:`, currentLocation);
            
            switch(level) {
                case 'national':
                    // Show national view - different zoom levels for expanded vs collapsed
                    const isCollapsed = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsed ? 3 : 5;
                    mapInstance.setView([37.8283, -98.5795], zoom); // Center of US
                    console.log(`Set to national view (zoom: ${zoom}, collapsed: ${isCollapsed})`);
                    // No boundaries at national level
                    break;
                    
                case 'state':
                    // Zoom to show state and surrounding areas - adjust zoom for map size
                    const isCollapsedState = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedState ? 5 : 7;
                    
                    console.log(`STATE ZOOM: Checking if currentUser.state exists:`, currentUser?.state);
                    
                    if (currentUser && currentUser.state) {
                        console.log(`Flying to state geographic center for: ${currentUser.state}`);
                        // Get state center coordinates and fly there
                        const stateCenter = await getStateCenterCoordinates(currentUser.state);
                        console.log(`State center result:`, stateCenter);
                        if (stateCenter) {
                            console.log(`Flying to state center: ${stateCenter.lat}, ${stateCenter.lng} with zoom ${zoom}`);
                            mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            console.log(`Map setView called successfully`);
                            
                            // Load state boundary
                            if (boundaryManager) {
                                console.log(`Loading state boundary for: ${currentUser.state}`);
                                boundaryManager.loadBoundary('state', null, currentUser.state);
                            }
                        } else {
                            console.log('State center not found, using US center fallback');
                            mapInstance.setView([37.8283, -98.5795], zoom);
                        }
                    } else {
                        console.log('ERROR: No user state info available - this should not happen for State zoom!');
                        console.log('Current user object:', currentUser);
                        // DO NOT fall back to US center for State zoom - that's wrong!
                        console.error('State zoom requested but no state data available');
                    }
                    break;
                    
                case 'local':
                    // Zoom to user's actual address - adjust zoom for map size
                    const isCollapsedLocal = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedLocal ? 9 : 11;
                    
                    console.log(`LOCAL ZOOM: Checking user address data - zipCode: ${currentUser?.zipCode}, city: ${currentUser?.city}, state: ${currentUser?.state}`);
                    
                    if (currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state) {
                        // Build address from user profile
                        let userAddress = '';
                        if (currentUser.streetAddress && currentUser.city) {
                            userAddress = `${currentUser.streetAddress}, ${currentUser.city}, ${currentUser.state}`;
                            if (currentUser.zipCode) userAddress += ` ${currentUser.zipCode}`;
                        } else if (currentUser.city) {
                            userAddress = `${currentUser.city}, ${currentUser.state}`;
                        } else if (currentUser.zipCode) {
                            userAddress = `${currentUser.zipCode}, ${currentUser.state}`;
                        }
                        
                        console.log(`Flying to user's address: ${userAddress}`);
                        
                        // Geocode the user's address and fly there
                        const addressCoords = await geocodeLocation(userAddress);
                        console.log(`Address geocoding result:`, addressCoords);
                        if (addressCoords) {
                            console.log(`Flying to address coordinates: ${addressCoords.lat}, ${addressCoords.lng} with zoom ${zoom}`);
                            mapInstance.setView([addressCoords.lat, addressCoords.lng], zoom);
                            console.log(`Map setView called for address successfully`);
                            
                            // Load district boundary if we have district info
                            if (boundaryManager && currentUser.district) {
                                console.log(`Loading district boundary: ${currentUser.state}-${currentUser.district}`);
                                boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                            }
                        } else {
                            console.log('Address geocoding failed, using state center fallback');
                            // Fallback to state center
                            const stateCenter = await getStateCenterCoordinates(currentUser.state);
                            if (stateCenter) {
                                mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            } else {
                                mapInstance.setView([37.8283, -98.5795], zoom);
                            }
                        }
                    } else {
                        console.log('ERROR: No user address info available - this should not happen for Local zoom!');
                        console.log('User address fields:', {
                            streetAddress: currentUser?.streetAddress,
                            city: currentUser?.city,
                            state: currentUser?.state,
                            zipCode: currentUser?.zipCode
                        });
                        // DO NOT fall back to US center for Local zoom - that's wrong!
                        console.error('Local zoom requested but no address data available');
                    }
                    break;
            }
        }
        
        function updateRadioButtonState(level) {
            // Update radio button to match current zoom level
            const radios = document.querySelectorAll('input[name="zoomLevel"]');
            radios.forEach(radio => {
                radio.checked = radio.value === level;
            });
        }

        // Helper function to get state center coordinates
        async function getStateCenterCoordinates(stateAbbr) {
            // State center coordinates (approximate geographic centers)
            const stateCenters = {
                'AL': { lat: 32.806671, lng: -86.791130 },
                'AK': { lat: 61.370716, lng: -152.404419 },
                'AZ': { lat: 33.729759, lng: -111.431221 },
                'AR': { lat: 34.969704, lng: -92.373123 },
                'CA': { lat: 36.116203, lng: -119.681564 },
                'CO': { lat: 39.059811, lng: -105.311104 },
                'CT': { lat: 41.597782, lng: -72.755371 },
                'DE': { lat: 39.318523, lng: -75.507141 },
                'FL': { lat: 27.766279, lng: -81.686783 },
                'GA': { lat: 33.040619, lng: -83.643074 },
                'HI': { lat: 21.094318, lng: -157.498337 },
                'ID': { lat: 44.240459, lng: -114.478828 },
                'IL': { lat: 40.349457, lng: -88.986137 },
                'IN': { lat: 39.849426, lng: -86.258278 },
                'IA': { lat: 42.011539, lng: -93.210526 },
                'KS': { lat: 38.526600, lng: -96.726486 },
                'KY': { lat: 37.668140, lng: -84.670067 },
                'LA': { lat: 31.169546, lng: -91.867805 },
                'ME': { lat: 44.693947, lng: -69.381927 },
                'MD': { lat: 39.063946, lng: -76.802101 },
                'MA': { lat: 42.230171, lng: -71.530106 },
                'MI': { lat: 43.326618, lng: -84.536095 },
                'MN': { lat: 45.694454, lng: -93.900192 },
                'MS': { lat: 32.741646, lng: -89.678696 },
                'MO': { lat: 38.456085, lng: -92.288368 },
                'MT': { lat: 47.097633, lng: -110.362566 },
                'NE': { lat: 41.492537, lng: -99.901813 },
                'NV': { lat: 38.313515, lng: -117.055374 },
                'NH': { lat: 43.452492, lng: -71.563896 },
                'NJ': { lat: 40.298904, lng: -74.521011 },
                'NM': { lat: 34.840515, lng: -106.248482 },
                'NY': { lat: 42.165726, lng: -74.948051 },
                'NC': { lat: 35.630066, lng: -79.806419 },
                'ND': { lat: 47.528912, lng: -99.784012 },
                'OH': { lat: 40.388783, lng: -82.764915 },
                'OK': { lat: 35.565342, lng: -96.928917 },
                'OR': { lat: 44.572021, lng: -122.070938 },
                'PA': { lat: 40.590752, lng: -77.209755 },
                'RI': { lat: 41.680893, lng: -71.51178 },
                'SC': { lat: 33.856892, lng: -80.945007 },
                'SD': { lat: 44.299782, lng: -99.438828 },
                'TN': { lat: 35.747845, lng: -86.692345 },
                'TX': { lat: 31.054487, lng: -97.563461 },
                'UT': { lat: 40.150032, lng: -111.862434 },
                'VT': { lat: 44.045876, lng: -72.710686 },
                'VA': { lat: 37.769337, lng: -78.169968 },
                'WA': { lat: 47.400902, lng: -121.490494 },
                'WV': { lat: 38.491226, lng: -80.954570 },
                'WI': { lat: 44.268543, lng: -89.616508 },
                'WY': { lat: 42.755966, lng: -107.302490 }
            };
            
            return stateCenters[stateAbbr.toUpperCase()] || null;
        }

        // Helper function to get district center coordinates
        async function getDistrictCenterCoordinates(stateAbbr, districtNumber) {
            try {
                // Try to fetch the district boundary data to calculate center
                const url = `https://theunitedstates.io/districts/cds/2012/${stateAbbr.toUpperCase()}-${districtNumber}/shape.geojson`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const geojsonData = await response.json();
                    
                    // Calculate the center of the district from its geometry
                    const center = calculateGeometryCenter(geojsonData);
                    if (center) {
                        console.log(`District center calculated: ${center.lat}, ${center.lng}`);
                        return center;
                    }
                }
                
                console.warn(`Could not fetch district boundary for ${stateAbbr}-${districtNumber}`);
                return null;
            } catch (error) {
                console.error('Error getting district center:', error);
                return null;
            }
        }

        // Helper function to calculate the center of a GeoJSON geometry
        function calculateGeometryCenter(geojsonData) {
            try {
                if (!geojsonData.features || geojsonData.features.length === 0) {
                    return null;
                }
                
                let totalLat = 0;
                let totalLng = 0;
                let pointCount = 0;
                
                geojsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'Polygon') {
                        const coordinates = feature.geometry.coordinates[0]; // First ring (exterior)
                        coordinates.forEach(coord => {
                            totalLng += coord[0];
                            totalLat += coord[1];
                            pointCount++;
                        });
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            const coordinates = polygon[0]; // First ring of each polygon
                            coordinates.forEach(coord => {
                                totalLng += coord[0];
                                totalLat += coord[1];
                                pointCount++;
                            });
                        });
                    }
                });
                
                if (pointCount > 0) {
                    return {
                        lat: totalLat / pointCount,
                        lng: totalLng / pointCount
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error calculating geometry center:', error);
                return null;
            }
        }

        // Initialize location input with user's address if available
        function updateLocationPlaceholder() {
            setTimeout(() => {
                if (currentUser && currentUser.city && currentUser.state) {
                    const locationInput = document.getElementById('locationInput');
                    if (locationInput) {
                        locationInput.placeholder = `${currentUser.city}, ${currentUser.state}`;
                    }
                }
            }, 100);
        }

        // Call when user data is loaded
        window.addEventListener('load', () => {
            setTimeout(updateLocationPlaceholder, 1000);
        });

        // Password validation and UI functions
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            const isValid = Object.values(requirements).every(req => req);
            const hasContent = password.length > 0;
            
            // Show/hide requirements based on focus and content
            const reqContainer = document.getElementById('password-requirements');
            const statusIndicator = document.getElementById('password-status');
            
            if (hasContent && !isValid) {
                // Show detailed requirements when typing but not valid
                reqContainer.style.display = 'block';
                statusIndicator.style.display = 'none';
            } else if (isValid) {
                // Show green checkmark when valid, hide requirements
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'block';
            } else {
                // Hide both when empty
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'none';
            }

            // Update individual requirement indicators
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-uppercase', requirements.uppercase);
            updateRequirement('req-lowercase', requirements.lowercase);
            updateRequirement('req-number', requirements.number);
            updateRequirement('req-special', requirements.special);

            return isValid;
        }

        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (element) {
                if (met) {
                    element.classList.add('met');
                    element.textContent = element.textContent.replace('‚Ä¢ ', '');
                } else {
                    element.classList.remove('met');
                    if (!element.textContent.startsWith('‚Ä¢ ')) {
                        element.textContent = '‚Ä¢ ' + element.textContent.replace('‚úì ', '');
                    }
                }
            }
        }

        // Add real-time password validation
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('registerPassword');
            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    validatePassword(this.value);
                });
            }
        });

        // Debug hCaptcha loading
        function checkHCaptchaStatus() {
            const widget = document.getElementById('hcaptcha-register');
            const hasIframe = widget && widget.querySelector('iframe');
            const widgetId = widget ? widget.getAttribute('data-hcaptcha-widget-id') : null;
            let response = null;
            
            try {
                if (window.hcaptcha && window.hcaptcha.getResponse) {
                    if (widgetId) {
                        response = window.hcaptcha.getResponse(widgetId);
                    } else {
                        response = window.hcaptcha.getResponse();
                    }
                }
            } catch (error) {
                console.log('hCaptcha getResponse error:', error.message);
            }
            
            console.log('hCaptcha status:', {
                loaded: typeof window.hcaptcha !== 'undefined',
                widgetExists: widget !== null,
                hasIframe: hasIframe !== null,
                widgetId: widgetId,
                sitekey: document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey'),
                currentResponse: response ? 'has response' : 'no response',
                responseLength: response ? response.length : 0,
                domain: window.location.hostname
            });
        }

        // Global hCaptcha callback function
        window.onHCaptchaCallback = function(token) {
            console.log('hCaptcha completed successfully!', { tokenLength: token ? token.length : 0 });
            // Store the token in a global variable for easy access
            window.hCaptchaToken = token;
        };

        // Check hCaptcha after page load (let it auto-render)
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkHCaptchaStatus();
                // No manual rendering needed - hCaptcha script auto-renders widgets with data-sitekey
                console.log('Relying on hCaptcha auto-render via data-sitekey attribute');
            }, 2000);
        });

        // ========================================
        // Background Image Functionality
        // ========================================

        async function handleBackgroundImageSelect(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Please select an image smaller than 5MB');
                return;
            }

            try {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('backgroundPreview');
                    if (preview) {
                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.textContent = '';
                    }
                };
                reader.readAsDataURL(file);

                // Upload the image
                const formData = new FormData();
                formData.append('backgroundImage', file);

                const response = await apiCall('/users/background-image', {
                    method: 'POST',
                    body: formData,
                    skipContentType: true
                });

                if (response.ok) {
                    console.log('‚úÖ Background image uploaded successfully');
                    
                    // Update current user data
                    if (currentUser) {
                        currentUser.backgroundImage = response.data.backgroundImage;
                    }
                    
                    // Apply the background to current views
                    applyUserBackground(response.data.backgroundImage);
                    
                    // Show success message
                    showToast('Background image updated successfully!');
                    
                } else {
                    alert('Failed to upload background image: ' + (response.data?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Background image upload error:', error);
                alert('Failed to upload background image. Please try again.');
            }
        }

        async function removeBackgroundImage() {
            if (!confirm('Are you sure you want to remove your background image?')) {
                return;
            }

            try {
                const response = await apiCall('/users/background-image', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('‚úÖ Background image removed successfully');
                    
                    // Update current user data
                    if (currentUser) {
                        currentUser.backgroundImage = null;
                    }
                    
                    // Remove background from current views
                    applyUserBackground(null);
                    
                    // Update preview
                    const preview = document.getElementById('backgroundPreview');
                    if (preview) {
                        preview.style.backgroundImage = '';
                        preview.textContent = 'No background set';
                    }
                    
                    // Show success message
                    showToast('Background image removed successfully!');
                    
                } else {
                    alert('Failed to remove background image: ' + (response.data?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Background image removal error:', error);
                alert('Failed to remove background image. Please try again.');
            }
        }

        function applyUserBackground(backgroundImageUrl) {
            // Apply to My Profile
            const myProfileElements = document.querySelectorAll('.my-profile');
            myProfileElements.forEach(element => {
                if (backgroundImageUrl) {
                    element.style.backgroundImage = `url(${backgroundImageUrl})`;
                    element.classList.add('has-background');
                } else {
                    element.style.backgroundImage = '';
                    element.classList.remove('has-background');
                }
            });

            // Apply to My Feed panel
            const myFeedPanel = document.getElementById('panel-myfeed');
            if (myFeedPanel) {
                if (backgroundImageUrl) {
                    myFeedPanel.style.backgroundImage = `url(${backgroundImageUrl})`;
                    myFeedPanel.classList.add('has-background');
                } else {
                    myFeedPanel.style.backgroundImage = '';
                    myFeedPanel.classList.remove('has-background');
                }
            }
        }

        function applyBackgroundForUser(user) {
            // Function to apply background when viewing another user's profile
            if (user && user.backgroundImage) {
                // Apply to user profile elements
                const profileElements = document.querySelectorAll('.user-profile, .profile-view');
                profileElements.forEach(element => {
                    element.style.backgroundImage = `url(${user.backgroundImage})`;
                    element.classList.add('has-background');
                });
            }
        }

        // Initialize background on app load
        function initializeUserBackground() {
            if (currentUser && currentUser.backgroundImage) {
                applyUserBackground(currentUser.backgroundImage);
            }
        }

        // Call this when user data is loaded
        window.addEventListener('userDataLoaded', initializeUserBackground);

        // Simple toast notification function
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification show';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

    </script>
    <!-- Mobile Navigation -->
    <nav class="mobile-nav" style="display: none;">
        <a href="#" class="mobile-nav-item mobile-nav-feed active" onclick="showMobileFeed()">
            <div class="mobile-nav-icon">üè†</div>
            <div>Feed</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showMobileSearch()">
            <div class="mobile-nav-icon">üîç</div>
            <div>Search</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showMobileMap()">
            <div class="mobile-nav-icon">üó∫Ô∏è</div>
            <div>Map</div>
        </a>
        <a href="#" class="mobile-nav-item mobile-nav-profile" onclick="showMobileProfile()">
            <div class="mobile-nav-icon">üë§</div>
            <div>Profile</div>
        </a>
        <a href="#" class="mobile-nav-item mobile-nav-messages" onclick="showMobileMessages()">
            <div class="mobile-nav-icon">üí¨</div>
            <div>Messages</div>
        </a>
    </nav>

    <!-- Mobile Map Close Button -->
    <button class="mobile-map-close" onclick="hideMobileMap()">‚úï Close Map</button>

</body>
</html>