<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>United We Rise - Demo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script src="src/components/AddressForm.js"></script>
    <script src="src/components/VerificationFlow.js"></script>
    <script src="src/components/ContentReporting.js"></script>
    <script src="src/components/CandidateSystem.js"></script>
    <script src="src/components/MyProfile.js"></script>
    <script src="src/integrations/backend-integration.js"></script>
    <script src="src/integrations/candidate-system-integration.js"></script>
    <script src="src/integrations/officials-system-integration.js"></script>
    <script src="src/integrations/elections-system-integration.js"></script>
    <script src="src/integrations/trending-system-integration.js"></script>
    
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden; /* Prevent page scrolling */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
        }
        .top-bar {
            position: fixed;
            top: 0;
            width: 100%;
            height: 5.5vh;
            padding-top: 2px;
            padding-bottom: 3px;
            background: #202e0c;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 1rem;
            padding-right: 1rem;
            z-index: 10;
            box-sizing: border-box;
        }
        .top-bar input.search {
            padding: 5px;
            width: 200px;
        }
        .top-bar .nav {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        .top-bar .nav a, .top-bar .nav button {
            color: white;
            text-decoration: none;
            white-space: nowrap;
            background: none;
            border: none;
            cursor: pointer;
            font-size: inherit;
        }
        .top-bar .nav button:hover {
            text-decoration: underline;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .container {
            display: flex;
            height: calc(100vh - 5.5vh); /* Full height minus top bar */
            margin-top: 5.5vh;
            overflow: hidden; /* Prevent container overflow */
        }
        .sidebar {
            background: #4b5c09;
            color: white;
            width: 3vw;
            transition: width 0.3s ease;
            position: fixed;
            top: 5.5vh;
            bottom: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            z-index: 9;
        }
        .sidebar.expanded {
            width: 10vw;
        }
        .sidebar .thumbs {
            display: flex;
            flex-direction: column;
            align-items: start;
            padding-top: 1rem;
            padding-left: 0.5rem;
        }
        .sidebar .thumb {
            margin: 10px 0;
            cursor: pointer;
            font-size: 1.5rem;
            white-space: nowrap;
        }
        .sidebar .thumb:hover {
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            padding: 2px 4px;
        }
        .sidebar .label {
            margin-left: 10px;
            display: none;
        }
        .sidebar.expanded .label {
            display: inline;
        }
        #toggleSidebar {
            background: none;
            border: none;
            color: white;
            padding: 1rem;
            cursor: pointer;
        }
        .main {
            margin-left: 3vw;
            margin-right: 26%; /* Permanently sized for collapsed map space */
            padding-top: 1vh; /* Small top padding in vh */
            padding-left: 1rem;
            padding-right: 1rem;
            padding-bottom: 1vh;
            flex-grow: 1;
            height: calc(100vh - 5.5vh); /* Full viewport height minus top bar */
            box-sizing: border-box;
            overflow-y: auto; /* Allow main container to scroll vertically */
            /* Hide scrollbar */
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .main::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        .sidebar.expanded ~ .main {
            margin-left: 10vw;
        }
        .search-container {
            position: fixed;
            top: 6.5vh; /* Below top bar */
            left: 3vw; /* After sidebar */
            width: calc(50vw - 80px); /* Half screen width minus sidebar and padding */
            height: calc(50vh - 10px); /* Half screen height */
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        .search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1vh;
            border-bottom: 1px solid #eee;
            background: #f9f9f9;
            border-radius: 8px 8px 0 0;
        }
        .search-filters {
            display: flex;
            gap: 1rem;
        }
        .search-filters label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .search-results {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        .info-panel, .detail-panel {
            position: fixed;
            top: 65px;
            width: 300px;
            background: #f0f4f8;
            border: 1px solid #ccc;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 99;
            transition: left 0.3s ease;
        }
        .detail-panel {
            z-index: 100;
        }
        [data-offset="1"] { left: 3vw; }
        [data-offset="2"] { left: 370px; }
        .sidebar.expanded ~ [data-offset="1"] { left: 10vw; }
        .sidebar.expanded ~ [data-offset="2"] { left: 510px; }

        .panel-header {
            display: flex;
            justify-content: space-between;
            background: #ccc;
            padding: 0.5rem;
            font-weight: bold;
        }
        .panel-body {
            padding: 1rem;
        }
        .hidden {
            display: none;
        }
        details {
            margin-bottom: 0.5rem;
        }
        body {
            margin: 0;
            overflow-x: hidden;
            background: #f0f4f8;
        }

        /* Map Styles */
        #mapContainer {
            position: absolute;
            top: 5.5vh;
            right: 0;
            width: 100%;
            height: calc(100vh - 60px);
            transition: all 0.3s ease;
            z-index: 5;
        }

        #mapContainer.collapsed {
            width: 25%;
            height: 30%;
            right: 0.5%;
            top: 60px;
            left: auto;
            border: 2px solid #ccc;
            box-shadow: 0 0 12px rgba(0,0,0,0.3);
            border-radius: 8px;
            overflow: hidden;
        }

        #mapToggleBtn {
            position: fixed;
            top: 72px;
            right: 24px;
            z-index: 9999;
            background: white;
            border: 1px solid #aaa;
            padding: 6px 12px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        #map {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .map-controls {
            position: absolute;
            top: 1vh;
            left: 5vw; 
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.3);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 1rem;
            transition: opacity 0.3s ease;
        }
        
        #mapContainer.collapsed .map-controls {
            top: 0.5%;
            left: 0;
            padding: 0.4rem;
            gap: 0.5rem;
            scale: 0.9;
        }
        
        #mapContainer.collapsed .zoom-filters label {
            font-size: 0.75rem;
        }
        
        #mapContainer.collapsed .location-input input {
            width: 120px !important;
            font-size: 0.7rem !important;
            padding: 0.2rem !important;
        }
        
        #mapContainer.collapsed .location-input button {
            font-size: 0.7rem !important;
            padding: 0.2rem 0.4rem !important;
        }
        
        .map-controls.hiding {
            opacity: 0;
            pointer-events: none;
        }
        
        .zoom-filters {
            display: flex;
            gap: 0.75rem;
        }
        
        .zoom-filters label {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
        }
        
        .location-input {
            display: flex;
            align-items: center;
        }
        
        /* Hide Leaflet attribution */
        .leaflet-control-attribution {
            display: none !important;
        }

        /* Auth Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 2rem;
            border-radius: 8px;
            width: 90%;
            max-width: 400px;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .modal-body {
            margin-bottom: 1rem;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .btn {
            background: #4b5c09;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
        }
        .btn:hover {
            background: #3a4707;
        }
        .btn-secondary {
            background: #6B8E23;
            margin-top: 0.5rem;
        }
        .btn-secondary:hover {
            background: #556b1d;
        }
        .auth-switch {
            text-align: center;
            margin-top: 1rem;
        }
        .auth-switch a {
            color: #4b5c09;
            cursor: pointer;
            text-decoration: underline;
        }
        .error-message {
            color: #d32f2f;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
        .success-message {
            color: #2e7d32;
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }

        /* CTA Panel Styles */
        #google-cta-panel {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: #F8F4E9;
            border: 2px solid #6B8E23;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            padding: 16px 24px;
            width: auto;
            max-width: 90vw;
            box-sizing: border-box;
            display: none;
            z-index: 9999;
        }
        #google-cta-panel button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 1.2rem;
            color: #5A534A;
            cursor: pointer;
        }

        /* Messages Panel Styles */
        .messages-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            max-height: 400px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
        }
        .messages-header {
            background: #4b5c09;
            color: white;
            padding: 0.75rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .messages-body {
            max-height: 300px;
            overflow-y: auto;
            padding: 0.5rem;
        }
        .conversation-item {
            padding: 0.75rem;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .conversation-item:hover {
            background: #f5f5f5;
        }
        .conversation-item:last-child {
            border-bottom: none;
        }
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4b5c09;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        .conversation-info {
            flex: 1;
        }
        .conversation-name {
            font-weight: bold;
            font-size: 0.9rem;
        }
        .conversation-preview {
            font-size: 0.8rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* User Profile Panel Styles */
        .profile-panel {
            position: fixed;
            top: 65px;
            right: 20px;
            width: 350px;
            max-height: 80vh;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 998;
            display: none;
            overflow-y: auto;
        }
        .profile-header {
            background: #4b5c09;
            color: white;
            padding: 1rem;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .profile-body {
            padding: 1rem;
        }
        .profile-section {
            margin-bottom: 1.5rem;
        }
        .profile-section h3 {
            margin: 0 0 0.5rem 0;
            color: #4b5c09;
            border-bottom: 1px solid #eee;
            padding-bottom: 0.25rem;
        }

        /* Posts Container Styles */
        .posts-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            top: 6.5vh; /* 6.5% from top of screen */
            bottom: 0.5vh; /* 0.5% from bottom of screen */
            left: 3vw; /* Account for sidebar */
            right: 26%; /* Account for map area */
            margin: 0 1rem; /* Side margins */
            display: flex;
            flex-direction: column;
            z-index: 1;
        }
        .post-composer {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .post-composer textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 0.75rem;
            resize: vertical;
            box-sizing: border-box;
        }
        .post-composer-actions {
            margin-top: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .post-composer-actions .btn {
            width: auto;
            padding: 0.5rem 1rem;
        }
        .posts-feed {
            flex-grow: 1; /* Take up remaining space in posts-container */
            overflow-y: auto;
            padding: 1rem;
            box-sizing: border-box;
        }
        .post-item {
            padding: 1rem;
            border-bottom: 1px solid #eee;
        }
        .post-item:last-child {
            border-bottom: none;
        }
        .post-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0.5rem;
        }
        .post-content {
            margin-bottom: 0.75rem;
            line-height: 1.4;
        }
        .post-actions {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #666;
        }
        .comments-modal {
            backdrop-filter: blur(4px);
        }
        .comments-modal-content {
            box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        }
        .comment-item:hover {
            background-color: #f9f9f9;
        }
        .post-action {
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            transition: background 0.2s;
        }
        .post-action:hover {
            background: #f0f0f0;
        }
        .post-action.liked {
            color: #d32f2f;
        }

        /* Notification Badge */
        .notification-badge {
            position: relative;
        }
        .notification-badge::after {
            content: attr(data-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background: #d32f2f;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        /* Trending Updates Panel (under collapsed map) */
        .trending-updates {
            position: fixed;
            top: calc(60px + 30vh + 10px); /* Below collapsed map */
            right: 0.5%;
            width: 25%; /* Match collapsed map width exactly */
            max-height: 300px;
            background: white;
            border: 2px solid #4b5c09;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 4; /* Below expanded map (z-index 5) but above content */
            display: none;
            overflow: hidden;
        }
        .trending-updates.show {
            display: block;
        }
        .trending-updates-header {
            background: #4b5c09;
            color: white;
            padding: 0.5rem;
            font-size: 0.9rem;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .trending-updates.expanded {
            max-height: calc(100vh - 60px - 30vh - 30px); /* Expand to bottom of screen minus padding */
        }
        .trending-updates.expanded .trending-updates-body {
            max-height: calc(100vh - 60px - 30vh - 80px); /* Account for header height */
        }
        .trending-item {
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
            font-size: 0.8rem;
            line-height: 1.3;
        }
        .trending-item:last-child {
            border-bottom: none;
        }
        .trending-item:hover {
            background: #f9f9f9;
        }
        .trending-expand-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.8rem;
            text-decoration: underline;
        }
        
        /* Password Input Styling */
        .password-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .password-toggle {
            position: absolute;
            right: 8px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            z-index: 1;
            opacity: 0.6;
            transition: opacity 0.2s;
        }
        
        .password-toggle:hover {
            opacity: 1;
        }
        
        .password-status {
            position: absolute;
            right: 40px;
            font-size: 1.2rem;
            color: #28a745;
            display: none;
            pointer-events: none;
        }
        
        .password-requirements {
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }
        
        .requirement {
            margin: 0.2rem 0;
            transition: color 0.2s;
            color: #dc3545; /* Red by default */
        }
        
        .requirement.met {
            color: #28a745; /* Green when met */
        }
        
        .requirement.met::before {
            content: '✓ ';
            font-weight: bold;
        }
        
        /* hCaptcha styling */
        .h-captcha {
            margin: 1rem 0;
        }

        /* Basic button styling */
        .btn {
            background: #4b5c09;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }
        
        .btn:hover {
            background: #3d4a08;
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <input class="search" type="text" placeholder="Search Name or Location" id="searchInput" onfocus="openSearch()" oninput="performGlobalSearch(this.value)">
        <div class="logo">[Logo Placeholder] United We Rise</div>
        <div class="nav">
            <givebutter-widget id="p75ZaL"></givebutter-widget>
            <a href="#">About UWR</a>
            <div id="authSection">
                <a href="#" onclick="openAuthModal('login')">Login / Sign-Up</a>
            </div>
            <div id="userSection" class="user-info" style="display: none;">
                <span id="userGreeting"></span>
                <button onclick="logout()">Logout</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authTitle">Login</h2>
                <button onclick="closeAuthModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <button class="btn" onclick="handleLogin()">Login</button>
                    <div class="auth-switch">
                        <a onclick="switchToRegister()">Don't have an account? Sign up</a>
                    </div>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="registerPassword" required>
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('registerPassword')">👁️</button>
                            <div class="password-status" id="password-status">✓</div>
                        </div>
                        <div class="password-requirements" id="password-requirements" style="display: none;">
                            <div class="requirement" id="req-length">• At least 8 characters</div>
                            <div class="requirement" id="req-uppercase">• One uppercase letter</div>
                            <div class="requirement" id="req-lowercase">• One lowercase letter</div>
                            <div class="requirement" id="req-number">• One number</div>
                            <div class="requirement" id="req-special">• One special character</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="registerFirstName">First Name</label>
                        <input type="text" id="registerFirstName">
                    </div>
                    <div class="form-group">
                        <label for="registerLastName">Last Name</label>
                        <input type="text" id="registerLastName">
                    </div>
                    <div class="form-group">
                        <!-- Use production key with proper domain (test.unitedwerise.com) -->
                        <div class="h-captcha" data-sitekey="9c5af3a8-5066-446c-970e-1c18d9fe8d9e" data-callback="onHCaptchaCallback" id="hcaptcha-register"></div>
                    </div>
                    <button class="btn" onclick="handleRegister()">Sign Up</button>
                    <div class="auth-switch">
                        <a onclick="switchToLogin()">Already have an account? Login</a>
                    </div>
                </div>
                
                <div id="authMessage"></div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar collapsed" id="sidebar">
            <div class="thumbs">
                <div class="thumb" onclick="toggleTrendingPanel()" title="Trending">🔥 <span class="label">Trending</span></div>
                <div class="thumb" onclick="togglePanel('upcoming')" title="Upcoming Contests">📅 <span class="label">Upcoming</span></div>
                <div class="thumb" onclick="togglePanel('officials')" title="My Elected Officials">🏛️ <span class="label">Officials</span></div>
                <div class="thumb" onclick="toggleMessages()" title="Messages" id="messagesThumb">💬 <span class="label">Messages</span></div>
                <div class="thumb" onclick="showMyProfile()" title="My Profile" id="profileThumb" style="display: none;">👤 <span class="label">My Profile</span></div>
            </div>
            <button id="toggleSidebar">⇄</button>
        </div>
        <div class="main" id="mainContent">
            <div class="posts-container">
                <div class="post-composer" id="postComposer" style="display: none;">
                    <textarea id="postContent" placeholder="Share your thoughts on political issues..."></textarea>
                    <div class="post-composer-actions">
                        <label>
                            <input type="checkbox" id="isPolitical"> Political post
                        </label>
                        <button class="btn" onclick="createPost()">Post</button>
                    </div>
                </div>
                <div class="posts-feed" id="postsFeed">
                    <h1>Welcome to United We Rise</h1>
                    <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="search-container" id="searchContainer" style="display: none;">
        <div class="search-header">
            <h3 style="margin: 0; color: #4b5c09;">Search Results</h3>
            <button onclick="closeSearch()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
        </div>
        <div class="search-results" id="globalSearchResults">
            <div style="text-align: center; color: #666; padding: 2rem;">
                Start typing to search for users
            </div>
        </div>
    </div>

    <div id="panel-trending" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Trending</span>
            <button onclick="closePanel('trending')">X</button>
        </div>
        <div class="panel-body">
            <div id="trendingContent">
                <details><summary>Local</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('Zoning Issue', 2)">Generic Zoning Issue</a></li>
                        <li><a href="#" onclick="openDetail('School District Issue', 2)">Generic School District Issue</a></li>
                    </ul>
                </details>
                <details><summary>State</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('State Tax Issue', 2)">Generic State Tax Issue</a></li>
                    </ul>
                </details>
                <details><summary>National</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('Immigration Issue', 2)">Generic Immigration Issue</a></li>
                        <li><a href="#" onclick="openDetail('Foreign Policy Issue', 2)">Generic Foreign Policy Issue</a></li>
                    </ul>
                </details>
            </div>
        </div>
    </div>

    <div id="panel-upcoming" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Upcoming Contests</span>
            <button onclick="closePanel('upcoming')">X</button>
        </div>
        <div class="panel-body">
            <details><summary>Local</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('Mayor', 2)">Mayor</a></li>
                    <li><a href="#" onclick="openDetail('City Council', 2)">City Council</a></li>
                    <li><a href="#" onclick="openDetail('School Board', 2)">School Board</a></li>
                </ul>
            </details>
            <details><summary>State</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('Governor', 2)">Governor</a></li>
                    <li><a href="#" onclick="openDetail('State Senate', 2)">State Senate</a></li>
                </ul>
            </details>
            <details><summary>National</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('President', 2)">President</a></li>
                    <li><a href="#" onclick="openDetail('U.S. House', 2)">U.S. House</a></li>
                </ul>
            </details>
        </div>
    </div>

    <div id="panel-officials" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>My Elected Officials</span>
            <button onclick="closePanel('officials')">X</button>
        </div>
        <div class="panel-body">
            <div id="officialsContent">
                <p>Please log in and set your address to see your elected officials.</p>
            </div>
        </div>
    </div>

    <div id="detail-panel" class="detail-panel hidden" data-offset="2">
        <div class="panel-header">
            <span id="detail-title">Detail</span>
            <button onclick="closeDetail()">X</button>
        </div>
        <div class="panel-body">
            <p id="detail-content">Placeholder content for selected topic.</p>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messagesContainer" class="messages-container">
        <div class="messages-header">
            <span>Messages</span>
            <button onclick="toggleMessages()" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="messages-body" id="messagesBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading conversations...</p>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div id="profilePanel" class="profile-panel">
        <div class="profile-header">
            <span>My Profile</span>
            <button onclick="toggleProfile()" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="profile-body" id="profileBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading profile...</p>
            </div>
        </div>
    </div>

    <!-- Trending Updates Panel (under collapsed map) -->
    <div id="trendingUpdates" class="trending-updates">
        <div class="trending-updates-header">
            <span>🔥 Trending Now</span>
            <button class="trending-expand-btn" onclick="toggleTrendingExpansion()" id="trendingExpandBtn">More</button>
        </div>
        <div class="trending-updates-body" id="trendingUpdatesBody">
            <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">
                Loading trending topics...
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="mapContainer">
        <button id="mapToggleBtn">Collapse</button>
        <div class="map-controls">
            <div class="zoom-filters">
                <label><input type="radio" name="zoomLevel" value="national" checked onchange="setZoomLevel('national')"> National</label>
                <label><input type="radio" name="zoomLevel" value="state" onchange="setZoomLevel('state')"> State</label>
                <label><input type="radio" name="zoomLevel" value="local" onchange="setZoomLevel('local')"> Local</label>
            </div>
            <div class="location-input">
                <input type="text" id="locationInput" placeholder="Enter location (or use current)" style="width: 200px; padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px; font-size: 0.8rem;">
                <button onclick="geocodeAndZoom()" style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-left: 0.25rem;">Go</button>
            </div>
        </div>
        <div id="map"></div>
    </div>

    <!-- CTA Panel -->
    <div id="google-cta-panel">
        <button onclick="this.parentElement.style.display='none'">&times;</button>
        <div style="text-align: left; margin: 0 10px;">
            <p style="margin: 0 0 8px 0; color: #5A534A; line-height: 1.4;">UnitedWeRise is a nonprofit platform connecting candidates directly with voters.</p>
            <p style="margin: 0 0 8px 0; color: #5A534A; line-height: 1.4;">No party machines. No corporate money.</p>
            <p style="margin: 0 0 8px 0; color: #5A534A; line-height: 1.4;">Together, we can elect leaders who actually represent us, not the Elites.</p>
            <p style="margin: 0 0 16px 0; color: #5A534A; line-height: 1.4;">Join the movement to reclaim democracy, because UnitedWeRise!</p>
        </div>
    </div>

    <script>
        // API Configuration
        const API_BASE = 'https://unitedwerise-backend.wonderfulpond-f8a8271f.eastus.azurecontainerapps.io/api';
        let currentUser = null;
        let authToken = null;
        let addressForm = null;

        // Check for existing auth on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load GiveButter widget
            const givebutterScript = document.createElement("script");
            givebutterScript.src = "https://widgets.givebutter.com/latest.umd.cjs?acct=rfuBvOJ14QTerl5N&p=other";
            givebutterScript.async = true;
            document.head.appendChild(givebutterScript);

            // Check for stored auth
            authToken = localStorage.getItem('authToken');
            console.log('Stored auth token:', authToken ? 'Present' : 'None');
            console.log('API Base URL:', API_BASE);
            if (authToken) {
                console.log('Attempting to verify user...');
                verifyAndSetUser();
            }

            // Wait for Leaflet to load before initializing map
            const initMapWhenReady = () => {
                if (typeof L !== 'undefined') {
                    initializeMap();
                } else {
                    // Check again in 100ms
                    setTimeout(initMapWhenReady, 100);
                }
            };
            
            // Start checking immediately
            initMapWhenReady();

            // Show CTA panel if not dismissed
            if (!localStorage.getItem('panelClosed')) {
                document.getElementById('google-cta-panel').style.display = 'block';
            }

            // Start trending refresh interval
            startTrendingRefresh();
        });

        // Authentication Functions
        async function verifyAndSetUser() {
            try {
                console.log('Verifying token with /auth/me...');
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Auth verification response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('Auth verification successful:', data.user);
                    setUserLoggedIn(data.user);
                } else {
                    // Token is invalid
                    console.log('Token invalid, removing from storage');
                    localStorage.removeItem('authToken');
                    authToken = null;
                }
            } catch (error) {
                console.error('Auth verification failed:', error);
                localStorage.removeItem('authToken');
                authToken = null;
            }
        }

        function openAuthModal(mode = 'login') {
            document.getElementById('authModal').style.display = 'block';
            if (mode === 'login') {
                switchToLogin();
            } else {
                switchToRegister();
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearAuthForm();
        }

        function switchToLogin() {
            document.getElementById('authTitle').textContent = 'Login';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearAuthForm();
        }

        function switchToRegister() {
            document.getElementById('authTitle').textContent = 'Sign Up';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearAuthForm();
        }

        function clearAuthForm() {
            document.getElementById('authMessage').innerHTML = '';
            // Clear all form inputs
            document.querySelectorAll('#authModal input').forEach(input => input.value = '');
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    setUserLoggedIn(data.user);
                    closeAuthModal();
                    showAuthMessage('Login successful!', 'success');
                } else {
                    showAuthMessage(data.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage('Network error. Please try again.', 'error');
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            
            // Get hCaptcha response
            let hcaptchaResponse = null;
            try {
                if (window.hcaptcha) {
                    const widget = document.getElementById('hcaptcha-register');
                    const hasIframe = widget && widget.querySelector('iframe');
                    
                    console.log('hCaptcha check before registration:', {
                        widget: widget ? 'exists' : 'missing',
                        iframe: hasIframe ? 'exists' : 'missing',
                        hcaptchaLoaded: typeof window.hcaptcha !== 'undefined'
                    });
                    
                    hcaptchaResponse = window.hcaptcha.getResponse();
                    console.log('hCaptcha response length:', hcaptchaResponse ? hcaptchaResponse.length : 0);
                }
            } catch (e) {
                console.error('hCaptcha getResponse error:', e);
            }

            if (!email || !username || !password) {
                showAuthMessage('Email, username, and password are required', 'error');
                return;
            }
            
            if (!hcaptchaResponse) {
                showAuthMessage('Please complete the captcha verification by clicking the checkbox above', 'error');
                return;
            }
            
            // Validate password
            if (!validatePassword(password)) {
                showAuthMessage('Password must meet all requirements', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ email, username, password, firstName, lastName, hcaptchaToken: hcaptchaResponse })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    setUserLoggedIn(data.user);
                    closeAuthModal();
                    showAuthMessage('Registration successful!', 'success');
                } else {
                    showAuthMessage(data.error || 'Registration failed', 'error');
                    // Reset hCaptcha on error
                    if (window.hcaptcha) {
                        window.hcaptcha.reset();
                    }
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthMessage('Network error. Please try again.', 'error');
                // Reset hCaptcha on error
                if (window.hcaptcha) {
                    window.hcaptcha.reset();
                }
            }
        }

        function setUserLoggedIn(user) {
            currentUser = user;
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'flex';
            document.getElementById('userGreeting').textContent = `Hello, ${user.firstName || user.username}!`;
            
            // Address info will be loaded by loadUserContent()
            
            // Show user-specific sidebar options
            document.getElementById('messagesThumb').style.display = 'block';
            document.getElementById('profileThumb').style.display = 'block';
            document.getElementById('postComposer').style.display = 'block';
            
            // Load user-specific content
            loadUserContent();
            loadUserPosts();
        }


        // Enable/disable radio buttons based on available location data
        function updateRadioButtonAvailability() {
            const stateRadio = document.querySelector('input[name="zoomLevel"][value="state"]');
            const localRadio = document.querySelector('input[name="zoomLevel"][value="local"]');
            const stateLabel = stateRadio?.parentElement;
            const localLabel = localRadio?.parentElement;
            
            // Check if user has location data
            const hasState = currentUser && currentUser.state;
            const hasAddress = currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state;
            
            // Enable/disable state radio
            if (stateRadio && stateLabel) {
                stateRadio.disabled = !hasState;
                stateLabel.style.opacity = hasState ? '1' : '0.5';
                stateLabel.style.cursor = hasState ? 'pointer' : 'not-allowed';
            }
            
            // Enable/disable local radio
            if (localRadio && localLabel) {
                localRadio.disabled = !hasAddress;
                localLabel.style.opacity = hasAddress ? '1' : '0.5';
                localLabel.style.cursor = hasAddress ? 'pointer' : 'not-allowed';
            }
            
            console.log(`Radio button availability - State: ${hasState}, Local: ${hasAddress}`);
        }

        function logout() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('authSection').style.display = 'block';
            document.getElementById('userSection').style.display = 'none';
            
            // Hide user-specific elements
            document.getElementById('messagesThumb').style.display = 'none';
            document.getElementById('profileThumb').style.display = 'none';
            document.getElementById('postComposer').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            document.getElementById('profilePanel').style.display = 'none';
            
            // Reset panels to default content
            resetPanelsToDefault();
            
            // Reset main content
            document.getElementById('postsFeed').innerHTML = `
                <h1>Welcome to United We Rise</h1>
                <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
            `;
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        async function loadUserContent() {
            // Load user's elected officials if they have an address
            try {
                const response = await apiCall('/users/profile');

                if (response.ok) {
                    const data = response.data;
                    
                    // UPDATE: Merge the complete profile data into currentUser
                    if (data.user) {
                        currentUser = { ...currentUser, ...data.user };
                        console.log('User profile data merged into currentUser:', currentUser);
                        
                        // Update radio button availability now that we have address data
                        updateRadioButtonAvailability();
                        
                        // Load representatives if we have address
                        if (data.user.zipCode && data.user.state) {
                            loadElectedOfficials(data.user.zipCode, data.user.state);
                        }
                        
                        // Update map location if we have address
                        if (mapInstance && currentUser.state) {
                            getCurrentUserLocation();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load user content:', error);
            }
        }

        async function loadElectedOfficials(zipCode, state) {
            try {
                const response = await apiCall('/political/representatives');
                
                if (response.ok && response.data) {
                    const representatives = response.data.representatives;
                    updateOfficialsPanel(representatives);
                    
                    // Extract district information for boundary loading
                    console.log('Representatives data received:', representatives);
                    
                    if (representatives && representatives.federal) {
                        console.log('Federal representatives:', representatives.federal);
                        
                        const districtRep = representatives.federal.find(rep => 
                            rep.office && rep.office.includes('Representative')
                        );
                        
                        console.log('Found district rep:', districtRep);
                        
                        if (districtRep) {
                            let districtNumber = null;
                            let stateAbbr = null;
                            
                            // First try to use the district field directly
                            if (districtRep.district) {
                                console.log('District field found:', districtRep.district);
                                
                                // District field might be like "IL-10" or just "10"  
                                const districtMatch = districtRep.district.match(/(?:(\w{2})-)?(\d+)/);
                                if (districtMatch) {
                                    stateAbbr = districtMatch[1] || (currentUser && currentUser.state);
                                    districtNumber = districtMatch[2];
                                }
                            }
                            
                            // Fallback: try to extract from office title
                            if (!districtNumber && districtRep.office) {
                                console.log('Fallback: parsing office title:', districtRep.office);
                                const officeMatch = districtRep.office.match(/(\w{2})-(\d+)/);
                                if (officeMatch) {
                                    stateAbbr = officeMatch[1];
                                    districtNumber = officeMatch[2];
                                }
                            }
                            
                            if (districtNumber && stateAbbr) {
                                // Store district info for boundary loading
                                if (!currentUser) currentUser = {};
                                currentUser.district = districtNumber;
                                currentUser.state = stateAbbr;
                                
                                console.log(`District info extracted: ${currentUser.state}-${currentUser.district}`);
                                
                                // Load boundary if currently at local zoom
                                if (currentZoomLevel === 'local' && boundaryManager && currentLocation) {
                                    console.log('Loading district boundary...');
                                    boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                                }
                            } else {
                                console.warn('Could not extract district information from representative data');
                            }
                        } else {
                            console.warn('No district representative found in federal representatives');
                        }
                    } else {
                        console.warn('No federal representatives found in response');
                    }
                } else {
                    console.log('No representatives data available yet - may need address in profile');
                }
            } catch (error) {
                console.error('Failed to load representatives:', error);
            }
        }

        function updateOfficialsPanel(representatives) {
            const content = document.getElementById('officialsContent');
            
            // Check if representatives object has any data
            const totalReps = (representatives.federal || []).length + 
                            (representatives.state || []).length + 
                            (representatives.local || []).length;
            
            if (totalReps === 0) {
                content.innerHTML = '<p>No representatives found. Please add your complete address in your profile.</p>';
                return;
            }

            let html = '<div>';
            
            // Federal representatives
            if (representatives.federal && representatives.federal.length > 0) {
                html += '<h4>Federal Representatives</h4>';
                representatives.federal.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                ${rep.photoUrl ? `<img src="${rep.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + rep.name.charAt(0) + '</div>'}
                                <div>
                                    <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                                    <em>${rep.office}</em>
                                </div>
                            </div>
                            ${rep.phones && rep.phones.length > 0 ? `<div>📞 ${rep.phones[0]}</div>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `<div>🌐 <a href="${rep.urls[0]}" target="_blank">Website</a></div>` : ''}
                            ${rep.social && rep.social.twitter ? `<div>🐦 @${rep.social.twitter}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // State representatives
            if (representatives.state && representatives.state.length > 0) {
                html += '<h4>State Representatives</h4>';
                representatives.state.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                ${rep.photoUrl ? `<img src="${rep.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #6B8E23; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + rep.name.charAt(0) + '</div>'}
                                <div>
                                    <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                                    <em>${rep.office}</em>
                                </div>
                            </div>
                            ${rep.phones && rep.phones.length > 0 ? `<div>📞 ${rep.phones[0]}</div>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `<div>🌐 <a href="${rep.urls[0]}" target="_blank">Website</a></div>` : ''}
                        </div>
                    `;
                });
            }
            
            // Local representatives
            if (representatives.local && representatives.local.length > 0) {
                html += '<h4>Local Representatives</h4>';
                representatives.local.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f0f8f0;">
                            <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                            <em>${rep.office}</em><br>
                            ${rep.phones && rep.phones.length > 0 ? `📞 ${rep.phones[0]}<br>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `🌐 <a href="${rep.urls[0]}" target="_blank">Website</a>` : ''}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function resetPanelsToDefault() {
            document.getElementById('officialsContent').innerHTML = '<p>Please log in and set your address to see your elected officials.</p>';
        }

        // Existing panel functions
        function togglePanel(name) {
            closeAllPanels();
            document.getElementById(`panel-${name}`).classList.remove('hidden');
        }

        function closePanel(name) {
            document.getElementById(`panel-${name}`).classList.add('hidden');
        }

        function closeAllPanels() {
            document.querySelectorAll('.info-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('detail-panel').classList.add('hidden');
        }

        function openDetail(title, offset) {
            const panel = document.getElementById('detail-panel');
            document.getElementById('detail-title').innerText = title;
            document.getElementById('detail-content').innerText = `Placeholder content for ${title}.`;
            panel.dataset.offset = offset;
            panel.classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.add('hidden');
        }

        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            document.getElementById('sidebar').classList.toggle('expanded');
        });

        // Map initialization
        function initializeMap() {
            const map = L.map('map', {
                center: [37.8283, -98.5795],
                zoom: 5,
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                tap: false,
                touchZoom: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '', // Remove attribution
                subdomains: 'abcd',
            }).addTo(map);

            const topics = [
                { coords: [40.7128, -74.0060], text: '📢 Rent control in NYC gaining momentum!' },
                { coords: [34.0522, -118.2437], text: '🚗 EV subsidies debated in California legislature.' },
                { coords: [41.8781, -87.6298], text: '⚖️ Chicago voters discuss criminal justice reform.' },
                { coords: [29.7604, -95.3698], text: '🗳️ Texas push for open primaries gaining traction.' },
                { coords: [47.6062, -122.3321], text: '🌳 Seattle community organizing for green zoning laws.' },
                { coords: [39.7392, -104.9903], text: '🏡 Denver debates housing-first initiatives.' },
                { coords: [33.4484, -112.0740], text: '🚁 Phoenix drone delivery regulations spark debate.' },
                { coords: [25.7617, -80.1918], text: '🏖️ Miami climate resiliency bonds trending.' },
                { coords: [32.7767, -96.7970], text: '💼 Dallas campaign finance reform gaining traction.' },
                { coords: [42.3601, -71.0589], text: '📚 Boston pushes universal childcare ballot measure.' }
            ];

            let usedTopics = new Map();

            function showRandomPopups() {
                const count = Math.floor(Math.random() * 2) + 1;
                const now = Date.now();

                const availableTopics = topics.filter(t => {
                    const lastShown = usedTopics.has(t.text) ? usedTopics.get(t.text) : 0;
                    return now - lastShown > 180000;
                });

                const shuffled = availableTopics.sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, count);

                selected.forEach(topic => {
                    const popup = L.popup({
                        closeButton: false,
                        autoClose: false,
                        closeOnClick: false,
                        autoPan: false
                    })
                        .setLatLng(topic.coords)
                        .setContent(topic.text)
                        .openOn(map);

                    usedTopics.set(topic.text, now);
                    setTimeout(() => map.closePopup(popup), 30000);
                });

                const nextDelay = Math.floor(Math.random() * 3000) + 13000;
                setTimeout(showRandomPopups, nextDelay);
            }

            showRandomPopups();

            // Toggle map collapse
            const mapContainer = document.getElementById('mapContainer');
            const toggleBtn = document.getElementById('mapToggleBtn');
            const resizeObserver = new ResizeObserver(() => {
                map.invalidateSize();
            });
            resizeObserver.observe(mapContainer);
            
            toggleBtn.addEventListener('click', () => {
                const isCollapsing = !mapContainer.classList.contains('collapsed');
                const mapControls = document.querySelector('.map-controls');
                
                // Store current zoom level state before collapsing
                const currentRadio = document.querySelector('input[name="zoomLevel"]:checked');
                const currentLevel = currentRadio ? currentRadio.value : 'national';
                
                // Fade out controls
                mapControls.classList.add('hiding');
                
                // Wait for fade out, then toggle map and fade back in
                setTimeout(async () => {
                    mapContainer.classList.toggle('collapsed');
                    toggleBtn.textContent = isCollapsing ? 'Expand' : 'Collapse';
                    
                    // Don't set hardcoded zoom - let setZoomLevel handle it properly
                    // Restore zoom level state and apply proper zoom for current map size
                    currentZoomLevel = currentLevel;
                    updateRadioButtonState(currentLevel);
                    
                    // Apply the zoom level with proper settings for expanded/collapsed state
                    if (currentLocation || currentLevel === 'national') {
                        await setZoomLevel(currentLevel);
                    }
                    
                    // Fade controls back in after a short delay for repositioning
                    setTimeout(() => {
                        mapControls.classList.remove('hiding');
                    }, 50);
                }, 300);
                
                // CSS handles the main content adjustment automatically
            });

            // Set map instance for zoom controls
            setMapInstance(map);

            return map;
        }

        // Close CTA panel permanently
        document.getElementById('google-cta-panel').querySelector('button').addEventListener('click', function() {
            localStorage.setItem('panelClosed', 'true');
        });

        // API Response Cache
        const apiCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes for general API calls
        const REPRESENTATIVES_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes for representatives (they don't change often)

        // API Helper Functions
        async function apiCall(endpoint, options = {}) {
            // Check cache for GET requests (unless explicitly bypassing cache)
            const isGet = !options.method || options.method === 'GET';
            const bypassCache = options.bypassCache;
            
            if (isGet && !bypassCache) {
                const cacheKey = `${endpoint}${authToken ? `_${authToken.substring(0, 10)}` : ''}`;
                const cached = apiCache.get(cacheKey);
                
                // Use longer cache duration for representatives data
                const cacheDuration = endpoint.includes('representatives') || endpoint.includes('officials') 
                    ? REPRESENTATIVES_CACHE_DURATION 
                    : CACHE_DURATION;
                
                if (cached && (Date.now() - cached.timestamp) < cacheDuration) {
                    console.log(`Using cached API response for ${endpoint} (${Math.round((Date.now() - cached.timestamp) / 1000)}s old)`);
                    return cached.data;
                }
            }
            
            const config = {
                headers: {
                    'Content-Type': 'application/json',
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };
            
            // Remove custom options before fetch
            delete config.bypassCache;

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                // Create a response object with ok status and parsed data
                const result = {
                    ok: response.ok,
                    status: response.status,
                    data: null
                };

                // Try to parse JSON response
                try {
                    const text = await response.text();
                    if (text) {
                        result.data = JSON.parse(text);
                    }
                } catch (parseError) {
                    console.warn('Failed to parse JSON response:', parseError);
                    result.data = { error: 'Invalid response format' };
                }
                
                // Cache GET responses
                if (isGet && !bypassCache && result.ok) {
                    const cacheKey = `${endpoint}${authToken ? `_${authToken.substring(0, 10)}` : ''}`;
                    apiCache.set(cacheKey, {
                        timestamp: Date.now(),
                        data: result
                    });
                    
                    // Clean old cache entries periodically
                    if (apiCache.size > 100) {
                        const cutoff = Date.now() - Math.max(CACHE_DURATION, REPRESENTATIVES_CACHE_DURATION);
                        for (const [key, value] of apiCache.entries()) {
                            if (value.timestamp < cutoff) {
                                apiCache.delete(key);
                            }
                        }
                    }
                }

                return result;
            } catch (networkError) {
                console.error('Network error:', networkError);
                return {
                    ok: false,
                    status: 0,
                    data: { error: 'Network error. Please check your connection.' }
                };
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    await performSearch(query);
                }
            }
        });

        async function performSearch(query) {
            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                
                if (response.ok) {
                    // Only use the global search results container, not the feed area
                    displayGlobalSearchResults(response.data.users);
                } else {
                    console.error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function displaySearchResults(users, query) {
            const mainContent = document.getElementById('mainContent');
            
            if (users.length === 0) {
                mainContent.innerHTML = `
                    <h1>Search Results</h1>
                    <p>No users found for "${query}"</p>
                `;
                return;
            }

            let html = `
                <h1>Search Results for "${query}"</h1>
                <div style="display: grid; gap: 1rem;">
            `;

            users.forEach(user => {
                const profileType = user.politicalProfileType || 'CITIZEN';
                const typeEmoji = {
                    'CANDIDATE': '🗳️',
                    'ELECTED_OFFICIAL': '🏛️',
                    'POLITICAL_ORG': '🏢',
                    'CITIZEN': '👤'
                }[profileType];

                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">${typeEmoji}</span>
                            <div>
                                <strong>${user.firstName || ''} ${user.lastName || ''}</strong>
                                ${user.verified ? '<span style="color: #1976d2;">✓</span>' : ''}
                                <br>
                                <small style="color: #666;">@${user.username}</small>
                            </div>
                        </div>
                        ${user.bio ? `<p style="margin: 0.5rem 0; color: #555;">${user.bio}</p>` : ''}
                        ${user.office ? `<p style="margin: 0.25rem 0; font-style: italic;">${user.office}</p>` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                            ${user.followersCount} followers
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            mainContent.innerHTML = html;
        }

        // Load trending posts for the trending panel
        async function loadTrendingPosts() {
            try {
                const response = await apiCall('/feed/trending');
                
                if (response.ok) {
                    updateTrendingPanel(response.data.posts);
                } else {
                    console.error('Failed to load trending posts:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load trending posts:', error);
            }
        }

        // Auto-refresh trending posts
        let trendingRefreshInterval = null;

        function startTrendingRefresh() {
            // Load initial trending updates (but don't spam if backend isn't ready)
            setTimeout(() => loadTrendingUpdates(), 2000);
            
            // Refresh trending every 50 seconds (new posts roll in at top, old ones roll off bottom)
            trendingRefreshInterval = setInterval(() => {
                // Only refresh if trending panel is visible
                if (document.getElementById('trendingUpdates').classList.contains('show')) {
                    loadTrendingUpdates();
                }
            }, 50000);
        }

        function stopTrendingRefresh() {
            if (trendingRefreshInterval) {
                clearInterval(trendingRefreshInterval);
                trendingRefreshInterval = null;
            }
        }

        // Load trending updates for the mini panel under map
        async function loadTrendingUpdates() {
            try {
                // Check if backend is reachable first
                const healthCheck = await fetch(`${API_BASE.replace('/api', '')}/health`);
                if (!healthCheck.ok) {
                    console.log('Backend not available, skipping trending updates');
                    return;
                }

                const response = await apiCall('/feed/trending?limit=20');
                
                if (response.ok) {
                    updateTrendingUpdatesPanel(response.data.posts);
                    
                    // Show the panel when there's content
                    const panel = document.getElementById('trendingUpdates');
                    if (response.data.posts.length > 0) {
                        panel.classList.add('show');
                    }
                } else {
                    console.log('No trending posts available yet');
                }
            } catch (error) {
                console.log('Trending updates not available:', error.message);
                // Silently fail - don't spam console with errors
            }
        }

        let allTrendingPosts = [];
        let trendingExpanded = false;

        function updateTrendingUpdatesPanel(posts) {
            allTrendingPosts = posts;
            const body = document.getElementById('trendingUpdatesBody');
            
            if (posts.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayPosts = trendingExpanded ? posts : posts.slice(0, 5);
            let html = '';
            
            displayPosts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                const preview = post.content.length > 80 ? post.content.substring(0, 80) + '...' : post.content;
                
                html += `
                    <div class="trending-item">
                        <div style="font-weight: bold; margin-bottom: 2px; font-size: 0.85rem;">@${post.author.username}</div>
                        <div style="margin-bottom: 4px;">${preview}</div>
                        <div style="color: #666; font-size: 0.75rem; margin-bottom: 4px;">
                            <span style="cursor: pointer; margin-right: 8px;" onclick="likeTrendingPost('${post.id}')">❤️ ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 8px;" onclick="showTrendingCommentBox('${post.id}')">💬 Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; margin-right: 8px; color: #4b5c09;" onclick="viewComments('${post.id}')">👁️ ${post.commentsCount}</span>` : ''}
                            <span>${timeAgo}</span>
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 50px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical; font-size: 0.8rem;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-size: 0.8rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
        }

        function toggleTrendingExpansion() {
            const panel = document.getElementById('trendingUpdates');
            const btn = document.getElementById('trendingExpandBtn');
            
            trendingExpanded = !trendingExpanded;
            
            if (trendingExpanded) {
                panel.classList.add('expanded');
                btn.textContent = 'Less';
            } else {
                panel.classList.remove('expanded');
                btn.textContent = 'More';
            }
            
            updateTrendingUpdatesPanel(allTrendingPosts);
        }

        function toggleTrendingPanel() {
            const panel = document.getElementById('trendingUpdates');
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
            } else {
                loadTrendingUpdates(); // Load fresh data
                panel.classList.add('show');
            }
        }

        function openFullTrending() {
            // This function kept for compatibility but now just expands in place
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function viewTrendingPost(postId) {
            // For now, just expand the trending if not already expanded
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function updateTrendingPanel(posts) {
            const content = document.getElementById('trendingContent');
            
            if (posts.length === 0) {
                content.innerHTML = '<p>No trending posts available.</p>';
                return;
            }

            let html = '<div>';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                html += `
                    <div style="margin-bottom: 1rem; padding: 0.75rem; border-left: 3px solid #4b5c09; background: #f9f9f9;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                            @${post.author.username} • ${timeAgo}
                        </div>
                        <div style="margin-bottom: 0.5rem;">${post.content}</div>
                        <div style="font-size: 0.8rem; color: #888;">
                            <span style="cursor: pointer; margin-right: 10px;" onclick="likeTrendingPost('${post.id}')">❤️ ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 10px;" onclick="showTrendingCommentBox('${post.id}')">💬 Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; color: #4b5c09;" onclick="viewComments('${post.id}')">👁️ View ${post.commentsCount}</span>` : ''}
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }

        // Override existing togglePanel to load live data
        const originalTogglePanel = window.togglePanel;
        window.togglePanel = function(name) {
            originalTogglePanel(name);
            
            // Load live data when panels open
            if (name === 'trending') {
                loadTrendingPosts();
            } else if (name === 'officials' && currentUser) {
                loadUserContent();
            }
        };

        // Messages Functions
        function toggleMessages() {
            const container = document.getElementById('messagesContainer');
            if (container.style.display === 'none' || !container.style.display) {
                container.style.display = 'block';
                loadConversations();
            } else {
                container.style.display = 'none';
            }
        }

        async function loadConversations() {
            if (!authToken) return;

            try {
                const response = await apiCall('/messages/conversations');
                
                if (response.ok) {
                    displayConversations(response.data.conversations);
                } else {
                    document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Failed to load conversations</p>';
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
                document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Error loading conversations</p>';
            }
        }

        function displayConversations(conversations) {
            const body = document.getElementById('messagesBody');
            
            if (!authToken) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view messages</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="showNewConversationForm()" style="width: 100%; padding: 0.5vh; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        + New Conversation
                    </button>
                </div>
            `;
            
            if (conversations.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>No conversations yet</p>
                        <p style="font-size: 0.9rem;">Start your first conversation!</p>
                    </div>
                `;
            } else {
                conversations.forEach(conv => {
                    const participant = conv.participants[0];
                    const timeAgo = conv.lastMessageAt ? getTimeAgo(new Date(conv.lastMessageAt)) : '';
                    
                    html += `
                        <div class="conversation-item" onclick="openConversation('${conv.id}', '${participant.username}')">
                            <div class="user-avatar">${(participant.firstName?.[0] || participant.username[0]).toUpperCase()}</div>
                            <div class="conversation-info">
                                <div class="conversation-name">${participant.firstName || participant.username}</div>
                                <div class="conversation-preview">${conv.lastMessageContent || 'No messages yet'} ${timeAgo ? '• ' + timeAgo : ''}</div>
                            </div>
                        </div>
                    `;
                });
            }

            body.innerHTML = html;
        }

        function showNewConversationForm() {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">←</button>
                    <span style="font-weight: bold;">New Conversation</span>
                </div>
                
                <div style="padding: 1rem; text-align: center;">
                    <div style="color: #666; margin-bottom: 1rem;">
                        <p>To start a new conversation, use the search bar at the top of the page to find users.</p>
                        <p style="font-size: 0.9rem;">Search results will include options to message, follow, and add as friend.</p>
                    </div>
                    <button onclick="document.getElementById('searchInput').focus(); openSearch();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Open Search
                    </button>
                </div>
            `;
            
            // Focus on search input
            setTimeout(() => {
                document.getElementById('userSearchInput')?.focus();
            }, 100);
        }


        async function startConversationWithUser(userId, username) {
            try {
                const response = await apiCall('/messages/conversations', {
                    method: 'POST',
                    body: JSON.stringify({ participantId: userId })
                });

                if (response.ok) {
                    // Open the conversation
                    openConversation(response.data.conversation.id, username);
                } else {
                    alert('Failed to start conversation');
                }
            } catch (error) {
                console.error('Failed to start conversation:', error);
                alert('Error starting conversation');
            }
        }

        async function openConversation(conversationId, username) {
            try {
                // Load messages for this conversation
                const response = await apiCall(`/messages/conversations/${conversationId}/messages`);
                
                if (response.ok) {
                    showConversationView(conversationId, username, response.data.messages);
                } else {
                    alert('Failed to load conversation');
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
                alert('Error loading conversation');
            }
        }

        function showConversationView(conversationId, username, messages) {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">←</button>
                    <div class="user-avatar" style="margin-right: 0.5rem;">${username[0].toUpperCase()}</div>
                    <span style="font-weight: bold;">${username}</span>
                </div>
                
                <div id="messagesArea" style="height: 250px; overflow-y: auto; padding: 0.5rem; background: white;">
                    ${messages.length === 0 ? 
                        '<div style="text-align: center; padding: 2rem; color: #666;">No messages yet. Start the conversation!</div>' :
                        messages.map(msg => `
                            <div style="margin-bottom: 0.75rem; ${msg.sender.id === currentUser?.id ? 'text-align: right;' : ''}">
                                <div style="display: inline-block; max-width: 80%; padding: 0.5rem 0.75rem; border-radius: 12px; ${
                                    msg.sender.id === currentUser?.id ? 
                                    'background: #4b5c09; color: white;' : 
                                    'background: #f0f0f0; color: black;'
                                }">
                                    <div style="font-size: 0.9rem;">${msg.content}</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.8;">
                                        ${msg.sender.id === currentUser?.id ? '' : msg.sender.username + ' • '}${new Date(msg.createdAt).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                
                <div style="display: flex; padding: 1vh; border-top: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <input 
                        type="text" 
                        id="messageInput-${conversationId}" 
                        placeholder="Type a message..." 
                        style="flex: 1; padding: 0.5vh; border: 1px solid #ddd; border-radius: 20px; margin-right: 0.5rem; outline: none;"
                        onkeypress="handleMessageKeyPress(event, '${conversationId}')"
                    >
                    <button 
                        onclick="sendMessage('${conversationId}')" 
                        style="background: #4b5c09; color: white; border: none; padding: 0.5vh 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem;"
                    >
                        Send
                    </button>
                </div>
            `;
            
            // Scroll to bottom of messages
            setTimeout(() => {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById(`messageInput-${conversationId}`)?.focus();
            }, 100);
        }

        function backToConversations() {
            loadConversations();
        }

        function handleMessageKeyPress(event, conversationId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(conversationId);
            }
        }

        async function sendMessage(conversationId) {
            const input = document.getElementById(`messageInput-${conversationId}`);
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                const response = await apiCall(`/messages/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    input.value = '';
                    // Refresh the conversation to show the new message
                    const username = document.querySelector('#messagesBody span[style*="font-weight: bold"]')?.textContent;
                    if (username) {
                        openConversation(conversationId, username);
                    }
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Error sending message');
            }
        }

        // Profile Functions - Updated to use main content area
        function toggleProfile() {
            // Use the new My Profile component instead of the old side panel
            showMyProfile();
        }

        // New function to show My Profile in main content area
        function showMyProfile() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your profile</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            // Hide all panels and show profile in main content
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            window.myProfile.render('mainContent');
        }

        async function loadUserProfile() {
            if (!authToken) {
                document.getElementById('profileBody').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view your profile</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }

            try {
                console.log('Loading user profile...');
                const response = await apiCall('/users/profile');
                
                console.log('Profile response:', response);
                
                if (response.ok) {
                    const data = response.data;
                    displayUserProfile(data.user);
                } else {
                    const errorMsg = response.data?.error || 'Failed to load profile';
                    document.getElementById('profileBody').innerHTML = `<p style="color: #d32f2f;">Error: ${errorMsg}</p>`;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                document.getElementById('profileBody').innerHTML = '<p style="color: #d32f2f;">Network error loading profile</p>';
            }
        }

        function displayUserProfile(user) {
            const body = document.getElementById('profileBody');
            
            let html = `
                <div class="profile-section">
                    <h3>Basic Information</h3>
                    <p><strong>Username:</strong> @${user.username}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    ${user.firstName ? `<p><strong>Name:</strong> ${user.firstName} ${user.lastName || ''}</p>` : ''}
                    ${user.bio ? `<p><strong>Bio:</strong> ${user.bio}</p>` : ''}
                    ${user.website ? `<p><strong>Website:</strong> <a href="${user.website}" target="_blank">${user.website}</a></p>` : ''}
                </div>

                <div class="profile-section">
                    <h3>Social Stats</h3>
                    <p><strong>Followers:</strong> <a href="#" onclick="showFollowersList('${user.id}')" style="color: #4b5c09; text-decoration: none;">${user.followersCount}</a></p>
                    <p><strong>Following:</strong> <a href="#" onclick="showFollowingList('${user.id}')" style="color: #4b5c09; text-decoration: none;">${user.followingCount}</a></p>
                </div>
            `;

            if (user.politicalProfileType && user.politicalProfileType !== 'CITIZEN') {
                html += `
                    <div class="profile-section">
                        <h3>Political Profile</h3>
                        <p><strong>Type:</strong> ${user.politicalProfileType.replace('_', ' ')}</p>
                        ${user.office ? `<p><strong>Office:</strong> ${user.office}</p>` : ''}
                        ${user.officialTitle ? `<p><strong>Title:</strong> ${user.officialTitle}</p>` : ''}
                        <p><strong>Verification:</strong> ${user.verificationStatus}</p>
                    </div>
                `;
            }

            if (user.streetAddress) {
                html += `
                    <div class="profile-section">
                        <h3>Location</h3>
                        <p>${user.streetAddress}<br>${user.city}, ${user.state} ${user.zipCode}</p>
                    </div>
                `;
            }

            html += `
                <div class="profile-section">
                    <button class="btn" onclick="editProfile()">Edit Profile</button>
                </div>
            `;

            body.innerHTML = html;
        }

        function editProfile() {
            const body = document.getElementById('profileBody');
            
            if (!currentUser) return;
            
            body.innerHTML = `
                <form id="profileEditForm">
                    <div class="profile-section">
                        <h3>Basic Information</h3>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="editFirstName" value="${currentUser.firstName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="editLastName" value="${currentUser.lastName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea id="editBio" style="width: 100%; height: 80px; box-sizing: border-box;">${currentUser.bio || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" id="editWebsite" value="${currentUser.website || ''}">
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Political Profile</h3>
                        <div class="form-group">
                            <label>Profile Type</label>
                            <select id="editPoliticalType" onchange="updatePoliticalFields()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="CITIZEN" ${(currentUser.politicalProfileType || 'CITIZEN') === 'CITIZEN' ? 'selected' : ''}>Citizen</option>
                                <option value="CANDIDATE" ${currentUser.politicalProfileType === 'CANDIDATE' ? 'selected' : ''}>Political Candidate</option>
                                <option value="ELECTED_OFFICIAL" ${currentUser.politicalProfileType === 'ELECTED_OFFICIAL' ? 'selected' : ''}>Elected Official</option>
                                <option value="POLITICAL_ORG" ${currentUser.politicalProfileType === 'POLITICAL_ORG' ? 'selected' : ''}>Political Organization</option>
                            </select>
                        </div>
                        
                        <div id="politicalFieldsContainer">
                            <!-- Political fields will be populated here -->
                        </div>
                        
                        <div id="verificationSection" style="display: none;">
                            <div style="background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #4b5c09;">Political Verification</h4>
                                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                                    Political candidates and elected officials require verification. Upload supporting documents to verify your political status.
                                </p>
                                
                                <div class="form-group">
                                    <label>Current Verification Status</label>
                                    <div style="padding: 0.5rem; background: ${getVerificationStatusColor(currentUser.verificationStatus)}; border-radius: 4px; font-weight: bold;">
                                        ${getVerificationStatusText(currentUser.verificationStatus)}
                                    </div>
                                </div>
                                
                                ${currentUser.verificationStatus === 'PENDING' || currentUser.verificationStatus === 'DENIED' ? `
                                <div class="form-group">
                                    <label>Upload Verification Documents</label>
                                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                                        Upload documents that verify your political status (e.g., filing papers, official campaign documents, government ID with title, etc.)
                                    </p>
                                    <input type="file" id="verificationDocs" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="width: 100%;">
                                    <button type="button" onclick="uploadVerificationDocs()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Upload Documents
                                    </button>
                                </div>
                                ` : ''}
                                
                                ${currentUser.verificationStatus === 'APPROVED' ? `
                                <div style="color: #2e7d32; font-weight: bold;">
                                    ✅ Your political profile has been verified!
                                </div>
                                ` : ''}
                                
                                ${currentUser.verificationStatus === 'DENIED' ? `
                                <div style="color: #d32f2f; font-weight: bold;">
                                    ❌ Verification was denied. Please upload additional documentation or contact support.
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Address (for finding your elected officials)</h3>
                        <div id="profileAddressForm"></div>
                    </div>
                    
                    <div class="profile-section">
                        <button type="button" class="btn" onclick="saveProfile()">Save Changes</button>
                        <button type="button" class="btn-secondary btn" onclick="cancelEditProfile()">Cancel</button>
                    </div>
                </form>
            `;
            
            // Initialize the address form
            addressForm = createAddressForm({
                containerId: 'profileAddressForm',
                initialValues: {
                    streetAddress: currentUser.streetAddress || '',
                    city: currentUser.city || '',
                    state: currentUser.state || '',
                    zipCode: currentUser.zipCode || ''
                },
                onChange: (data) => {
                    // Address data changed - could trigger validation or auto-save
                    console.log('Address updated:', data);
                },
                required: false
            });
            
            // Initialize political fields
            updatePoliticalFields();
        }

        function getVerificationStatusColor(status) {
            switch(status) {
                case 'APPROVED': return '#e8f5e8';
                case 'DENIED': return '#ffebee';
                case 'PENDING': return '#fff3e0';
                default: return '#f5f5f5';
            }
        }

        function getVerificationStatusText(status) {
            switch(status) {
                case 'APPROVED': return '✅ Verified';
                case 'DENIED': return '❌ Verification Denied';
                case 'PENDING': return '⏳ Verification Pending';
                case 'NOT_REQUIRED': return 'Not Required';
                default: return 'Unknown';
            }
        }

        function updatePoliticalFields() {
            const politicalType = document.getElementById('editPoliticalType')?.value;
            const container = document.getElementById('politicalFieldsContainer');
            const verificationSection = document.getElementById('verificationSection');
            
            if (!container) return;
            
            let fieldsHtml = '';
            
            if (politicalType === 'CANDIDATE') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Political Party (optional)</label>
                        <input type="text" id="editPoliticalParty" value="${currentUser.politicalParty || ''}" placeholder="e.g., Democratic, Republican, Independent">
                    </div>
                    <div class="form-group">
                        <label>Office Seeking</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., Mayor of Springfield, State Senator District 5">
                    </div>
                    <div class="form-group">
                        <label>Campaign Website (optional)</label>
                        <input type="url" id="editCampaignWebsite" value="${currentUser.campaignWebsite || ''}" placeholder="https://...">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Political Party (optional)</label>
                        <input type="text" id="editPoliticalParty" value="${currentUser.politicalParty || ''}" placeholder="e.g., Democratic, Republican, Independent">
                    </div>
                    <div class="form-group">
                        <label>Current Office</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., Mayor of Springfield, State Senator District 5">
                    </div>
                    <div class="form-group">
                        <label>Official Title</label>
                        <input type="text" id="editOfficialTitle" value="${currentUser.officialTitle || ''}" placeholder="e.g., The Honorable, Mayor, Senator">
                    </div>
                    <div class="form-group">
                        <label>Term Start Date (optional)</label>
                        <input type="date" id="editTermStart" value="${currentUser.termStart ? new Date(currentUser.termStart).toISOString().split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label>Term End Date (optional)</label>
                        <input type="date" id="editTermEnd" value="${currentUser.termEnd ? new Date(currentUser.termEnd).toISOString().split('T')[0] : ''}">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else if (politicalType === 'POLITICAL_ORG') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Organization Type</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., PAC, SuperPAC, Campaign Committee, Party Organization">
                    </div>
                    <div class="form-group">
                        <label>Organization Website (optional)</label>
                        <input type="url" id="editCampaignWebsite" value="${currentUser.campaignWebsite || ''}" placeholder="https://...">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else {
                // CITIZEN - no additional fields needed
                verificationSection.style.display = 'none';
            }
            
            container.innerHTML = fieldsHtml;
        }

        async function uploadVerificationDocs() {
            const fileInput = document.getElementById('verificationDocs');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            // In a real implementation, you would upload these files to your server
            // For now, we'll just simulate the upload
            alert(`${files.length} document(s) selected for upload. In a real implementation, these would be uploaded to the server for review.`);
            
            // Update verification status to pending after upload
            // This would normally be handled by the server after successful upload
        }

        function cancelEditProfile() {
            loadUserProfile(); // Reload the view mode
        }

        async function saveProfile() {
            // Validate address form first
            if (addressForm && !addressForm.validate()) {
                alert('Please fix address form errors before saving');
                return;
            }

            const profileData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                bio: document.getElementById('editBio').value,
                website: document.getElementById('editWebsite').value
            };

            // Get address data from the address form
            const addressData = addressForm ? addressForm.getData() : {};
            
            // Get political profile data
            const politicalType = document.getElementById('editPoliticalType').value;
            const politicalData = {
                streetAddress: addressData.streetAddress || '',
                city: addressData.city || '',
                state: addressData.state || '',
                zipCode: addressData.zipCode || '',
                politicalProfileType: politicalType
            };

            // Add political-specific fields based on type
            if (politicalType === 'CANDIDATE') {
                politicalData.politicalParty = document.getElementById('editPoliticalParty')?.value || '';
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                politicalData.politicalParty = document.getElementById('editPoliticalParty')?.value || '';
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.officialTitle = document.getElementById('editOfficialTitle')?.value || '';
                
                const termStart = document.getElementById('editTermStart')?.value;
                const termEnd = document.getElementById('editTermEnd')?.value;
                if (termStart) politicalData.termStart = new Date(termStart).toISOString();
                if (termEnd) politicalData.termEnd = new Date(termEnd).toISOString();
            } else if (politicalType === 'POLITICAL_ORG') {
                politicalData.office = document.getElementById('editOffice')?.value || ''; // Using office field for org type
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            }

            try {
                // Update basic profile
                const profileResponse = await apiCall('/users/profile', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });

                // Update political/address info
                const politicalResponse = await apiCall('/political/profile', {
                    method: 'PUT',
                    body: JSON.stringify(politicalData)
                });
                
                console.log('Political profile update response:', politicalResponse.status);

                if (profileResponse.ok && politicalResponse.ok) {
                    // Update current user object
                    const updatedProfile = await apiCall('/users/profile');
                    if (updatedProfile.ok) {
                        const data = await updatedProfile.json();
                        currentUser = data.user;
                    }
                    
                    loadUserProfile(); // Switch back to view mode
                    
                    // Show different messages based on political type change
                    if (politicalType !== 'CITIZEN' && (currentUser.politicalProfileType === 'CITIZEN' || currentUser.verificationStatus === 'PENDING')) {
                        alert('Profile updated successfully! Your political profile will need to be verified by our team. Please upload verification documents if you haven\'t already.');
                    } else {
                        alert('Profile updated successfully!');
                    }
                } else {
                    alert('Failed to update profile. Please try again.');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Trending-specific like and comment functions
        async function likeTrendingPost(postId) {
            if (!authToken) {
                alert('Please log in to like posts');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Just update the like count in place, don't refresh whole panel
                    updateLikeCount(postId, data.liked);
                }
            } catch (error) {
                console.error('Failed to like trending post:', error);
            }
        }

        function updateLikeCount(postId, isLiked) {
            // Find the like button for this post and update its count
            const likeButtons = document.querySelectorAll(`[onclick*="likeTrendingPost('${postId}')"]`);
            likeButtons.forEach(button => {
                const currentText = button.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
                const newCount = isLiked ? currentCount + 1 : Math.max(0, currentCount - 1);
                button.innerHTML = `❤️ ${newCount}`;
            });
        }

        function showTrendingCommentBox(postId) {
            if (!authToken) {
                alert('Please log in to comment');
                return;
            }
            document.getElementById(`trending-comments-${postId}`).style.display = 'block';
        }

        function hideTrendingCommentBox(postId) {
            document.getElementById(`trending-comments-${postId}`).style.display = 'none';
            document.getElementById(`trending-comment-input-${postId}`).value = '';
        }

        async function addTrendingComment(postId) {
            const content = document.getElementById(`trending-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST'
                });

                if (response.ok) {
                    hideTrendingCommentBox(postId);
                    // Just update the comment count, don't refresh whole panel
                    updateCommentCount(postId);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        function updateCommentCount(postId) {
            // Find the comment button for this post and increment its count
            const commentButtons = document.querySelectorAll(`[onclick*="showTrendingCommentBox('${postId}')"]`);
            commentButtons.forEach(button => {
                const currentText = button.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
                const newCount = currentCount + 1;
                button.innerHTML = `💬 ${newCount}`;
            });
        }

        // Comment Functions
        function showCommentBox(postId) {
            document.getElementById(`comments-${postId}`).style.display = 'block';
        }

        function hideCommentBox(postId) {
            document.getElementById(`comments-${postId}`).style.display = 'none';
            document.getElementById(`comment-input-${postId}`).value = '';
        }

        async function addComment(postId) {
            const content = document.getElementById(`comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    hideCommentBox(postId);
                    // Reload posts to show updated comment count
                    loadUserPosts();
                    // Also refresh trending if that's open
                    if (!document.getElementById('panel-trending').classList.contains('hidden')) {
                        loadTrendingPosts();
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        // Posts Functions
        async function createPost() {
            const content = document.getElementById('postContent').value.trim();
            const isPolitical = document.getElementById('isPolitical').checked;

            if (!content) {
                alert('Please enter some content for your post');
                return;
            }

            try {
                const response = await apiCall('/posts', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        content, 
                        isPolitical: isPolitical 
                    })
                });

                if (response.ok) {
                    document.getElementById('postContent').value = '';
                    document.getElementById('isPolitical').checked = false;
                    loadUserPosts();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create post');
                }
            } catch (error) {
                console.error('Failed to create post:', error);
                alert('Network error. Please try again.');
            }
        }

        async function loadUserPosts() {
            if (!authToken) return;

            try {
                const response = await apiCall('/posts/me');
                
                if (response.ok) {
                    displayPosts(response.data.posts);
                } else {
                    console.error('Failed to load user posts:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }

        function displayPosts(posts) {
            const feed = document.getElementById('postsFeed');
            
            if (posts.length === 0) {
                feed.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <h2>Your Posts</h2>
                        <p>You haven't posted anything yet. Share your thoughts above!</p>
                    </div>
                `;
                return;
            }

            let html = '<h2>Your Posts</h2>';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                
                html += `
                    <div class="post-item" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="user-avatar">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                            <div>
                                <strong>${post.author.firstName || post.author.username}</strong>
                                ${post.author.verified ? '<span style="color: #1976d2;">✓</span>' : ''}
                                <br>
                                <small style="color: #666;">@${post.author.username} • ${timeAgo}</small>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-actions">
                            <span class="post-action" onclick="likePost('${post.id}')">
                                ❤️ ${post.likesCount}
                            </span>
                            <span class="post-action" onclick="showCommentBox('${post.id}')">
                                💬 Add Comment
                            </span>
                            ${post.commentsCount > 0 ? `<span class="post-action" onclick="viewComments('${post.id}')" style="color: #4b5c09;">👁️ View ${post.commentsCount} Comment${post.commentsCount === 1 ? '' : 's'}</span>` : ''}
                        </div>
                        <div id="comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            feed.innerHTML = html;
        }

        async function likePost(postId) {
            if (!authToken) return;

            try {
                const response = await apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    // Reload posts to update like counts
                    loadUserPosts();
                }
            } catch (error) {
                console.error('Failed to like post:', error);
            }
        }

        async function viewComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // If comments are already visible, hide them
            if (commentsContainer && commentsContainer.style.display === 'block') {
                commentsContainer.style.display = 'none';
                return;
            }

            try {
                // Load comments
                const response = await apiCall(`/posts/${postId}/comments?limit=50`);
                if (!response.ok) {
                    alert('Failed to load comments');
                    return;
                }
                const data = response.data;

                showCommentsInline(postId, data.comments);
            } catch (error) {
                console.error('Failed to load comments:', error);
                alert('Network error. Please try again.');
            }
        }

        function showCommentsInline(postId, comments) {
            let commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // Create comments container if it doesn't exist
            if (!commentsContainer) {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (!postElement) return;
                
                commentsContainer = document.createElement('div');
                commentsContainer.id = `post-comments-${postId}`;
                commentsContainer.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; background: #f9f9f9; border-radius: 8px; padding: 1rem;';
                postElement.appendChild(commentsContainer);
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: #4b5c09;">Comments (${comments.length})</h4>
                    <button onclick="hideComments('${postId}')" style="background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
            `;

            if (comments.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 1rem;">No comments yet</div>';
            } else {
                comments.forEach(comment => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <img src="${comment.user.avatar || '/default-avatar.png'}" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 0.5rem;">
                                <div>
                                    <div style="font-weight: bold; font-size: 0.85rem;">${comment.user.firstName || comment.user.username} ${comment.user.lastName || ''}</div>
                                    <div style="color: #666; font-size: 0.75rem;">@${comment.user.username}</div>
                                </div>
                                ${comment.user.verified ? '<span style="color: #1d9bf0; margin-left: 5px; font-size: 0.8rem;">✓</span>' : ''}
                                <div style="margin-left: auto; color: #666; font-size: 0.75rem;">
                                    ${new Date(comment.createdAt).toLocaleString()}
                                </div>
                            </div>
                            <div style="margin-left: 32px; line-height: 1.4;">
                                ${comment.content}
                            </div>
                        </div>
                    `;
                });
            }

            // Add comment form if user is logged in
            if (authToken) {
                html += `
                    <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <textarea id="inline-comment-input-${postId}" placeholder="Add a comment..." style="width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; box-sizing: border-box; resize: vertical; font-family: inherit; font-size: 0.9rem;"></textarea>
                        <div style="margin-top: 0.75rem; text-align: right;">
                            <button onclick="addInlineComment('${postId}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Post Comment</button>
                        </div>
                    </div>
                `;
            }

            commentsContainer.innerHTML = html;
            commentsContainer.style.display = 'block';
        }

        function hideComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            if (commentsContainer) {
                commentsContainer.style.display = 'none';
            }
        }

        async function addInlineComment(postId) {
            const content = document.getElementById(`inline-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    // Refresh the comments display
                    viewComments(postId);
                    
                    // Update comment counts in main feeds
                    updateCommentCount(postId);
                } else {
                    const error = response.data || {};
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }


        async function loadUserPosts() {
            if (!authToken) return;

            try {
                const response = await apiCall('/posts/me');
                
                if (response.ok) {
                    displayPosts(response.data.posts);
                } else {
                    console.error('Failed to load user posts:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }

        // Check follow status and render appropriate button
        async function renderFollowButton(userId, containerElement) {
            if (!currentUser || userId === currentUser.id) return '';
            
            try {
                const response = await apiCall(`/users/follow-status/${userId}`);
                
                if (response.ok) {
                    const isFollowing = response.data.isFollowing;
                    
                    const buttonHtml = `
                        <button onclick="toggleFollow('${userId}', this)" 
                            data-user-id="${userId}"
                            data-following="${isFollowing}"
                            style="padding: 0.25rem 0.5rem; background: ${isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            ${isFollowing ? 'Following' : 'Follow'}
                        </button>
                    `;
                    
                    return buttonHtml;
                } else {
                    return `
                        <button onclick="toggleFollow('${userId}', this)" 
                            data-user-id="${userId}"
                            data-following="false"
                            style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            Follow
                        </button>
                    `;
                }
            } catch (error) {
                console.error('Failed to check follow status:', error);
                return '';
            }
        }

        // Toggle follow/unfollow based on current state
        async function toggleFollow(userId, buttonElement) {
            const isCurrentlyFollowing = buttonElement.dataset.following === 'true';
            
            if (isCurrentlyFollowing) {
                await unfollowUser(userId, buttonElement);
            } else {
                await followUser(userId, buttonElement);
            }
        }

        // Follow/Unfollow functionality
        async function followUser(userId, buttonElement) {
            try {
                const response = await apiCall(`/users/follow/${userId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Update button to show Following state
                    if (buttonElement) {
                        buttonElement.textContent = 'Following';
                        buttonElement.style.background = '#666';
                        buttonElement.dataset.following = 'true';
                    }
                    // Refresh current view if it's profile or user search
                    loadUserProfile();
                } else {
                    alert(response.data?.error || 'Failed to follow user');
                }
            } catch (error) {
                console.error('Failed to follow user:', error);
                alert('Error following user');
            }
        }

        async function unfollowUser(userId, buttonElement) {
            try {
                const response = await apiCall(`/users/follow/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Update button back to Follow state
                    if (buttonElement) {
                        buttonElement.textContent = 'Follow';
                        buttonElement.style.background = '#4b5c09';
                        buttonElement.dataset.following = 'false';
                    }
                    // Refresh current view
                    loadUserProfile();
                } else {
                    alert(response.data?.error || 'Failed to unfollow user');
                }
            } catch (error) {
                console.error('Failed to unfollow user:', error);
                alert('Error unfollowing user');
            }
        }

        async function showFollowersList(userId) {
            try {
                const response = await apiCall(`/users/${userId}/followers`);
                
                if (response.ok) {
                    displayUsersList(response.data.followers, 'Followers');
                } else {
                    alert('Failed to load followers');
                }
            } catch (error) {
                console.error('Failed to load followers:', error);
                alert('Error loading followers');
            }
        }

        async function showFollowingList(userId) {
            try {
                const response = await apiCall(`/users/${userId}/following`);
                
                if (response.ok) {
                    displayUsersList(response.data.following, 'Following');
                } else {
                    alert('Failed to load following list');
                }
            } catch (error) {
                console.error('Failed to load following list:', error);
                alert('Error loading following list');
            }
        }

        function displayUsersList(users, title) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1vh; padding: 1vh; min-height: 2vh;">
                        <h3 style="margin: 0;">${title}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">×</button>
                    </div>
                    <div>
                        ${users.length === 0 ? 
                            `<p style="text-align: center; color: #666; padding: 2rem;">No ${title.toLowerCase()} yet</p>` :
                            users.map(user => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center;">
                                        <div class="user-avatar" style="margin-right: 0.75rem;">${(user.firstName?.[0] || user.username[0]).toUpperCase()}</div>
                                        <div>
                                            <div style="font-weight: bold; font-size: 0.9rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                                            <div style="color: #666; font-size: 0.8rem;">@${user.username}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        ${user.id !== currentUser?.id ? `
                                            <button onclick="followUser('${user.id}', this)" 
                                                style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                                Follow
                                            </button>
                                            <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                                style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                                Message
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        // Global search functionality
        function openSearch() {
            document.getElementById('searchContainer').style.display = 'flex';
            closeAllPanels(); // Close other panels
            document.getElementById('searchInput').focus();
        }

        function closeSearch() {
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('globalSearchResults').innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    Start typing to search for users
                </div>
            `;
        }

        let globalSearchTimeout;
        async function performGlobalSearch(query) {
            clearTimeout(globalSearchTimeout);
            
            if (!query || query.length < 2) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Type at least 2 characters to search
                    </div>
                `;
                return;
            }

            globalSearchTimeout = setTimeout(async () => {
                await executeGlobalSearch(query);
            }, 300);
        }

        async function executeGlobalSearch(query) {
            if (!authToken) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Please log in to search for users
                    </div>
                `;
                return;
            }

            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}&limit=20`);
                
                if (response.ok) {
                    displayGlobalSearchResults(response.data.users);
                } else {
                    document.getElementById('globalSearchResults').innerHTML = `
                        <div style="text-align: center; color: #d32f2f; padding: 2rem;">
                            Error searching users
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Global search error:', error);
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #d32f2f; padding: 2rem;">
                        Network error occurred
                    </div>
                `;
            }
        }

        async function displayGlobalSearchResults(users) {
            const resultsContainer = document.getElementById('globalSearchResults');
            
            if (users.length === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        No users found
                    </div>
                `;
                return;
            }

            let html = '';
            users.forEach(user => {
                html += `
                    <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer;" onclick="openUserFeed('${user.id}', '${user.username}')">
                        <div class="user-avatar" style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                            ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 1rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                            <div style="color: #666; font-size: 0.9rem;">@${user.username}</div>
                            <div style="color: #666; font-size: 0.8rem;">${user.followersCount} followers${user.state ? ` • ${user.state}` : ''}${user.district ? ` • District ${user.district}` : ''}</div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                            ${user.verified ? '<span style="color: #1d9bf0; margin-right: 0.5rem;">✓</span>' : ''}
                            ${user.id !== currentUser?.id ? `
                                <button onclick="toggleFollow('${user.id}', this)" 
                                    data-user-id="${user.id}"
                                    data-following="${user.isFollowing || false}"
                                    style="padding: 0.25rem 0.5rem; background: ${user.isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                    ${user.isFollowing ? 'Following' : 'Follow'}
                                </button>
                                <button onclick="addFriend('${user.id}')" 
                                    style="padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                    Add Friend
                                </button>
                                <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                    style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                    Message
                                </button>
                            ` : '<span style="color: #666; font-size: 0.8rem;">You</span>'}
                        </div>
                    </div>
                `;
            });

            resultsContainer.innerHTML = html;
        }

        // Open user feed in main area
        async function openUserFeed(userId, username) {
            try {
                closeSearch();
                
                // Show loading state
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading @${username}'s Profile</h2>
                        <p>Loading profile and posts...</p>
                    </div>
                `;

                // Load user's profile and posts in parallel
                const [profileResponse, postsResponse] = await Promise.all([
                    apiCall(`/users/${username}`),
                    apiCall(`/posts/user/${userId}`)
                ]);
                
                if (profileResponse.ok && postsResponse.ok) {
                    const userProfile = profileResponse.data.user;
                    const posts = postsResponse.data.posts || [];
                    
                    // Create profile header
                    let html = `
                        <div style="background: linear-gradient(135deg, #4b5c09 0%, #6b7f1a 100%); color: white; padding: 2rem; margin-bottom: 1rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">
                                        ${(userProfile.firstName?.[0] || userProfile.username[0]).toUpperCase()}
                                    </div>
                                    <div>
                                        <h1 style="margin: 0; font-size: 1.8rem;">
                                            ${userProfile.firstName ? `${userProfile.firstName} ${userProfile.lastName || ''}` : userProfile.username}
                                            ${userProfile.verified ? '<span style="color: #ffd700; margin-left: 0.5rem;">✓</span>' : ''}
                                        </h1>
                                        <p style="margin: 0.25rem 0; font-size: 1.1rem; opacity: 0.9;">@${userProfile.username}</p>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">
                                            <span><strong>${userProfile.followersCount || 0}</strong> followers</span>
                                            <span><strong>${userProfile.followingCount || 0}</strong> following</span>
                                            <span>Joined ${new Date(userProfile.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="loadTrendingPosts(); showMainFeed();" style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                    Back to Main Feed
                                </button>
                            </div>
                            
                            ${userProfile.bio ? `<div style="margin-bottom: 1rem; font-size: 1rem; line-height: 1.4;">${userProfile.bio}</div>` : ''}
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.9;">
                                ${userProfile.location ? `<span>📍 ${userProfile.location}</span>` : ''}
                                ${userProfile.website ? `<span>🔗 <a href="${userProfile.website}" target="_blank" style="color: #ffd700;">${userProfile.website}</a></span>` : ''}
                            </div>
                            
                            ${userId !== currentUser?.id ? `
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button onclick="toggleFollow('${userId}', this)" 
                                        data-user-id="${userId}"
                                        style="padding: 0.5rem 1rem; background: #fff; color: #4b5c09; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        Follow
                                    </button>
                                    <button onclick="startConversationWithUser('${userId}', '${username}')" 
                                        style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                        Message
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="border-bottom: 2px solid #4b5c09; margin-bottom: 1rem; padding-bottom: 0.5rem;">
                            <h2 style="margin: 0; color: #4b5c09; font-size: 1.3rem;">Posts (${posts.length})</h2>
                        </div>
                    `;
                    
                    if (posts.length === 0) {
                        html += `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <p style="margin: 0; font-size: 1.1rem;">This user hasn't posted anything yet.</p>
                            </div>
                        `;
                    } else {
                        // Render posts
                        posts.forEach(post => {
                            html += `
                                <div class="post-item" data-post-id="${post.id}" style="background: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                        <div style="display: flex; align-items: center;">
                                            <div class="user-avatar" style="margin-right: 0.75rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                                            <div>
                                                <div style="font-weight: bold;">
                                                    ${post.author.firstName ? `${post.author.firstName} ${post.author.lastName || ''}` : post.author.username}
                                                    ${post.author.verified ? '<span style="color: #1d9bf0; margin-left: 0.25rem;">✓</span>' : ''}
                                                </div>
                                                <div style="color: #666; font-size: 0.9rem;">@${post.author.username} • ${new Date(post.createdAt).toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                        <div style="color: #666; font-size: 0.8rem;">${new Date(post.createdAt).toLocaleTimeString()}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem; line-height: 1.5;">
                                        ${post.content}
                                    </div>
                                    
                                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post image" style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem;">` : ''}
                                    
                                    <div style="display: flex; gap: 1rem; color: #666; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 0.75rem;">
                                        <button onclick="likePost('${post.id}')" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>👍</span> ${post.likesCount || 0}
                                        </button>
                                        <button onclick="toggleComments('${post.id}')" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>💬</span> ${post.commentsCount || 0}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    feedElement.innerHTML = html;
                } else {
                    feedElement.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h2>Error Loading Profile</h2>
                            <p style="color: #d32f2f;">Unable to load @${username}'s profile and posts</p>
                            <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Back to Main Feed
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user feed:', error);
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Network Error</h2>
                        <p style="color: #d32f2f;">Unable to load @${username}'s profile</p>
                        <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Back to Main Feed
                        </button>
                    </div>
                `;
            }
        }

        function showMainFeed() {
            // Reset to main feed view - could load trending or user's own posts
            loadTrendingPosts();
        }

        async function addFriend(userId) {
            console.log('Adding friend:', userId);
            // TODO: Implement friend request functionality
        }

        // Map zoom and location functionality
        let mapInstance = null;
        let currentLocation = null;
        let currentZoomLevel = 'national'; // Track current zoom level (default to match radio button)
        let boundaryManager = null;

        // Boundary management class
        class BoundaryManager {
            constructor(map) {
                this.map = map;
                this.layers = new Map();
                this.cache = new Map();
                this.loadLocalCache();
            }
            
            // Load cached boundary data from localStorage
            loadLocalCache() {
                try {
                    const cached = localStorage.getItem('boundaryCache');
                    if (cached) {
                        const parsedCache = JSON.parse(cached);
                        // Check if cache is less than 30 days old
                        const cacheAge = Date.now() - (parsedCache.timestamp || 0);
                        if (cacheAge < 30 * 24 * 60 * 60 * 1000) { // 30 days
                            Object.entries(parsedCache.data || {}).forEach(([key, value]) => {
                                this.cache.set(key, value);
                            });
                            console.log(`Loaded ${this.cache.size} cached boundaries from localStorage`);
                        } else {
                            localStorage.removeItem('boundaryCache');
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load boundary cache:', error);
                    localStorage.removeItem('boundaryCache');
                }
            }
            
            // Save boundary cache to localStorage
            saveLocalCache() {
                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: Object.fromEntries(this.cache)
                    };
                    localStorage.setItem('boundaryCache', JSON.stringify(cacheData));
                } catch (error) {
                    console.warn('Failed to save boundary cache:', error);
                }
            }
            
            async loadBoundary(type, identifier, state) {
                const key = `${type}-${state}-${identifier || 'state'}`;
                
                // Check cache first
                if (this.cache.has(key)) {
                    console.log(`Using cached boundary for ${key}`);
                    this.displayBoundary(key, this.cache.get(key), type);
                    return;
                }
                
                // Try multiple sources for boundary data
                const sources = [
                    // Primary source - raw GitHub content (more reliable)
                    {
                        name: 'GitHub raw',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/states/${state}/shape.geojson`;
                            }
                        }
                    },
                    // Fallback to theunitedstates.io (if SSL issue is fixed)
                    {
                        name: 'theunitedstates.io',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://theunitedstates.io/districts/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://theunitedstates.io/districts/states/${state}/shape.geojson`;
                            }
                        }
                    }
                ];
                
                for (const source of sources) {
                    try {
                        const url = source.getUrl(type, state, identifier);
                        if (!url) continue;
                        
                        console.log(`Fetching boundary data from ${source.name}: ${url}`);
                        
                        const response = await fetch(url, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (!response.ok) {
                            console.warn(`HTTP ${response.status} from ${source.name}`);
                            continue;
                        }
                        
                        const geojsonData = await response.json();
                        
                        // Cache the data in memory and localStorage
                        this.cache.set(key, geojsonData);
                        this.saveLocalCache();
                        
                        console.log(`Successfully loaded boundary from ${source.name}`);
                        
                        // Display boundary
                        this.displayBoundary(key, geojsonData, type);
                        return;
                        
                    } catch (error) {
                        console.warn(`Failed to load boundary from ${source.name}:`, error);
                        continue;
                    }
                }
                
                console.error(`Failed to load ${type} boundary from all sources for ${key}`);
            }
            
            displayBoundary(key, geojsonData, type) {
                // Remove existing layer if present
                this.removeBoundary(key);
                
                const style = type === 'district' ? {
                    color: '#ff6b35',
                    weight: 3,
                    opacity: 0.8,
                    fillColor: '#ff6b35',
                    fillOpacity: 0.1
                } : {
                    color: '#4b5c09',
                    weight: 2,
                    opacity: 0.6,
                    fillColor: '#4b5c09',
                    fillOpacity: 0.05
                };
                
                const layer = L.geoJSON(geojsonData, { style }).addTo(this.map);
                this.layers.set(key, layer);
                console.log(`${type} boundary loaded and displayed`);
            }
            
            removeBoundary(key) {
                if (this.layers.has(key)) {
                    this.map.removeLayer(this.layers.get(key));
                    this.layers.delete(key);
                }
            }
            
            clearAll() {
                this.layers.forEach(layer => this.map.removeLayer(layer));
                this.layers.clear();
            }
        }

        function setMapInstance(map) {
            mapInstance = map;
            boundaryManager = new BoundaryManager(map);
            
            // Try to get user location, with fallback
            setTimeout(() => {
                if (currentUser && currentUser.state) {
                    getCurrentUserLocation();
                } else {
                    currentLocation = { lat: 37.8283, lng: -98.5795 }; // Center of US
                }
            }, 500); // Wait for user data to load
        }

        async function getCurrentUserLocation() {
            try {
                if (currentUser && currentUser.zipCode && currentUser.state) {
                    // Use user's stored address for location
                    const address = currentUser.city ? 
                        `${currentUser.city}, ${currentUser.state} ${currentUser.zipCode}` :
                        `${currentUser.zipCode}, ${currentUser.state}`;
                    
                    const coords = await geocodeLocation(address);
                    if (coords) {
                        currentLocation = coords;
                        // Only set zoom level if we're not at national level (to avoid moving away from default)
                        if (currentZoomLevel !== 'national') {
                            await setZoomLevel(currentZoomLevel);
                        }
                        
                        // Load representative data to get district info
                        loadElectedOfficials();
                    }
                }
            } catch (error) {
                console.error('Error getting user location:', error);
                currentLocation = { lat: 37.8283, lng: -98.5795 }; // Fallback
            }
        }

        async function geocodeLocation(address) {
            try {
                // Using a free geocoding service - you might want to use your existing Geocod.io API
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        async function geocodeAndZoom() {
            const locationInput = document.getElementById('locationInput');
            const address = locationInput.value.trim();
            
            if (!address) {
                // Use current location if no address provided
                getCurrentUserLocation();
                return;
            }

            const coords = await geocodeLocation(address);
            if (coords) {
                currentLocation = coords;
                // Apply current zoom level to new location
                await setZoomLevel(currentZoomLevel);
            } else {
                alert('Location not found. Please try a different address.');
            }
        }

        async function setZoomLevel(level) {
            if (!mapInstance) return;

            // Update current zoom level and radio button state
            currentZoomLevel = level;
            updateRadioButtonState(level);

            let zoom, bounds;
            
            // Clear existing boundaries
            if (boundaryManager) {
                boundaryManager.clearAll();
            }
            
            console.log(`Setting zoom level: ${level}`);
            console.log(`Current user:`, currentUser);
            console.log(`Current user state: ${currentUser?.state}, district: ${currentUser?.district}`);
            console.log(`Current location:`, currentLocation);
            
            switch(level) {
                case 'national':
                    // Show national view - different zoom levels for expanded vs collapsed
                    const isCollapsed = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsed ? 3 : 5;
                    mapInstance.setView([37.8283, -98.5795], zoom); // Center of US
                    console.log(`Set to national view (zoom: ${zoom}, collapsed: ${isCollapsed})`);
                    // No boundaries at national level
                    break;
                    
                case 'state':
                    // Zoom to show state and surrounding areas - adjust zoom for map size
                    const isCollapsedState = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedState ? 5 : 7;
                    
                    console.log(`STATE ZOOM: Checking if currentUser.state exists:`, currentUser?.state);
                    
                    if (currentUser && currentUser.state) {
                        console.log(`Flying to state geographic center for: ${currentUser.state}`);
                        // Get state center coordinates and fly there
                        const stateCenter = await getStateCenterCoordinates(currentUser.state);
                        console.log(`State center result:`, stateCenter);
                        if (stateCenter) {
                            console.log(`Flying to state center: ${stateCenter.lat}, ${stateCenter.lng} with zoom ${zoom}`);
                            mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            console.log(`Map setView called successfully`);
                            
                            // Load state boundary
                            if (boundaryManager) {
                                console.log(`Loading state boundary for: ${currentUser.state}`);
                                boundaryManager.loadBoundary('state', null, currentUser.state);
                            }
                        } else {
                            console.log('State center not found, using US center fallback');
                            mapInstance.setView([37.8283, -98.5795], zoom);
                        }
                    } else {
                        console.log('ERROR: No user state info available - this should not happen for State zoom!');
                        console.log('Current user object:', currentUser);
                        // DO NOT fall back to US center for State zoom - that's wrong!
                        console.error('State zoom requested but no state data available');
                    }
                    break;
                    
                case 'local':
                    // Zoom to user's actual address - adjust zoom for map size
                    const isCollapsedLocal = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedLocal ? 9 : 11;
                    
                    console.log(`LOCAL ZOOM: Checking user address data - zipCode: ${currentUser?.zipCode}, city: ${currentUser?.city}, state: ${currentUser?.state}`);
                    
                    if (currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state) {
                        // Build address from user profile
                        let userAddress = '';
                        if (currentUser.streetAddress && currentUser.city) {
                            userAddress = `${currentUser.streetAddress}, ${currentUser.city}, ${currentUser.state}`;
                            if (currentUser.zipCode) userAddress += ` ${currentUser.zipCode}`;
                        } else if (currentUser.city) {
                            userAddress = `${currentUser.city}, ${currentUser.state}`;
                        } else if (currentUser.zipCode) {
                            userAddress = `${currentUser.zipCode}, ${currentUser.state}`;
                        }
                        
                        console.log(`Flying to user's address: ${userAddress}`);
                        
                        // Geocode the user's address and fly there
                        const addressCoords = await geocodeLocation(userAddress);
                        console.log(`Address geocoding result:`, addressCoords);
                        if (addressCoords) {
                            console.log(`Flying to address coordinates: ${addressCoords.lat}, ${addressCoords.lng} with zoom ${zoom}`);
                            mapInstance.setView([addressCoords.lat, addressCoords.lng], zoom);
                            console.log(`Map setView called for address successfully`);
                            
                            // Load district boundary if we have district info
                            if (boundaryManager && currentUser.district) {
                                console.log(`Loading district boundary: ${currentUser.state}-${currentUser.district}`);
                                boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                            }
                        } else {
                            console.log('Address geocoding failed, using state center fallback');
                            // Fallback to state center
                            const stateCenter = await getStateCenterCoordinates(currentUser.state);
                            if (stateCenter) {
                                mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            } else {
                                mapInstance.setView([37.8283, -98.5795], zoom);
                            }
                        }
                    } else {
                        console.log('ERROR: No user address info available - this should not happen for Local zoom!');
                        console.log('User address fields:', {
                            streetAddress: currentUser?.streetAddress,
                            city: currentUser?.city,
                            state: currentUser?.state,
                            zipCode: currentUser?.zipCode
                        });
                        // DO NOT fall back to US center for Local zoom - that's wrong!
                        console.error('Local zoom requested but no address data available');
                    }
                    break;
            }
        }
        
        function updateRadioButtonState(level) {
            // Update radio button to match current zoom level
            const radios = document.querySelectorAll('input[name="zoomLevel"]');
            radios.forEach(radio => {
                radio.checked = radio.value === level;
            });
        }

        // Helper function to get state center coordinates
        async function getStateCenterCoordinates(stateAbbr) {
            // State center coordinates (approximate geographic centers)
            const stateCenters = {
                'AL': { lat: 32.806671, lng: -86.791130 },
                'AK': { lat: 61.370716, lng: -152.404419 },
                'AZ': { lat: 33.729759, lng: -111.431221 },
                'AR': { lat: 34.969704, lng: -92.373123 },
                'CA': { lat: 36.116203, lng: -119.681564 },
                'CO': { lat: 39.059811, lng: -105.311104 },
                'CT': { lat: 41.597782, lng: -72.755371 },
                'DE': { lat: 39.318523, lng: -75.507141 },
                'FL': { lat: 27.766279, lng: -81.686783 },
                'GA': { lat: 33.040619, lng: -83.643074 },
                'HI': { lat: 21.094318, lng: -157.498337 },
                'ID': { lat: 44.240459, lng: -114.478828 },
                'IL': { lat: 40.349457, lng: -88.986137 },
                'IN': { lat: 39.849426, lng: -86.258278 },
                'IA': { lat: 42.011539, lng: -93.210526 },
                'KS': { lat: 38.526600, lng: -96.726486 },
                'KY': { lat: 37.668140, lng: -84.670067 },
                'LA': { lat: 31.169546, lng: -91.867805 },
                'ME': { lat: 44.693947, lng: -69.381927 },
                'MD': { lat: 39.063946, lng: -76.802101 },
                'MA': { lat: 42.230171, lng: -71.530106 },
                'MI': { lat: 43.326618, lng: -84.536095 },
                'MN': { lat: 45.694454, lng: -93.900192 },
                'MS': { lat: 32.741646, lng: -89.678696 },
                'MO': { lat: 38.456085, lng: -92.288368 },
                'MT': { lat: 47.097633, lng: -110.362566 },
                'NE': { lat: 41.492537, lng: -99.901813 },
                'NV': { lat: 38.313515, lng: -117.055374 },
                'NH': { lat: 43.452492, lng: -71.563896 },
                'NJ': { lat: 40.298904, lng: -74.521011 },
                'NM': { lat: 34.840515, lng: -106.248482 },
                'NY': { lat: 42.165726, lng: -74.948051 },
                'NC': { lat: 35.630066, lng: -79.806419 },
                'ND': { lat: 47.528912, lng: -99.784012 },
                'OH': { lat: 40.388783, lng: -82.764915 },
                'OK': { lat: 35.565342, lng: -96.928917 },
                'OR': { lat: 44.572021, lng: -122.070938 },
                'PA': { lat: 40.590752, lng: -77.209755 },
                'RI': { lat: 41.680893, lng: -71.51178 },
                'SC': { lat: 33.856892, lng: -80.945007 },
                'SD': { lat: 44.299782, lng: -99.438828 },
                'TN': { lat: 35.747845, lng: -86.692345 },
                'TX': { lat: 31.054487, lng: -97.563461 },
                'UT': { lat: 40.150032, lng: -111.862434 },
                'VT': { lat: 44.045876, lng: -72.710686 },
                'VA': { lat: 37.769337, lng: -78.169968 },
                'WA': { lat: 47.400902, lng: -121.490494 },
                'WV': { lat: 38.491226, lng: -80.954570 },
                'WI': { lat: 44.268543, lng: -89.616508 },
                'WY': { lat: 42.755966, lng: -107.302490 }
            };
            
            return stateCenters[stateAbbr.toUpperCase()] || null;
        }

        // Helper function to get district center coordinates
        async function getDistrictCenterCoordinates(stateAbbr, districtNumber) {
            try {
                // Try to fetch the district boundary data to calculate center
                const url = `https://theunitedstates.io/districts/cds/2012/${stateAbbr.toUpperCase()}-${districtNumber}/shape.geojson`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const geojsonData = await response.json();
                    
                    // Calculate the center of the district from its geometry
                    const center = calculateGeometryCenter(geojsonData);
                    if (center) {
                        console.log(`District center calculated: ${center.lat}, ${center.lng}`);
                        return center;
                    }
                }
                
                console.warn(`Could not fetch district boundary for ${stateAbbr}-${districtNumber}`);
                return null;
            } catch (error) {
                console.error('Error getting district center:', error);
                return null;
            }
        }

        // Helper function to calculate the center of a GeoJSON geometry
        function calculateGeometryCenter(geojsonData) {
            try {
                if (!geojsonData.features || geojsonData.features.length === 0) {
                    return null;
                }
                
                let totalLat = 0;
                let totalLng = 0;
                let pointCount = 0;
                
                geojsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'Polygon') {
                        const coordinates = feature.geometry.coordinates[0]; // First ring (exterior)
                        coordinates.forEach(coord => {
                            totalLng += coord[0];
                            totalLat += coord[1];
                            pointCount++;
                        });
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            const coordinates = polygon[0]; // First ring of each polygon
                            coordinates.forEach(coord => {
                                totalLng += coord[0];
                                totalLat += coord[1];
                                pointCount++;
                            });
                        });
                    }
                });
                
                if (pointCount > 0) {
                    return {
                        lat: totalLat / pointCount,
                        lng: totalLng / pointCount
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error calculating geometry center:', error);
                return null;
            }
        }

        // Initialize location input with user's address if available
        function updateLocationPlaceholder() {
            setTimeout(() => {
                if (currentUser && currentUser.city && currentUser.state) {
                    const locationInput = document.getElementById('locationInput');
                    if (locationInput) {
                        locationInput.placeholder = `${currentUser.city}, ${currentUser.state}`;
                    }
                }
            }, 100);
        }

        // Call when user data is loaded
        window.addEventListener('load', () => {
            setTimeout(updateLocationPlaceholder, 1000);
        });

        // Password validation and UI functions
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = '🙈';
            } else {
                field.type = 'password';
                button.textContent = '👁️';
            }
        }

        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            const isValid = Object.values(requirements).every(req => req);
            const hasContent = password.length > 0;
            
            // Show/hide requirements based on focus and content
            const reqContainer = document.getElementById('password-requirements');
            const statusIndicator = document.getElementById('password-status');
            
            if (hasContent && !isValid) {
                // Show detailed requirements when typing but not valid
                reqContainer.style.display = 'block';
                statusIndicator.style.display = 'none';
            } else if (isValid) {
                // Show green checkmark when valid, hide requirements
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'block';
            } else {
                // Hide both when empty
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'none';
            }

            // Update individual requirement indicators
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-uppercase', requirements.uppercase);
            updateRequirement('req-lowercase', requirements.lowercase);
            updateRequirement('req-number', requirements.number);
            updateRequirement('req-special', requirements.special);

            return isValid;
        }

        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (element) {
                if (met) {
                    element.classList.add('met');
                    element.textContent = element.textContent.replace('• ', '');
                } else {
                    element.classList.remove('met');
                    if (!element.textContent.startsWith('• ')) {
                        element.textContent = '• ' + element.textContent.replace('✓ ', '');
                    }
                }
            }
        }

        // Add real-time password validation
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('registerPassword');
            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    validatePassword(this.value);
                });
            }
        });

        // Debug hCaptcha loading
        function checkHCaptchaStatus() {
            const widget = document.getElementById('hcaptcha-register');
            const hasIframe = widget && widget.querySelector('iframe');
            const widgetId = widget ? widget.getAttribute('data-hcaptcha-widget-id') : null;
            let response = null;
            
            try {
                if (window.hcaptcha && window.hcaptcha.getResponse) {
                    if (widgetId) {
                        response = window.hcaptcha.getResponse(widgetId);
                    } else {
                        response = window.hcaptcha.getResponse();
                    }
                }
            } catch (error) {
                console.log('hCaptcha getResponse error:', error.message);
            }
            
            console.log('hCaptcha status:', {
                loaded: typeof window.hcaptcha !== 'undefined',
                widgetExists: widget !== null,
                hasIframe: hasIframe !== null,
                widgetId: widgetId,
                sitekey: document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey'),
                currentResponse: response ? 'has response' : 'no response',
                responseLength: response ? response.length : 0,
                domain: window.location.hostname
            });
        }

        // Global hCaptcha callback function
        window.onHCaptchaCallback = function(token) {
            console.log('hCaptcha completed successfully!', { tokenLength: token ? token.length : 0 });
            // Store the token in a global variable for easy access
            window.hCaptchaToken = token;
        };

        // Check hCaptcha after page load (let it auto-render)
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkHCaptchaStatus();
                // No manual rendering needed - hCaptcha script auto-renders widgets with data-sitekey
                console.log('Relying on hCaptcha auto-render via data-sitekey attribute');
            }, 2000);
        });
    </script>
</body>
</html>