<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="build-time" content="2025-08-21T21:15:00.000Z">
    <meta name="version" content="1.1.0">
    <meta name="last-updated" content="2025-08-21T21:15:00.000Z">
    <title>United We Rise</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="android-chrome-192x192.png">
    
    <!-- External CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.css" />
    
    <!-- Application CSS -->
    <link rel="stylesheet" href="src/styles/main.css">
    <link rel="stylesheet" href="src/styles/search.css">
    <link rel="stylesheet" href="src/styles/map.css">
    <link rel="stylesheet" href="src/styles/modals.css">
    <link rel="stylesheet" href="src/styles/messaging.css">
    <link rel="stylesheet" href="src/styles/posts.css">
    <link rel="stylesheet" href="src/styles/candidate-system.css">
    <link rel="stylesheet" href="src/styles/elections-system.css">
    <link rel="stylesheet" href="src/styles/officials-system.css">
    <link rel="stylesheet" href="src/styles/trending-system.css">
    <link rel="stylesheet" href="src/styles/post-component.css">
    <link rel="stylesheet" href="src/styles/responsive.css">
    
    <!-- External JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/maplibre-gl@4.0.0/dist/maplibre-gl.js"></script>
    <script src="https://js.hcaptcha.com/1/api.js" async defer></script>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    
    <!-- Application JavaScript -->
    <script src="src/config/api.js"></script>
    <script src="src/js/api-manager.js"></script>
    <script src="src/js/websocket-client.js"></script>
    <script src="src/js/app-initialization.js"></script>
    <script src="src/js/force-optimization.js"></script>
    <script src="js/posting.js"></script>
    
    <!-- Inline Optimization Override (Backup) -->
    <script>
    // Emergency inline optimization override
    if (typeof adminDebugLog !== 'undefined') {
        adminDebugLog('InlineOptimization', 'Inline optimization override loading...');
    }
    
    // Check if main scripts loaded
    setTimeout(() => {
        if (!window.apiManager || !window.appInitializer) {
            console.log('‚ùå Main optimization scripts failed to load, using emergency override');
            
            // Create minimal API manager
            window.apiCall = async (endpoint, options = {}) => {
                const API_BASE = window.API_CONFIG ? window.API_CONFIG.BASE_URL : 'https://unitedwerise-backend.wonderfulpond-f8a8271f.eastus.azurecontainerapps.io/api';
                const url = endpoint.startsWith('http') ? endpoint : `${API_BASE}${endpoint}`;
                
                const headers = {
                    'Content-Type': 'application/json',
                    ...options.headers
                };
                
                if (window.authToken) {
                    headers['Authorization'] = `Bearer ${window.authToken}`;
                }
                
                console.log('üåê Emergency API Request:', endpoint);
                const response = await fetch(url, {
                    method: options.method || 'GET',
                    headers,
                    body: options.body ? JSON.stringify(options.body) : undefined
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                return await response.json();
            };
            
            // initializeApp will be provided by app-initialization.js
            console.log('üîß Deferring to app-initialization.js for auth logic');
            
            console.log('‚úÖ Emergency optimization override ready');
        } else {
            console.log('‚úÖ Main optimization scripts loaded successfully');
        }
    }, 500);
    </script>
    
    <script src="src/components/AddressForm.js"></script>
    <script src="src/components/VerificationFlow.js"></script>
    <script src="src/components/ContentReporting.js"></script>
    <script src="src/components/CandidateSystem.js"></script>
    <script src="src/components/PostComponent.js"></script>
    <script src="src/components/MyProfile.js"></script>
    <script src="src/integrations/backend-integration.js"></script>
    <script src="src/integrations/candidate-system-integration.js"></script>
    <script src="src/integrations/officials-system-integration.js"></script>
    <script src="src/integrations/elections-system-integration.js"></script>
    <script src="src/integrations/trending-system-integration.js"></script>
    <script src="src/js/mobile-navigation.js"></script>
    <script src="src/js/map-maplibre.js"></script>
    <script src="src/js/relationship-utils.js"></script>
    <script src="src/components/user-relationship-display.js"></script>
    <script src="src/js/donation-system.js"></script>
    <!-- Inline Reputation System (Critical Path) -->
    <script>
        // Essential reputation badge functions
        function getReputationBadge(score) {
            if (score >= 95) {
                return { color: 'green', text: 'Trusted', class: 'reputation-badge-green', show: true };
            } else if (score >= 50) {
                return { color: null, text: null, class: null, show: false };
            } else if (score >= 30) {
                return { color: 'yellow', text: 'Mixed', class: 'reputation-badge-yellow', show: true };
            } else {
                return { color: 'brown', text: 'Low Trust', class: 'reputation-badge-brown', show: true };
            }
        }
        
        function createReputationBadgeElement(score, options = {}) {
            const badge = getReputationBadge(score);
            if (!badge.show) return null;
            
            const element = document.createElement('span');
            element.className = `reputation-badge ${badge.class}`;
            element.textContent = badge.text;
            element.title = `Reputation: ${score}/100`;
            return element;
        }
        
        // Basic integration with posts
        function addReputationBadgeToPost(postElement, reputation) {
            if (!postElement || reputation === undefined) return;
            
            const authorElement = postElement.querySelector('.post-author-name, .post-author, .comment-author');
            if (authorElement && !authorElement.querySelector('.reputation-badge')) {
                const badgeElement = createReputationBadgeElement(reputation);
                if (badgeElement) {
                    authorElement.appendChild(badgeElement);
                }
            }
        }
        
        // Global reputation functions
        window.ReputationBadges = {
            getReputationBadge,
            createReputationBadgeElement,
            addReputationBadgeToPost: addReputationBadgeToPost,
            updateAllPostBadges: function() {
                document.querySelectorAll('[data-author-reputation]').forEach(post => {
                    const reputation = parseInt(post.getAttribute('data-author-reputation'));
                    if (reputation) {
                        addReputationBadgeToPost(post, reputation);
                    }
                });
            },
            updateProfileBadge: function(reputation) {
                const profileElement = document.querySelector('.my-profile .profile-header, .user-profile .profile-header');
                if (profileElement && !profileElement.querySelector('.reputation-badge')) {
                    const badgeElement = createReputationBadgeElement(reputation);
                    if (badgeElement) {
                        profileElement.appendChild(badgeElement);
                    }
                }
            }
        };
        
        if (typeof adminDebugLog !== 'undefined') {
            adminDebugLog('ReputationBadges', 'Reputation badge system loaded (inline)');
        }
    </script>
    <script src="js/adminDebugger.js"></script>
    <script src="src/js/deployment-status.js"></script>
    <script src="src/js/legal-modal.js"></script>
</head>
<body>
    <div class="top-bar">
        <div class="top-bar-left">
            <input class="search desktop-search" type="text" placeholder="Search Name or Location" id="searchInput" onfocus="openSearch()" oninput="performGlobalSearch(this.value)">
        </div>
        
        <div class="top-bar-center">
            <div class="site-title-container" onclick="window.location.href='/'" title="United We Rise - Home">
                <span class="site-title-left">United</span>
                <div class="logo">
                    <img src="UWR Logo on Circle.png" alt="United We Rise" class="logo-circle">
                </div>
                <span class="site-title-right">We Ris<span class="rise-e">e<span class="beta-badge">Beta</span></span></span>
            </div>
        </div>
        
        <div class="top-bar-right">
            <!-- Desktop/Tablet Navigation -->
            <div class="desktop-nav">
                <givebutter-widget id="p75ZaL" class="donation-widget"></givebutter-widget>
                <a href="#" class="nav-link" onclick="openAboutModal()">About UWR</a>
                <div id="notificationSection" class="notification-section" style="display: none;">
                    <button onclick="toggleNotifications()" class="notification-btn">
                        <span class="notification-icon">üîî</span>
                        <span class="notification-badge" id="notificationBadge" style="display: none;">0</span>
                    </button>
                </div>
                <div id="authSection">
                    <button onclick="openAuthModal('login')" class="login-btn">Login</button>
                </div>
                <div id="userSection" class="user-info" style="display: none;">
                    <span id="userGreeting" style="display: none;"></span>
                </div>
            </div>
            
            <!-- Mobile Search Icon -->
            <button class="mobile-search-btn" onclick="toggleMobileSearch()" style="display: none;">
                <span class="search-icon">üîç</span>
            </button>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="authTitle">Login</h2>
                <button onclick="closeAuthModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email</label>
                        <input type="email" id="loginEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" id="loginPassword" required>
                    </div>
                    <div class="form-group" id="totpField" style="display: none;">
                        <label for="loginTOTP">Two-Factor Authentication Code</label>
                        <input type="text" id="loginTOTP" placeholder="Enter 6-digit code" maxlength="6" pattern="[0-9]{6}">
                        <small style="color: #666; font-size: 0.8rem;">Enter the 6-digit code from your authenticator app</small>
                    </div>
                    <button class="btn" onclick="handleLogin()" id="loginButton">Login</button>
                    
                    <div class="oauth-divider">
                        <span>Or continue with</span>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button class="oauth-btn google-btn" onclick="handleGoogleLogin()">
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Google
                        </button>
                        <!-- Microsoft and Apple OAuth temporarily disabled -->
                        <!--
                        <button class="oauth-btn microsoft-btn" onclick="handleMicrosoftLogin()">
                            Microsoft
                        </button>
                        <button class="oauth-btn apple-btn" onclick="handleAppleLogin()">
                            Apple  
                        </button>
                        -->
                    </div>
                    
                    <div class="auth-switch">
                        <a onclick="switchToRegister()">Don't have an account? Sign up</a>
                    </div>
                </div>
                
                <div id="registerForm" style="display: none;">
                    <div class="form-group">
                        <label for="registerEmail">Email</label>
                        <input type="email" id="registerEmail" required>
                    </div>
                    <div class="form-group">
                        <label for="registerUsername">Username</label>
                        <input type="text" id="registerUsername" required>
                    </div>
                    <div class="form-group">
                        <label for="registerPassword">Password</label>
                        <div class="password-input-container">
                            <input type="password" id="registerPassword" required>
                            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('registerPassword')">üëÅÔ∏è</button>
                            <div class="password-status" id="password-status">‚úì</div>
                        </div>
                        <div class="password-requirements" id="password-requirements" style="display: none;">
                            <div class="requirement" id="req-length">‚Ä¢ At least 8 characters</div>
                            <div class="requirement" id="req-uppercase">‚Ä¢ One uppercase letter</div>
                            <div class="requirement" id="req-lowercase">‚Ä¢ One lowercase letter</div>
                            <div class="requirement" id="req-number">‚Ä¢ One number</div>
                            <div class="requirement" id="req-special">‚Ä¢ One special character</div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="registerFirstName">First Name</label>
                        <input type="text" id="registerFirstName">
                    </div>
                    <div class="form-group">
                        <label for="registerLastName">Last Name</label>
                        <input type="text" id="registerLastName">
                    </div>
                    <div class="form-group">
                        <label class="checkbox-container">
                            <input type="checkbox" id="termsAgreement" required>
                            <span class="checkmark"></span>
                            I agree to the <a href="#" onclick="openLegalModal('terms'); return false;">Terms of Service</a> 
                            and <a href="#" onclick="openLegalModal('privacy'); return false;">Privacy Policy</a>
                        </label>
                    </div>
                    <div class="form-group">
                        <!-- Use production key with proper domain (test.unitedwerise.com) -->
                        <div class="h-captcha" data-sitekey="9c5af3a8-5066-446c-970e-1c18d9fe8d9e" data-callback="onHCaptchaCallback" id="hcaptcha-register"></div>
                    </div>
                    <button class="btn" onclick="handleRegister()">Sign Up</button>
                    
                    <div class="oauth-divider">
                        <span>Or continue with</span>
                    </div>
                    
                    <div class="oauth-buttons">
                        <button class="oauth-btn google-btn" onclick="handleGoogleLogin()">
                            <svg width="20" height="20" viewBox="0 0 24 24">
                                <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                                <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                                <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                                <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                            </svg>
                            Google
                        </button>
                        <!-- Microsoft and Apple OAuth temporarily disabled -->
                        <!--
                        <button class="oauth-btn microsoft-btn" onclick="handleMicrosoftLogin()">
                            Microsoft
                        </button>
                        <button class="oauth-btn apple-btn" onclick="handleAppleLogin()">
                            Apple  
                        </button>
                        -->
                    </div>
                    
                    <div class="auth-switch">
                        <a onclick="switchToLogin()">Already have an account? Login</a>
                    </div>
                </div>
                
                <div id="authMessage"></div>
            </div>
        </div>
    </div>

    <!-- Legal Documents Modal -->
    <div id="legalModal" class="modal">
        <div class="modal-content" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 id="legalTitle">Legal Documents</h2>
                <button onclick="closeLegalModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <div id="legalContent">
                    <!-- Content will be loaded dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- About United We Rise Modal -->
    <div id="aboutModal" class="modal">
        <div class="modal-content" style="max-width: 700px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header">
                <h2>About United We Rise</h2>
                <button onclick="closeAboutModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Hero Section -->
                <div style="text-align: center; margin-bottom: 2rem; padding: 2rem; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 8px;">
                    <img src="UWR Logo on Circle.png" alt="United We Rise" style="width: 80px; height: 80px; margin-bottom: 1rem;">
                    <h3 style="color: #2c3e50; margin-bottom: 0.5rem; font-size: 1.8rem;">Democratizing Democracy, Together.</h3>
                    <p style="color: #5a6c7d; max-width: 500px; margin: 0 auto;">United We Rise exists to break down the barriers that keep everyday people from engaging in politics.</p>
                </div>

                <!-- Our Mission -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #2c3e50; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">Our Mission</h4>
                    <p style="font-size: 1.1rem; line-height: 1.6;">We empower communities to connect directly with representatives, discover grassroots candidates, and build a transparent, accountable democracy.</p>
                </div>

                <!-- Why I Started This -->
                <div style="margin-bottom: 2rem; background: #f8f9fa; padding: 1.5rem; border-radius: 8px; border-left: 4px solid #4b5c09;">
                    <h4 style="color: #2c3e50; margin-top: 0;">Why I Started This</h4>
                    <p style="line-height: 1.6; margin-bottom: 1rem;">I reached a point where the growing sense of nihilism was overwhelming ‚Äî it felt like no one was doing anything to change the system. Everyone was waiting for someone else.</p>
                    
                    <p style="line-height: 1.6; margin-bottom: 1rem;">The problem was obvious: big money dominates our politics. From mainstream media deciding who is "electable," to donors holding politicians' ears, ordinary people had no way to compete in that arena.</p>
                    
                    <p style="line-height: 1.6; margin-bottom: 1rem;"><strong>So I built my own.</strong></p>
                    
                    <p style="line-height: 1.6; margin-bottom: 1rem;">United We Rise is a place where I don't have to care who pays the most. Every candidate can be discovered. Every idea can be weighed on its merits. And every voter can get the information they need to choose leaders who will actually improve their lives.</p>
                    
                    <p style="line-height: 1.6; font-style: italic;">I'm not a web developer. United We Rise was built by me over many long hours using AI. It isn't perfect yet ‚Äî but I'm committed to making it better every day. If you stick with me, if you use it and share it, we can turn this into the pre-eminent social media source for political information and change. Together, we can make democracy work again.</p>
                </div>

                <!-- Our Principles -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #2c3e50; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">Our Principles</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üõ°Ô∏è</div>
                            <strong style="color: #2c3e50;">Integrity</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">No ads. No corporate sponsors. No data sales.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üóΩ</div>
                            <strong style="color: #2c3e50;">Independence</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Built and funded by users, not investors.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">üîç</div>
                            <strong style="color: #2c3e50;">Transparency</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Donor disclosures and open governance.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">‚öñÔ∏è</div>
                            <strong style="color: #2c3e50;">Equity</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Centering underrepresented voices and grassroots candidates.</p>
                        </div>
                        <div style="text-align: center; padding: 1rem;">
                            <div style="font-size: 2rem; margin-bottom: 0.5rem;">ü§ù</div>
                            <strong style="color: #2c3e50;">Accessibility</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem; color: #5a6c7d;">Always free to use.</p>
                        </div>
                    </div>
                </div>

                <!-- Radical Transparency -->
                <div style="margin-bottom: 2rem; background: #e8f5e9; padding: 1.5rem; border-radius: 8px;">
                    <h4 style="color: #2c3e50; margin-top: 0;">Radical Transparency</h4>
                    <p style="line-height: 1.6;">We will always be free, and we only accept donations from users. We refuse ads, corporate money, and profit motives. To back that up, we are committed to donor disclosure, so you always know who supports us. Our independence is non-negotiable.</p>
                </div>

                <!-- How It Works -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: #2c3e50; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">How It Works</h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; position: relative;">
                            <span style="position: absolute; top: 5px; right: 5px; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">BETA</span>
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üó∫Ô∏è</div>
                            <strong>Geographic Social Graph</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Connects you first to your own community and representatives.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">üí¨</div>
                            <strong>Direct Representative Messaging</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Makes your voice harder to ignore.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; position: relative;">
                            <span style="position: absolute; top: 5px; right: 5px; background: #ffc107; color: #333; padding: 2px 6px; border-radius: 3px; font-size: 0.7rem; font-weight: bold;">BETA</span>
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">ü§ñ</div>
                            <strong>AI-Powered Topic Discovery</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Helps you find balanced perspectives on the issues that matter.</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px;">
                            <div style="font-size: 1.5rem; margin-bottom: 0.5rem;">‚≠ê</div>
                            <strong>Reputation-Based Moderation</strong>
                            <p style="margin: 0.5rem 0; font-size: 0.9rem;">Builds a healthier civic space without corporate algorithms.</p>
                        </div>
                    </div>
                </div>

                <!-- Be Part of It -->
                <div style="margin-bottom: 2rem; text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="color: #2c3e50; margin-bottom: 1rem;">Be Part of It</h4>
                    <p style="font-size: 1.1rem; margin-bottom: 1.5rem; font-weight: bold;">This platform is only as powerful as the people who use it.</p>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap; margin-bottom: 1rem;">
                        <button onclick="closeAboutModal(); document.getElementById('loginModal').style.display='block';" style="background: #4b5c09; color: white; padding: 0.75rem 2rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
                            Join the Community
                        </button>
                        <button onclick="closeAboutModal(); window.location.href='/donate.html';" style="background: white; color: #4b5c09; padding: 0.75rem 2rem; border: 2px solid #4b5c09; border-radius: 4px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
                            Support Our Mission
                        </button>
                    </div>
                    
                    <button onclick="closeAboutModal(); openVolunteerModal();" style="background: none; border: none; color: #4b5c09; text-decoration: underline; font-size: 0.9rem; cursor: pointer; padding: 0;">Volunteer your skills</button>
                </div>

                <div style="border-top: 1px solid #dee2e6; padding-top: 1rem; text-align: center; color: #6c757d; font-size: 0.9rem;">
                    <p><strong>United We Rise</strong> - Democratizing Democracy, Together<br>
                    Operated by People United for Peaceful Revolution, Inc. 501(c)(3)<br>
                    Built by users, for users, with radical transparency at our core</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Volunteer Modal -->
    <div id="volunteerModal" class="modal" style="display: none;">
        <div class="modal-content">
            <span class="close" onclick="closeVolunteerModal()">&times;</span>
            <div id="volunteerModalContent">
                <div style="padding: 2rem; max-width: 600px; margin: 0 auto;">
                    <h2 style="color: #2c3e50; margin-bottom: 1.5rem; text-align: center;">Volunteer Your Skills</h2>
                    
                    <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem;">
                        <p style="font-size: 1.1rem; line-height: 1.6; color: #495057; margin: 0;">
                            Help us build a platform that truly serves democracy. Whether you're a developer, designer, writer, organizer, or have other skills to offer, there's a place for you in our movement.
                        </p>
                    </div>

                    <form id="volunteerForm" style="margin-bottom: 1.5rem;">
                        <div id="emailSection" style="margin-bottom: 1.5rem; display: none;">
                            <label for="volunteerEmail" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Email Address:</label>
                            <input type="email" id="volunteerEmail" name="volunteerEmail" required 
                                   style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                                   placeholder="your.email@example.com">
                        </div>

                        <div style="margin-bottom: 1.5rem;">
                            <label for="volunteerMessage" style="display: block; margin-bottom: 0.5rem; font-weight: bold; color: #2c3e50;">Tell us about your skills and how you'd like to help:</label>
                            <textarea id="volunteerMessage" name="volunteerMessage" required maxlength="800" rows="6"
                                     style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem; resize: vertical;"
                                     placeholder="I'm a [your expertise] and I'd like to help with [specific area]. My background includes..."></textarea>
                            <div style="text-align: right; margin-top: 0.5rem; font-size: 0.9rem; color: #6c757d;">
                                <span id="charCount">0</span>/800 characters
                            </div>
                        </div>

                        <div style="text-align: center;">
                            <button type="submit" id="volunteerSubmitBtn" 
                                    style="background: #4b5c09; color: white; padding: 0.75rem 2rem; border: none; border-radius: 4px; font-size: 1.1rem; cursor: pointer; font-weight: bold;">
                                Send Volunteer Inquiry
                            </button>
                        </div>
                    </form>

                    <div style="text-align: center; color: #6c757d; font-size: 0.9rem; line-height: 1.4;">
                        <p>Your message will be reviewed by our team and we'll get back to you soon.<br>
                        Thank you for wanting to be part of democratizing democracy!</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="sidebar" id="sidebar">
            <div class="thumbs">
                <div class="thumb" onclick="toggleMyFeed()" title="My Feed" id="feedThumb">üì∞ <span class="label">My Feed</span></div>
                <div class="thumb" onclick="toggleTrendingPanel()" title="Trending">üî• <span class="label">Trending</span></div>
                <div class="thumb" onclick="togglePanel('upcoming')" title="Upcoming Contests">üìÖ <span class="label">Upcoming</span></div>
                <div class="thumb" onclick="togglePanel('officials')" title="My Elected Officials">üèõÔ∏è <span class="label">Officials</span></div>
                <div class="thumb" onclick="window.map && window.map.showMap ? window.map.showMap() : showMapFromSidebar()" title="Show Map" id="mapThumb">üó∫Ô∏è <span class="label">Map</span></div>
                <div class="thumb" onclick="toggleMessages()" title="Messages" id="messagesThumb">üí¨ <span class="label">Messages</span></div>
                <div class="thumb" onclick="window.donationSystem ? window.donationSystem.openDonationModal() : alert('Donation system loading...')" title="Support Our Mission" id="donationThumb">üíù <span class="label">Donate</span></div>
                <div class="thumb" onclick="openCivicOrganizing()" title="Civic Organizing" id="organizingThumb" style="display: none;">üìã <span class="label">Organize</span></div>
                <div class="thumb" onclick="toggleMyProfile()" title="My Profile" id="profileThumb" style="display: none;">üë§ <span class="label">My Profile</span></div>
            </div>
            <div class="sidebar-bottom">
                <div class="thumb logout-thumb" onclick="logout()" title="Logout" id="logoutThumb" style="display: none;">
                    üö™ <span class="label">Logout</span>
                </div>
            </div>
        </div>
        <!-- Sidebar Toggle Button (on the edge) -->
        <button id="toggleSidebar" class="sidebar-toggle-edge" title="Expand Sidebar">
            <span class="arrow-icon">‚ñ∂</span>
        </button>
        <div class="main" id="mainContent">
            <!-- Content will be dynamically inserted here -->
            <div class="welcome-content">
                <h1>Welcome to United We Rise</h1>
                <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                <p>We are still in active development. We are excited for you to join us, and if you see anything that needs addressing, just write it as a post</p>
            </div>
        </div>
    </div>

    <div class="search-container" id="searchContainer" style="display: none;">
        <div class="search-header">
            <h3 style="margin: 0; color: #4b5c09;">Search Results</h3>
            <button onclick="closeSearch()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        
        <!-- Enhanced Search Filters -->
        <div class="search-filters" style="padding: 1rem; border-bottom: 1px solid #eee; background: #f9f9f9;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="all" checked onchange="updateSearchResults()">
                    All
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="users" onchange="updateSearchResults()">
                    üë§ Users
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="posts" onchange="updateSearchResults()">
                    üìù Posts
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="officials" onchange="updateSearchResults()">
                    üèõÔ∏è Officials
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="candidates" onchange="updateSearchResults()">
                    üó≥Ô∏è Candidates
                </label>
                <label style="display: flex; align-items: center; gap: 0.25rem; cursor: pointer; font-size: 0.9rem;">
                    <input type="radio" name="searchType" value="topics" onchange="updateSearchResults()">
                    üè∑Ô∏è Topics
                </label>
            </div>
            
            <!-- Advanced Filters -->
            <div id="advancedFilters" style="margin-top: 1rem; display: none;">
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <!-- Location Filter -->
                    <select id="locationFilter" onchange="updateSearchResults()" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Locations</option>
                        <option value="local">My District</option>
                        <option value="state">My State</option>
                        <option value="national">National</option>
                    </select>
                    
                    <!-- Time Filter -->
                    <select id="timeFilter" onchange="updateSearchResults()" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Time</option>
                        <option value="24h">Last 24 Hours</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    
                    <!-- Topic Filter -->
                    <select id="topicFilter" onchange="updateSearchResults()" style="padding: 0.25rem; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">All Topics</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="economy">Economy</option>
                        <option value="education">Education</option>
                        <option value="environment">Environment</option>
                        <option value="immigration">Immigration</option>
                        <option value="civil-rights">Civil Rights</option>
                        <option value="foreign-policy">Foreign Policy</option>
                        <option value="gun-policy">Gun Policy</option>
                        <option value="local-issues">Local Issues</option>
                    </select>
                </div>
            </div>
            
            <button onclick="toggleAdvancedFilters()" style="background: none; border: none; color: #4b5c09; cursor: pointer; font-size: 0.9rem; margin-top: 0.5rem;">
                <span id="advancedFiltersToggle">‚ñº Advanced Filters</span>
            </button>
        </div>
        
        <div class="search-results" id="globalSearchResults">
            <div style="text-align: center; color: #666; padding: 2rem;">
                Start typing to search across users, posts, officials, and topics
            </div>
        </div>
    </div>

    <div id="panel-trending" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Trending</span>
            <button onclick="closePanel('trending')">X</button>
        </div>
        <div class="panel-body">
            <div id="trendingContent">
                <details><summary>Local</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('Zoning Issue', 2)">Generic Zoning Issue</a></li>
                        <li><a href="#" onclick="openDetail('School District Issue', 2)">Generic School District Issue</a></li>
                    </ul>
                </details>
                <details><summary>State</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('State Tax Issue', 2)">Generic State Tax Issue</a></li>
                    </ul>
                </details>
                <details><summary>National</summary>
                    <ul>
                        <li><a href="#" onclick="openDetail('Immigration Issue', 2)">Generic Immigration Issue</a></li>
                        <li><a href="#" onclick="openDetail('Foreign Policy Issue', 2)">Generic Foreign Policy Issue</a></li>
                    </ul>
                </details>
            </div>
        </div>
    </div>

    <!-- DEPRECATED: panel-myfeed removed - My Feed now populates in main content area per CLAUDE.md documentation -->

    <div id="panel-upcoming" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Upcoming Contests</span>
            <button onclick="closePanel('upcoming')">X</button>
        </div>
        <div class="panel-body">
            <details><summary>Local</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('Mayor', 2)">Mayor</a></li>
                    <li><a href="#" onclick="openDetail('City Council', 2)">City Council</a></li>
                    <li><a href="#" onclick="openDetail('School Board', 2)">School Board</a></li>
                </ul>
            </details>
            <details><summary>State</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('Governor', 2)">Governor</a></li>
                    <li><a href="#" onclick="openDetail('State Senate', 2)">State Senate</a></li>
                </ul>
            </details>
            <details><summary>National</summary>
                <ul>
                    <li><a href="#" onclick="openDetail('President', 2)">President</a></li>
                    <li><a href="#" onclick="openDetail('U.S. House', 2)">U.S. House</a></li>
                </ul>
            </details>
        </div>
    </div>

    <div id="panel-officials" class="info-panel hidden" data-offset="1">
        <div class="panel-header">
            <span>Find Representatives</span>
            <button onclick="closePanel('officials')">X</button>
        </div>
        <div class="panel-body">
            <div id="officialsContent">
                <p>Enter any address to find elected representatives.</p>
            </div>
        </div>
    </div>


    <div id="detail-panel" class="detail-panel hidden" data-offset="2">
        <div class="panel-header">
            <span id="detail-title">Detail</span>
            <button onclick="closeDetail()">X</button>
        </div>
        <div class="panel-body">
            <p id="detail-content">Placeholder content for selected topic.</p>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="messagesContainer" class="messages-container">
        <div class="messages-header">
            <span>Messages</span>
            <button onclick="toggleMessages()" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="messages-body" id="messagesBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading conversations...</p>
            </div>
        </div>
    </div>

    <!-- User Profile Panel -->
    <div id="profilePanel" class="profile-panel">
        <div class="profile-header">
            <span>My Profile</span>
            <button onclick="toggleProfile()" style="background: none; border: none; color: white; cursor: pointer;">&times;</button>
        </div>
        <div class="profile-body" id="profileBody">
            <div style="text-align: center; padding: 2rem; color: #666;">
                <p>Loading profile...</p>
            </div>
        </div>
    </div>

    <!-- Trending Updates Panel (under collapsed map) -->
    <div id="trendingUpdates" class="trending-updates">
        <div class="trending-updates-header">
            <span>üî• Trending Now</span>
            <button class="trending-expand-btn" onclick="toggleTrendingExpansion()" id="trendingExpandBtn">More</button>
        </div>
        <div class="trending-updates-body" id="trendingUpdatesBody">
            <div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">
                Loading trending topics...
            </div>
        </div>
    </div>

    <!-- Map Container (hidden initially) -->
    <div id="mapContainer" style="display: none;">
        <!-- Map Loading State (overlay) -->
        <div id="mapLoadingState" class="map-loading-state">
            <div class="map-loading-spinner"></div>
            <div class="map-loading-text">Loading Map...</div>
        </div>
        
        <div class="map-action-buttons">
            <!-- Main button row -->
            <div class="zoom-buttons-group">
                <button class="map-action-btn" onclick="toggleMapView('national')">National</button>
                <button class="map-action-btn" onclick="toggleMapView('state')">State</button>
                <button class="map-action-btn" onclick="toggleMapView('local')">Local</button>
                <button class="map-action-btn control-btn primary" id="mapToggleBtn">Collapse</button>
                <button class="map-action-btn control-btn close-btn" onclick="window.map && window.map.closeMap ? window.map.closeMap() : closeMap()">√ó</button>
            </div>
            
            <!-- Layer dropdown toggle - positioned relative to button group -->
            <div class="map-layer-dropdown">
                <button class="layer-dropdown-btn" onclick="toggleLayerDropdown()">
                    Layers ‚ñº
                </button>
                <div class="layer-dropdown-content" id="layerDropdown">
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('trending')" data-layer="trending">
                        <span class="layer-icon">üí¨</span>
                        <span>Trending</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('events')" data-layer="events">
                        <span class="layer-icon">üìÖ</span>
                        <span>Events</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('news')" data-layer="news">
                        <span class="layer-icon">üì∞</span>
                        <span>News</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('civic')" data-layer="civic">
                        <span class="layer-icon">üèõÔ∏è</span>
                        <span>Civic</span>
                    </label>
                    <label class="layer-toggle">
                        <input type="checkbox" checked onchange="toggleMapLayer('community')" data-layer="community">
                        <span class="layer-icon">üë•</span>
                        <span>Community</span>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="map"></div>
    </div>

    <!-- MOTD Panel (Message of the Day) -->
    <div id="google-cta-panel" style="display: none;">
        <button id="motd-close-btn">&times;</button>
        <div id="motd-content" style="text-align: left; margin: 0 10px;">
            <div id="motd-title" style="font-weight: bold; margin-bottom: 8px; color: #5A534A;"></div>
            <div id="motd-body" style="color: #5A534A; line-height: 1.4;"></div>
        </div>
    </div>

    <script>
        // API Configuration - Environment-based
        const API_BASE = window.API_CONFIG ? window.API_CONFIG.BASE_URL 
            : (window.location.hostname === 'localhost' || 
               window.location.hostname === '127.0.0.1' || 
               window.location.protocol === 'file:')
                ? 'http://localhost:3001/api' 
                : 'https://unitedwerise-backend.wonderfulpond-f8a8271f.eastus.azurecontainerapps.io/api';
        let currentUser = null;
        let authToken = null;
        let addressForm = null;
        
        // Utility function to fix auth-related localStorage issues without clearing everything
        function fixAuthStorageIssues() {
            console.log('üîß Fixing auth storage issues...');
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            
            // Reset UI to logged out state
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            document.getElementById('userGreeting').textContent = '';
            
            console.log('‚úÖ Auth storage cleared. Please log in again.');
            return 'Auth storage cleared. Please refresh the page and log in again.';
        }
        
        // Make function available in console for easy debugging
        window.fixAuthStorageIssues = fixAuthStorageIssues;

        // Setup collapse button handler function
        function setupCollapseButton() {
            console.log('üîß Setting up collapse button handler...');
            
            // Wait for DOM elements to be available
            setTimeout(() => {
                const mapContainer = document.getElementById('mapContainer');
                const toggleBtn = document.getElementById('mapToggleBtn');
                
                console.log('üîç mapContainer found:', !!mapContainer);
                console.log('üîç toggleBtn found:', !!toggleBtn);
                
                if (toggleBtn && mapContainer) {
                    // Remove any existing listeners
                    toggleBtn.replaceWith(toggleBtn.cloneNode(true));
                    const newToggleBtn = document.getElementById('mapToggleBtn');
                    
                    // Add click handler
                    newToggleBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        console.log('üî• COLLAPSE BUTTON CLICKED!');
                        
                        // Debug current state
                        const isCollapsed = mapContainer.classList.contains('collapsed');
                        console.log('üîç Current collapsed state:', isCollapsed);
                        console.log('üîç mapContainer classes before:', mapContainer.className);
                        console.log('üîç mapContainer computed width before:', getComputedStyle(mapContainer).width);
                        
                        // Hide bubbles before transition
                        if (window.map && window.map.hideBubbles) {
                            window.map.hideBubbles();
                        }
                        
                        // Toggle the class
                        mapContainer.classList.toggle('collapsed');
                        const newIsCollapsed = mapContainer.classList.contains('collapsed');
                        
                        // Debug after toggle
                        console.log('üîç mapContainer classes after:', mapContainer.className);
                        console.log('üîç mapContainer computed width after:', getComputedStyle(mapContainer).width);
                        
                        // Update button text
                        newToggleBtn.textContent = isCollapsed ? 'Collapse' : 'Expand';
                        
                        // Visual feedback
                        newToggleBtn.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            newToggleBtn.style.transform = '';
                        }, 150);
                        
                        console.log(`‚úÖ Map should now be ${isCollapsed ? 'expanded' : 'collapsed'}`);
                        
                        // Force a style recalculation
                        mapContainer.offsetHeight; // Trigger reflow
                        
                        // Adjust map for new container size with appropriate zoom
                        if (window.map && window.map.adjustForContainerState) {
                            window.map.adjustForContainerState(newIsCollapsed);
                        }
                        
                        // Show bubbles after transition completes
                        if (window.map && window.map.showBubbles) {
                            window.map.showBubbles();
                        }
                    }, false);
                    
                    console.log('‚úÖ Collapse button handler attached successfully');
                } else {
                    console.error('‚ùå Could not find button or container elements');
                }
            }, 2000); // Wait 2 seconds for map to fully load
        }

        // Setup close button handler function
        function setupCloseButton() {
            console.log('üîß Setting up close button handler...');
            
            setTimeout(() => {
                const closeBtn = document.querySelector('.map-action-btn.close-btn');
                console.log('üîç closeBtn found:', !!closeBtn);
                
                if (closeBtn) {
                    // Remove existing onclick and replace with proper handler
                    closeBtn.removeAttribute('onclick');
                    closeBtn.addEventListener('click', function(event) {
                        event.preventDefault();
                        event.stopPropagation();
                        
                        console.log('üî• CLOSE BUTTON CLICKED!');
                        
                        if (window.map && window.map.closeMap) {
                            console.log('‚úÖ Calling window.map.closeMap()');
                            window.map.closeMap();
                        } else {
                            console.log('‚ö†Ô∏è Fallback: hiding map container directly');
                            const mapContainer = document.getElementById('mapContainer');
                            if (mapContainer) {
                                mapContainer.style.display = 'none';
                                localStorage.setItem('mapClosed', 'true');
                                
                                // Show sidebar button
                                const mapThumb = document.getElementById('mapThumb');
                                if (mapThumb) {
                                    mapThumb.style.display = 'block';
                                }
                            }
                        }
                    });
                    
                    console.log('‚úÖ Close button handler attached successfully');
                } else {
                    console.error('‚ùå Could not find close button element');
                }
            }, 2000);
        }

        // Setup sidebar map button handler function
        function setupSidebarMapButton() {
            console.log('üîß Setting up sidebar map button handler...');
            
            const mapThumb = document.getElementById('mapThumb');
            console.log('üîç mapThumb found:', !!mapThumb);
            
            if (mapThumb) {
                // Remove existing onclick and replace with proper handler
                mapThumb.removeAttribute('onclick');
                mapThumb.addEventListener('click', function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    
                    console.log('üî• SIDEBAR MAP BUTTON CLICKED!');
                    
                    if (window.map && window.map.showMap) {
                        console.log('‚úÖ Calling window.map.showMap()');
                        window.map.showMap();
                    } else {
                        console.log('‚ö†Ô∏è Fallback: showing map container directly');
                        const mapContainer = document.getElementById('mapContainer');
                        if (mapContainer) {
                            mapContainer.style.display = 'block';
                            localStorage.removeItem('mapClosed');
                            
                            // Hide sidebar button
                            mapThumb.style.display = 'none';
                            
                            console.log('‚úÖ Map restored via fallback method');
                        }
                    }
                });
                
                console.log('‚úÖ Sidebar map button handler attached successfully');
            } else {
                console.error('‚ùå Could not find sidebar map button element');
            }
        }

        // Map layer toggle function
        function toggleMapLayer(layerName) {
            console.log(`üîß Toggling map layer: ${layerName}`);
            
            if (window.map && typeof window.map.toggleLayer === 'function') {
                window.map.toggleLayer(layerName);
            } else {
                console.warn('Map layer toggle not available - map may not be initialized yet');
            }
        }

        // Layer dropdown toggle function
        function toggleLayerDropdown() {
            const dropdown = document.getElementById('layerDropdown');
            const btn = document.querySelector('.layer-dropdown-btn');
            
            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                btn.textContent = 'Layers ‚ñº';
            } else {
                dropdown.classList.add('show');
                btn.textContent = 'Layers ‚ñ≤';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('layerDropdown');
            const dropdownContainer = document.querySelector('.map-layer-dropdown');
            
            if (dropdown && dropdownContainer && !dropdownContainer.contains(event.target)) {
                dropdown.classList.remove('show');
                const btn = document.querySelector('.layer-dropdown-btn');
                if (btn) btn.textContent = 'Layers ‚ñº';
            }
        });

        // Map view toggle function
        function toggleMapView(jurisdiction) {
            console.log(`üîß Switching map view to: ${jurisdiction}`);
            
            // Update active button styling
            const buttons = document.querySelectorAll('.zoom-buttons-group .map-action-btn');
            buttons.forEach(btn => {
                if (btn.textContent.toLowerCase() === jurisdiction.toLowerCase()) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            if (window.map && typeof window.map.setJurisdiction === 'function') {
                window.map.setJurisdiction(jurisdiction);
            } else {
                console.warn('Map jurisdiction change not available - map may not be initialized yet');
            }
            
            // Refresh map topics for new scope
            if (typeof updateMapTopics === 'function') {
                updateMapTopics().catch(console.error);
            }
        }

        // Check for existing auth on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Use new optimized initialization system
            if (typeof adminDebugLog !== 'undefined') {
                adminDebugLog('AppInit', 'Starting optimized app initialization...');
            }
            initializeApp().then(result => {
                if (typeof adminDebugLog !== 'undefined') {
                    adminDebugLog('AppInit', 'App initialization complete', result);
                }
                
                // Setup civic organizing sidebar monitoring
                setupCivicOrganizingSidebarMonitoring();
            }).catch(error => {
                console.error('üí• App initialization failed:', error);
            });

            // Map initialization is now handled by map-maplibre.js to avoid conflicts
            console.log('Map initialization delegated to map-maplibre.js script');
            
            // Setup collapse button handler (runs regardless of map system)
            setupCollapseButton();
            
            // Setup close button handler 
            setupCloseButton();
            
            // Setup sidebar map button handler
            setupSidebarMapButton();

            // Load and show MOTD if available
            loadMOTD();

            // Start trending refresh interval
            startTrendingRefresh();
        });

        // Authentication Functions
        async function verifyAndSetUser() {
            try {
                if (typeof adminDebugLog !== 'undefined') {
                    await adminDebugLog('Authentication', 'Verifying token with /auth/me');
                }
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: {
                        'Authorization': `Bearer ${authToken}`
                    }
                });

                console.log('Auth verification response status:', response.status);
                
                if (response.ok) {
                    const data = await response.json();
                    if (typeof adminDebugLog !== 'undefined') {
                        await adminDebugLog('Authentication', 'Auth verification successful', {
                            userId: data.user?.id,
                            username: data.user?.username
                        });
                    }
                    
                    // Only set user logged in if we actually have user data
                    if (data.user && data.user.id) {
                        setUserLoggedIn(data.user);
                    } else {
                        console.warn('Invalid user data received:', data);
                        // Clear invalid session
                        localStorage.removeItem('authToken');
                        authToken = null;
                        // Ensure UI shows logged out state
                        setUserLoggedOut();
                    }
                } else {
                    // Token is invalid
                    console.log('Token invalid, removing from storage');
                    localStorage.removeItem('authToken');
                    authToken = null;
                    // Ensure UI shows logged out state
                    setUserLoggedOut();
                }
            } catch (error) {
                console.error('Auth verification failed:', error);
                localStorage.removeItem('authToken');
                authToken = null;
                // Ensure UI shows logged out state
                setUserLoggedOut();
            }
        }

        function openAuthModal(mode = 'login') {
            document.getElementById('authModal').style.display = 'block';
            if (mode === 'login') {
                switchToLogin();
            } else {
                switchToRegister();
            }
        }

        function closeAuthModal() {
            document.getElementById('authModal').style.display = 'none';
            clearAuthForm();
        }

        function switchToLogin() {
            document.getElementById('authTitle').textContent = 'Login';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
            clearAuthForm();
        }

        function switchToRegister() {
            document.getElementById('authTitle').textContent = 'Sign Up';
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
            clearAuthForm();
        }

        function clearAuthForm() {
            document.getElementById('authMessage').innerHTML = '';
            // Clear all form inputs
            document.querySelectorAll('#authModal input').forEach(input => input.value = '');
            // Hide TOTP field and reset button text
            const totpField = document.getElementById('totpField');
            if (totpField) totpField.style.display = 'none';
            const loginButton = document.getElementById('loginButton');
            if (loginButton) loginButton.textContent = 'Login';
        }

        async function handleLogin() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAuthMessage('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const loginButton = document.getElementById('loginButton');
                loginButton.disabled = true;
                loginButton.textContent = 'Signing in...';
                
                // Use unified login function
                const result = await unifiedLogin(email, password, 'main-site');
                
                if (result.success) {
                    // Set auth token for compatibility
                    authToken = result.token;
                    
                    setUserLoggedIn(result.user);
                    closeAuthModal();
                    showAuthMessage('Login successful!', 'success');
                } else {
                    showAuthMessage(result.error || 'Login failed', 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showAuthMessage('Network error. Please try again.', 'error');
            } finally {
                const loginButton = document.getElementById('loginButton');
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        }

        async function handleRegister() {
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const firstName = document.getElementById('registerFirstName').value;
            const lastName = document.getElementById('registerLastName').value;
            
            
            // Get hCaptcha response
            let hcaptchaResponse = null;
            try {
                if (window.hcaptcha) {
                    const widget = document.getElementById('hcaptcha-register');
                    const hasIframe = widget && widget.querySelector('iframe');
                    
                    console.log('hCaptcha check before registration:', {
                        widget: widget ? 'exists' : 'missing',
                        iframe: hasIframe ? 'exists' : 'missing',
                        hcaptchaLoaded: typeof window.hcaptcha !== 'undefined'
                    });
                    
                    hcaptchaResponse = window.hcaptcha.getResponse();
                    console.log('hCaptcha response length:', hcaptchaResponse ? hcaptchaResponse.length : 0);
                }
            } catch (e) {
                console.error('hCaptcha getResponse error:', e);
            }

            if (!email || !username || !password) {
                showAuthMessage('Email, username, and password are required', 'error');
                return;
            }

            // Check terms agreement checkbox
            const termsAgreement = document.getElementById('termsAgreement');
            if (!termsAgreement || !termsAgreement.checked) {
                showAuthMessage('You must agree to the Terms of Service and Privacy Policy to continue', 'error');
                return;
            }
            
            // Skip hCaptcha entirely for local development
            const isLocalDev = window.location.protocol === 'file:' || 
                             window.location.hostname === 'localhost' || 
                             window.location.hostname === '127.0.0.1';

            if (!isLocalDev && !hcaptchaResponse) {
                showAuthMessage('Please complete the captcha verification by clicking the checkbox above', 'error');
                return;
            }
            
            // Validate password
            if (!validatePassword(password)) {
                showAuthMessage('Password must meet all requirements', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        email, 
                        username, 
                        password, 
                        firstName, 
                        lastName, 
                        hcaptchaToken: hcaptchaResponse || null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    setUserLoggedIn(data.user);
                    closeAuthModal();
                    showAuthMessage('Registration successful!', 'success');
                } else {
                    showAuthMessage(data.error || 'Registration failed', 'error');
                    // Reset hCaptcha on error
                    if (window.hcaptcha) {
                        window.hcaptcha.reset();
                    }
                }
            } catch (error) {
                console.error('Registration error:', error);
                showAuthMessage('Network error. Please try again.', 'error');
                // Reset hCaptcha on error
                if (window.hcaptcha) {
                    window.hcaptcha.reset();
                }
            }
        }

        async function refreshUserDataIfNeeded(user) {
            // If user data is missing firstName, refresh it from the backend
            if (!user.firstName && authToken) {
                console.log('User data missing firstName, refreshing...');
                try {
                    const response = await fetch(`${API_BASE}/auth/me`, {
                        headers: {
                            'Authorization': `Bearer ${authToken}`
                        }
                    });
                    
                    if (response.ok) {
                        const freshUser = await response.json();
                        console.log('Refreshed user data:', freshUser);
                        
                        // Update localStorage with fresh data
                        localStorage.setItem('currentUser', JSON.stringify(freshUser));
                        
                        return freshUser;
                    }
                } catch (error) {
                    console.warn('Could not refresh user data:', error);
                }
            }
            return user;
        }

        async function setUserLoggedIn(user) {
            // Safety check - don't process if no user data
            if (!user || !user.id) {
                console.error('Invalid user data passed to setUserLoggedIn:', user);
                setUserLoggedOut();
                return;
            }
            
            // Refresh user data if needed
            const refreshedUser = await refreshUserDataIfNeeded(user);
            currentUser = refreshedUser;
            
            // Store user data in localStorage for persistence
            localStorage.setItem('currentUser', JSON.stringify(refreshedUser));
            
            document.getElementById('authSection').style.display = 'none';
            document.getElementById('userSection').style.display = 'flex';
            
            // More robust greeting with multiple fallbacks
            const displayName = refreshedUser.firstName || refreshedUser.username || 'User';
            console.log('üîç Setting greeting - firstName:', refreshedUser.firstName, 'username:', refreshedUser.username, 'displayName:', displayName);
            const greetingElement = document.getElementById('userGreeting');
            if (greetingElement) {
                greetingElement.textContent = `Hello, ${displayName}!`;
                greetingElement.style.display = 'inline'; // Show the greeting span
                console.log('‚úÖ Greeting set to:', greetingElement.textContent, 'visible:', greetingElement.style.display);
                
                // Debug: Check if anything clears this immediately
                setTimeout(() => {
                    console.log('üîç Greeting after 100ms:', greetingElement.textContent, 'visible:', greetingElement.style.display);
                }, 100);
                setTimeout(() => {
                    console.log('üîç Greeting after 1s:', greetingElement.textContent, 'visible:', greetingElement.style.display);
                }, 1000);
            }
            
            // Address info will be loaded by loadUserContent()
            
            // Show user-specific sidebar options
            document.getElementById('messagesThumb').style.display = 'block';
            document.getElementById('organizingThumb').style.display = 'block';
            document.getElementById('profileThumb').style.display = 'block';
            document.getElementById('feedThumb').style.display = 'block';
            // Note: postComposer is now part of feed view, not a standalone element
            document.getElementById('logoutThumb').style.display = 'block';
            
            // Load user-specific content
            loadUserContent();
            loadUserPosts();
            
            // Show My Feed by default in main content area
            showMyFeedInMain();
        }
        
        function setUserLoggedOut() {
            currentUser = null;
            authToken = null;
            
            // Reset UI to logged out state
            document.getElementById('authSection').style.display = 'flex';
            document.getElementById('userSection').style.display = 'none';
            const greetingElement = document.getElementById('userGreeting');
            if (greetingElement) {
                greetingElement.textContent = '';
                greetingElement.style.display = 'none'; // Hide the greeting span
            }
            
            // Hide user-specific sidebar options
            document.getElementById('messagesThumb').style.display = 'none';
            document.getElementById('profileThumb').style.display = 'none';
            document.getElementById('feedThumb').style.display = 'none';
            document.getElementById('logoutThumb').style.display = 'none';
            
            // Reset main content to welcome message
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="welcome-content">
                        <h1>Welcome to United We Rise</h1>
                        <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                    </div>
                `;
            }
        }


        // Enable/disable radio buttons based on available location data
        function updateRadioButtonAvailability() {
            const stateRadio = document.querySelector('input[name="zoomLevel"][value="state"]');
            const localRadio = document.querySelector('input[name="zoomLevel"][value="local"]');
            const stateLabel = stateRadio?.parentElement;
            const localLabel = localRadio?.parentElement;
            
            // Check if user has location data
            const hasState = currentUser && currentUser.state;
            const hasAddress = currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state;
            
            // Enable/disable state radio
            if (stateRadio && stateLabel) {
                stateRadio.disabled = !hasState;
                stateLabel.style.opacity = hasState ? '1' : '0.5';
                stateLabel.style.cursor = hasState ? 'pointer' : 'not-allowed';
            }
            
            // Enable/disable local radio
            if (localRadio && localLabel) {
                localRadio.disabled = !hasAddress;
                localLabel.style.opacity = hasAddress ? '1' : '0.5';
                localLabel.style.cursor = hasAddress ? 'pointer' : 'not-allowed';
            }
            
            console.log(`Radio button availability - State: ${hasState}, Local: ${hasAddress}`);
        }

        function logout() {
            // Use unified logout function
            unifiedLogout('main-site');
            
            // Additional main-site specific cleanup
            setUserLoggedOut();
            
            // Hide additional elements
            document.getElementById('messagesContainer').style.display = 'none';
            document.getElementById('profilePanel').style.display = 'none';
            
            // Reset panels to default content
            resetPanelsToDefault();
            
            // Reset main content
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.innerHTML = `
                    <div class="welcome-content">
                        <h1>Welcome to United We Rise</h1>
                        <p>Connect with candidates, elected officials, and fellow citizens. Join the conversation about the issues that matter.</p>
                    </div>
                `;
            }
        }

        function showAuthMessage(message, type) {
            const messageEl = document.getElementById('authMessage');
            messageEl.innerHTML = `<div class="${type}-message">${message}</div>`;
        }

        // About Modal Functions
        function openAboutModal() {
            document.getElementById('aboutModal').style.display = 'block';
        }

        function closeAboutModal() {
            document.getElementById('aboutModal').style.display = 'none';
        }

        // Add click-outside-to-close functionality for About modal
        document.addEventListener('DOMContentLoaded', function() {
            const aboutModal = document.getElementById('aboutModal');
            if (aboutModal) {
                aboutModal.addEventListener('click', (e) => {
                    if (e.target === aboutModal) {
                        closeAboutModal();
                    }
                });
            }
        });

        // Volunteer Modal Functions
        function openVolunteerModal() {
            const modal = document.getElementById('volunteerModal');
            const emailSection = document.getElementById('emailSection');
            
            // Show email field if user is not logged in
            const emailInput = document.getElementById('volunteerEmail');
            if (!window.authToken || !localStorage.getItem('currentUser')) {
                emailSection.style.display = 'block';
                emailInput.required = true;
            } else {
                emailSection.style.display = 'none';
                emailInput.required = false; // Remove required attribute for logged-in users
            }
            
            modal.style.display = 'block';
            
            // Set up character counter
            const messageTextarea = document.getElementById('volunteerMessage');
            const charCount = document.getElementById('charCount');
            
            messageTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
        }

        function closeVolunteerModal() {
            document.getElementById('volunteerModal').style.display = 'none';
            // Reset form
            document.getElementById('volunteerForm').reset();
            document.getElementById('charCount').textContent = '0';
        }

        // Add click-outside-to-close functionality for Volunteer modal
        document.addEventListener('DOMContentLoaded', function() {
            const volunteerModal = document.getElementById('volunteerModal');
            if (volunteerModal) {
                volunteerModal.addEventListener('click', (e) => {
                    if (e.target === volunteerModal) {
                        closeVolunteerModal();
                    }
                });
            }

            // Handle volunteer form submission
            const volunteerForm = document.getElementById('volunteerForm');
            if (volunteerForm) {
                volunteerForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const submitBtn = document.getElementById('volunteerSubmitBtn');
                    const originalText = submitBtn.textContent;
                    submitBtn.textContent = 'Sending...';
                    submitBtn.disabled = true;

                    try {
                        const message = document.getElementById('volunteerMessage').value.trim();
                        const email = document.getElementById('volunteerEmail').value.trim();
                        
                        if (!message) {
                            alert('Please enter your message.');
                            return;
                        }

                        // Check if user is logged in
                        const isLoggedIn = window.authToken && localStorage.getItem('currentUser');
                        
                        // For non-logged in users, require email
                        if (!isLoggedIn && !email) {
                            alert('Please enter your email address.');
                            return;
                        }

                        // Create post using unified volunteer system
                        const result = await createPostVolunteer(message, email);

                        if (result.success) {
                            alert('Thank you! Your volunteer inquiry has been submitted. We\'ll review it and get back to you soon.');
                            closeVolunteerModal();
                        } else {
                            throw new Error(result.error || 'Failed to submit inquiry');
                        }

                    } catch (error) {
                        console.error('Error submitting volunteer inquiry:', error);
                        alert('Error submitting your inquiry. Please try again.');
                    } finally {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                });
            }
        });

        // OAuth Authentication Functions
        async function handleGoogleLogin() {
            try {
                console.log('üöÄ Starting Google Sign-In process...');
                console.log('   Domain:', window.location.origin);
                
                // Initialize Google Sign-In if not already done
                if (!window.google?.accounts?.id) {
                    console.log('üì• Google Sign-In not loaded, attempting to load...');
                    try {
                        await loadGoogleSignIn();
                        console.log('‚úÖ Google Sign-In loaded successfully');
                    } catch (loadError) {
                        console.error('‚ùå Failed to load Google Sign-In:', loadError.message);
                        
                        if (loadError.message.includes('domain authorization')) {
                            showAuthMessage('Google Sign-In is still initializing. Domain authorization may be propagating. Please try again in 15-30 minutes.', 'warning');
                            console.log('üí° Run testGoogleDomainAuth() to check status');
                        } else {
                            showAuthMessage('Google Sign-In is temporarily unavailable. Please try again later.', 'error');
                        }
                        return;
                    }
                }

                console.log('üîß Creating Google Sign-In button...');
                
                // Use the One Tap prompt with immediate fallback to button render
                const buttonContainer = document.createElement('div');
                buttonContainer.style.position = 'fixed';
                buttonContainer.style.top = '50%';
                buttonContainer.style.left = '50%';
                buttonContainer.style.transform = 'translate(-50%, -50%)';
                buttonContainer.style.zIndex = '10000';
                buttonContainer.style.display = 'none';
                document.body.appendChild(buttonContainer);

                // Render the Google Sign-In button
                google.accounts.id.renderButton(buttonContainer, {
                    type: 'standard',
                    size: 'large',
                    text: 'signin_with',
                    shape: 'rectangular',
                    logo_alignment: 'left',
                    width: 250
                });

                console.log('üñ±Ô∏è  Triggering Google Sign-In dialog...');
                
                // Click the rendered button programmatically
                setTimeout(() => {
                    const googleButton = buttonContainer.querySelector('[role="button"]');
                    if (googleButton) {
                        console.log('‚úÖ Google Sign-In button found, clicking...');
                        googleButton.click();
                    } else {
                        console.error('‚ùå Google Sign-In button not found in container');
                        showAuthMessage('Google Sign-In button failed to load. Please try again.', 'error');
                    }
                    // Clean up
                    setTimeout(() => {
                        if (document.body.contains(buttonContainer)) {
                            document.body.removeChild(buttonContainer);
                        }
                    }, 100);
                }, 100);
                
            } catch (error) {
                console.error('‚ùå Google login error:', error);
                showAuthMessage('Google Sign-In encountered an error. Please try again later.', 'error');
            }
        }

        async function handleGoogleCredentialResponse(response) {
            try {
                console.log('Google credential response received');
                
                const result = await fetch(`${API_BASE}/oauth/google`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        idToken: response.credential
                    })
                });

                const data = await result.json();

                if (result.ok) {
                    // Store auth data
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    window.authToken = data.token;
                    authToken = data.token;

                    // Close auth modal and set logged in state
                    closeAuthModal();
                    setUserLoggedIn(data.user);

                    // Show welcome message for new users
                    if (data.isNewUser) {
                        showAuthMessage('Welcome to United We Rise! Your account has been created.', 'success');
                    } else {
                        showAuthMessage('Successfully signed in with Google!', 'success');
                    }
                } else {
                    showAuthMessage(data.error || 'Google sign-in failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Google login error:', error);
                showAuthMessage('Google sign-in failed. Please try again.', 'error');
            }
        }

        async function handleMicrosoftLogin() {
            try {
                // For Microsoft, we'll use MSAL.js (Microsoft Authentication Library)
                if (!window.msal) {
                    await loadMicrosoftAuth();
                }

                const loginRequest = {
                    scopes: ['User.Read']
                };

                const response = await window.msalInstance.loginPopup(loginRequest);
                
                const result = await fetch('/api/oauth/microsoft', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        accessToken: response.accessToken
                    })
                });

                const data = await result.json();

                if (result.ok) {
                    // Store auth data
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    window.authToken = data.token;
                    authToken = data.token;

                    // Close auth modal and set logged in state
                    closeAuthModal();
                    setLoggedInState(data.user);

                    // Show welcome message
                    if (data.isNewUser) {
                        showAuthMessage('Welcome to United We Rise! Your account has been created.', 'success');
                    } else {
                        showAuthMessage('Successfully signed in with Microsoft!', 'success');
                    }
                } else {
                    showAuthMessage(data.error || 'Microsoft sign-in failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Microsoft login error:', error);
                showAuthMessage('Microsoft sign-in failed. Please try again.', 'error');
            }
        }

        async function handleAppleLogin() {
            try {
                // For Apple Sign In, we'll use Apple's JS SDK
                if (!window.AppleID) {
                    await loadAppleSignIn();
                }

                const response = await AppleID.auth.signIn();
                
                const result = await fetch('/api/oauth/apple', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        identityToken: response.authorization.id_token,
                        user: response.user // Only provided on first sign in
                    })
                });

                const data = await result.json();

                if (result.ok) {
                    // Store auth data
                    localStorage.setItem('authToken', data.token);
                    localStorage.setItem('currentUser', JSON.stringify(data.user));
                    window.authToken = data.token;
                    authToken = data.token;

                    // Close auth modal and set logged in state
                    closeAuthModal();
                    setLoggedInState(data.user);

                    // Show welcome message
                    if (data.isNewUser) {
                        showAuthMessage('Welcome to United We Rise! Your account has been created.', 'success');
                    } else {
                        showAuthMessage('Successfully signed in with Apple!', 'success');
                    }
                } else {
                    showAuthMessage(data.error || 'Apple sign-in failed. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Apple login error:', error);
                showAuthMessage('Apple sign-in failed. Please try again.', 'error');
            }
        }

        // OAuth Debugging and Testing Functions
        window.testGoogleDomainAuth = async function() {
            console.log('üîç Testing Google domain authorization...');
            console.log('   Current domain:', window.location.origin);
            console.log('   Time since domain added: ~45-60 minutes');
            
            try {
                const testResponse = await fetch('https://accounts.google.com/gsi/client', {
                    method: 'HEAD',
                    mode: 'cors'
                });
                console.log('‚úÖ Google GSI client accessible (CORS allowed)');
                console.log('   Response status:', testResponse.status);
            } catch (corsError) {
                console.log('‚ùå CORS error still present:', corsError.message);
                console.log('üí° Domain authorization not yet propagated');
                return false;
            }
            
            // Try to load and test the library
            try {
                await loadGoogleSignIn();
                console.log('üéâ Google OAuth is now ready for testing!');
                return true;
            } catch (loadError) {
                console.log('‚ùå Library load failed:', loadError.message);
                return false;
            }
        };

        window.retryGoogleOAuth = async function() {
            console.log('üîÑ Retrying Google OAuth setup...');
            
            const isReady = await testGoogleDomainAuth();
            if (isReady) {
                console.log('‚úÖ Google OAuth is ready! Try clicking the Google Sign-In button.');
                return true;
            } else {
                console.log('‚è≥ Still waiting for Google domain authorization to propagate...');
                console.log('üí° Try again in 15-30 minutes or run: retryGoogleOAuth()');
                return false;
            }
        };

        // OAuth SDK Loading Functions
        async function loadGoogleSignIn() {
            return new Promise(async (resolve, reject) => {
                try {
                    // Use configured Google Client ID
                    const googleClientId = '496604941751-663p6eiqo34iumaet9tme4g19msa1bf0.apps.googleusercontent.com';
                    const currentDomain = window.location.origin;
                    
                    console.log('üöÄ Loading Google Sign-In...');
                    console.log('   Client ID:', googleClientId);
                    console.log('   Current domain:', currentDomain);
                    console.log('   Expected authorized domain: https://www.unitedwerise.org');
                    
                    // Check if we're on the authorized domain
                    if (currentDomain !== 'https://www.unitedwerise.org') {
                        console.warn('‚ö†Ô∏è  Domain mismatch detected!');
                        console.log('   Current:', currentDomain);
                        console.log('   Authorized:', 'https://www.unitedwerise.org');
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://accounts.google.com/gsi/client';
                    script.async = true;
                    script.defer = true;
                    script.onload = () => {
                        console.log('‚úÖ Google Sign-In script loaded successfully');
                        
                        // Add debugging for library availability
                        setTimeout(() => {
                            console.log('üîç Checking Google library...');
                            console.log('   window.google exists:', !!window.google);
                            console.log('   window.google.accounts exists:', !!window.google?.accounts);
                            console.log('   window.google.accounts.id exists:', !!window.google?.accounts?.id);
                            
                            if (!window.google?.accounts?.id) {
                                console.error('‚ùå Google Sign-In library not available after script load');
                                console.log('üí° This usually means:');
                                console.log('   1. Domain authorization still propagating (wait 15-30 more minutes)');
                                console.log('   2. CORS blocking the library (domain not authorized)');
                                console.log('   3. Network connectivity issues');
                                reject(new Error('Google Sign-In library failed to initialize - domain authorization may still be propagating'));
                                return;
                            }
                            
                            try {
                                console.log('üîß Initializing Google Sign-In...');
                                google.accounts.id.initialize({
                                    client_id: googleClientId,
                                    callback: handleGoogleCredentialResponse,
                                    auto_select: false,
                                    cancel_on_tap_outside: false,
                                    use_fedcm_for_prompt: false // Disable FedCM which can cause issues
                                });
                                console.log('‚úÖ Google Sign-In initialized successfully');
                                console.log('üí° You can now test Google OAuth by clicking the Google Sign-In button');
                                resolve();
                            } catch (initError) {
                                console.error('‚ùå Error initializing Google Sign-In:', initError);
                                reject(initError);
                            }
                        }, 500);
                    };
                    script.onerror = (error) => {
                        console.error('‚ùå Failed to load Google Sign-In script:', error);
                        console.log('üí° This usually indicates CORS blocking due to unauthorized domain');
                        console.log('   Solution: Wait for Google domain authorization to propagate');
                        reject(error);
                    };
                    document.head.appendChild(script);
                } catch (error) {
                    console.error('‚ùå Error in loadGoogleSignIn:', error);
                    reject(error);
                }
            });
        }

        async function loadMicrosoftAuth() {
            return new Promise(async (resolve, reject) => {
                try {
                    // Fetch OAuth configuration from backend
                    const configResponse = await fetch('/api/oauth/config');
                    const config = await configResponse.json();
                    
                    if (!config.microsoft.enabled) {
                        throw new Error('Microsoft OAuth is not configured');
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://alcdn.msauth.net/browser/2.38.1/js/msal-browser.min.js';
                    script.onload = () => {
                        const msalConfig = {
                            auth: {
                                clientId: config.microsoft.clientId,
                                authority: 'https://login.microsoftonline.com/common'
                            }
                        };
                        window.msalInstance = new msal.PublicClientApplication(msalConfig);
                        resolve();
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function loadAppleSignIn() {
            return new Promise(async (resolve, reject) => {
                try {
                    // Fetch OAuth configuration from backend
                    const configResponse = await fetch('/api/oauth/config');
                    const config = await configResponse.json();
                    
                    if (!config.apple.enabled) {
                        throw new Error('Apple OAuth is not configured');
                    }
                    
                    const script = document.createElement('script');
                    script.src = 'https://appleid.cdn-apple.com/appleauth/static/jsapi/appleid/1/en_US/appleid.auth.js';
                    script.onload = () => {
                        AppleID.auth.init({
                            clientId: config.apple.clientId,
                            scope: 'name email',
                            redirectURI: window.location.origin + '/apple-callback',
                            state: 'signin',
                            usePopup: true
                        });
                        resolve();
                    };
                    script.onerror = reject;
                    document.head.appendChild(script);
                } catch (error) {
                    reject(error);
                }
            });
        }

        async function loadUserContent() {
            // Load user's elected officials if they have an address
            try {
                const response = await apiCall('/users/profile');

                if (response.ok) {
                    const data = response.data;
                    
                    // UPDATE: Merge the complete profile data into currentUser
                    if (data.user) {
                        // Debug: Check what's in the profile data
                        console.log('üîç Profile data before merge:', data.user);
                        console.log('üîç currentUser before merge:', currentUser);
                        
                        // Only merge non-null values to avoid overwriting good data with undefined
                        const mergedUser = { ...currentUser };
                        for (const [key, value] of Object.entries(data.user)) {
                            if (value !== null && value !== undefined) {
                                mergedUser[key] = value;
                            }
                        }
                        currentUser = mergedUser;
                        console.log('User profile data merged into currentUser:', currentUser);
                        
                        // Re-update the greeting if it got cleared
                        const displayName = currentUser.firstName || currentUser.username || 'User';
                        const greetingElement = document.getElementById('userGreeting');
                        if (greetingElement) {
                            greetingElement.textContent = `Hello, ${displayName}!`;
                            console.log('üîß Re-set greeting after profile merge to:', greetingElement.textContent);
                        }
                        
                        // Update radio button availability now that we have address data
                        updateRadioButtonAvailability();
                        
                        // Load representatives if we have address
                        if (data.user.zipCode && data.user.state) {
                            loadElectedOfficials(data.user.zipCode, data.user.state);
                        }
                        
                        // Update map location if we have address
                        if (mapInstance && currentUser.state) {
                            getCurrentUserLocation();
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to load user content:', error);
            }
        }

        async function loadElectedOfficials(zipCode, state) {
            try {
                const response = await apiCall('/political/representatives');
                
                if (response.ok && response.data) {
                    const representatives = response.data.representatives;
                    updateOfficialsPanel(representatives);
                    
                    // Extract district information for boundary loading
                    console.log('Representatives data received:', representatives);
                    
                    if (representatives && representatives.federal) {
                        console.log('Federal representatives:', representatives.federal);
                        
                        const districtRep = representatives.federal.find(rep => 
                            rep.office && rep.office.includes('Representative')
                        );
                        
                        console.log('Found district rep:', districtRep);
                        
                        if (districtRep) {
                            let districtNumber = null;
                            let stateAbbr = null;
                            
                            // First try to use the district field directly
                            if (districtRep.district) {
                                console.log('District field found:', districtRep.district);
                                
                                // District field might be like "IL-10" or just "10"  
                                const districtMatch = districtRep.district.match(/(?:(\w{2})-)?(\d+)/);
                                if (districtMatch) {
                                    stateAbbr = districtMatch[1] || (currentUser && currentUser.state);
                                    districtNumber = districtMatch[2];
                                }
                            }
                            
                            // Fallback: try to extract from office title
                            if (!districtNumber && districtRep.office) {
                                console.log('Fallback: parsing office title:', districtRep.office);
                                const officeMatch = districtRep.office.match(/(\w{2})-(\d+)/);
                                if (officeMatch) {
                                    stateAbbr = officeMatch[1];
                                    districtNumber = officeMatch[2];
                                }
                            }
                            
                            if (districtNumber && stateAbbr) {
                                // Store district info for boundary loading
                                if (!currentUser) currentUser = {};
                                currentUser.district = districtNumber;
                                currentUser.state = stateAbbr;
                                
                                console.log(`District info extracted: ${currentUser.state}-${currentUser.district}`);
                                
                                // Load boundary if currently at local zoom
                                if (currentZoomLevel === 'local' && boundaryManager && currentLocation) {
                                    console.log('Loading district boundary...');
                                    boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                                }
                            } else {
                                console.warn('Could not extract district information from representative data');
                            }
                        } else {
                            console.warn('No district representative found in federal representatives');
                        }
                    } else {
                        console.warn('No federal representatives found in response');
                    }
                } else {
                    console.log('No representatives data available yet - may need address in profile');
                }
            } catch (error) {
                console.error('Failed to load representatives:', error);
            }
        }

        function updateOfficialsPanel(representatives) {
            const content = document.getElementById('officialsContent');
            
            // Check if representatives object has any data
            const totalReps = (representatives.federal || []).length + 
                            (representatives.state || []).length + 
                            (representatives.local || []).length;
            
            if (totalReps === 0) {
                content.innerHTML = '<p>No representatives found. Please add your complete address in your profile.</p>';
                return;
            }

            let html = '<div>';
            
            // Federal representatives
            if (representatives.federal && representatives.federal.length > 0) {
                html += '<h4>Federal Representatives</h4>';
                representatives.federal.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                ${rep.photoUrl ? `<img src="${rep.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + rep.name.charAt(0) + '</div>'}
                                <div>
                                    <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                                    <em>${rep.office}</em>
                                </div>
                            </div>
                            ${rep.phones && rep.phones.length > 0 ? `<div>üìû ${rep.phones[0]}</div>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `<div>üåê <a href="${rep.urls[0]}" target="_blank">Website</a></div>` : ''}
                            ${rep.social && rep.social.twitter ? `<div>üê¶ @${rep.social.twitter}</div>` : ''}
                        </div>
                    `;
                });
            }
            
            // State representatives
            if (representatives.state && representatives.state.length > 0) {
                html += '<h4>State Representatives</h4>';
                representatives.state.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f5f5f5;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                                ${rep.photoUrl ? `<img src="${rep.photoUrl}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">` : '<div style="width: 40px; height: 40px; border-radius: 50%; background: #6B8E23; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">' + rep.name.charAt(0) + '</div>'}
                                <div>
                                    <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                                    <em>${rep.office}</em>
                                </div>
                            </div>
                            ${rep.phones && rep.phones.length > 0 ? `<div>üìû ${rep.phones[0]}</div>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `<div>üåê <a href="${rep.urls[0]}" target="_blank">Website</a></div>` : ''}
                        </div>
                    `;
                });
            }
            
            // Local representatives
            if (representatives.local && representatives.local.length > 0) {
                html += '<h4>Local Representatives</h4>';
                representatives.local.forEach(rep => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; background: #f0f8f0;">
                            <strong>${rep.name}</strong> ${rep.party ? `(${rep.party})` : ''}<br>
                            <em>${rep.office}</em><br>
                            ${rep.phones && rep.phones.length > 0 ? `üìû ${rep.phones[0]}<br>` : ''}
                            ${rep.urls && rep.urls.length > 0 ? `üåê <a href="${rep.urls[0]}" target="_blank">Website</a>` : ''}
                        </div>
                    `;
                });
            }
            
            html += '</div>';
            content.innerHTML = html;
        }

        function resetPanelsToDefault() {
            document.getElementById('officialsContent').innerHTML = '<p>Please log in and set your address to see your elected officials.</p>';
        }

        // Existing panel functions
        function togglePanel(name) {
            const panel = document.getElementById(`panel-${name}`);
            const isHidden = panel.classList.contains('hidden');
            
            if (isHidden) {
                // Panel is hidden, show it (close others first)
                closeAllPanels();
                panel.classList.remove('hidden');
            } else {
                // Panel is visible, hide it and show default view
                panel.classList.add('hidden');
                showDefaultView();
            }
        }

        function closePanel(name) {
            document.getElementById(`panel-${name}`).classList.add('hidden');
        }

        function closeAllPanels() {
            document.querySelectorAll('.info-panel').forEach(p => p.classList.add('hidden'));
            document.getElementById('detail-panel').classList.add('hidden');
        }

        function openDetail(title, offset) {
            const panel = document.getElementById('detail-panel');
            document.getElementById('detail-title').innerText = title;
            document.getElementById('detail-content').innerText = `Placeholder content for ${title}.`;
            panel.dataset.offset = offset;
            panel.classList.remove('hidden');
        }

        function closeDetail() {
            document.getElementById('detail-panel').classList.add('hidden');
        }

        // Sidebar toggle
        document.getElementById('toggleSidebar').addEventListener('click', () => {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleSidebar');
            const arrow = document.querySelector('.arrow-icon');
            
            sidebar.classList.toggle('expanded');
            
            // Update arrow direction and tooltip based on sidebar state
            if (sidebar.classList.contains('expanded')) {
                arrow.textContent = '‚óÄ'; // Arrow pointing left when expanded (to collapse)
                toggleButton.title = 'Collapse Sidebar';
                console.log('Sidebar expanded - arrow should point left');
            } else {
                arrow.textContent = '‚ñ∂'; // Arrow pointing right when collapsed (to expand)
                toggleButton.title = 'Expand Sidebar';
                console.log('Sidebar collapsed - arrow should point right');
            }
        });

        // Set initial arrow state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleButton = document.getElementById('toggleSidebar');
            const arrow = document.querySelector('.arrow-icon');
            
            if (sidebar && toggleButton && arrow) {
                if (sidebar.classList.contains('expanded')) {
                    arrow.textContent = '‚óÄ';
                    toggleButton.title = 'Collapse Sidebar';
                } else {
                    arrow.textContent = '‚ñ∂';
                    toggleButton.title = 'Expand Sidebar';
                }
                console.log('Initial sidebar state set');
            }
        });

        // Map initialization - Toggle between Leaflet and MapLibre
        const USE_MAPLIBRE = true; // Set to false to use Leaflet during migration
        
        function initializeMap() {
            if (USE_MAPLIBRE) {
                // Use new MapLibre implementation
                initializeMapLibreLocal();
                return;
            }
            
            // Original Leaflet implementation (fallback)
            const map = L.map('map', {
                center: [37.8283, -98.5795],
                zoom: 5,
                zoomControl: false,
                dragging: false,
                scrollWheelZoom: false,
                doubleClickZoom: false,
                boxZoom: false,
                keyboard: false,
                tap: false,
                touchZoom: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '', // Remove attribution
                subdomains: 'abcd',
            }).addTo(map);

            // Dynamic topics array - will be updated with AI-generated content
            let topics = [
                { coords: [40.7128, -74.0060], text: 'üì¢ Rent control in NYC gaining momentum!' },
                { coords: [34.0522, -118.2437], text: 'üöó EV subsidies debated in California legislature.' },
                { coords: [41.8781, -87.6298], text: '‚öñÔ∏è Chicago voters discuss criminal justice reform.' },
                { coords: [29.7604, -95.3698], text: 'üó≥Ô∏è Texas push for open primaries gaining traction.' },
                { coords: [47.6062, -122.3321], text: 'üå≥ Seattle community organizing for green zoning laws.' },
                { coords: [39.7392, -104.9903], text: 'üè° Denver debates housing-first initiatives.' },
                { coords: [33.4484, -112.0740], text: 'üöÅ Phoenix drone delivery regulations spark debate.' },
                { coords: [25.7617, -80.1918], text: 'üèñÔ∏è Miami climate resiliency bonds trending.' },
                { coords: [32.7767, -96.7970], text: 'üíº Dallas campaign finance reform gaining traction.' },
                { coords: [42.3601, -71.0589], text: 'üìö Boston pushes universal childcare ballot measure.' }
            ];
            
            // Enhanced popup creation with topic mode integration
            function createTopicPopup(topicData, map) {
                const popupOptions = {
                    closeButton: false,
                    autoClose: false,
                    closeOnClick: false,
                    autoPan: false
                };
                
                let popupContent = topicData.text;
                
                // Add click functionality for AI topics
                if (topicData.topicId) {
                    popupContent += `<br><div style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; background: rgba(255,107,53,0.9); color: white; border-radius: 4px; cursor: pointer; font-size: 0.8rem; text-align: center;" onclick="enterTopicMode('${topicData.topicId}')">üí¨ Join Discussion</div>`;
                }
                
                const popup = L.popup(popupOptions)
                    .setLatLng(topicData.coords)
                    .setContent(popupContent)
                    .openOn(map);
                    
                return popup;
            }
            
            // Function to update Leaflet map topics dynamically
            function updateLeafletMapTopics(newTopics) {
                if (newTopics && newTopics.length > 0) {
                    topics = newTopics.map(bubble => ({
                        coords: bubble.coords,
                        text: bubble.text,
                        topicId: bubble.topicId || null,
                        priority: bubble.priority || 'normal'
                    }));
                    console.log('Updated Leaflet map topics with', topics.length, 'AI-generated topics');
                }
            }
            
            // Make update function globally accessible
            window.updateMapTopics = updateLeafletMapTopics;

            let usedTopics = new Map();

            function showRandomPopups() {
                const count = Math.floor(Math.random() * 2) + 1;
                const now = Date.now();

                const availableTopics = topics.filter(t => {
                    const lastShown = usedTopics.has(t.text) ? usedTopics.get(t.text) : 0;
                    return now - lastShown > 180000;
                });

                const shuffled = availableTopics.sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, count);

                selected.forEach(topic => {
                    const popup = createTopicPopup(topic, map);

                    usedTopics.set(topic.text, now);
                    setTimeout(() => map.closePopup(popup), 30000);
                });

                const nextDelay = Math.floor(Math.random() * 3000) + 13000;
                setTimeout(showRandomPopups, nextDelay);
            }

            showRandomPopups();


            // Set map instance for zoom controls
            setMapInstance(map);

            return map;
        }

        // MapLibre initialization function
        function initializeMapLibreLocal() {
            console.log('initializeMapLibreLocal() called');
            
            // Set loading start time for minimum loading duration
            window.mapLoadStartTime = Date.now();
            
            // CRITICAL FIX: Show the map container BEFORE initializing MapLibre
            // MapLibre needs the container to be visible to measure dimensions correctly
            const mapContainer = document.getElementById('mapContainer');
            const loadingState = document.getElementById('mapLoadingState');
            
            console.log('Showing map container for MapLibre initialization...');
            if (mapContainer && loadingState) {
                // Hide loading state and show map container immediately
                loadingState.classList.add('hidden');
                mapContainer.style.display = 'block';
                console.log('Map container is now visible');
            }
            
            // Initialize MapLibre through the class in map-maplibre.js
            console.log('üîç Checking for external initializeMapLibre function...');
            console.log('üîç typeof window.initializeMapLibre:', typeof window.initializeMapLibre);
            console.log('üîç window.initializeMapLibre === initializeMapLibreLocal?', window.initializeMapLibre === initializeMapLibreLocal);
            console.log('üîç window.initializeMapLibre !== initializeMapLibreLocal?', window.initializeMapLibre !== initializeMapLibreLocal);
            
            if (typeof window.initializeMapLibre === 'function' && window.initializeMapLibre !== initializeMapLibreLocal) {
                console.log('‚úÖ Found external initializeMapLibre function, calling it...');
                window.initializeMapLibre();
            } else {
                console.error('‚ùå External initializeMapLibre function not found - map-maplibre.js may not have loaded correctly');
                
                // Fallback: Initialize directly if the function isn't available
                if (typeof UWRMapLibre !== 'undefined') {
                    console.log('UWRMapLibre class found, initializing directly...');
                    const mapInstance = new UWRMapLibre('map');
                    mapInstance.initialize().then(map => {
                        console.log('Direct MapLibre initialization complete');
                        
                        // Create window.map object manually since initializeMapLibre() wasn't called
                        window.map = {
                            // Wrapper methods for Leaflet compatibility
                            setView: (center, zoom) => mapInstance.setView(center, zoom),
                            invalidateSize: () => mapInstance.invalidateSize(),
                            closePopup: () => mapInstance.closeAllPopups(),
                            fitBounds: (bounds) => mapInstance.fitBounds(bounds),
                            // New MapLibre-specific methods
                            toggleCollapsed: () => {
                                console.log('window.map.toggleCollapsed called');
                                return mapInstance.toggleCollapsed();
                            },
                            closeMap: () => mapInstance.closeMap(),
                            showMap: () => mapInstance.showMap(),
                            // Transition methods for smooth bubble handling
                            hideBubbles: () => mapInstance.hideAllBubblesDuringTransition(),
                            showBubbles: () => mapInstance.showAllBubblesAfterTransition(),
                            // Map container state adjustment
                            adjustForContainerState: (isCollapsed) => mapInstance.adjustForContainerState(isCollapsed),
                            setZoomLevel: (level) => {
                                mapInstance.setZoomLevel(level);
                                // Update button states
                                updateMapViewButtons(level);
                            },
                            geocodeAndZoom: () => mapInstance.geocodeAndZoom(),
                            // Layer management system
                            toggleLayer: (layerName) => mapInstance.toggleLayer(layerName),
                            setJurisdiction: (jurisdiction) => mapInstance.setJurisdiction(jurisdiction),
                            // MapLibre instance for advanced use
                            _maplibre: map,
                            _uwrMap: mapInstance
                        };
                        
                        console.log('window.map object created with adjustForContainerState:', !!window.map.adjustForContainerState);
                    }).catch(error => {
                        console.error('Direct MapLibre initialization failed:', error);
                    });
                } else {
                    console.error('UWRMapLibre class not found - falling back to Leaflet');
                    // Fall back to Leaflet if MapLibre fails completely
                    USE_MAPLIBRE = false;
                    initializeMap();
                }
            }
        }

        // MOTD dismiss handler
        document.getElementById('motd-close-btn').addEventListener('click', function() {
            dismissCurrentMOTD();
        });

        // API Response Cache
        const apiCache = new Map();
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes for general API calls
        const REPRESENTATIVES_CACHE_DURATION = 30 * 60 * 1000; // 30 minutes for representatives (they don't change often)

        // API Helper Functions
        async function apiCall(endpoint, options = {}) {
            // Check cache for GET requests (unless explicitly bypassing cache)
            const isGet = !options.method || options.method === 'GET';
            const bypassCache = options.bypassCache;
            
            if (isGet && !bypassCache) {
                const cacheKey = `${endpoint}${authToken ? `_${authToken.substring(0, 10)}` : ''}`;
                const cached = apiCache.get(cacheKey);
                
                // Use longer cache duration for representatives data
                const cacheDuration = endpoint.includes('representatives') || endpoint.includes('officials') 
                    ? REPRESENTATIVES_CACHE_DURATION 
                    : CACHE_DURATION;
                
                if (cached && (Date.now() - cached.timestamp) < cacheDuration) {
                    console.log(`Using cached API response for ${endpoint} (${Math.round((Date.now() - cached.timestamp) / 1000)}s old)`);
                    return cached.data;
                }
            }
            
            const config = {
                headers: {
                    ...(authToken && { 'Authorization': `Bearer ${authToken}` })
                },
                ...options
            };

            // Only set Content-Type to application/json if body is not FormData
            // FormData should set its own Content-Type with proper boundary
            if (!options.skipContentType && !(config.body instanceof FormData)) {
                config.headers['Content-Type'] = 'application/json';
            }
            
            // Remove custom options before fetch
            delete config.bypassCache;
            delete config.skipContentType;

            try {
                const response = await fetch(`${API_BASE}${endpoint}`, config);
                
                // Create a response object with ok status and parsed data
                const result = {
                    ok: response.ok,
                    status: response.status,
                    data: null
                };

                // Try to parse JSON response
                try {
                    const text = await response.text();
                    if (text) {
                        result.data = JSON.parse(text);
                    }
                } catch (parseError) {
                    console.warn('Failed to parse JSON response:', parseError);
                    result.data = { error: 'Invalid response format' };
                }
                
                // Cache GET responses
                if (isGet && !bypassCache && result.ok) {
                    const cacheKey = `${endpoint}${authToken ? `_${authToken.substring(0, 10)}` : ''}`;
                    apiCache.set(cacheKey, {
                        timestamp: Date.now(),
                        data: result
                    });
                    
                    // Clean old cache entries periodically
                    if (apiCache.size > 100) {
                        const cutoff = Date.now() - Math.max(CACHE_DURATION, REPRESENTATIVES_CACHE_DURATION);
                        for (const [key, value] of apiCache.entries()) {
                            if (value.timestamp < cutoff) {
                                apiCache.delete(key);
                            }
                        }
                    }
                }

                return result;
            } catch (networkError) {
                console.error('Network error:', networkError);
                return {
                    ok: false,
                    status: 0,
                    data: { error: 'Network error. Please check your connection.' }
                };
            }
        }

        // Search functionality
        document.getElementById('searchInput').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const query = this.value.trim();
                if (query) {
                    await performSearch(query);
                }
            }
        });

        async function performSearch(query) {
            try {
                const response = await apiCall(`/users/search?q=${encodeURIComponent(query)}`);
                
                if (response.ok) {
                    // Only use the global search results container, not the feed area
                    displayGlobalSearchResults(response.data.users);
                } else {
                    console.error('Search failed');
                }
            } catch (error) {
                console.error('Search error:', error);
            }
        }

        function displaySearchResults(users, query) {
            const mainContent = document.getElementById('mainContent');
            
            if (users.length === 0) {
                mainContent.innerHTML = `
                    <h1>Search Results</h1>
                    <p>No users found for "${query}"</p>
                `;
                return;
            }

            let html = `
                <h1>Search Results for "${query}"</h1>
                <div style="display: grid; gap: 1rem;">
            `;

            users.forEach(user => {
                const profileType = user.politicalProfileType || 'CITIZEN';
                const typeEmoji = {
                    'CANDIDATE': 'üó≥Ô∏è',
                    'ELECTED_OFFICIAL': 'üèõÔ∏è',
                    'POLITICAL_ORG': 'üè¢',
                    'CITIZEN': 'üë§'
                }[profileType];

                html += `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; background: white;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 0.5rem;">
                            <span style="font-size: 1.5rem;">${typeEmoji}</span>
                            <div>
                                <strong>${user.firstName || ''} ${user.lastName || ''}</strong>
                                ${user.verified ? '<span style="color: #1976d2;">‚úì</span>' : ''}
                                <br>
                                <small style="color: #666;">@${user.username}</small>
                            </div>
                        </div>
                        ${user.bio ? `<p style="margin: 0.5rem 0; color: #555;">${user.bio}</p>` : ''}
                        ${user.office ? `<p style="margin: 0.25rem 0; font-style: italic;">${user.office}</p>` : ''}
                        <div style="margin-top: 0.5rem; font-size: 0.9rem; color: #666;">
                            ${user.followersCount} followers
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            mainContent.innerHTML = html;
        }

        // MOTD Functions
        let currentMOTDData = null;
        let dismissalToken = null;

        async function loadMOTD() {
            try {
                // Get dismissal token for anonymous users
                dismissalToken = localStorage.getItem('motd-dismissal-token') || generateDismissalToken();
                
                const headers = {};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }
                headers['X-Dismissal-Token'] = dismissalToken;

                const response = await fetch(`${API_BASE}/motd/current`, {
                    headers: headers
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data.motd) {
                        currentMOTDData = data.data.motd;
                        dismissalToken = data.data.dismissalToken;
                        
                        // Store dismissal token for future use
                        localStorage.setItem('motd-dismissal-token', dismissalToken);
                        
                        displayMOTD(currentMOTDData);
                    }
                }
            } catch (error) {
                console.error('Failed to load MOTD:', error);
            }
        }

        function generateDismissalToken() {
            return `anon_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        }

        function displayMOTD(motd) {
            const panel = document.getElementById('google-cta-panel');
            const title = document.getElementById('motd-title');
            const body = document.getElementById('motd-body');
            
            if (motd.title) {
                title.textContent = motd.title;
                title.style.display = 'block';
            } else {
                title.style.display = 'none';
            }
            
            body.innerHTML = motd.content;
            panel.style.display = 'block';
        }

        async function dismissCurrentMOTD() {
            if (!currentMOTDData) return;
            
            try {
                const headers = {'X-Dismissal-Token': dismissalToken};
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`${API_BASE}/motd/dismiss/${currentMOTDData.id}`, {
                    method: 'POST',
                    headers: headers
                });

                if (response.ok) {
                    document.getElementById('google-cta-panel').style.display = 'none';
                    currentMOTDData = null;
                }
            } catch (error) {
                console.error('Failed to dismiss MOTD:', error);
                // Still hide the panel on error
                document.getElementById('google-cta-panel').style.display = 'none';
            }
        }

        // Load trending topics for the trending panel (AI-powered)
        async function loadTrendingPosts() {
            try {
                // Try AI topic discovery first, fallback to posts if needed
                let response;
                try {
                    response = await apiCall('/topic-navigation/trending?limit=20');
                    if (response.ok && response.data.topics && response.data.topics.length > 0) {
                        updateTrendingTopicsPanel(response.data.topics);
                        return;
                    }
                } catch (topicError) {
                    console.log('AI topics unavailable for sidebar, falling back to posts:', topicError.message);
                }
                
                // Fallback to post-based trending for sidebar
                response = await apiCall('/feed/trending');
                
                if (response.ok) {
                    updateTrendingPanel(response.data.posts);
                } else {
                    console.error('Failed to load trending content:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load trending content:', error);
            }
        }
        
        // Enhanced function to render AI topics in the sidebar trending panel
        function updateTrendingTopicsPanel(topics) {
            const content = document.getElementById('trendingContent');
            
            if (!content) return;
            
            if (topics.length === 0) {
                content.innerHTML = '<p>No trending topics available.</p>';
                return;
            }
            
            let html = '<div class="trending-topics-list">';
            
            topics.forEach((topic, index) => {
                const isFeature = index === 0;
                const timeAgo = getTimeAgo(new Date(topic.createdAt || Date.now()));
                
                html += `
                    <div class="trending-topic-card" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; cursor: pointer; transition: all 0.2s;" onclick="enterTopicMode('${topic.id}')" onmouseover="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.boxShadow='none'; this.style.transform='none'">
                        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
                            <span style="font-size: 1.2rem;">${isFeature ? 'üî•' : 'üè∑Ô∏è'}</span>
                            <div style="font-weight: bold; font-size: 1rem; flex: 1; color: #333;">${topic.title}</div>
                            ${isFeature ? '<span style="background: #ff6b35; color: white; padding: 0.2rem 0.4rem; border-radius: 6px; font-size: 0.7rem; font-weight: 500;">TRENDING</span>' : ''}
                        </div>
                        
                        <div style="font-size: 0.9rem; color: #555; margin-bottom: 0.75rem; line-height: 1.4;">
                            ${(topic.summary || 'Discussion topic').substring(0, 150)}${topic.summary && topic.summary.length > 150 ? '...' : ''}
                        </div>
                        
                        ${topic.prevailingPosition ? `
                            <div style="background: #f8f9fa; border-left: 3px solid #28a745; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 0.25rem;">üìç PREVAILING POSITION</div>
                                <div style="font-size: 0.85rem; color: #555;">${topic.prevailingPosition.substring(0, 120)}${topic.prevailingPosition.length > 120 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        
                        ${topic.leadingCritique ? `
                            <div style="background: #f8f9fa; border-left: 3px solid #dc3545; padding: 0.5rem; margin-bottom: 0.5rem; border-radius: 0 4px 4px 0;">
                                <div style="font-size: 0.8rem; font-weight: 600; color: #666; margin-bottom: 0.25rem;">‚ö° LEADING CRITIQUE</div>
                                <div style="font-size: 0.85rem; color: #555;">${topic.leadingCritique.substring(0, 120)}${topic.leadingCritique.length > 120 ? '...' : ''}</div>
                            </div>
                        ` : ''}
                        
                        <div style="display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; color: #666; padding-top: 0.5rem; border-top: 1px solid #f0f0f0;">
                            <span>üí¨ ${topic.postCount} posts ‚Ä¢ üë• ${topic.participantCount} people</span>
                            <span>${timeAgo}</span>
                        </div>
                        
                        <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
                            <button onclick="event.stopPropagation(); enterTopicMode('${topic.id}')" style="background: #ff6b35; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;" onmouseover="this.style.background='#e55a2b'" onmouseout="this.style.background='#ff6b35'">
                                üí¨ Enter Discussion
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            content.innerHTML = html;
        }

        // Auto-refresh trending posts
        let trendingRefreshInterval = null;

        function startTrendingRefresh() {
            // Load initial trending updates (but don't spam if backend isn't ready)
            setTimeout(() => loadTrendingUpdates(), 2000);
            
            // Refresh trending every 50 seconds (new posts roll in at top, old ones roll off bottom)
            trendingRefreshInterval = setInterval(() => {
                // Only refresh if trending panel is visible
                if (document.getElementById('trendingUpdates').classList.contains('show')) {
                    loadTrendingUpdates();
                }
            }, 50000);
        }

        function stopTrendingRefresh() {
            if (trendingRefreshInterval) {
                clearInterval(trendingRefreshInterval);
                trendingRefreshInterval = null;
            }
        }

        // Load trending topics for the mini panel under map (AI-powered)
        async function loadTrendingUpdates() {
            try {
                // Check if backend is reachable first
                const healthCheck = await fetch(`${API_BASE.replace('/api', '')}/health`);
                if (!healthCheck.ok) {
                    console.log('Backend not available, skipping trending updates');
                    return;
                }

                // Get user's current geographic scope
                const scope = getCurrentGeographicScope(); // 'national', 'state', or 'local'

                // Try AI topic aggregation with dual-vector clustering
                let response;
                try {
                    response = await apiCall(`/trending/topics?scope=${scope}&limit=7`);
                    if (response.ok && response.data.topics && response.data.topics.length > 0) {
                        updateTrendingTopicsPanel(response.data.topics);
                        
                        // Show the panel when there's content
                        const panel = document.getElementById('trendingUpdates');
                        panel.classList.add('show');
                        return;
                    }
                } catch (topicError) {
                    console.log('AI topics unavailable, falling back to posts:', topicError.message);
                }
                
                // Fallback to post-based trending if AI aggregation fails
                response = await apiCall('/feed/trending?limit=20');
                
                if (response.ok) {
                    updateTrendingUpdatesPanel(response.data.posts);
                    
                    // Show the panel when there's content
                    const panel = document.getElementById('trendingUpdates');
                    if (response.data.posts.length > 0) {
                        panel.classList.add('show');
                    }
                } else {
                    console.log('No trending content available yet');
                }
            } catch (error) {
                console.log('Trending updates not available:', error.message);
                // Silently fail - don't spam console with errors
            }
        }

        let allTrendingPosts = [];
        let allTrendingTopics = [];
        let trendingExpanded = false;
        let displayMode = 'topics'; // 'topics' or 'posts'
        let currentTopicMode = null; // Track if user is in topic-filtered mode

        // Helper function to get current geographic scope
        function getCurrentGeographicScope() {
            // Check if user has a preferred scope setting or use national as default
            return localStorage.getItem('geographicScope') || 'national';
        }

        // Topic mode functions
        async function enterTopicMode(topicId) {
            try {
                const topic = allTrendingTopics.find(t => t.id === topicId);
                if (!topic) {
                    console.error('Topic not found:', topicId);
                    return;
                }

                // Fetch posts for this topic
                const response = await apiCall(`/trending/topics/${topicId}/posts?limit=20&stance=all`);
                
                if (response.ok) {
                    currentTopicMode = {
                        topicId,
                        topic: response.data.topic,
                        posts: response.data.posts
                    };

                    // Update My Feed to show topic-filtered posts
                    displayTopicFilteredFeed(response.data.topic, response.data.posts);
                    
                    // Update trending panel to show topic mode indicator
                    updateTrendingWithTopicMode();
                    
                    // Show topic mode header in My Feed
                    showTopicModeHeader(response.data.topic);

                } else {
                    console.error('Failed to fetch topic posts');
                }
            } catch (error) {
                console.error('Error entering topic mode:', error);
            }
        }
        
        // Make globally accessible for map bubbles
        window.enterTopicMode = enterTopicMode;
        window.exitTopicMode = exitTopicMode;

        function exitTopicMode() {
            currentTopicMode = null;
            
            // Clear topic mode header
            const header = document.getElementById('topicModeHeader');
            if (header) {
                header.remove();
            }
            
            // Reload normal My Feed
            loadMyFeed();
            
            // Refresh trending panel
            loadTrendingUpdates();
        }

        function showTopicModeHeader(topic) {
            // Remove any existing topic header
            const existingHeader = document.getElementById('topicModeHeader');
            if (existingHeader) {
                existingHeader.remove();
            }

            // Create new topic mode header
            const feedContainer = document.getElementById('myFeedPosts') || document.getElementById('mainContent');
            if (feedContainer) {
                const header = document.createElement('div');
                header.id = 'topicModeHeader';
                header.innerHTML = `
                    <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üìç</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">Viewing: ${topic.title}</h3>
                            </div>
                            <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">‚úï Exit Topic Mode</button>
                        </div>
                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
                            <div style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px;">
                                <strong>For (${topic.supportPercentage}%):</strong> ${topic.supportSummary}
                            </div>
                            <div style="flex: 1; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px;">
                                <strong>Against (${topic.opposePercentage}%):</strong> ${topic.opposeSummary}
                            </div>
                        </div>
                    </div>
                `;
                feedContainer.insertBefore(header, feedContainer.firstChild);
            }
        }

        function displayTopicFilteredFeed(topic, posts) {
            const feedContainer = document.getElementById('myFeedPosts') || document.getElementById('mainContent');
            if (!feedContainer) return;

            // Clear existing posts (except the topic header)
            const existingPosts = feedContainer.querySelectorAll('.post-container, .feed-post');
            existingPosts.forEach(post => post.remove());

            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const postElement = createPostElement(post);
                    
                    // Add stance indicator
                    if (post.stance) {
                        const stanceIndicator = document.createElement('div');
                        stanceIndicator.style.cssText = `
                            position: absolute; 
                            top: 10px; 
                            right: 10px; 
                            padding: 0.2rem 0.5rem; 
                            border-radius: 4px; 
                            font-size: 0.7rem; 
                            font-weight: bold;
                            ${post.stance === 'support' ? 'background: rgba(40, 167, 69, 0.1); color: #28a745; border: 1px solid #28a745;' : 
                              post.stance === 'oppose' ? 'background: rgba(220, 53, 69, 0.1); color: #dc3545; border: 1px solid #dc3545;' : 
                              'background: rgba(108, 117, 125, 0.1); color: #6c757d; border: 1px solid #6c757d;'}
                        `;
                        stanceIndicator.textContent = post.stance === 'support' ? 'Supporting' : 
                                                    post.stance === 'oppose' ? 'Opposing' : 'Neutral';
                        
                        postElement.style.position = 'relative';
                        postElement.appendChild(stanceIndicator);
                    }
                    
                    feedContainer.appendChild(postElement);
                });
            } else {
                const noPostsMessage = document.createElement('div');
                noPostsMessage.style.cssText = 'text-align: center; color: #666; padding: 2rem; background: white; border-radius: 8px; margin: 1rem 0;';
                noPostsMessage.innerHTML = `
                    <h3>No posts found for this topic</h3>
                    <p>Be the first to share your thoughts on "${topic.title}"!</p>
                    <button onclick="exitTopicMode()" style="background: #ff6b35; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">View All Posts</button>
                `;
                feedContainer.appendChild(noPostsMessage);
            }
        }

        // Enhanced function to display AI-aggregated topics with dual-vector stance info
        function updateTrendingTopicsPanel(topics) {
            allTrendingTopics = topics;
            displayMode = 'topics';
            const body = document.getElementById('trendingUpdatesBody');
            
            if (topics.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayTopics = trendingExpanded ? topics : topics.slice(0, 5);
            let html = '';
            
            displayTopics.forEach((topic, index) => {
                const isFeature = index === 0;
                
                // Create percentage bar visualization
                const supportPct = topic.support?.percentage || 50;
                const opposePct = topic.oppose?.percentage || 50;
                
                html += `
                    <div class="trending-item topic-item" onclick="enterTopicMode('${topic.id}')" style="cursor: pointer; padding: 0.8rem; border-bottom: 1px solid #eee; transition: background 0.2s;">
                        <div class="topic-header" style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 6px;">
                            <span style="font-size: 1.1rem;">${isFeature ? 'üî•' : 'üí≠'}</span>
                            <div style="font-weight: bold; font-size: 0.9rem; flex: 1; color: #333;">${topic.title}</div>
                            ${isFeature ? '<span style="background: #ff6b35; color: white; padding: 0.15rem 0.35rem; border-radius: 6px; font-size: 0.65rem; font-weight: bold;">HOT</span>' : ''}
                        </div>
                        
                        <!-- Sentiment Bar -->
                        <div style="margin: 8px 0;">
                            <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                <div style="flex: 1; height: 6px; background: #e0e0e0; border-radius: 3px; overflow: hidden; position: relative;">
                                    <div style="position: absolute; left: 0; top: 0; height: 100%; background: #28a745; width: ${supportPct}%; transition: width 0.3s;"></div>
                                </div>
                                <span style="font-size: 0.75rem; color: #666; min-width: 60px;">${supportPct}% | ${opposePct}%</span>
                            </div>
                        </div>
                        
                        <!-- Stance Summaries -->
                        ${topic.support?.summary ? `
                            <div style="margin: 6px 0; padding: 6px 8px; background: rgba(40, 167, 69, 0.08); border-radius: 4px; border-left: 2px solid #28a745;">
                                <div style="font-size: 0.75rem; color: #155724;">
                                    <strong>For:</strong> ${topic.support.summary.substring(0, 80)}${topic.support.summary.length > 80 ? '...' : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${topic.oppose?.summary ? `
                            <div style="margin: 6px 0; padding: 6px 8px; background: rgba(220, 53, 69, 0.08); border-radius: 4px; border-left: 2px solid #dc3545;">
                                <div style="font-size: 0.75rem; color: #721c24;">
                                    <strong>Against:</strong> ${topic.oppose.summary.substring(0, 80)}${topic.oppose.summary.length > 80 ? '...' : ''}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Metadata -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 6px;">
                            <span style="font-size: 0.7rem; color: #888;">
                                üí¨ ${topic.totalPosts || (topic.support?.postCount + topic.oppose?.postCount) || 0} posts
                                ${topic.geographicScope ? ` ‚Ä¢ üìç ${topic.geographicScope}` : ''}
                            </span>
                            ${topic.state || topic.city ? `
                                <span style="font-size: 0.65rem; color: #666; background: #f0f0f0; padding: 2px 6px; border-radius: 3px;">
                                    ${topic.city || topic.state}
                                </span>
                            ` : ''}
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
            
            // Add hover effect
            body.querySelectorAll('.topic-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.background = '#f8f9fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.background = '';
                });
            });
        }

        function updateTrendingUpdatesPanel(posts) {
            allTrendingPosts = posts;
            displayMode = 'posts';
            const body = document.getElementById('trendingUpdatesBody');
            
            if (posts.length === 0) {
                body.innerHTML = '<div style="text-align: center; padding: 1rem; color: #666; font-size: 0.8rem;">No trending topics</div>';
                return;
            }

            const displayPosts = trendingExpanded ? posts : posts.slice(0, 5);
            let html = '';
            
            displayPosts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                const preview = post.content.length > 80 ? post.content.substring(0, 80) + '...' : post.content;
                
                html += `
                    <div class="trending-item">
                        <div style="font-weight: bold; margin-bottom: 2px; font-size: 0.85rem;">@${post.author.username}</div>
                        <div style="margin-bottom: 4px;">${preview}</div>
                        <div style="color: #666; font-size: 0.75rem; margin-bottom: 4px;">
                            <span style="cursor: pointer; margin-right: 8px;" onclick="likeTrendingPost('${post.id}')">‚ù§Ô∏è ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 8px;" onclick="showTrendingCommentBox('${post.id}')">üí¨ Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; margin-right: 8px; color: #4b5c09;" onclick="viewComments('${post.id}')">üëÅÔ∏è ${post.commentsCount}</span>` : ''}
                            <span>${timeAgo}</span>
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 50px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical; font-size: 0.8rem;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem; font-size: 0.8rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            body.innerHTML = html;
        }

        function toggleTrendingExpansion() {
            const panel = document.getElementById('trendingUpdates');
            const btn = document.getElementById('trendingExpandBtn');
            
            trendingExpanded = !trendingExpanded;
            
            if (trendingExpanded) {
                panel.classList.add('expanded');
                btn.textContent = 'Less';
            } else {
                panel.classList.remove('expanded');
                btn.textContent = 'More';
            }
            
            updateTrendingUpdatesPanel(allTrendingPosts);
        }

        function toggleTrendingPanel() {
            const panel = document.getElementById('trendingUpdates');
            if (panel.classList.contains('show')) {
                panel.classList.remove('show');
            } else {
                loadTrendingUpdates(); // Load fresh data
                panel.classList.add('show');
            }
        }
        window.toggleTrendingPanel = toggleTrendingPanel; // Make globally accessible
        
        // NEW: Topic Mode Functions for My Feed Integration
        async function enterTopicMode(topicId) {
            try {
                console.log(`Entering topic mode: ${topicId}`);
                
                // Store previous feed state if not already in topic mode
                if (!currentTopicMode) {
                    // Cache current My Feed state
                    const currentFeed = document.getElementById('feedContent');
                    if (currentFeed) {
                        window.cachedFeedState = currentFeed.innerHTML;
                    }
                }
                
                const response = await apiCall(`/topic-navigation/enter/${topicId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ limit: 30 })
                });
                
                if (response.ok && response.data.success) {
                    currentTopicMode = {
                        topicId: topicId,
                        topic: response.data.topic,
                        posts: response.data.posts
                    };
                    
                    // Update My Feed with topic-filtered content
                    updateMyFeedWithTopic(response.data.topic, response.data.posts);
                    
                    // Update trending panel to show exit option
                    updateTrendingWithTopicMode();
                    
                    console.log(`‚úÖ Entered topic: ${response.data.topic.title}`);
                } else {
                    console.error('Failed to enter topic mode:', response.data?.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error entering topic mode:', error);
            }
        }
        
        async function exitTopicMode() {
            try {
                console.log('Exiting topic mode...');
                
                const response = await apiCall('/topic-navigation/exit', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                if (response.ok && response.data.success) {
                    currentTopicMode = null;
                    
                    // Restore cached feed or load fresh algorithm feed
                    if (window.cachedFeedState) {
                        const feedContent = document.getElementById('feedContent');
                        if (feedContent) {
                            feedContent.innerHTML = window.cachedFeedState;
                        }
                        delete window.cachedFeedState;
                    } else {
                        // Load fresh algorithm feed
                        if (typeof loadMyFeed === 'function') {
                            loadMyFeed();
                        }
                    }
                    
                    // Reset trending panel to normal state
                    loadTrendingUpdates();
                    
                    console.log('‚úÖ Returned to main algorithm feed');
                } else {
                    console.error('Failed to exit topic mode:', response.data?.error || 'Unknown error');
                }
            } catch (error) {
                console.error('Error exiting topic mode:', error);
                // Force reset on error
                currentTopicMode = null;
                if (typeof loadMyFeed === 'function') {
                    loadMyFeed();
                }
                loadTrendingUpdates();
            }
        }
        
        function updateMyFeedWithTopic(topic, posts) {
            const feedContent = document.getElementById('feedContent');
            if (!feedContent) return;
            
            let html = `
                <div class="topic-mode-indicator">
                    <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                            <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.2rem;">üè∑Ô∏è</span>
                                <h3 style="margin: 0; font-size: 1.1rem;">${topic.title}</h3>
                            </div>
                            <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem;">‚Üê Exit Topic</button>
                        </div>
                        <div style="font-size: 0.9rem; opacity: 0.9;">${topic.summary}</div>
                        ${topic.prevailingPosition ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; border-left: 3px solid rgba(255,255,255,0.5);">
                                <strong>üìç Main Position:</strong> ${topic.prevailingPosition}
                            </div>
                        ` : ''}
                        ${topic.leadingCritique ? `
                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.15); border-radius: 4px; border-left: 3px solid rgba(255,255,255,0.5);">
                                <strong>‚ö° Leading Critique:</strong> ${topic.leadingCritique}
                            </div>
                        ` : ''}
                    </div>
                </div>
                <div class="topic-posts-feed">
            `;
            
            if (posts && posts.length > 0) {
                posts.forEach(post => {
                    const timeAgo = getTimeAgo(new Date(post.createdAt));
                    html += `
                        <div class="post-item" style="background: white; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                <div style="width: 32px; height: 32px; border-radius: 50%; background: #ff6b35; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">
                                    ${post.author.username.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div style="font-weight: 600; font-size: 0.9rem;">@${post.author.username}</div>
                                    <div style="color: #666; font-size: 0.8rem;">${timeAgo}</div>
                                </div>
                            </div>
                            <div style="margin-bottom: 0.75rem; line-height: 1.4;">${post.content}</div>
                            <div style="display: flex; gap: 1rem; padding-top: 0.5rem; border-top: 1px solid #f0f0f0; font-size: 0.85rem; color: #666;">
                                <span style="cursor: pointer;" onclick="likePost('${post.id}')">‚ù§Ô∏è ${post.likesCount || 0}</span>
                                <span style="cursor: pointer;">üí¨ ${post.commentsCount || 0}</span>
                                <span style="cursor: pointer;">üîÑ Share</span>
                            </div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="text-align: center; color: #666; padding: 2rem;">No posts found for this topic.</div>';
            }
            
            html += '</div>';
            feedContent.innerHTML = html;
        }
        
        function updateTrendingWithTopicMode() {
            const body = document.getElementById('trendingUpdatesBody');
            if (!body || !currentTopicMode) return;
            
            const topic = currentTopicMode.topic;
            
            body.innerHTML = `
                <div style="background: linear-gradient(135deg, #ff6b35, #f7931e); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 0.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: bold; font-size: 0.85rem;">üè∑Ô∏è TOPIC MODE</span>
                        <button onclick="exitTopicMode()" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.5); color: white; padding: 0.25rem 0.5rem; border-radius: 4px; cursor: pointer; font-size: 0.75rem;">Exit</button>
                    </div>
                    <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 0.25rem;">${topic.title}</div>
                    <div style="font-size: 0.8rem; opacity: 0.9;">${topic.postCount} posts ‚Ä¢ ${topic.participantCount} participants</div>
                </div>
                <div style="text-align: center; padding: 0.5rem; color: #666; font-size: 0.8rem;">
                    My Feed is now filtered by this topic.<br>
                    <a href="#" onclick="loadTrendingUpdates(); return false;" style="color: #ff6b35; text-decoration: none;">View other trending topics</a>
                </div>
            `;
        }
        
        // Map Integration Functions - Sync AI Topics with Map Bubbles
        let mapTopicCache = [];
        let lastMapTopicUpdate = 0;
        let lastMapTopicScope = 'national';
        const MAP_TOPIC_CACHE_DURATION = 45000; // 45 seconds (3 topics x 15 seconds each)
        
        // Fetch and cycle AI topics for map display
        async function updateMapTopics() {
            try {
                const now = Date.now();
                
                // Check if we need to refresh the cache or if scope changed
                const currentScope = currentZoomLevel || 'national';
                if (now - lastMapTopicUpdate > MAP_TOPIC_CACHE_DURATION || mapTopicCache.length === 0 || lastMapTopicScope !== currentScope) {
                    const response = await apiCall(`/trending/map-topics?count=9&scope=${currentScope}`); // Get 9 topics for current scope
                    
                    if (response.ok && response.data.topics) {
                        mapTopicCache = response.data.topics;
                        lastMapTopicUpdate = now;
                        lastMapTopicScope = currentScope;
                        console.log(`Updated map topic cache with ${mapTopicCache.length} topics for ${currentScope} scope`);
                    }
                }
                
                // Get current set of 3 topics to display (rotating every 15 seconds)
                return getCurrentMapTopics();
                
            } catch (error) {
                console.error('Error updating map topics:', error);
                return [];
            }
        }
        
        // Get the current 3 topics to display on map (cycles every 15 seconds)
        function getCurrentMapTopics() {
            if (mapTopicCache.length === 0) return [];
            
            // Calculate which slice of 3 topics to show based on time
            const cycleIndex = Math.floor(Date.now() / 15000) % Math.max(1, Math.ceil(mapTopicCache.length / 3));
            const startIndex = cycleIndex * 3;
            const endIndex = Math.min(startIndex + 3, mapTopicCache.length);
            
            return mapTopicCache.slice(startIndex, endIndex);
        }
        
        // Convert AI topics to map bubble format with geographic distribution
        function convertTopicsToMapBubbles(aiTopics) {
            if (!aiTopics || aiTopics.length === 0) return [];
            
            // Predefined coordinates for major US cities - AI topics get distributed across these
            const cityCoords = [
                { coords: [40.7128, -74.0060], city: 'NYC', weight: 1.0 },
                { coords: [34.0522, -118.2437], city: 'Los Angeles', weight: 0.9 },
                { coords: [41.8781, -87.6298], city: 'Chicago', weight: 0.8 },
                { coords: [29.7604, -95.3698], city: 'Houston', weight: 0.7 },
                { coords: [47.6062, -122.3321], city: 'Seattle', weight: 0.6 },
                { coords: [39.7392, -104.9903], city: 'Denver', weight: 0.5 },
                { coords: [33.4484, -112.0740], city: 'Phoenix', weight: 0.5 },
                { coords: [25.7617, -80.1918], city: 'Miami', weight: 0.4 },
                { coords: [32.7767, -96.7970], city: 'Dallas', weight: 0.4 },
                { coords: [42.3601, -71.0589], city: 'Boston', weight: 0.4 },
                { coords: [38.9072, -77.0369], city: 'Washington DC' },
                { coords: [37.7749, -122.4194], city: 'San Francisco' },
                { coords: [39.9526, -75.1652], city: 'Philadelphia' },
                { coords: [30.2672, -97.7431], city: 'Austin' },
                { coords: [39.7391, -104.9903], city: 'Colorado Springs' }
            ];
            
            const mapBubbles = [];
            let coordIndex = 0;
            
            aiTopics.forEach((topic, index) => {
                const coord = cityCoords[coordIndex % cityCoords.length];
                coordIndex++;
                
                // Create bubble text from new topic data structure
                let bubbleText = `üí≠ ${topic.title}`;
                
                // Add stance percentages
                if (topic.supportPercentage && topic.opposePercentage) {
                    bubbleText += ` (${topic.supportPercentage}% vs ${topic.opposePercentage}%)`;
                }
                
                // Add geographic scope indicator
                if (topic.geographicScope) {
                    const scopeIcon = topic.geographicScope === 'local' ? 'üèòÔ∏è' : 
                                    topic.geographicScope === 'state' ? 'üèõÔ∏è' : 'üåé';
                    bubbleText += ` ${scopeIcon}`;
                }
                
                mapBubbles.push({
                    coords: coord.coords,
                    text: bubbleText,
                    city: coord.city,
                    topicId: topic.id,
                    priority: index < 3 ? 'high' : 'normal', // Top 3 get higher priority
                    aiTopic: true, // Flag to distinguish from static topics
                    supportPercentage: topic.supportPercentage,
                    opposePercentage: topic.opposePercentage,
                    geographicScope: topic.geographicScope
                });
            });
            
            return mapBubbles;
        }
        
        // Enhanced function to update map with AI topics
        async function updateMapWithTrendingTopics() {
            try {
                // Check if we need to refresh the topic cache
                const now = Date.now();
                if (mapTopicCache.length > 0 && (now - lastMapTopicUpdate) < MAP_TOPIC_CACHE_DURATION) {
                    console.log('Using cached map topics');
                    return mapTopicCache;
                }
                
                // Fetch latest AI topics using new aggregation API
                const response = await apiCall('/trending/map-topics?count=12');
                if (response.ok && response.data.topics && response.data.topics.length > 0) {
                    const aiTopics = response.data.topics;
                    const mapBubbles = convertTopicsToMapBubbles(aiTopics);
                    
                    // Update cache
                    mapTopicCache = mapBubbles;
                    lastMapTopicUpdate = now;
                    
                    // Update the map if available
                    if (window.updateMapTopics && typeof window.updateMapTopics === 'function') {
                        console.log('Updating map with AI-generated topics...');
                        window.updateMapTopics(mapBubbles);
                    } else if (window.map && window.map.updateTopics) {
                        console.log('Updating map topics via map.updateTopics...');
                        window.map.updateTopics(mapBubbles);
                    } else {
                        console.log('Map topic update method not available, topics cached for next map init');
                    }
                    
                    return mapBubbles;
                } else {
                    console.log('AI topics unavailable for map, using fallback');
                    return getFallbackMapTopics();
                }
            } catch (error) {
                console.error('Failed to update map with trending topics:', error);
                return getFallbackMapTopics();
            }
        }
        
        // Fallback to static topics if AI topics are unavailable
        function getFallbackMapTopics() {
            return [
                { coords: [40.7128, -74.0060], text: 'üèõÔ∏è NYC discussing local election reforms', city: 'NYC', priority: 'normal' },
                { coords: [34.0522, -118.2437], text: 'üöó California EV subsidy debates heating up', city: 'Los Angeles', priority: 'normal' },
                { coords: [41.8781, -87.6298], text: '‚öñÔ∏è Chicago criminal justice reform discussions', city: 'Chicago', priority: 'normal' },
                { coords: [29.7604, -95.3698], text: 'üó≥Ô∏è Texas open primary initiatives gaining support', city: 'Houston', priority: 'normal' },
                { coords: [47.6062, -122.3321], text: 'üå≥ Seattle green zoning community organizing', city: 'Seattle', priority: 'normal' },
                { coords: [39.7392, -104.9903], text: 'üè° Denver housing-first policy debates', city: 'Denver', priority: 'normal' }
            ];
        }
        
        // Integration with trending system - call this when topics are loaded
        function syncMapWithTrendingTopics() {
            updateMapWithTrendingTopics();
        }
        
        // Enhanced loadTrendingUpdates to sync with map
        const originalLoadTrendingUpdates = loadTrendingUpdates;
        loadTrendingUpdates = async function() {
            await originalLoadTrendingUpdates();
            
            // After loading trending topics, sync with map
            setTimeout(() => {
                syncMapWithTrendingTopics();
            }, 500); // Small delay to ensure trending updates are complete
        };
        
        // NEW: Geographic Layering System with Balanced Timing
        let geographicTopicTimer = null;
        let lastGeographicTopicTime = 0;
        const GEOGRAPHIC_TOPIC_INTERVAL = 50000; // 50 seconds (45-60 range)
        
        // Enhanced geographic distribution based on zoom level and user location
        function getGeographicLayeredTopics(aiTopics, zoomLevel = 'national') {
            if (!aiTopics || aiTopics.length === 0) return [];
            
            const userState = currentUser?.state || null;
            const userCity = currentUser?.city || null;
            
            const layeredTopics = [];
            let topicIndex = 0;
            
            // Determine topic distribution based on zoom level
            switch (zoomLevel) {
                case 'national':
                    // National view: Primarily national topics, with periodic state/local injection
                    const nationalTopics = aiTopics.filter((_, index) => index < 10); // Top 10 as national
                    
                    // Every 45-60 seconds, inject state/local topics
                    const now = Date.now();
                    const shouldInjectLocal = (now - lastGeographicTopicTime) > GEOGRAPHIC_TOPIC_INTERVAL;
                    
                    if (shouldInjectLocal && aiTopics.length > 10) {
                        // Inject 2-3 topics as "state/local" with user's geographic context
                        const localTopics = aiTopics.slice(10, 13).map((topic, index) => ({
                            ...topic,
                            geographicContext: userState ? `${userState} Local` : 'Regional',
                            localPriority: true
                        }));
                        
                        layeredTopics.push(...localTopics);
                        lastGeographicTopicTime = now;
                        console.log('Injected local topics for national view');
                    }
                    
                    layeredTopics.push(...nationalTopics.map(topic => ({
                        ...topic,
                        geographicContext: 'National'
                    })));
                    break;
                    
                case 'state':
                    // State view: Mix of state-specific and national topics
                    layeredTopics.push(...aiTopics.map(topic => ({
                        ...topic,
                        geographicContext: userState || 'State'
                    })));
                    break;
                    
                case 'local':
                    // Local view: Focus on local and regional topics
                    layeredTopics.push(...aiTopics.map(topic => ({
                        ...topic,
                        geographicContext: userCity ? `${userCity}, ${userState}` : 'Local'
                    })));
                    break;
            }
            
            return layeredTopics;
        }
        
        // Enhanced convertTopicsToMapBubbles with geographic layering
        const originalConvertTopicsToMapBubbles = convertTopicsToMapBubbles;
        convertTopicsToMapBubbles = function(aiTopics, zoomLevel = null) {
            const effectiveZoomLevel = zoomLevel || currentZoomLevel || 'national';
            const layeredTopics = getGeographicLayeredTopics(aiTopics, effectiveZoomLevel);
            
            if (!layeredTopics || layeredTopics.length === 0) return [];
            
            // Get appropriate coordinates based on zoom level
            const coordSets = getCoordinatesByZoomLevel(effectiveZoomLevel);
            const mapBubbles = [];
            let coordIndex = 0;
            
            layeredTopics.forEach((topic, index) => {
                const coord = coordSets[coordIndex % coordSets.length];
                coordIndex++;
                
                // Enhanced bubble text with geographic context
                let bubbleText = `${topic.localPriority ? 'üìç' : 'üè∑Ô∏è'} ${topic.title}`;
                
                // Add geographic context indicator
                if (topic.geographicContext && topic.geographicContext !== 'National') {
                    bubbleText += ` [${topic.geographicContext}]`;
                }
                
                // Add brief description if available
                if (topic.summary && topic.summary.length > 0) {
                    const shortSummary = topic.summary.length > 60 
                        ? topic.summary.substring(0, 60) + '...' 
                        : topic.summary;
                    bubbleText += ` - ${shortSummary}`;
                }
                
                // Add engagement indicator for top topics or local priority
                if (index < 3 || topic.localPriority) {
                    bubbleText += ` (${topic.postCount} posts${topic.localPriority ? ', local interest' : ''})`;
                }
                
                mapBubbles.push({
                    coords: coord.coords,
                    text: bubbleText,
                    city: coord.city,
                    topicId: topic.id,
                    priority: topic.localPriority ? 'local' : (index < 3 ? 'high' : 'normal'),
                    geographicContext: topic.geographicContext,
                    aiTopic: true
                });
            });
            
            return mapBubbles;
        };
        
        // Get appropriate coordinate sets based on zoom level
        function getCoordinatesByZoomLevel(zoomLevel) {
            const nationalCoords = [
                { coords: [40.7128, -74.0060], city: 'NYC' },
                { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                { coords: [41.8781, -87.6298], city: 'Chicago' },
                { coords: [29.7604, -95.3698], city: 'Houston' },
                { coords: [47.6062, -122.3321], city: 'Seattle' },
                { coords: [39.7392, -104.9903], city: 'Denver' },
                { coords: [33.4484, -112.0740], city: 'Phoenix' },
                { coords: [25.7617, -80.1918], city: 'Miami' },
                { coords: [32.7767, -96.7970], city: 'Dallas' },
                { coords: [42.3601, -71.0589], city: 'Boston' },
                { coords: [38.9072, -77.0369], city: 'Washington DC' },
                { coords: [37.7749, -122.4194], city: 'San Francisco' }
            ];
            
            const stateCoords = getUserStateCoordinates();
            const localCoords = getUserLocalCoordinates();
            
            switch (zoomLevel) {
                case 'state':
                    return stateCoords.length > 0 ? stateCoords : nationalCoords.slice(0, 8);
                case 'local':
                    return localCoords.length > 0 ? localCoords : nationalCoords.slice(0, 6);
                case 'national':
                default:
                    return nationalCoords;
            }
        }
        
        // Get coordinates relevant to user's state
        function getUserStateCoordinates() {
            if (!currentUser?.state) return [];
            
            // Major cities by state (sample)
            const stateCityMap = {
                'CA': [
                    { coords: [34.0522, -118.2437], city: 'Los Angeles' },
                    { coords: [37.7749, -122.4194], city: 'San Francisco' },
                    { coords: [32.7157, -117.1611], city: 'San Diego' }
                ],
                'TX': [
                    { coords: [29.7604, -95.3698], city: 'Houston' },
                    { coords: [32.7767, -96.7970], city: 'Dallas' },
                    { coords: [30.2672, -97.7431], city: 'Austin' }
                ],
                'NY': [
                    { coords: [40.7128, -74.0060], city: 'NYC' },
                    { coords: [42.3584, -75.3890], city: 'Albany' },
                    { coords: [43.0481, -76.1474], city: 'Syracuse' }
                ],
                'FL': [
                    { coords: [25.7617, -80.1918], city: 'Miami' },
                    { coords: [28.5383, -81.3792], city: 'Orlando' },
                    { coords: [30.4383, -84.2807], city: 'Tallahassee' }
                ]
            };
            
            return stateCityMap[currentUser.state] || [];
        }
        
        // Get coordinates relevant to user's local area
        function getUserLocalCoordinates() {
            if (!currentUser?.city || !currentUser?.state) return [];
            
            // For local view, create coordinates around user's area
            // This would ideally use real local coordinates
            const userLat = parseFloat(currentUser.latitude) || 39.8283;
            const userLng = parseFloat(currentUser.longitude) || -98.5795;
            
            // Generate nearby coordinates (simplified approach)
            const localCoords = [];
            for (let i = 0; i < 6; i++) {
                const offsetLat = (Math.random() - 0.5) * 0.5; // ~25 mile radius
                const offsetLng = (Math.random() - 0.5) * 0.5;
                
                localCoords.push({
                    coords: [userLat + offsetLat, userLng + offsetLng],
                    city: `${currentUser.city} Area ${i + 1}`
                });
            }
            
            return localCoords;
        }
        
        // Start geographic topic balancing timer
        function startGeographicTopicBalancing() {
            if (geographicTopicTimer) {
                clearInterval(geographicTopicTimer);
            }
            
            geographicTopicTimer = setInterval(() => {
                // Only inject local topics when viewing national level
                if (currentZoomLevel === 'national') {
                    console.log('Geographic topic balancing - refreshing for local injection');
                    syncMapWithTrendingTopics();
                }
            }, GEOGRAPHIC_TOPIC_INTERVAL);
        }
        
        // Initialize geographic balancing on page load
        document.addEventListener('DOMContentLoaded', () => {
            startGeographicTopicBalancing();
        });

        function openFullTrending() {
            // This function kept for compatibility but now just expands in place
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function viewTrendingPost(postId) {
            // For now, just expand the trending if not already expanded
            if (!trendingExpanded) {
                toggleTrendingExpansion();
            }
        }

        function updateTrendingPanel(posts) {
            const content = document.getElementById('trendingContent');
            
            if (posts.length === 0) {
                content.innerHTML = '<p>No trending posts available.</p>';
                return;
            }

            let html = '<div>';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                html += `
                    <div data-post-id="${post.id}" style="margin-bottom: 1rem; padding: 0.75rem; border-left: 3px solid #4b5c09; background: #f9f9f9; border-radius: 4px; transition: all 0.3s ease;">
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.25rem;">
                            @${post.author.username} ‚Ä¢ ${timeAgo}
                        </div>
                        <div style="margin-bottom: 0.5rem;">${post.content}</div>
                        <div style="font-size: 0.8rem; color: #888;">
                            <span style="cursor: pointer; margin-right: 10px;" onclick="likeTrendingPost('${post.id}')">‚ù§Ô∏è ${post.likesCount}</span>
                            <span style="cursor: pointer; margin-right: 10px;" onclick="showTrendingCommentBox('${post.id}')">üí¨ Add</span>
                            ${post.commentsCount > 0 ? `<span style="cursor: pointer; color: #4b5c09;" onclick="viewComments('${post.id}')">üëÅÔ∏è View ${post.commentsCount}</span>` : ''}
                        </div>
                        <div id="trending-comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="trending-comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addTrendingComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideTrendingCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            content.innerHTML = html;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
            const diffDays = Math.floor(diffHours / 24);

            if (diffDays > 0) return `${diffDays}d ago`;
            if (diffHours > 0) return `${diffHours}h ago`;
            return 'Just now';
        }

        // Override existing togglePanel to load live data
        const originalTogglePanel = window.togglePanel;
        window.togglePanel = function(name) {
            const panel = document.getElementById(`panel-${name}`);
            const wasHidden = panel.classList.contains('hidden');
            
            originalTogglePanel(name);
            
            // Load live data when panels are opened (not when closed)
            if (wasHidden) {
                if (name === 'trending') {
                    loadTrendingPosts();
                } else if (name === 'officials' && currentUser) {
                    loadUserContent();
                }
            }
        };

        // Messages Functions
        function toggleMessages() {
            const container = document.getElementById('messagesContainer');
            if (container.style.display === 'none' || !container.style.display) {
                container.style.display = 'block';
                loadConversations();
            } else {
                container.style.display = 'none';
                // Show default view when messages are closed
                showDefaultView();
            }
        }

        async function loadConversations() {
            if (!authToken) return;

            try {
                const response = await apiCall('/messages/conversations');
                
                if (response.ok) {
                    displayConversations(response.data.conversations);
                } else {
                    document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Failed to load conversations</p>';
                }
            } catch (error) {
                console.error('Failed to load conversations:', error);
                document.getElementById('messagesBody').innerHTML = '<p style="text-align: center; padding: 1rem; color: #666;">Error loading conversations</p>';
            }
        }

        async function displayConversations(conversations) {
            const body = document.getElementById('messagesBody');
            
            if (!authToken) {
                body.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view messages</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="showNewConversationForm()" style="width: 100%; padding: 0.5vh; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-bottom: 0.5vh;">
                        + New Conversation
                    </button>
                    <button onclick="showFriendsList()" style="width: 100%; padding: 0.5vh; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                        üë• Message Friends
                    </button>
                </div>
            `;
            
            if (conversations.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>No conversations yet</p>
                        <p style="font-size: 0.9rem;">Start your first conversation with a friend!</p>
                    </div>
                `;
            } else {
                conversations.forEach(conv => {
                    const participant = conv.participants[0];
                    const timeAgo = conv.lastMessageAt ? getTimeAgo(new Date(conv.lastMessageAt)) : '';
                    
                    html += `
                        <div class="conversation-item" onclick="openConversation('${conv.id}', '${participant.username}')">
                            <div class="user-avatar">${(participant.firstName?.[0] || participant.username[0]).toUpperCase()}</div>
                            <div class="conversation-info">
                                <div class="conversation-name">${participant.firstName || participant.username}</div>
                                <div class="conversation-preview">${conv.lastMessageContent || 'No messages yet'} ${timeAgo ? '‚Ä¢ ' + timeAgo : ''}</div>
                            </div>
                        </div>
                    `;
                });
            }

            body.innerHTML = html;
        }

        function showNewConversationForm() {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">‚Üê</button>
                    <span style="font-weight: bold;">New Conversation</span>
                </div>
                
                <div style="padding: 1rem; text-align: center;">
                    <div style="color: #666; margin-bottom: 1rem;">
                        <p>To start a new conversation, use the search bar at the top of the page to find users.</p>
                        <p style="font-size: 0.9rem;">Search results will include options to message, follow, and add as friend.</p>
                    </div>
                    <button onclick="document.getElementById('searchInput').focus(); openSearch();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Open Search
                    </button>
                </div>
            `;
            
            // Focus on search input
            setTimeout(() => {
                document.getElementById('userSearchInput')?.focus();
            }, 100);
        }


        async function startConversationWithUser(userId, username) {
            try {
                const response = await apiCall('/messages/conversations', {
                    method: 'POST',
                    body: JSON.stringify({ participantId: userId })
                });

                if (response.ok) {
                    // Open the conversation
                    openConversation(response.data.conversation.id, username);
                } else {
                    alert('Failed to start conversation');
                }
            } catch (error) {
                console.error('Failed to start conversation:', error);
                alert('Error starting conversation');
            }
        }

        async function openConversation(conversationId, username) {
            try {
                // Load messages for this conversation
                const response = await apiCall(`/messages/conversations/${conversationId}/messages`);
                
                if (response.ok) {
                    showConversationView(conversationId, username, response.data.messages);
                } else {
                    alert('Failed to load conversation');
                }
            } catch (error) {
                console.error('Failed to load conversation:', error);
                alert('Error loading conversation');
            }
        }

        function showConversationView(conversationId, username, messages) {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">‚Üê</button>
                    <div class="user-avatar" style="margin-right: 0.5rem;">${username[0].toUpperCase()}</div>
                    <span style="font-weight: bold;">${username}</span>
                </div>
                
                <div id="messagesArea" style="height: 250px; overflow-y: auto; padding: 0.5rem; background: white;">
                    ${messages.length === 0 ? 
                        '<div style="text-align: center; padding: 2rem; color: #666;">No messages yet. Start the conversation!</div>' :
                        messages.map(msg => `
                            <div style="margin-bottom: 0.75rem; ${msg.sender.id === currentUser?.id ? 'text-align: right;' : ''}">
                                <div style="display: inline-block; max-width: 80%; padding: 0.5rem 0.75rem; border-radius: 12px; ${
                                    msg.sender.id === currentUser?.id ? 
                                    'background: #4b5c09; color: white;' : 
                                    'background: #f0f0f0; color: black;'
                                }">
                                    <div style="font-size: 0.9rem;">${msg.content}</div>
                                    <div style="font-size: 0.7rem; margin-top: 0.25rem; opacity: 0.8;">
                                        ${msg.sender.id === currentUser?.id ? '' : msg.sender.username + ' ‚Ä¢ '}${new Date(msg.createdAt).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        `).join('')
                    }
                </div>
                
                <div style="display: flex; padding: 1vh; border-top: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <input 
                        type="text" 
                        id="messageInput-${conversationId}" 
                        placeholder="Type a message..." 
                        style="flex: 1; padding: 0.5vh; border: 1px solid #ddd; border-radius: 20px; margin-right: 0.5rem; outline: none;"
                        onkeypress="handleMessageKeyPress(event, '${conversationId}')"
                    >
                    <button 
                        onclick="sendMessage('${conversationId}')" 
                        style="background: #4b5c09; color: white; border: none; padding: 0.5vh 1rem; border-radius: 20px; cursor: pointer; font-size: 0.9rem;"
                    >
                        Send
                    </button>
                </div>
            `;
            
            // Scroll to bottom of messages
            setTimeout(() => {
                const messagesArea = document.getElementById('messagesArea');
                messagesArea.scrollTop = messagesArea.scrollHeight;
            }, 100);
            
            // Focus on input
            setTimeout(() => {
                document.getElementById(`messageInput-${conversationId}`)?.focus();
            }, 100);
        }

        function backToConversations() {
            loadConversations();
        }

        function handleMessageKeyPress(event, conversationId) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage(conversationId);
            }
        }

        async function sendMessage(conversationId) {
            const input = document.getElementById(`messageInput-${conversationId}`);
            const content = input.value.trim();
            
            if (!content) return;
            
            try {
                const response = await apiCall(`/messages/conversations/${conversationId}/messages`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    input.value = '';
                    // Refresh the conversation to show the new message
                    const username = document.querySelector('#messagesBody span[style*="font-weight: bold"]')?.textContent;
                    if (username) {
                        openConversation(conversationId, username);
                    }
                } else {
                    alert('Failed to send message');
                }
            } catch (error) {
                console.error('Failed to send message:', error);
                alert('Error sending message');
            }
        }

        // Profile Functions - Updated to use main content area
        function toggleProfile() {
            // Use the new My Profile component instead of the old side panel
            showMyProfile();
        }

        // New function to show My Profile in main content area
        function showMyProfile() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your profile</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            // Hide all panels and show profile in main content
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            window.myProfile.render('mainContent');
        }

        // New function to toggle My Profile - shows/hides profile window
        function toggleMyProfile() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your profile</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            // Hide Civic Organizing container if open
            const civicOrganizing = document.querySelector('.civic-organizing-container');
            if (civicOrganizing) {
                civicOrganizing.style.display = 'none';
            }
            
            // Hide other main view systems
            const electionsView = document.querySelector('.elections-main-view');
            if (electionsView) {
                electionsView.style.display = 'none';
            }
            
            const officialsView = document.querySelector('.officials-main-view');
            if (officialsView) {
                officialsView.style.display = 'none';
            }
            
            const candidatesView = document.querySelector('.candidates-main-view');
            if (candidatesView) {
                candidatesView.style.display = 'none';
            }

            const mainContent = document.getElementById('mainContent');
            const isProfileCurrentlyShown = mainContent.querySelector('.my-profile') !== null;
            
            if (isProfileCurrentlyShown) {
                // Profile is currently shown, hide it and show default view
                showDefaultView();
            } else {
                // Profile is not shown, show it
                showMyProfile();
            }
        }

        // Function to show default view when all windows are closed
        function showDefaultView() {
            // Hide all side panels
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            closeAllPanels();
            
            // Show My Feed in main content area as default, or map if user is not logged in
            if (authToken) {
                showMyFeedInMain();
            } else {
                // For logged-out users, show the map or welcome screen
                if (window.map && typeof window.map.showMap === 'function') {
                    window.map.showMap();
                } else {
                    // Fallback to welcome screen
                    document.getElementById('mainContent').innerHTML = `
                        <div style="text-align: center; padding: 3rem;">
                            <h2>Welcome to United We Rise</h2>
                            <p>Connect with your community and engage in meaningful political discourse.</p>
                            <button onclick="openAuthModal('login')" class="btn">Log In</button>
                            <button onclick="openAuthModal('register')" class="btn" style="margin-left: 1rem;">Sign Up</button>
                        </div>
                    `;
                }
            }
        }
        window.toggleMyProfile = toggleMyProfile; // Make globally accessible

        // Toggle function for My Feed - shows/hides feed window in main content area
        function toggleMyFeed() {
            if (!authToken) {
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your feed</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }

            const mainContent = document.getElementById('mainContent');
            const isFeedCurrentlyShown = mainContent.querySelector('.my-feed') !== null;
            
            if (isFeedCurrentlyShown) {
                // Feed is currently shown, hide it and show default view
                showDefaultView();
            } else {
                // Feed is not shown, show it
                showMyFeedInMain();
            }
        }

        // Function to show My Feed in main content area (like Profile)
        async function showMyFeedInMain() {
            console.log('üéØ Showing My Feed in main content area');
            
            // Hide Civic Organizing container if open
            const civicOrganizing = document.querySelector('.civic-organizing-container');
            if (civicOrganizing) {
                civicOrganizing.style.display = 'none';
            }
            
            // Hide other main view systems
            const electionsView = document.querySelector('.elections-main-view');
            if (electionsView) {
                electionsView.style.display = 'none';
            }
            
            const officialsView = document.querySelector('.officials-main-view');
            if (officialsView) {
                officialsView.style.display = 'none';
            }
            
            const candidatesView = document.querySelector('.candidates-main-view');
            if (candidatesView) {
                candidatesView.style.display = 'none';
            }
            
            // Sync all auth token variables
            const token = window.authToken || authToken || localStorage.getItem('authToken');
            if (!token) {
                console.log('‚ùå No auth token found, showing login prompt');
                document.getElementById('mainContent').innerHTML = `
                    <div style="text-align: center; padding: 3rem;">
                        <h2>Please log in to view your feed</h2>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }
            
            // Ensure all auth variables are synced
            window.authToken = authToken = token;
            console.log('‚úÖ Auth token synced for My Feed');

            // Hide other content
            closeAllPanels();
            document.getElementById('profilePanel').style.display = 'none';
            document.getElementById('messagesContainer').style.display = 'none';
            
            // Show My Feed in main content area
            const mainContent = document.getElementById('mainContent');
            mainContent.innerHTML = `
                <div class="my-feed">
                    <div class="sticky-composer-wrapper">
                        <div class="quick-post-composer">
                            <textarea id="feedPostContent" placeholder="What's on your mind?" style="width: 100%; min-height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; font-family: inherit; resize: vertical; box-sizing: border-box;"></textarea>
                            <div style="text-align: right; margin-top: 0.25rem; margin-bottom: 0.25rem;">
                                <span id="feedPostCharCount" style="font-size: 0.85rem; color: #6c757d;">0/500</span>
                                <span id="sectionIndicator" style="display: none; margin-left: 10px; font-size: 0.85rem; color: #1da1f2;">Section 1</span>
                            </div>
                            <div style="margin-top: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <label for="feedMediaUpload" style="background: #666; color: white; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem; margin-right: 0.5rem;">
                                        üì∑ Add Media
                                        <input type="file" id="feedMediaUpload" multiple accept="image/*,video/*" style="display: none;" onchange="handlePostMediaUpload(this)">
                                    </label>
                                    <div id="feedMediaPreview" style="margin-top: 0.5rem;"></div>
                                </div>
                                <div>
                                    <button onclick="createPostFromFeed()" class="btn">Post</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="myFeedPosts" style="margin-top: 1rem; min-height: 400px; height: calc(100vh - 300px); overflow-y: auto;">
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>Loading your personalized feed...</p>
                        </div>
                    </div>
                </div>
            `;
            
            // Load the posts with error handling
            try {
                await loadMyFeedPosts();
            } catch (error) {
                console.error('‚ùå Error loading My Feed posts:', error);
                document.getElementById('myFeedPosts').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p>Error loading feed. Please refresh the page.</p>
                        <button onclick="showMyFeedInMain()" class="btn">Retry</button>
                    </div>
                `;
            }
            
            // Setup infinite scroll for My Feed (with safety check)
            try {
                if (typeof setupMyFeedInfiniteScroll === 'function') {
                    setupMyFeedInfiniteScroll();
                } else {
                    console.warn('‚ö†Ô∏è setupMyFeedInfiniteScroll function not available');
                }
            } catch (error) {
                console.error('‚ùå Error setting up infinite scroll:', error);
            }
            
            // Character counter - only shows when approaching max limit
            const feedPostTextarea = document.getElementById('feedPostContent');
            const feedCharCount = document.getElementById('feedPostCharCount');
            const sectionIndicator = document.getElementById('sectionIndicator');
            
            if (feedPostTextarea && feedCharCount) {
                // Function to update character count
                function updateCharCounter() {
                    const text = feedPostTextarea.value;
                    const charCount = text.length;
                    
                    // Hide section indicator (no longer needed)
                    if (sectionIndicator) {
                        sectionIndicator.style.display = 'none';
                    }
                    
                    // Only show counter when approaching 5000 char limit
                    if (charCount >= 4900) {
                        feedCharCount.style.display = 'inline';
                        feedCharCount.textContent = `${charCount}/5000`;
                        
                        if (charCount > 5000) {
                            feedCharCount.style.color = '#dc3545'; // Red
                            feedCharCount.style.fontWeight = 'bold';
                        } else {
                            feedCharCount.style.color = '#ffc107'; // Orange warning
                            feedCharCount.style.fontWeight = 'bold';
                        }
                    } else {
                        // Hide counter when under 4900
                        feedCharCount.style.display = 'none';
                    }
                }
                
                // Initial count
                updateCharCounter();
                
                // Update on input
                feedPostTextarea.addEventListener('input', updateCharCounter);
            }
            
            // Apply background if user has one
            if (currentUser && currentUser.backgroundImage) {
                applyUserBackground(currentUser.backgroundImage);
            }
        }
        window.toggleMyFeed = toggleMyFeed; // Make globally accessible
        
        // Make function globally available
        window.showMyFeedInMain = showMyFeedInMain;

        // Load posts for My Feed in main area
        async function loadMyFeedPosts() {
            console.log('üîÑ Loading My Feed posts...');
            
            // Ensure auth token is available
            if (!window.authToken && !localStorage.getItem('authToken')) {
                console.error('‚ùå No auth token available for My Feed');
                document.getElementById('myFeedPosts').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p>Please log in to view your feed.</p>
                        <button onclick="openAuthModal('login')" class="btn">Log In</button>
                    </div>
                `;
                return;
            }
            
            // Sync auth token if needed
            if (!window.authToken && localStorage.getItem('authToken')) {
                window.authToken = localStorage.getItem('authToken');
                console.log('üîß Synced auth token from localStorage');
            }
            
            try {
                console.log('üåê Making API call to /feed/');
                const response = await apiCall('/feed/?limit=15', {
                    method: 'GET'
                });
                
                console.log('üì¶ My Feed API Response:', response);
                
                // Handle different response formats
                let posts = null;
                if (response && response.posts) {
                    // Direct posts array
                    posts = response.posts;
                } else if (response && response.data && response.data.posts) {
                    // Wrapped in data object
                    posts = response.data.posts;
                } else if (response && response.ok && response.data && response.data.posts) {
                    // Double wrapped
                    posts = response.data.posts;
                }
                
                if (posts && Array.isArray(posts) && posts.length > 0) {
                    console.log(`‚úÖ Found ${posts.length} posts for My Feed`);
                    // Reset offset for initial load
                    currentFeedOffset = posts.length;
                    hasMorePosts = true; // Reset for new feed
                    displayMyFeedPosts(posts);
                } else {
                    console.log('üìù No posts found in My Feed');
                    document.getElementById('myFeedPosts').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No posts in your feed yet. Follow some users to see their posts here!</p>
                            <p><small>Start by exploring trending topics or searching for users to follow.</small></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Feed loading error:', error);
                document.getElementById('myFeedPosts').innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <p>Unable to load your feed. Please try again.</p>
                        <p><small>Error: ${error.message}</small></p>
                        <button onclick="loadMyFeedPosts()" class="btn">Retry</button>
                    </div>
                `;
            }
        }

        // Display posts in My Feed
        function displayMyFeedPosts(posts, appendMode = false) {
            const container = document.getElementById('myFeedPosts');
            
            if (!container) {
                console.error('‚ùå My Feed container not found');
                return;
            }
            
            if (!posts || posts.length === 0) {
                if (!appendMode) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <p>No posts in your feed yet. Follow some users to see their posts here!</p>
                        </div>
                    `;
                }
                return;
            }
            
            console.log(`üéØ ${appendMode ? 'Appending' : 'Displaying'} ${posts.length} posts in My Feed`);
            
            // Use the existing displayPosts function with fallback
            try {
                if (typeof displayPosts === 'function') {
                    displayPosts(posts, 'myFeedPosts', appendMode);
                } else {
                    console.warn('‚ö†Ô∏è displayPosts function not available, using fallback');
                    displayMyFeedPostsFallback(posts, container, appendMode);
                }
            } catch (error) {
                console.error('‚ùå Error displaying posts:', error);
                displayMyFeedPostsFallback(posts, container, appendMode);
            }
        }
        
        // Fallback display function for My Feed
        function displayMyFeedPostsFallback(posts, container, appendMode = false) {
            console.log(`üîß Using fallback display for My Feed (${appendMode ? 'append' : 'replace'} mode)`);
            
            let html = '';
            posts.forEach(post => {
                html += `
                    <div class="post-item" style="border: 1px solid #ddd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: white;">
                        <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                            <strong>${post.author?.firstName || post.author?.username || 'Anonymous'}</strong>
                            <span style="color: #666; margin-left: 0.5rem; font-size: 0.9rem;">
                                ${post.createdAt ? new Date(post.createdAt).toLocaleDateString() : ''}
                            </span>
                        </div>
                        <div style="margin-bottom: 1rem;">${post.content || ''}</div>
                        <div style="color: #666; font-size: 0.9rem;">
                            üëç ${post.likesCount || 0} likes ‚Ä¢ üí¨ ${post.commentsCount || 0} comments
                        </div>
                    </div>
                `;
            });
            
            if (appendMode) {
                container.insertAdjacentHTML('beforeend', html);
            } else {
                container.innerHTML = html;
            }
        }

        // DEPRECATED - Panel-based My Feed implementation removed

        // DEPRECATED - Panel-based feed functions removed

        // DEPRECATED - Panel scroll handler removed

        // Variables for infinite scroll functionality
        let isLoadingMorePosts = false;
        let hasMorePosts = true;
        let currentFeedOffset = 0; // Track total posts loaded

        // Load more posts for infinite scroll (corrected implementation for main content area)
        async function loadMoreMyFeedPosts() {
            if (isLoadingMorePosts || !hasMorePosts) return;
            
            isLoadingMorePosts = true;
            const container = document.getElementById('myFeedPosts');
            
            // Add loading indicator
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'feed-loading';
            loadingDiv.innerHTML = 'Loading more posts...';
            container.appendChild(loadingDiv);

            try {
                // Use offset-based pagination
                console.log(`üîÑ Loading more My Feed posts... (offset: ${currentFeedOffset})`);
                const response = await apiCall(`/feed/?limit=15&offset=${currentFeedOffset}`, {
                    method: 'GET'
                });

                console.log('üì¶ Load more response:', response);
                
                // Handle different response formats (same as main load)
                let posts = null;
                if (response && response.posts) {
                    posts = response.posts;
                } else if (response && response.data && response.data.posts) {
                    posts = response.data.posts;
                } else if (response && response.ok && response.data && response.data.posts) {
                    posts = response.data.posts;
                }
                
                // Remove loading indicator
                container.removeChild(loadingDiv);

                if (!posts || posts.length === 0) {
                    hasMorePosts = false;
                    const endDiv = document.createElement('div');
                    endDiv.className = 'feed-end-indicator';
                    endDiv.style.cssText = 'text-align: center; padding: 1rem; color: #666; font-style: italic;';
                    endDiv.innerHTML = "You're all caught up! üéâ";
                    container.appendChild(endDiv);
                    return;
                }

                // Append new posts to existing feed (pagination now supported)
                console.log(`‚úÖ Appending ${posts.length} more posts (total offset: ${currentFeedOffset})`);
                displayMyFeedPosts(posts, true); // true = append mode
                currentFeedOffset += posts.length; // Increment offset by number of posts loaded
                
                // Check if backend indicates more posts available
                if (response.pagination && response.pagination.hasMore === false) {
                    hasMorePosts = false;
                    console.log('üìù Backend indicates no more posts available');
                }

            } catch (error) {
                console.error('‚ùå Error loading more posts:', error);
                
                // Remove loading indicator
                if (container.contains(loadingDiv)) {
                    container.removeChild(loadingDiv);
                }
                
                const errorDiv = document.createElement('div');
                errorDiv.className = 'feed-error';
                errorDiv.style.cssText = 'text-align: center; padding: 1rem;';
                errorDiv.innerHTML = `
                    <p style="color: #666; margin-bottom: 0.5rem;">Failed to refresh feed.</p>
                    <button onclick="loadMoreMyFeedPosts()" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Retry</button>
                `;
                container.appendChild(errorDiv);
            }

            isLoadingMorePosts = false;
        }

        // Scroll event listener for infinite scroll on My Feed
        function setupMyFeedInfiniteScroll() {
            const myFeedContainer = document.getElementById('myFeedPosts');
            if (myFeedContainer) {
                console.log('‚úÖ Setting up infinite scroll for My Feed');
                myFeedContainer.addEventListener('scroll', () => {
                    // Skip if already loading
                    if (isLoadingMorePosts || !hasMorePosts) {
                        return;
                    }
                    
                    const { scrollTop, scrollHeight, clientHeight } = myFeedContainer;
                    const distanceFromBottom = scrollHeight - (scrollTop + clientHeight);
                    
                    // Only trigger at the very bottom to prevent multiple requests
                    if (distanceFromBottom <= 50) {
                        console.log('üîÑ Infinite scroll triggered - loading more posts');
                        loadMoreMyFeedPosts();
                    }
                });
            } else {
                console.warn('‚ö†Ô∏è myFeedPosts container not found for infinite scroll setup');
            }
        }

        // New function to show My Feed - personalized feed based on who user follows
        async function showMyFeed() {
            // Use the correct main content area implementation
            showMyFeedInMain();
        }


        // Global variable to store selected media for post
        let selectedPostMedia = null;

        // Function to trigger media upload
        function attachMediaToPost() {
            document.getElementById('postMediaUpload').click();
        }

        // Function to handle media selection and preview
        async function handlePostMediaUpload(input) {
            const file = input.files[0];
            if (!file) return;

            // Validate file type
            const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/webp', 'image/gif'];
            if (!allowedTypes.includes(file.type)) {
                alert('Please select a valid image file (JPEG, PNG, WebP, or GIF)');
                input.value = '';
                return;
            }

            // Validate file size (10MB for images, 5MB for GIFs)
            const maxSize = file.type === 'image/gif' ? 5 * 1024 * 1024 : 10 * 1024 * 1024;
            if (file.size > maxSize) {
                const limitMB = file.type === 'image/gif' ? 5 : 10;
                alert(`File too large. ${file.type === 'image/gif' ? 'GIFs' : 'Images'} must be smaller than ${limitMB}MB`);
                input.value = '';
                return;
            }

            // Store selected file
            selectedPostMedia = file;

            // Show preview
            const previewArea = document.getElementById('mediaPreview');
            const previewContent = previewArea.querySelector('.media-preview-content');
            
            // Create preview element
            const fileURL = URL.createObjectURL(file);
            const isGif = file.type === 'image/gif';
            
            previewContent.innerHTML = `
                <div class="media-item">
                    <img src="${fileURL}" alt="Preview" 
                         style="max-width: 200px; max-height: 150px; border-radius: 8px; object-fit: cover;">
                    <div class="media-info">
                        <p><strong>${file.name}</strong></p>
                        <p>${isGif ? 'üéûÔ∏è GIF' : 'üì∑ Image'} ‚Ä¢ ${(file.size / 1024 / 1024).toFixed(1)}MB</p>
                    </div>
                </div>
            `;
            
            previewArea.style.display = 'block';
        }

        // Function to clear media attachment
        function clearMediaAttachment() {
            selectedPostMedia = null;
            document.getElementById('mediaPreview').style.display = 'none';
            document.getElementById('postMediaUpload').value = '';
        }

        // ============================================================================
        // REUSABLE POSTING BOX FUNCTION - Use this for any posting box on the site
        // ============================================================================
        /**
         * Creates a post from any posting box on the site (UNIFIED SYSTEM)
         * @param {string} textareaId - The ID of the textarea containing the post content
         * @param {Function} onSuccess - Optional callback function to run after successful post creation
         * @param {Object} options - Optional configuration (e.g., { refreshFeed: true, clearMedia: true })
         */
        async function createPostFromTextarea(textareaId, onSuccess = null, options = {}) {
            const textarea = document.getElementById(textareaId);
            if (!textarea) {
                console.error(`Textarea with ID '${textareaId}' not found`);
                return false;
            }

            const content = textarea.value.trim();
            
            // Check if we have content or media
            if (!content && !selectedPostMedia) {
                alert('Please enter some content or attach media for your post');
                return false;
            }

            try {
                let mediaId = null;

                // Upload media first if selected
                if (selectedPostMedia) {
                    const formData = new FormData();
                    formData.append('photos', selectedPostMedia);
                    formData.append('photoType', 'POST_MEDIA');
                    formData.append('purpose', 'PERSONAL');

                    console.log('üñºÔ∏è Uploading media for post...');
                    const mediaResponse = await apiCall('/photos/upload', {
                        method: 'POST',
                        body: formData
                    });

                    if (!mediaResponse.ok) {
                        const errorData = mediaResponse.data || {};
                        const errorMessage = errorData.message || errorData.error || 'Failed to upload media';
                        alert(`Media upload failed: ${errorMessage}`);
                        return false;
                    }

                    // Get the uploaded photo ID
                    mediaId = mediaResponse.data.photos[0]?.id;
                    console.log('‚úÖ Media uploaded successfully:', mediaId);
                }

                // Create the post using unified system (defaults to Public Post)
                const result = await createPostPublic(content, { mediaId });

                if (result.success) {
                    // Clear the textarea
                    textarea.value = '';
                    
                    // Clear media if option is set (default true)
                    if (options.clearMedia !== false && selectedPostMedia) {
                        clearMediaAttachment();
                    }
                    
                    console.log('‚úÖ Post created successfully');
                    
                    // Call the success callback if provided
                    if (onSuccess && typeof onSuccess === 'function') {
                        onSuccess(result.post);
                    }
                    
                    // Refresh feed if option is set
                    if (options.refreshFeed) {
                        if (typeof showMyFeed === 'function') {
                            showMyFeed();
                        } else if (typeof loadMyFeedPosts === 'function') {
                            loadMyFeedPosts();
                        }
                    }
                    
                    return true;
                } else {
                    alert(result.error || 'Failed to create post. Please try again.');
                    return false;
                }
            } catch (error) {
                console.error('Post creation error:', error);
                alert('Error creating post. Please check your connection and try again.');
                return false;
            }
        }

        // Wrapper function for My Feed posting box (uses unified posting system)
        async function createPostFromFeed() {
            const textarea = document.getElementById('feedPostContent');
            if (!textarea) return false;

            const content = textarea.value.trim();
            if (!content) return false;

            // Check if content exceeds maximum limit (5000 chars)
            if (content.length > 5000) {
                alert('Post exceeds 5000 characters. Please shorten your post.');
                return false;
            }

            // Get media attachment if any
            const mediaId = window.currentMediaId || null;
            const imageUrl = null; // Handled by mediaId

            try {
                const result = await createPostPublic(content, { 
                    mediaId,
                    imageUrl
                });

                if (result.success) {
                    textarea.value = '';
                    // Clear media attachment
                    if (window.currentMediaId) {
                        window.currentMediaId = null;
                        // Clear media preview if exists
                        const mediaPreview = document.getElementById('media-preview');
                        if (mediaPreview) mediaPreview.style.display = 'none';
                    }
                    
                    // Update character counter
                    const charCount = document.getElementById('feedPostCharCount');
                    if (charCount) charCount.textContent = '0/5000';
                    
                    // Refresh feed
                    if (typeof loadMoreMyFeedPosts === 'function') {
                        showMyFeedInMain();
                    }
                    
                    return true;
                } else {
                    alert('Error creating post: ' + (result.error || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('Feed post creation error:', error);
                alert('Error creating post');
                return false;
            }
        }

        // REMOVED: createThreadedPost function - no longer needed with automatic splitting
        // The backend now handles splitting content >500 chars into content + extendedContent
        
        // REMOVED: Old threaded post function
        /* async function createThreadedPost(content) {
            const textarea = document.getElementById('feedPostContent');
            const separator = '--- Continue ---';
            
            // Split content by separator
            const parts = content.split(separator);
            if (parts.length !== 2) {
                alert('Invalid thread structure');
                return false;
            }
            
            const mainContent = parts[0].trim();
            const continuationContent = parts[1].trim();
            
            // Validate lengths
            if (mainContent.length > 500) {
                alert('First section exceeds 500 characters. Please shorten it.');
                return false;
            }
            
            if (continuationContent.length > 5000) {
                alert('Continuation exceeds 5000 characters. Please shorten it.');
                return false;
            }
            
            if (mainContent.length === 0 || continuationContent.length === 0) {
                alert('Both sections must contain content.');
                return false;
            }

            // Get media attachment (only applies to first post)
            const mediaId = window.currentMediaId || null;

            try {
                // Create main post
                const result = await createPostPublic(mainContent, { 
                    mediaId,
                    refreshFeed: false // Don't refresh until we're done
                });

                if (!result.success) {
                    throw new Error('Failed to create main post: ' + result.error);
                }

                const postId = result.post.id;
                
                // Track this as a post with continuation
                if (!window.postsWithContinuation) window.postsWithContinuation = new Set();
                window.postsWithContinuation.add(postId);
                
                // Create continuation comment (NOT nested - parentId: null)
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ 
                        content: continuationContent,
                        parentId: null // Keep at layer 0
                    })
                });

                if (!response.ok || !response.data.comment) {
                    const errorMsg = response.data?.error || response.data?.message || 'Failed to create continuation comment';
                    throw new Error(errorMsg);
                }

                // Success - clear the textarea and reset state
                textarea.value = '';
                window.threadBreakPosition = null;
                
                // Clear media attachment
                if (window.currentMediaId) {
                    window.currentMediaId = null;
                    const mediaPreview = document.getElementById('media-preview');
                    if (mediaPreview) mediaPreview.style.display = 'none';
                }
                
                // Refresh feed to show the new post
                if (typeof showMyFeedInMain === 'function') {
                    showMyFeedInMain();
                }
                
                return true;

            } catch (error) {
                console.error('Threaded post creation error:', error);
                alert('Error creating threaded post: ' + error.message);
                return false;
            }
        } */
        
        // REMOVED: addThreadBreak function - no longer needed
        /* function addThreadBreak() {
            const textarea = document.getElementById('feedPostContent');
            if (!textarea) return;
            
            // Check if we already have a break
            if (window.threadBreakPosition !== null) {
                alert('You can only have one continuation. The continuation can be up to 5000 characters.');
                return;
            }
            
            const cursorPos = textarea.selectionStart;
            const textBefore = textarea.value.substring(0, cursorPos);
            const textAfter = textarea.value.substring(cursorPos);
            
            // Insert separator
            const separator = '\n\n--- Continue ---\n\n';
            textarea.value = textBefore + separator + textAfter;
            
            // Store break position
            window.threadBreakPosition = cursorPos;
            
            // Position cursor after separator
            const newCursorPos = cursorPos + separator.length;
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            textarea.focus();
            
            // Trigger character counter update
            textarea.dispatchEvent(new Event('input'));
            textarea.dispatchEvent(new Event('click'));
        } */

        // REMOVED: createPostWithContinuation function - replaced by automatic backend splitting
        /* async function createPostWithContinuation() {
            const textarea = document.getElementById('feedPostContent');
            if (!textarea) return false;

            const fullContent = textarea.value.trim();
            if (!fullContent) return false;
            
            // Split content at 500 characters, finding the last space before the limit
            let splitIndex = 500;
            if (fullContent.length > 500) {
                // Find the last space before 500 characters to avoid breaking words
                const lastSpaceIndex = fullContent.lastIndexOf(' ', 500);
                if (lastSpaceIndex > 400) { // Don't go too far back
                    splitIndex = lastSpaceIndex;
                }
            }
            
            const mainContent = fullContent.substring(0, splitIndex).trim();
            const continuationContent = fullContent.substring(splitIndex).trim();
            
            // Get media attachment if any (only apply to main post)
            const mediaId = window.currentMediaId || null;
            
            try {
                // Create the main post
                const result = await createPostPublic(mainContent, { 
                    mediaId,
                    refreshFeed: false // Don't refresh yet, we need to add comment first
                });

                if (result && result.success) {
                    const postId = result.post.id;
                    
                    // Mark this post as truncated for UI display
                    if (!window.truncatedPosts) {
                        window.truncatedPosts = new Set();
                    }
                    window.truncatedPosts.add(postId);
                    
                    // Clear the form
                    textarea.value = '';
                    const charCount = document.getElementById('feedPostCharCount');
                    if (charCount) charCount.textContent = '0/500';
                    
                    // Hide continue button and hint
                    const continueBtn = document.getElementById('continueInCommentBtn');
                    const continueHint = document.getElementById('continueInCommentHint');
                    if (continueBtn) continueBtn.style.display = 'none';
                    if (continueHint) continueHint.style.display = 'none';
                    
                    // Clear media
                    window.currentMediaId = null;
                    const mediaPreview = document.getElementById('feedMediaPreview');
                    if (mediaPreview) mediaPreview.style.display = 'none';
                    
                    // Add the continuation as a comment
                    if (continuationContent) {
                        await addCommentToPost(postId, continuationContent);
                    }
                    
                    // Refresh feed
                    if (typeof loadMoreMyFeedPosts === 'function') {
                        showMyFeedInMain();
                    }
                    
                    return true;
                } else {
                    alert('Error creating post: ' + (result.error || 'Unknown error'));
                    return false;
                }
            } catch (error) {
                console.error('Post continuation creation error:', error);
                alert('Error creating post with continuation');
                return false;
            }
        } */
        
        // REMOVED: addCommentToPost helper - no longer needed for continuations
        /* async function addCommentToPost(postId, content) {
            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: { content }
                });
                
                if (!response.ok) {
                    console.error('Error adding continuation comment:', response.data);
                    // Don't show alert for comment error - main post was successful
                }
            } catch (error) {
                console.error('Error adding continuation comment:', error);
                // Don't show alert for comment error - main post was successful
            }
        } */

        async function loadUserProfile() {
            if (!authToken) {
                document.getElementById('profileBody').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #666;">
                        <p>Please log in to view your profile</p>
                        <button onclick="openAuthModal('login')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Log In
                        </button>
                    </div>
                `;
                return;
            }

            try {
                console.log('Loading user profile...');
                const response = await apiCall('/users/profile');
                
                console.log('Profile response:', response);
                
                if (response.ok) {
                    const data = response.data;
                    displayUserProfile(data.user);
                } else {
                    const errorMsg = response.data?.error || 'Failed to load profile';
                    document.getElementById('profileBody').innerHTML = `<p style="color: #d32f2f;">Error: ${errorMsg}</p>`;
                }
            } catch (error) {
                console.error('Failed to load profile:', error);
                document.getElementById('profileBody').innerHTML = '<p style="color: #d32f2f;">Network error loading profile</p>';
            }
        }

        function displayUserProfile(user) {
            const body = document.getElementById('profileBody');
            
            let html = `
                <div class="profile-section">
                    <h3>Basic Information</h3>
                    <p><strong>Username:</strong> @${user.username}</p>
                    <p><strong>Email:</strong> ${user.email}</p>
                    ${user.firstName ? `<p><strong>Name:</strong> ${user.firstName} ${user.lastName || ''}</p>` : ''}
                    ${user.bio ? `<p><strong>Bio:</strong> ${user.bio}</p>` : ''}
                    ${user.website ? `<p><strong>Website:</strong> <a href="${user.website}" target="_blank">${user.website}</a></p>` : ''}
                </div>

                <div class="profile-section">
                    <h3>Social Stats</h3>
                    <p><strong>Followers:</strong> <a href="#" onclick="showFollowersList('${user.id}')" style="color: #4b5c09; text-decoration: none;">${user.followersCount}</a></p>
                    <p><strong>Following:</strong> <a href="#" onclick="showFollowingList('${user.id}')" style="color: #4b5c09; text-decoration: none;">${user.followingCount}</a></p>
                </div>
            `;

            if (user.politicalProfileType && user.politicalProfileType !== 'CITIZEN') {
                html += `
                    <div class="profile-section">
                        <h3>Political Profile</h3>
                        <p><strong>Type:</strong> ${user.politicalProfileType.replace('_', ' ')}</p>
                        ${user.office ? `<p><strong>Office:</strong> ${user.office}</p>` : ''}
                        ${user.officialTitle ? `<p><strong>Title:</strong> ${user.officialTitle}</p>` : ''}
                        <p><strong>Verification:</strong> ${user.verificationStatus}</p>
                    </div>
                `;
            }

            if (user.streetAddress) {
                html += `
                    <div class="profile-section">
                        <h3>Location</h3>
                        <p>${user.streetAddress}<br>${user.city}, ${user.state} ${user.zipCode}</p>
                    </div>
                `;
            }

            html += `
                <div class="profile-section">
                    <button class="btn" onclick="editProfile()">Edit Profile</button>
                </div>
            `;

            body.innerHTML = html;
        }

        function editProfile() {
            const body = document.getElementById('profileBody');
            
            if (!currentUser) return;
            
            body.innerHTML = `
                <form id="profileEditForm">
                    <div class="profile-section">
                        <h3>Basic Information</h3>
                        <div class="form-group">
                            <label>First Name</label>
                            <input type="text" id="editFirstName" value="${currentUser.firstName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Last Name</label>
                            <input type="text" id="editLastName" value="${currentUser.lastName || ''}">
                        </div>
                        <div class="form-group">
                            <label>Bio</label>
                            <textarea id="editBio" style="width: 100%; height: 80px; box-sizing: border-box;">${currentUser.bio || ''}</textarea>
                        </div>
                        <div class="form-group">
                            <label>Website</label>
                            <input type="url" id="editWebsite" value="${currentUser.website || ''}">
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Political Profile</h3>
                        <div class="form-group">
                            <label>Profile Type</label>
                            <select id="editPoliticalType" onchange="updatePoliticalFields()" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="CITIZEN" ${(currentUser.politicalProfileType || 'CITIZEN') === 'CITIZEN' ? 'selected' : ''}>Citizen</option>
                                <option value="CANDIDATE" ${currentUser.politicalProfileType === 'CANDIDATE' ? 'selected' : ''}>Political Candidate</option>
                                <option value="ELECTED_OFFICIAL" ${currentUser.politicalProfileType === 'ELECTED_OFFICIAL' ? 'selected' : ''}>Elected Official</option>
                                <option value="POLITICAL_ORG" ${currentUser.politicalProfileType === 'POLITICAL_ORG' ? 'selected' : ''}>Political Organization</option>
                            </select>
                        </div>
                        
                        <div id="politicalFieldsContainer">
                            <!-- Political fields will be populated here -->
                        </div>
                        
                        <div id="verificationSection" style="display: none;">
                            <div style="background: #f9f9f9; padding: 1rem; border-radius: 4px; margin-top: 1rem;">
                                <h4 style="margin: 0 0 0.5rem 0; color: #4b5c09;">Political Verification</h4>
                                <p style="margin: 0 0 1rem 0; font-size: 0.9rem; color: #666;">
                                    Political candidates and elected officials require verification. Upload supporting documents to verify your political status.
                                </p>
                                
                                <div class="form-group">
                                    <label>Current Verification Status</label>
                                    <div style="padding: 0.5rem; background: ${getVerificationStatusColor(currentUser.verificationStatus)}; border-radius: 4px; font-weight: bold;">
                                        ${getVerificationStatusText(currentUser.verificationStatus)}
                                    </div>
                                </div>
                                
                                ${currentUser.verificationStatus === 'PENDING' || currentUser.verificationStatus === 'DENIED' ? `
                                <div class="form-group">
                                    <label>Upload Verification Documents</label>
                                    <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.5rem;">
                                        Upload documents that verify your political status (e.g., filing papers, official campaign documents, government ID with title, etc.)
                                    </p>
                                    <input type="file" id="verificationDocs" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" style="width: 100%;">
                                    <button type="button" onclick="uploadVerificationDocs()" style="margin-top: 0.5rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Upload Documents
                                    </button>
                                </div>
                                ` : ''}
                                
                                ${currentUser.verificationStatus === 'APPROVED' ? `
                                <div style="color: #2e7d32; font-weight: bold;">
                                    ‚úÖ Your political profile has been verified!
                                </div>
                                ` : ''}
                                
                                ${currentUser.verificationStatus === 'DENIED' ? `
                                <div style="color: #d32f2f; font-weight: bold;">
                                    ‚ùå Verification was denied. Please upload additional documentation or contact support.
                                </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Custom Background Image</h3>
                        <div class="background-settings">
                            <p style="color: #666; margin-bottom: 1rem;">
                                Set a custom background image for your Profile and My Feed. This will be visible to others when they view your profile.
                            </p>
                            
                            <div class="background-upload-container">
                                <div class="background-preview" id="backgroundPreview" ${currentUser.backgroundImage ? `style="background-image: url(${currentUser.backgroundImage})"` : ''}>
                                    ${currentUser.backgroundImage ? '' : 'No background set'}
                                </div>
                                
                                <div>
                                    <input type="file" id="backgroundImageFile" accept="image/*" style="display: none;" onchange="handleBackgroundImageSelect(this)">
                                    <button type="button" class="background-upload-btn" onclick="document.getElementById('backgroundImageFile').click()">
                                        Choose Background Image
                                    </button>
                                    ${currentUser.backgroundImage ? `
                                        <button type="button" class="background-remove-btn" onclick="removeBackgroundImage()">
                                            Remove Background
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="profile-section">
                        <h3>Address (for finding your elected officials)</h3>
                        <div id="profileAddressForm"></div>
                    </div>
                    
                    <div class="profile-section">
                        <button type="button" class="btn" onclick="saveProfile()">Save Changes</button>
                        <button type="button" class="btn-secondary btn" onclick="cancelEditProfile()">Cancel</button>
                    </div>
                </form>
            `;
            
            // Initialize the address form
            addressForm = createAddressForm({
                containerId: 'profileAddressForm',
                initialValues: {
                    streetAddress: currentUser.streetAddress || '',
                    city: currentUser.city || '',
                    state: currentUser.state || '',
                    zipCode: currentUser.zipCode || ''
                },
                onChange: (data) => {
                    // Address data changed - could trigger validation or auto-save
                    console.log('Address updated:', data);
                },
                required: false
            });
            
            // Initialize political fields
            updatePoliticalFields();
        }

        function getVerificationStatusColor(status) {
            switch(status) {
                case 'APPROVED': return '#e8f5e8';
                case 'DENIED': return '#ffebee';
                case 'PENDING': return '#fff3e0';
                default: return '#f5f5f5';
            }
        }

        function getVerificationStatusText(status) {
            switch(status) {
                case 'APPROVED': return '‚úÖ Verified';
                case 'DENIED': return '‚ùå Verification Denied';
                case 'PENDING': return '‚è≥ Verification Pending';
                case 'NOT_REQUIRED': return 'Not Required';
                default: return 'Unknown';
            }
        }

        function updatePoliticalFields() {
            const politicalType = document.getElementById('editPoliticalType')?.value;
            const container = document.getElementById('politicalFieldsContainer');
            const verificationSection = document.getElementById('verificationSection');
            
            if (!container) return;
            
            let fieldsHtml = '';
            
            if (politicalType === 'CANDIDATE') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Political Party (optional)</label>
                        <input type="text" id="editPoliticalParty" value="${currentUser.politicalParty || ''}" placeholder="e.g., Democratic, Republican, Independent">
                    </div>
                    <div class="form-group">
                        <label>Office Seeking</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., Mayor of Springfield, State Senator District 5">
                    </div>
                    <div class="form-group">
                        <label>Campaign Website (optional)</label>
                        <input type="url" id="editCampaignWebsite" value="${currentUser.campaignWebsite || ''}" placeholder="https://...">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Political Party (optional)</label>
                        <input type="text" id="editPoliticalParty" value="${currentUser.politicalParty || ''}" placeholder="e.g., Democratic, Republican, Independent">
                    </div>
                    <div class="form-group">
                        <label>Current Office</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., Mayor of Springfield, State Senator District 5">
                    </div>
                    <div class="form-group">
                        <label>Official Title</label>
                        <input type="text" id="editOfficialTitle" value="${currentUser.officialTitle || ''}" placeholder="e.g., The Honorable, Mayor, Senator">
                    </div>
                    <div class="form-group">
                        <label>Term Start Date (optional)</label>
                        <input type="date" id="editTermStart" value="${currentUser.termStart ? new Date(currentUser.termStart).toISOString().split('T')[0] : ''}">
                    </div>
                    <div class="form-group">
                        <label>Term End Date (optional)</label>
                        <input type="date" id="editTermEnd" value="${currentUser.termEnd ? new Date(currentUser.termEnd).toISOString().split('T')[0] : ''}">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else if (politicalType === 'POLITICAL_ORG') {
                fieldsHtml = `
                    <div class="form-group">
                        <label>Organization Type</label>
                        <input type="text" id="editOffice" value="${currentUser.office || ''}" placeholder="e.g., PAC, SuperPAC, Campaign Committee, Party Organization">
                    </div>
                    <div class="form-group">
                        <label>Organization Website (optional)</label>
                        <input type="url" id="editCampaignWebsite" value="${currentUser.campaignWebsite || ''}" placeholder="https://...">
                    </div>
                `;
                verificationSection.style.display = 'block';
            } else {
                // CITIZEN - no additional fields needed
                verificationSection.style.display = 'none';
            }
            
            container.innerHTML = fieldsHtml;
        }

        async function uploadVerificationDocs() {
            const fileInput = document.getElementById('verificationDocs');
            const files = fileInput.files;
            
            if (files.length === 0) {
                alert('Please select files to upload');
                return;
            }
            
            // In a real implementation, you would upload these files to your server
            // For now, we'll just simulate the upload
            alert(`${files.length} document(s) selected for upload. In a real implementation, these would be uploaded to the server for review.`);
            
            // Update verification status to pending after upload
            // This would normally be handled by the server after successful upload
        }

        function cancelEditProfile() {
            loadUserProfile(); // Reload the view mode
        }

        async function saveProfile() {
            // Validate address form first
            if (addressForm && !addressForm.validate()) {
                alert('Please fix address form errors before saving');
                return;
            }

            const profileData = {
                firstName: document.getElementById('editFirstName').value,
                lastName: document.getElementById('editLastName').value,
                bio: document.getElementById('editBio').value,
                website: document.getElementById('editWebsite').value
            };

            // Get address data from the address form
            const addressData = addressForm ? addressForm.getData() : {};
            
            // Get political profile data
            const politicalType = document.getElementById('editPoliticalType').value;
            const politicalData = {
                streetAddress: addressData.streetAddress || '',
                city: addressData.city || '',
                state: addressData.state || '',
                zipCode: addressData.zipCode || '',
                politicalProfileType: politicalType
            };

            // Add political-specific fields based on type
            if (politicalType === 'CANDIDATE') {
                politicalData.politicalParty = document.getElementById('editPoliticalParty')?.value || '';
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            } else if (politicalType === 'ELECTED_OFFICIAL') {
                politicalData.politicalParty = document.getElementById('editPoliticalParty')?.value || '';
                politicalData.office = document.getElementById('editOffice')?.value || '';
                politicalData.officialTitle = document.getElementById('editOfficialTitle')?.value || '';
                
                const termStart = document.getElementById('editTermStart')?.value;
                const termEnd = document.getElementById('editTermEnd')?.value;
                if (termStart) politicalData.termStart = new Date(termStart).toISOString();
                if (termEnd) politicalData.termEnd = new Date(termEnd).toISOString();
            } else if (politicalType === 'POLITICAL_ORG') {
                politicalData.office = document.getElementById('editOffice')?.value || ''; // Using office field for org type
                politicalData.campaignWebsite = document.getElementById('editCampaignWebsite')?.value || '';
            }

            try {
                // Update basic profile
                const profileResponse = await apiCall('/users/profile', {
                    method: 'PUT',
                    body: JSON.stringify(profileData)
                });

                // Update political/address info
                const politicalResponse = await apiCall('/political/profile', {
                    method: 'PUT',
                    body: JSON.stringify(politicalData)
                });
                
                console.log('Political profile update response:', politicalResponse.status);

                if (profileResponse.ok && politicalResponse.ok) {
                    // Refresh profile display (loadUserProfile will fetch latest data)
                    loadUserProfile(); // Switch back to view mode
                    
                    // Show different messages based on political type change
                    if (politicalType !== 'CITIZEN' && (currentUser.politicalProfileType === 'CITIZEN' || currentUser.verificationStatus === 'PENDING')) {
                        alert('Profile updated successfully! Your political profile will need to be verified by our team. Please upload verification documents if you haven\'t already.');
                    } else {
                        alert('Profile updated successfully!');
                    }
                } else {
                    alert('Failed to update profile. Please try again.');
                }
            } catch (error) {
                console.error('Profile update error:', error);
                alert('Network error. Please try again.');
            }
        }

        // Trending-specific like and comment functions
        async function likeTrendingPost(postId) {
            if (!authToken) {
                alert('Please log in to like posts');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    // Just update the like count in place, don't refresh whole panel
                    updateLikeCount(postId, data.liked);
                }
            } catch (error) {
                console.error('Failed to like trending post:', error);
            }
        }

        function updateLikeCount(postId, isLiked) {
            // Find the like button for this post and update its count
            const likeButtons = document.querySelectorAll(`[onclick*="likeTrendingPost('${postId}')"]`);
            likeButtons.forEach(button => {
                const currentText = button.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
                const newCount = isLiked ? currentCount + 1 : Math.max(0, currentCount - 1);
                button.innerHTML = `‚ù§Ô∏è ${newCount}`;
            });
        }

        function showTrendingCommentBox(postId) {
            if (!authToken) {
                alert('Please log in to comment');
                return;
            }
            document.getElementById(`trending-comments-${postId}`).style.display = 'block';
        }

        function hideTrendingCommentBox(postId) {
            document.getElementById(`trending-comments-${postId}`).style.display = 'none';
            document.getElementById(`trending-comment-input-${postId}`).value = '';
        }

        async function addTrendingComment(postId) {
            const content = document.getElementById(`trending-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST'
                });

                if (response.ok) {
                    hideTrendingCommentBox(postId);
                    // Just update the comment count, don't refresh whole panel
                    updateCommentCount(postId);
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        function updateCommentCount(postId) {
            // Find the comment button for this post and increment its count
            const commentButtons = document.querySelectorAll(`[onclick*="showTrendingCommentBox('${postId}')"]`);
            commentButtons.forEach(button => {
                const currentText = button.textContent;
                const currentCount = parseInt(currentText.match(/\d+/)?.[0] || '0');
                const newCount = currentCount + 1;
                button.innerHTML = `üí¨ ${newCount}`;
            });
        }

        // Comment Functions
        function showCommentBox(postId) {
            document.getElementById(`comments-${postId}`).style.display = 'block';
        }

        function hideCommentBox(postId) {
            document.getElementById(`comments-${postId}`).style.display = 'none';
            document.getElementById(`comment-input-${postId}`).value = '';
        }

        async function addComment(postId) {
            const content = document.getElementById(`comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    hideCommentBox(postId);
                    // Reload posts to show updated comment count
                    loadUserPosts();
                    // Also refresh trending if that's open
                    if (!document.getElementById('panel-trending').classList.contains('hidden')) {
                        loadTrendingPosts();
                    }
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }

        // Posts Functions
        async function createPost() {
            const content = document.getElementById('postContent').value.trim();

            if (!content) {
                alert('Please enter some content for your post');
                return;
            }

            try {
                const response = await apiCall('/posts', {
                    method: 'POST',
                    body: JSON.stringify({ 
                        content
                    })
                });

                if (response.ok) {
                    document.getElementById('postContent').value = '';
                    loadUserPosts();
                } else {
                    const error = await response.json();
                    alert(error.error || 'Failed to create post');
                }
            } catch (error) {
                console.error('Failed to create post:', error);
                alert('Network error. Please try again.');
            }
        }

        async function loadUserPosts() {
            if (!authToken) return;

            try {
                const response = await apiCall('/posts/me');
                
                if (response.ok) {
                    // Store posts for later display when feed view is shown
                    window.userPostsCache = response.data.posts;
                } else {
                    console.error('Failed to load user posts:', response.data?.error);
                }
            } catch (error) {
                console.error('Failed to load posts:', error);
            }
        }

        function displayPosts(posts, containerId = 'postsFeed', appendMode = false) {
            const feed = document.getElementById(containerId);
            if (!feed) {
                console.warn('Feed container not found:', containerId);
                return;
            }
            
            if (posts.length === 0) {
                if (!appendMode) {
                    feed.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #666;">
                            <h2>Your Posts</h2>
                            <p>You haven't posted anything yet. Share your thoughts above!</p>
                        </div>
                    `;
                }
                return;
            }

            // Use the standardized PostComponent if available
            if (window.postComponent) {
                let html = '';
                
                // Only add header in replace mode, not append mode
                if (!appendMode) {
                    html += '<div class="posts-list">';
                }
                
                posts.forEach(post => {
                    html += window.postComponent.renderPost(post, {
                        showActions: true,
                        showComments: true,
                        showAuthor: true,
                        showTimestamp: true,
                        compactView: false
                    });
                });
                
                if (!appendMode) {
                    html += '</div>';
                    feed.innerHTML = html;
                } else {
                    // Append to existing content
                    feed.insertAdjacentHTML('beforeend', html);
                }
                
                // Add friend status indicators after posts are rendered
                setTimeout(() => addFriendStatusToExistingPosts(containerId, posts), 500);
            } else {
                // Enhanced fallback with friend status indicators
                displayPostsWithFriendStatus(posts, containerId, appendMode);
            }
        }

        function displayPostsFallback(posts, containerId, appendMode = false) {
            const feed = document.getElementById(containerId);
            if (!feed) return;

            let html = '';
            posts.forEach(post => {
                const timeAgo = getTimeAgo(new Date(post.createdAt));
                
                html += `
                    <div class="post-item" data-post-id="${post.id}">
                        <div class="post-header">
                            <div class="user-avatar">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                            <div>
                                <strong>${post.author.firstName || post.author.username}</strong>
                                ${post.author.verified ? '<span style="color: #1976d2;">‚úì</span>' : ''}
                                <br>
                                <small style="color: #666;">@${post.author.username} ‚Ä¢ ${timeAgo}</small>
                            </div>
                        </div>
                        <div class="post-content">${post.content}</div>
                        <div class="post-actions">
                            <span class="post-action" onclick="likePost('${post.id}', event)" style="cursor: pointer; transition: transform 0.2s;">
                                ${post.isLiked ? '‚ù§Ô∏è' : 'üëç'} ${post.likesCount || 0}
                            </span>
                            <span class="post-action" onclick="showCommentBox('${post.id}')">
                                üí¨ Add Comment
                            </span>
                            ${post.commentsCount > 0 ? `<span class="post-action" onclick="viewComments('${post.id}')" style="color: #4b5c09;">üëÅÔ∏è View ${post.commentsCount} Comment${post.commentsCount === 1 ? '' : 's'}</span>` : ''}
                        </div>
                        <div id="comments-${post.id}" class="comments-section" style="display: none; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid #eee;">
                            <textarea id="comment-input-${post.id}" placeholder="Add a comment..." style="width: 100%; height: 60px; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; box-sizing: border-box; resize: vertical;"></textarea>
                            <div style="margin-top: 0.5rem;">
                                <button onclick="addComment('${post.id}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">Comment</button>
                                <button onclick="hideCommentBox('${post.id}')" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; margin-left: 0.5rem;">Cancel</button>
                            </div>
                        </div>
                    </div>
                `;
            });

            if (appendMode) {
                feed.insertAdjacentHTML('beforeend', html);
            } else {
                feed.innerHTML = html;
            }
        }

        async function likePost(postId, event) {
            if (!authToken) {
                alert('Please log in to like posts');
                return;
            }

            // Find the like button element
            const likeElement = event ? event.target.closest('[onclick*="likePost"]') : document.querySelector(`[onclick*="likePost('${postId}'"]`);
            if (!likeElement) return;

            try {
                const response = await apiCall(`/posts/${postId}/like`, {
                    method: 'POST'
                });

                if (response.ok) {
                    const data = await response.json();
                    
                    // Update the UI immediately
                    if (likeElement.tagName === 'BUTTON') {
                        // For button-style like elements (in feed)
                        const countSpan = likeElement.querySelector('span:last-child') || likeElement;
                        const currentCount = parseInt(countSpan.textContent) || 0;
                        const newCount = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
                        
                        // Update the display
                        likeElement.innerHTML = `<span>${data.liked ? '‚ù§Ô∏è' : 'üëç'}</span> ${newCount}`;
                    } else if (likeElement.classList.contains('post-action')) {
                        // For span-style like elements (in profile)
                        const currentCount = parseInt(likeElement.textContent.match(/\d+/)?.[0] || '0');
                        const newCount = data.liked ? currentCount + 1 : Math.max(0, currentCount - 1);
                        likeElement.innerHTML = `${data.liked ? '‚ù§Ô∏è' : 'üëç'} ${newCount}`;
                    }
                    
                    // Add visual feedback
                    likeElement.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        likeElement.style.transform = '';
                    }, 200);
                }
            } catch (error) {
                console.error('Failed to like post:', error);
                alert('Failed to like post. Please try again.');
            }
        }

        async function viewComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // If comments are already visible, hide them
            if (commentsContainer && commentsContainer.style.display === 'block') {
                commentsContainer.style.display = 'none';
                return;
            }

            try {
                // Load comments
                const response = await apiCall(`/posts/${postId}/comments?limit=50`);
                if (!response.ok) {
                    alert('Failed to load comments');
                    return;
                }
                const data = response.data;

                showCommentsInline(postId, data.comments);
            } catch (error) {
                console.error('Failed to load comments:', error);
                alert('Network error. Please try again.');
            }
        }

        function showCommentsInline(postId, comments) {
            let commentsContainer = document.getElementById(`post-comments-${postId}`);
            
            // Create comments container if it doesn't exist
            if (!commentsContainer) {
                const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                if (!postElement) return;
                
                commentsContainer = document.createElement('div');
                commentsContainer.id = `post-comments-${postId}`;
                commentsContainer.style.cssText = 'margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #eee; background: #f9f9f9; border-radius: 8px; padding: 1rem;';
                postElement.appendChild(commentsContainer);
            }

            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h4 style="margin: 0; color: #4b5c09;">Comments (${comments.length})</h4>
                    <button onclick="hideComments('${postId}')" style="background: none; border: none; color: #666; cursor: pointer; font-size: 1.2rem;">&times;</button>
                </div>
            `;

            if (comments.length === 0) {
                html += '<div style="text-align: center; color: #666; padding: 1rem;">No comments yet</div>';
            } else {
                comments.forEach(comment => {
                    html += `
                        <div style="margin-bottom: 1rem; padding: 0.75rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                            <div style="display: flex; align-items: center; margin-bottom: 0.5rem;">
                                <img src="${comment.user.avatar || '/default-avatar.png'}" alt="Avatar" style="width: 24px; height: 24px; border-radius: 50%; margin-right: 0.5rem;">
                                <div>
                                    <div style="font-weight: bold; font-size: 0.85rem;">${comment.user.firstName || comment.user.username} ${comment.user.lastName || ''}</div>
                                    <div style="color: #666; font-size: 0.75rem;">@${comment.user.username}</div>
                                </div>
                                ${comment.user.verified ? '<span style="color: #1d9bf0; margin-left: 5px; font-size: 0.8rem;">‚úì</span>' : ''}
                                <div style="margin-left: auto; color: #666; font-size: 0.75rem;">
                                    ${new Date(comment.createdAt).toLocaleString()}
                                </div>
                            </div>
                            <div style="margin-left: 32px; line-height: 1.4;">
                                ${comment.content}
                            </div>
                        </div>
                    `;
                });
            }

            // Add comment form if user is logged in
            if (authToken) {
                html += `
                    <div style="margin-top: 1rem; padding: 1rem; background: white; border-radius: 8px; border: 1px solid #ddd;">
                        <textarea id="inline-comment-input-${postId}" placeholder="Add a comment..." style="width: 100%; height: 80px; border: 1px solid #ddd; border-radius: 4px; padding: 0.75rem; box-sizing: border-box; resize: vertical; font-family: inherit; font-size: 0.9rem;"></textarea>
                        <div style="margin-top: 0.75rem; text-align: right;">
                            <button onclick="addInlineComment('${postId}')" style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">Post Comment</button>
                        </div>
                    </div>
                `;
            }

            commentsContainer.innerHTML = html;
            commentsContainer.style.display = 'block';
        }

        function hideComments(postId) {
            const commentsContainer = document.getElementById(`post-comments-${postId}`);
            if (commentsContainer) {
                commentsContainer.style.display = 'none';
            }
        }

        async function addInlineComment(postId) {
            const content = document.getElementById(`inline-comment-input-${postId}`).value.trim();
            
            if (!content) {
                alert('Please enter a comment');
                return;
            }

            try {
                const response = await apiCall(`/posts/${postId}/comments`, {
                    method: 'POST',
                    body: JSON.stringify({ content })
                });

                if (response.ok) {
                    // Refresh the comments display
                    viewComments(postId);
                    
                    // Update comment counts in main feeds
                    updateCommentCount(postId);
                } else {
                    const error = response.data || {};
                    alert(error.error || 'Failed to add comment');
                }
            } catch (error) {
                console.error('Failed to add comment:', error);
                alert('Network error. Please try again.');
            }
        }


        // Duplicate removed - using the one defined earlier

        // üéØ OPTIMIZED: Check follow status from cached data (NO API CALLS!)
        function renderFollowButton(userId, containerElement) {
            if (!currentUser || userId === currentUser.id) return '';
            
            try {
                // Get follow status from CACHED data - instant, no API call!
                const status = getCachedRelationshipStatus(userId);
                const isFollowing = status.isFollowing;
                
                const buttonHtml = `
                    <button onclick="toggleFollow('${userId}', this)" 
                        data-user-id="${userId}"
                        data-following="${isFollowing}"
                        style="padding: 0.25rem 0.5rem; background: ${isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        ${isFollowing ? 'Following' : 'Follow'}
                    </button>
                `;
                
                return buttonHtml;
            } catch (error) {
                console.error('Error loading cached follow status:', error);
                return `
                    <button onclick="toggleFollow('${userId}', this)" 
                        data-user-id="${userId}"
                        data-following="false"
                        style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                        Follow
                    </button>
                `;
            }
        }

        // Toggle follow/unfollow based on current state
        async function toggleFollow(userId, buttonElement) {
            const isCurrentlyFollowing = buttonElement.dataset.following === 'true';
            
            if (isCurrentlyFollowing) {
                await unfollowUser(userId, buttonElement);
            } else {
                await followUser(userId, buttonElement);
            }
        }

        // Follow/Unfollow functionality
        async function followUser(userId, buttonElement) {
            try {
                const response = await apiCall(`/users/follow/${userId}`, {
                    method: 'POST'
                });
                
                if (response.ok) {
                    // Update button to show Following state
                    if (buttonElement) {
                        buttonElement.textContent = 'Following';
                        buttonElement.style.background = '#666';
                        buttonElement.dataset.following = 'true';
                    }
                    // Refresh current view if it's profile or user search
                    loadUserProfile();
                } else {
                    alert(response.data?.error || 'Failed to follow user');
                }
            } catch (error) {
                console.error('Failed to follow user:', error);
                alert('Error following user');
            }
        }

        async function unfollowUser(userId, buttonElement) {
            try {
                const response = await apiCall(`/users/follow/${userId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    // Update button back to Follow state
                    if (buttonElement) {
                        buttonElement.textContent = 'Follow';
                        buttonElement.style.background = '#4b5c09';
                        buttonElement.dataset.following = 'false';
                    }
                    // Refresh current view
                    loadUserProfile();
                } else {
                    alert(response.data?.error || 'Failed to unfollow user');
                }
            } catch (error) {
                console.error('Failed to unfollow user:', error);
                alert('Error unfollowing user');
            }
        }

        async function showFollowersList(userId) {
            try {
                const response = await apiCall(`/users/${userId}/followers`);
                
                if (response.ok) {
                    displayUsersList(response.data.followers, 'Followers');
                } else {
                    alert('Failed to load followers');
                }
            } catch (error) {
                console.error('Failed to load followers:', error);
                alert('Error loading followers');
            }
        }

        async function showFollowingList(userId) {
            try {
                const response = await apiCall(`/users/${userId}/following`);
                
                if (response.ok) {
                    displayUsersList(response.data.following, 'Following');
                } else {
                    alert('Failed to load following list');
                }
            } catch (error) {
                console.error('Failed to load following list:', error);
                alert('Error loading following list');
            }
        }

        function displayUsersList(users, title) {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
                background: rgba(0,0,0,0.5); z-index: 1000; 
                display: flex; align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1vh; padding: 1vh; min-height: 2vh;">
                        <h3 style="margin: 0;">${title}</h3>
                        <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                    </div>
                    <div>
                        ${users.length === 0 ? 
                            `<p style="text-align: center; color: #666; padding: 2rem;">No ${title.toLowerCase()} yet</p>` :
                            users.map(user => `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 0.75rem; border-bottom: 1px solid #eee;">
                                    <div style="display: flex; align-items: center;">
                                        <div class="user-avatar" style="margin-right: 0.75rem;">${(user.firstName?.[0] || user.username[0]).toUpperCase()}</div>
                                        <div>
                                            <div style="font-weight: bold; font-size: 0.9rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                                            <div style="color: #666; font-size: 0.8rem;">@${user.username}</div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 0.5rem;">
                                        ${user.id !== currentUser?.id ? `
                                            <button onclick="followUser('${user.id}', this)" 
                                                style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                                Follow
                                            </button>
                                            <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                                style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                                Message
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            `).join('')
                        }
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        /**
         * ENHANCED SEARCH SYSTEM
         * Comprehensive search across users, posts, officials, topics with advanced filtering
         */

        // Global search state
        let currentSearchQuery = '';
        let currentSearchResults = {
            users: [],
            posts: [],
            officials: [],
            topics: []
        };

        // Enhanced search functionality
        function openSearch() {
            document.getElementById('searchContainer').style.display = 'flex';
            closeAllPanels(); // Close other panels
            document.getElementById('searchInput').focus();
            
            // Initialize search if there's already a query
            const searchInput = document.getElementById('searchInput');
            if (searchInput.value.length >= 2) {
                performGlobalSearch(searchInput.value);
            }
        }

        function closeSearch() {
            document.getElementById('searchContainer').style.display = 'none';
            document.getElementById('searchInput').value = '';
            currentSearchQuery = '';
            currentSearchResults = { users: [], posts: [], officials: [], topics: [] };
            
            // Reset filters
            document.querySelector('input[name="searchType"][value="all"]').checked = true;
            document.getElementById('locationFilter').value = '';
            document.getElementById('timeFilter').value = '';
            document.getElementById('topicFilter').value = '';
            document.getElementById('advancedFilters').style.display = 'none';
            document.getElementById('advancedFiltersToggle').textContent = '‚ñº Advanced Filters';
            
            document.getElementById('globalSearchResults').innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    Start typing to search across users, posts, officials, and topics
                </div>
            `;
        }

        // Toggle advanced filters
        function toggleAdvancedFilters() {
            const filtersDiv = document.getElementById('advancedFilters');
            const toggleSpan = document.getElementById('advancedFiltersToggle');
            
            if (filtersDiv.style.display === 'none') {
                filtersDiv.style.display = 'block';
                toggleSpan.textContent = '‚ñ≤ Advanced Filters';
            } else {
                filtersDiv.style.display = 'none';
                toggleSpan.textContent = '‚ñº Advanced Filters';
            }
        }

        let globalSearchTimeout;
        async function performGlobalSearch(query) {
            clearTimeout(globalSearchTimeout);
            currentSearchQuery = query;
            
            if (!query || query.length < 2) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Type at least 2 characters to search
                    </div>
                `;
                return;
            }

            // Show loading state
            document.getElementById('globalSearchResults').innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <div style="margin-bottom: 1rem;">üîç Searching...</div>
                    <div style="font-size: 0.9rem;">Looking across users, posts, officials, and topics</div>
                </div>
            `;

            globalSearchTimeout = setTimeout(async () => {
                await executeEnhancedSearch(query);
            }, 300);
        }

        // Update search results when filters change
        async function updateSearchResults() {
            if (currentSearchQuery && currentSearchQuery.length >= 2) {
                await executeEnhancedSearch(currentSearchQuery);
            }
        }

        // Enhanced search execution with multiple content types
        async function executeEnhancedSearch(query) {
            if (!authToken) {
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        Please log in to search
                    </div>
                `;
                return;
            }

            try {
                // Get current filters
                const searchType = document.querySelector('input[name="searchType"]:checked').value;
                const locationFilter = document.getElementById('locationFilter').value;
                const timeFilter = document.getElementById('timeFilter').value;
                const topicFilter = document.getElementById('topicFilter').value;
                
                // Build search parameters
                const searchParams = new URLSearchParams({
                    q: query,
                    limit: '20'
                });
                
                if (locationFilter) searchParams.append('location', locationFilter);
                if (timeFilter) searchParams.append('time', timeFilter);
                if (topicFilter) searchParams.append('topic', topicFilter);

                // Execute searches based on type
                let searchPromises = [];
                
                if (searchType === 'all') {
                    // üéØ OPTIMIZED: Use unified search endpoint (1 call instead of 4)
                    searchPromises = [
                        apiCall(`/search/unified?${searchParams.toString()}&types=users,posts,officials,topics`).catch(() => ({ok: false, data: {users: [], posts: [], officials: [], topics: []}}))
                    ];
                } else if (searchType === 'candidates') {
                    // For candidates filter, search officials but filter client-side
                    const endpoint = `/search/unified?${searchParams.toString()}&types=officials`;
                    searchPromises = [apiCall(endpoint)];
                } else {
                    // Search specific type - use unified endpoint with single type
                    const endpoint = `/search/unified?${searchParams.toString()}&types=${searchType}`;
                    searchPromises = [apiCall(endpoint)];
                }

                const results = await Promise.all(searchPromises);
                
                // üéØ OPTIMIZED: Process unified search results (single response contains all data)
                const result = results[0];
                if (result.ok && result.data && result.data.data) {
                    const searchData = result.data.data;
                    currentSearchResults = {
                        users: searchData.users || [],
                        posts: searchData.posts || [],
                        officials: searchData.officials || [],
                        topics: searchData.topics || []
                    };
                    
                    if (searchType === 'all') {
                        displayAllSearchResults();
                    } else {
                        displayFilteredSearchResults(searchType);
                    }
                } else {
                    // Fallback to empty results
                    currentSearchResults = {
                        users: [],
                        posts: [],
                        officials: [],
                        topics: []
                    };
                    
                    if (searchType === 'all') {
                        displayAllSearchResults();
                    } else {
                        displayFilteredSearchResults(searchType);
                    }
                }

            } catch (error) {
                console.error('Enhanced search error:', error);
                document.getElementById('globalSearchResults').innerHTML = `
                    <div style="text-align: center; color: #d32f2f; padding: 2rem;">
                        Search error occurred. Please try again.
                    </div>
                `;
            }
        }

        /**
         * ENHANCED SEARCH RESULT DISPLAY FUNCTIONS
         * Support for users, posts, officials, topics with rich formatting
         */

        // Display all search results with category sections
        function displayAllSearchResults() {
            const resultsContainer = document.getElementById('globalSearchResults');
            const { users, posts, officials, topics } = currentSearchResults;
            
            // Separate candidates from officials
            const candidates = officials ? officials.filter(o => o.politicalProfileType === 'CANDIDATE') : [];
            const actualOfficials = officials ? officials.filter(o => o.politicalProfileType === 'ELECTED_OFFICIAL') : [];
            
            const totalResults = users.length + posts.length + candidates.length + actualOfficials.length + topics.length;
            
            if (totalResults === 0) {
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <h3>No Results Found</h3>
                        <p>Try different keywords or adjust your filters</p>
                    </div>
                `;
                return;
            }

            let html = `
                <div style="padding: 1rem; border-bottom: 1px solid #eee; background: #f9f9f9; font-weight: bold; color: #4b5c09;">
                    Found ${totalResults} results for "${currentSearchQuery}"
                </div>
            `;

            // Display each category with results
            if (users.length > 0) {
                html += renderSearchSection('üë§ Users', users, renderUserResult);
            }
            if (candidates.length > 0) {
                html += renderSearchSection('üó≥Ô∏è Candidates', candidates, renderCandidateResult);
            }
            if (actualOfficials.length > 0) {
                html += renderSearchSection('üèõÔ∏è Officials', actualOfficials, renderOfficialResult);
            }
            if (posts.length > 0) {
                html += renderSearchSection('üìù Posts', posts, renderPostResult);
            }
            if (topics.length > 0) {
                html += renderSearchSection('üè∑Ô∏è Topics', topics, renderTopicResult);
            }

            resultsContainer.innerHTML = html;
        }

        // Display filtered results for a specific type
        function displayFilteredSearchResults(type) {
            const resultsContainer = document.getElementById('globalSearchResults');
            let results = currentSearchResults[type];
            
            // Handle separation of candidates and officials
            if (type === 'officials') {
                results = currentSearchResults.officials ? currentSearchResults.officials.filter(o => o.politicalProfileType === 'ELECTED_OFFICIAL') : [];
            } else if (type === 'candidates') {
                results = currentSearchResults.officials ? currentSearchResults.officials.filter(o => o.politicalProfileType === 'CANDIDATE') : [];
            }
            
            if (results.length === 0) {
                const typeLabels = {
                    users: 'üë§ Users',
                    posts: 'üìù Posts', 
                    officials: 'üèõÔ∏è Officials',
                    candidates: 'üó≥Ô∏è Candidates',
                    topics: 'üè∑Ô∏è Topics'
                };
                
                resultsContainer.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <h3>No ${typeLabels[type]} Found</h3>
                        <p>Try different keywords or remove filters</p>
                    </div>
                `;
                return;
            }

            const renderFunctions = {
                users: renderUserResult,
                posts: renderPostResult,
                officials: renderOfficialResult,
                candidates: renderCandidateResult,
                topics: renderTopicResult
            };

            let html = results.map(result => renderFunctions[type](result)).join('');
            resultsContainer.innerHTML = html;
        }

        // Helper function to render search sections
        function renderSearchSection(title, results, renderFunction) {
            return `
                <div style="background: #f5f5f5; padding: 0.5rem 1rem; font-weight: bold; color: #4b5c09; border-bottom: 1px solid #ddd;">
                    ${title} (${results.length})
                </div>
                ${results.slice(0, 5).map(result => renderFunction(result)).join('')}
                ${results.length > 5 ? `
                    <div style="padding: 0.5rem 1rem; text-align: center; color: #666; font-size: 0.9rem; border-bottom: 1px solid #eee;">
                        +${results.length - 5} more results...
                    </div>
                ` : ''}
            `;
        }

        // Render individual result types
        function renderUserResult(user) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="openUserProfile('${user.id}', '${user.username}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div class="user-avatar" style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}</div>
                        <div style="color: #666; font-size: 0.9rem;">@${user.username}</div>
                        <div style="color: #666; font-size: 0.8rem;">${user.followersCount || 0} followers${user.state ? ` ‚Ä¢ ${user.state}` : ''}${user.district ? ` ‚Ä¢ District ${user.district}` : ''}</div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        ${user.verified ? '<span style="color: #1d9bf0; margin-right: 0.5rem;">‚úì</span>' : ''}
                        ${user.id !== currentUser?.id ? `
                            <button onclick="window.FollowUtils.toggleFollow('${user.id}', ${user.isFollowing || false})" 
                                style="padding: 0.25rem 0.5rem; background: ${user.isFollowing ? '#666' : '#4b5c09'}; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                ${user.isFollowing ? 'Following' : 'Follow'}
                            </button>
                            <button onclick="window.FriendUtils.sendFriendRequest('${user.id}')" 
                                style="padding: 0.25rem 0.5rem; background: #2196F3; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; margin-right: 0.25rem;">
                                Add Friend
                            </button>
                            <button onclick="startConversationWithUser('${user.id}', '${user.username}')" 
                                style="padding: 0.25rem 0.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                Message
                            </button>
                        ` : '<span style="color: #666; font-size: 0.8rem;">You</span>'}
                    </div>
                </div>
            `;
        }

        function renderPostResult(post) {
            const timeAgo = getTimeAgo(new Date(post.createdAt));
            return `
                <div class="search-result-item" style="padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="showPostInFeed('${post.id}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="display: flex; align-items: start; gap: 0.75rem;">
                        <div class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;">
                            ${(post.author?.firstName?.[0] || post.author?.username?.[0] || 'U').toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 0.9rem; margin-bottom: 0.25rem;">
                                ${post.author?.firstName ? `${post.author.firstName} ${post.author.lastName || ''}` : post.author?.username || 'Unknown User'}
                                <span style="color: #666; font-weight: normal;">@${post.author?.username || 'unknown'} ‚Ä¢ ${timeAgo}</span>
                            </div>
                            <div style="color: #333; line-height: 1.4; margin-bottom: 0.5rem;">
                                ${post.content.length > 150 ? post.content.substring(0, 150) + '...' : post.content}
                            </div>
                            <div style="color: #666; font-size: 0.8rem; display: flex; gap: 1rem;">
                                <span>‚ù§Ô∏è ${post.likesCount || 0}</span>
                                <span>üí¨ ${post.commentsCount || 0}</span>
                                ${post.topics ? `<span>üè∑Ô∏è ${post.topics.slice(0, 2).join(', ')}</span>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderOfficialResult(official) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="${official.politicalProfileType === 'CANDIDATE' ? `openUserProfile('${official.id}', '${official.username}')` : `showOfficialDetails('${official.id}')`}" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #1976d2; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        üèõÔ∏è
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${official.name || (official.firstName ? `${official.firstName} ${official.lastName || ''}` : official.username || 'Unknown')}</div>
                        <div style="color: #666; font-size: 0.9rem;">${official.office || official.officialTitle || official.title || 'Office Unknown'} ${official.politicalProfileType === 'ELECTED_OFFICIAL' ? '(Incumbent)' : ''}</div>
                        <div style="color: #666; font-size: 0.8rem;">
                            ${official.party ? `${official.party} ‚Ä¢ ` : ''}${official.state || official.district || 'Federal'}
                            ${official.chamber ? ` ‚Ä¢ ${official.chamber}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        <button onclick="viewOfficialProfile('${official.id}')" 
                            style="padding: 0.25rem 0.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            View Profile
                        </button>
                        ${official.contactInfo ? `
                            <button onclick="contactOfficial('${official.id}')" 
                                style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                                Contact
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderCandidateResult(candidate) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="openUserProfile('${candidate.id}', '${candidate.username}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        üó≥Ô∏è
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${candidate.firstName ? `${candidate.firstName} ${candidate.lastName || ''}` : candidate.username}</div>
                        <div style="color: #666; font-size: 0.9rem;">${candidate.office || candidate.officialTitle || 'Office Unknown'} Candidate</div>
                        <div style="color: #666; font-size: 0.8rem;">
                            ${candidate.politicalParty ? `${candidate.politicalParty} ‚Ä¢ ` : ''}${candidate.state || 'Location Unknown'}
                            ${candidate.candidateStatus ? ` ‚Ä¢ ${candidate.candidateStatus}` : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        <button onclick="openUserProfile('${candidate.id}', '${candidate.username}')" 
                            style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            View Profile
                        </button>
                        ${candidate.isExternallySourced ? `
                            <span style="padding: 0.25rem 0.5rem; background: #17a2b8; color: white; border-radius: 4px; font-size: 0.7rem;">
                                External
                            </span>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTopicResult(topic) {
            return `
                <div class="search-result-item" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onclick="enterTopicMode('${topic.id}')" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                    <div style="margin-right: 1rem; width: 40px; height: 40px; border-radius: 50%; background: #ff9800; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">
                        üè∑Ô∏è
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; font-size: 1rem;">${topic.name}</div>
                        <div style="color: #666; font-size: 0.9rem; margin-bottom: 0.25rem;">
                            ${topic.description || 'Political discussion topic'}
                        </div>
                        <div style="color: #666; font-size: 0.8rem; display: flex; gap: 1rem;">
                            <span>üìù ${topic.postCount || 0} posts</span>
                            <span>üë• ${topic.participantCount || 0} participants</span>
                            ${topic.trending ? '<span style="color: #ff9800;">üî• Trending</span>' : ''}
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;" onclick="event.stopPropagation()">
                        <button onclick="enterTopicMode('${topic.id}')" 
                            style="padding: 0.25rem 0.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            View Topic
                        </button>
                    </div>
                </div>
            `;
        }

        /**
         * SEARCH RESULT ACTION FUNCTIONS
         * Handle clicks on different types of search results
         */

        // Open user profile (enhanced version)
        async function openUserProfile(userId, username) {
            try {
                closeSearch();
                
                // Show loading state
                const mainContent = document.getElementById('mainContent');
                mainContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading @${username}'s Profile</h2>
                        <p>Loading profile and posts...</p>
                    </div>
                `;

                // Load user's profile using the MyProfile component
                if (window.MyProfile) {
                    await window.MyProfile.showUserProfile(userId);
                } else {
                    // Fallback to basic profile view
                    await openUserFeed(userId, username);
                }
                
            } catch (error) {
                console.error('Failed to open user profile:', error);
                showToast('Failed to load user profile');
            }
        }

        // Show specific post in feed
        async function showPostInFeed(postId) {
            try {
                closeSearch();
                
                // Load single post and display in My Feed
                const response = await apiCall(`/posts/${postId}`);
                if (response.ok && response.data) {
                    // Show the post in main content
                    showMyFeedInMain();
                    
                    // Highlight the specific post
                    setTimeout(() => {
                        const postElement = document.querySelector(`[data-post-id="${postId}"]`);
                        if (postElement) {
                            postElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            postElement.style.border = '2px solid #4b5c09';
                            postElement.style.borderRadius = '8px';
                            setTimeout(() => {
                                postElement.style.border = '';
                                postElement.style.borderRadius = '';
                            }, 3000);
                        }
                    }, 1000);
                    
                    showToast('Post found in feed');
                } else {
                    showToast('Post not found or not accessible');
                }
                
            } catch (error) {
                console.error('Failed to show post:', error);
                showToast('Failed to load post');
            }
        }

        // Show official details
        async function showOfficialDetails(officialId) {
            try {
                closeSearch();
                
                // Load official information in main content
                const mainContent = document.getElementById('mainContent');
                mainContent.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading Official Information</h2>
                        <p>Loading details...</p>
                    </div>
                `;

                const response = await apiCall(`/legislative/officials/${officialId}`);
                if (response.ok && response.data) {
                    const official = response.data;
                    displayOfficialProfile(official);
                } else {
                    mainContent.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #d32f2f;">
                            <h2>Official Not Found</h2>
                            <p>Could not load official information</p>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Failed to load official:', error);
                showToast('Failed to load official information');
            }
        }

        // Display official profile in main content
        function displayOfficialProfile(official) {
            const mainContent = document.getElementById('mainContent');
            
            mainContent.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; padding: 2rem;">
                    <div style="background: white; border-radius: 8px; padding: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: flex; align-items: center; margin-bottom: 2rem;">
                            <div style="width: 80px; height: 80px; border-radius: 50%; background: #1976d2; color: white; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-right: 1.5rem;">
                                üèõÔ∏è
                            </div>
                            <div>
                                <h1 style="margin: 0; font-size: 2rem; color: #333;">${official.name}</h1>
                                <h2 style="margin: 0.5rem 0; font-size: 1.3rem; color: #666; font-weight: normal;">${official.office || official.title}</h2>
                                <div style="color: #666; font-size: 1rem;">
                                    ${official.party ? `${official.party} ‚Ä¢ ` : ''}${official.state || official.district || 'Federal'}
                                    ${official.chamber ? ` ‚Ä¢ ${official.chamber}` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <h3 style="color: #4b5c09; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">Contact Information</h3>
                                ${official.phone ? `<p><strong>Phone:</strong> ${official.phone}</p>` : ''}
                                ${official.email ? `<p><strong>Email:</strong> ${official.email}</p>` : ''}
                                ${official.website ? `<p><strong>Website:</strong> <a href="${official.website}" target="_blank">${official.website}</a></p>` : ''}
                                ${official.address ? `<p><strong>Address:</strong> ${official.address}</p>` : ''}
                            </div>
                            <div>
                                <h3 style="color: #4b5c09; border-bottom: 2px solid #4b5c09; padding-bottom: 0.5rem;">Political Information</h3>
                                ${official.nextElection ? `<p><strong>Next Election:</strong> ${official.nextElection}</p>` : ''}
                                ${official.termStart ? `<p><strong>Term Start:</strong> ${official.termStart}</p>` : ''}
                                ${official.termEnd ? `<p><strong>Term End:</strong> ${official.termEnd}</p>` : ''}
                                ${official.committees ? `<p><strong>Committees:</strong> ${official.committees.join(', ')}</p>` : ''}
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            ${official.contactInfo ? `
                                <button onclick="contactOfficial('${official.id}')" style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
                                    Contact ${official.name}
                                </button>
                            ` : ''}
                            <button onclick="viewVotingRecords('${official.bioguideId || official.id}')" style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
                                View Voting Records
                            </button>
                            <button onclick="viewOfficialNews('${official.name}')" style="padding: 0.75rem 1.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 1rem;">
                                Recent News
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Enter topic mode (integrate with existing topic navigation)
        async function enterTopicMode(topicId) {
            try {
                closeSearch();
                
                // Use existing topic navigation system if available
                if (window.TopicNavigation && typeof window.TopicNavigation.enterTopic === 'function') {
                    await window.TopicNavigation.enterTopic(topicId);
                    showToast('Viewing topic discussions');
                } else {
                    // Fallback to basic topic view
                    showMyFeedInMain();
                    showToast('Topic mode activated - showing related posts');
                }
                
            } catch (error) {
                console.error('Failed to enter topic mode:', error);
                showToast('Failed to load topic');
            }
        }

        // Placeholder functions for official actions
        function contactOfficial(officialId) {
            showToast('Contact feature coming soon!');
        }

        function viewOfficialProfile(officialId) {
            showOfficialDetails(officialId);
        }

        function viewVotingRecords(bioguideId) {
            if (window.LegislativeIntegration) {
                window.LegislativeIntegration.showVotingRecords(bioguideId);
            } else {
                showToast('Voting records feature coming soon!');
            }
        }

        function viewOfficialNews(officialName) {
            if (window.LegislativeIntegration) {
                window.LegislativeIntegration.showOfficialNews(officialName);
            } else {
                showToast('Official news feature coming soon!');
            }
        }

        // Legacy function for compatibility
        async function openUserFeed(userId, username) {
            try {
                closeSearch();
                
                // Show loading state
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Loading @${username}'s Profile</h2>
                        <p>Loading profile and posts...</p>
                    </div>
                `;

                // Load user's profile and posts in parallel
                const [profileResponse, postsResponse] = await Promise.all([
                    apiCall(`/users/${username}`),
                    apiCall(`/posts/user/${userId}`)
                ]);
                
                if (profileResponse.ok && postsResponse.ok) {
                    const userProfile = profileResponse.data.user;
                    const posts = postsResponse.data.posts || [];
                    
                    // Create profile header
                    let html = `
                        <div style="background: linear-gradient(135deg, #4b5c09 0%, #6b7f1a 100%); color: white; padding: 2rem; margin-bottom: 1rem; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                                <div style="display: flex; align-items: center; gap: 1rem;">
                                    <div style="width: 80px; height: 80px; border-radius: 50%; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 2rem; font-weight: bold;">
                                        ${(userProfile.firstName?.[0] || userProfile.username[0]).toUpperCase()}
                                    </div>
                                    <div>
                                        <h1 style="margin: 0; font-size: 1.8rem;">
                                            ${userProfile.firstName ? `${userProfile.firstName} ${userProfile.lastName || ''}` : userProfile.username}
                                            ${userProfile.verified ? '<span style="color: #ffd700; margin-left: 0.5rem;">‚úì</span>' : ''}
                                        </h1>
                                        <p style="margin: 0.25rem 0; font-size: 1.1rem; opacity: 0.9;">@${userProfile.username}</p>
                                        <div style="display: flex; gap: 1rem; margin-top: 0.5rem; font-size: 0.9rem; opacity: 0.8;">
                                            <span><strong>${userProfile.followersCount || 0}</strong> followers</span>
                                            <span><strong>${userProfile.followingCount || 0}</strong> following</span>
                                            <span>Joined ${new Date(userProfile.createdAt).toLocaleDateString()}</span>
                                        </div>
                                    </div>
                                </div>
                                <button onclick="loadTrendingPosts(); showMainFeed();" style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                    Back to Main Feed
                                </button>
                            </div>
                            
                            ${userProfile.bio ? `<div style="margin-bottom: 1rem; font-size: 1rem; line-height: 1.4;">${userProfile.bio}</div>` : ''}
                            
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; font-size: 0.9rem; opacity: 0.9;">
                                ${userProfile.location ? `<span>üìç ${userProfile.location}</span>` : ''}
                                ${userProfile.website ? `<span>üîó <a href="${userProfile.website}" target="_blank" style="color: #ffd700;">${userProfile.website}</a></span>` : ''}
                            </div>
                            
                            ${userId !== currentUser?.id ? `
                                <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                    <button onclick="toggleFollow('${userId}', this)" 
                                        data-user-id="${userId}"
                                        style="padding: 0.5rem 1rem; background: #fff; color: #4b5c09; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                                        Follow
                                    </button>
                                    <button onclick="startConversationWithUser('${userId}', '${username}')" 
                                        style="padding: 0.5rem 1rem; background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.3); border-radius: 4px; cursor: pointer;">
                                        Message
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                        
                        <div style="border-bottom: 2px solid #4b5c09; margin-bottom: 1rem; padding-bottom: 0.5rem;">
                            <h2 style="margin: 0; color: #4b5c09; font-size: 1.3rem;">Posts (${posts.length})</h2>
                        </div>
                    `;
                    
                    if (posts.length === 0) {
                        html += `
                            <div style="text-align: center; padding: 2rem; color: #666;">
                                <p style="margin: 0; font-size: 1.1rem;">This user hasn't posted anything yet.</p>
                            </div>
                        `;
                    } else {
                        // Render posts
                        posts.forEach(post => {
                            html += `
                                <div class="post-item" data-post-id="${post.id}" style="background: white; padding: 1.5rem; margin-bottom: 1rem; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                                        <div style="display: flex; align-items: center;">
                                            <div class="user-avatar" style="margin-right: 0.75rem; width: 40px; height: 40px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;">${(post.author.firstName?.[0] || post.author.username[0]).toUpperCase()}</div>
                                            <div>
                                                <div style="font-weight: bold;">
                                                    ${post.author.firstName ? `${post.author.firstName} ${post.author.lastName || ''}` : post.author.username}
                                                    ${post.author.verified ? '<span style="color: #1d9bf0; margin-left: 0.25rem;">‚úì</span>' : ''}
                                                </div>
                                                <div style="color: #666; font-size: 0.9rem;">@${post.author.username} ‚Ä¢ ${new Date(post.createdAt).toLocaleDateString()}</div>
                                            </div>
                                        </div>
                                        <div style="color: #666; font-size: 0.8rem;">${new Date(post.createdAt).toLocaleTimeString()}</div>
                                    </div>
                                    
                                    <div style="margin-bottom: 1rem; line-height: 1.5;">
                                        ${post.content}
                                    </div>
                                    
                                    ${post.imageUrl ? `<img src="${post.imageUrl}" alt="Post image" style="max-width: 100%; height: auto; border-radius: 8px; margin-bottom: 1rem;">` : ''}
                                    
                                    <div style="display: flex; gap: 1rem; color: #666; font-size: 0.9rem; border-top: 1px solid #eee; padding-top: 0.75rem;">
                                        <button onclick="likePost('${post.id}', event)" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: all 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>${post.isLiked ? '‚ù§Ô∏è' : 'üëç'}</span> <span>${post.likesCount || 0}</span>
                                        </button>
                                        <button onclick="toggleComments('${post.id}')" style="background: none; border: none; color: #666; cursor: pointer; display: flex; align-items: center; gap: 0.25rem; padding: 0.25rem 0.5rem; border-radius: 4px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='transparent'">
                                            <span>üí¨</span> ${post.commentsCount || 0}
                                        </button>
                                    </div>
                                </div>
                            `;
                        });
                    }

                    feedElement.innerHTML = html;
                } else {
                    feedElement.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <h2>Error Loading Profile</h2>
                            <p style="color: #d32f2f;">Unable to load @${username}'s profile and posts</p>
                            <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Back to Main Feed
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading user feed:', error);
                const feedElement = document.getElementById('postsFeed');
                feedElement.innerHTML = `
                    <div style="text-align: center; padding: 2rem;">
                        <h2>Network Error</h2>
                        <p style="color: #d32f2f;">Unable to load @${username}'s profile</p>
                        <button onclick="loadTrendingPosts(); showMainFeed();" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Back to Main Feed
                        </button>
                    </div>
                `;
            }
        }

        function showMainFeed() {
            // Reset to main feed view - could load trending or user's own posts
            loadTrendingPosts();
        }

        async function addFriend(userId) {
            console.log('Adding friend:', userId);
            // TODO: Implement friend request functionality
        }

        // Map zoom and location functionality
        let mapInstance = null;
        let currentLocation = null;
        let currentZoomLevel = 'national'; // Track current zoom level (default to match radio button)
        let boundaryManager = null;

        // Boundary management class
        class BoundaryManager {
            constructor(map) {
                this.map = map;
                this.layers = new Map();
                this.cache = new Map();
                this.loadLocalCache();
            }
            
            // Load cached boundary data from localStorage
            loadLocalCache() {
                try {
                    const cached = localStorage.getItem('boundaryCache');
                    if (cached) {
                        const parsedCache = JSON.parse(cached);
                        // Check if cache is less than 30 days old
                        const cacheAge = Date.now() - (parsedCache.timestamp || 0);
                        if (cacheAge < 30 * 24 * 60 * 60 * 1000) { // 30 days
                            Object.entries(parsedCache.data || {}).forEach(([key, value]) => {
                                this.cache.set(key, value);
                            });
                            console.log(`Loaded ${this.cache.size} cached boundaries from localStorage`);
                        } else {
                            localStorage.removeItem('boundaryCache');
                        }
                    }
                } catch (error) {
                    console.warn('Failed to load boundary cache:', error);
                    localStorage.removeItem('boundaryCache');
                }
            }
            
            // Save boundary cache to localStorage
            saveLocalCache() {
                try {
                    const cacheData = {
                        timestamp: Date.now(),
                        data: Object.fromEntries(this.cache)
                    };
                    localStorage.setItem('boundaryCache', JSON.stringify(cacheData));
                } catch (error) {
                    console.warn('Failed to save boundary cache:', error);
                }
            }
            
            async loadBoundary(type, identifier, state) {
                const key = `${type}-${state}-${identifier || 'state'}`;
                
                // Check cache first
                if (this.cache.has(key)) {
                    console.log(`Using cached boundary for ${key}`);
                    this.displayBoundary(key, this.cache.get(key), type);
                    return;
                }
                
                // Try multiple sources for boundary data
                const sources = [
                    // Primary source - raw GitHub content (more reliable)
                    {
                        name: 'GitHub raw',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://raw.githubusercontent.com/unitedstates/districts/main/states/${state}/shape.geojson`;
                            }
                        }
                    },
                    // Fallback to theunitedstates.io (if SSL issue is fixed)
                    {
                        name: 'theunitedstates.io',
                        getUrl: (type, state, identifier) => {
                            if (type === 'district') {
                                return `https://theunitedstates.io/districts/cds/2012/${state}-${identifier}/shape.geojson`;
                            } else if (type === 'state') {
                                return `https://theunitedstates.io/districts/states/${state}/shape.geojson`;
                            }
                        }
                    }
                ];
                
                for (const source of sources) {
                    try {
                        const url = source.getUrl(type, state, identifier);
                        if (!url) continue;
                        
                        console.log(`Fetching boundary data from ${source.name}: ${url}`);
                        
                        const response = await fetch(url, {
                            mode: 'cors',
                            credentials: 'omit'
                        });
                        
                        if (!response.ok) {
                            console.warn(`HTTP ${response.status} from ${source.name}`);
                            continue;
                        }
                        
                        const geojsonData = await response.json();
                        
                        // Cache the data in memory and localStorage
                        this.cache.set(key, geojsonData);
                        this.saveLocalCache();
                        
                        console.log(`Successfully loaded boundary from ${source.name}`);
                        
                        // Display boundary
                        this.displayBoundary(key, geojsonData, type);
                        return;
                        
                    } catch (error) {
                        console.warn(`Failed to load boundary from ${source.name}:`, error);
                        continue;
                    }
                }
                
                console.error(`Failed to load ${type} boundary from all sources for ${key}`);
            }
            
            displayBoundary(key, geojsonData, type) {
                // Remove existing layer if present
                this.removeBoundary(key);
                
                const style = type === 'district' ? {
                    color: '#ff6b35',
                    weight: 3,
                    opacity: 0.8,
                    fillColor: '#ff6b35',
                    fillOpacity: 0.1
                } : {
                    color: '#4b5c09',
                    weight: 2,
                    opacity: 0.6,
                    fillColor: '#4b5c09',
                    fillOpacity: 0.05
                };
                
                const layer = L.geoJSON(geojsonData, { style }).addTo(this.map);
                this.layers.set(key, layer);
                console.log(`${type} boundary loaded and displayed`);
            }
            
            removeBoundary(key) {
                if (this.layers.has(key)) {
                    this.map.removeLayer(this.layers.get(key));
                    this.layers.delete(key);
                }
            }
            
            clearAll() {
                this.layers.forEach(layer => this.map.removeLayer(layer));
                this.layers.clear();
            }
        }

        function setMapInstance(map) {
            mapInstance = map;
            boundaryManager = new BoundaryManager(map);
            
            // Try to get user location, with fallback
            setTimeout(() => {
                if (currentUser && currentUser.state) {
                    getCurrentUserLocation();
                } else {
                    currentLocation = { lat: 37.8283, lng: -98.5795 }; // Center of US
                }
            }, 500); // Wait for user data to load
        }

        async function getCurrentUserLocation() {
            try {
                if (currentUser && currentUser.zipCode && currentUser.state) {
                    // Use user's stored address for location
                    const address = currentUser.city ? 
                        `${currentUser.city}, ${currentUser.state} ${currentUser.zipCode}` :
                        `${currentUser.zipCode}, ${currentUser.state}`;
                    
                    const coords = await geocodeLocation(address);
                    if (coords) {
                        currentLocation = coords;
                        // Only set zoom level if we're not at national level (to avoid moving away from default)
                        if (currentZoomLevel !== 'national') {
                            await setZoomLevel(currentZoomLevel);
                        }
                        
                        // Load representative data to get district info
                        loadElectedOfficials();
                    }
                }
            } catch (error) {
                console.error('Error getting user location:', error);
                currentLocation = { lat: 37.8283, lng: -98.5795 }; // Fallback
            }
        }

        async function geocodeLocation(address) {
            try {
                // Using a free geocoding service - you might want to use your existing Geocod.io API
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}&limit=1`);
                const data = await response.json();
                
                if (data.length > 0) {
                    return {
                        lat: parseFloat(data[0].lat),
                        lng: parseFloat(data[0].lon)
                    };
                }
                return null;
            } catch (error) {
                console.error('Geocoding error:', error);
                return null;
            }
        }

        async function geocodeAndZoom() {
            const locationInput = document.getElementById('locationInput');
            const address = locationInput.value.trim();
            
            if (!address) {
                // Use current location if no address provided
                getCurrentUserLocation();
                return;
            }

            const coords = await geocodeLocation(address);
            if (coords) {
                currentLocation = coords;
                // Apply current zoom level to new location
                await setZoomLevel(currentZoomLevel);
            } else {
                alert('Location not found. Please try a different address.');
            }
        }

        async function setZoomLevel(level) {
            if (USE_MAPLIBRE && window.map && window.map.setZoomLevel) {
                // Use MapLibre zoom level method
                window.map.setZoomLevel(level);
                updateRadioButtonState(level);
                return;
            }
            
            if (!mapInstance) return;

            // Original Leaflet implementation
            // Update current zoom level and radio button state
            currentZoomLevel = level;
            updateRadioButtonState(level);

            let zoom, bounds;
            
            // Clear existing boundaries
            if (boundaryManager) {
                boundaryManager.clearAll();
            }
            
            console.log(`Setting zoom level: ${level}`);
            console.log(`Current user:`, currentUser);
            console.log(`Current user state: ${currentUser?.state}, district: ${currentUser?.district}`);
            console.log(`Current location:`, currentLocation);
            
            switch(level) {
                case 'national':
                    // Show national view - different zoom levels for expanded vs collapsed
                    const isCollapsed = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsed ? 3 : 5;
                    mapInstance.setView([37.8283, -98.5795], zoom); // Center of US
                    console.log(`Set to national view (zoom: ${zoom}, collapsed: ${isCollapsed})`);
                    // No boundaries at national level
                    break;
                    
                case 'state':
                    // Zoom to show state and surrounding areas - adjust zoom for map size
                    const isCollapsedState = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedState ? 5 : 7;
                    
                    console.log(`STATE ZOOM: Checking if currentUser.state exists:`, currentUser?.state);
                    
                    if (currentUser && currentUser.state) {
                        console.log(`Flying to state geographic center for: ${currentUser.state}`);
                        // Get state center coordinates and fly there
                        const stateCenter = await getStateCenterCoordinates(currentUser.state);
                        console.log(`State center result:`, stateCenter);
                        if (stateCenter) {
                            console.log(`Flying to state center: ${stateCenter.lat}, ${stateCenter.lng} with zoom ${zoom}`);
                            mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            console.log(`Map setView called successfully`);
                            
                            // Load state boundary
                            if (boundaryManager) {
                                console.log(`Loading state boundary for: ${currentUser.state}`);
                                boundaryManager.loadBoundary('state', null, currentUser.state);
                            }
                        } else {
                            console.log('State center not found, using US center fallback');
                            mapInstance.setView([37.8283, -98.5795], zoom);
                        }
                    } else {
                        console.log('ERROR: No user state info available - this should not happen for State zoom!');
                        console.log('Current user object:', currentUser);
                        // DO NOT fall back to US center for State zoom - that's wrong!
                        console.error('State zoom requested but no state data available');
                    }
                    break;
                    
                case 'local':
                    // Zoom to user's actual address - adjust zoom for map size
                    const isCollapsedLocal = document.getElementById('mapContainer').classList.contains('collapsed');
                    zoom = isCollapsedLocal ? 9 : 11;
                    
                    console.log(`LOCAL ZOOM: Checking user address data - zipCode: ${currentUser?.zipCode}, city: ${currentUser?.city}, state: ${currentUser?.state}`);
                    
                    if (currentUser && (currentUser.zipCode || currentUser.city) && currentUser.state) {
                        // Build address from user profile
                        let userAddress = '';
                        if (currentUser.streetAddress && currentUser.city) {
                            userAddress = `${currentUser.streetAddress}, ${currentUser.city}, ${currentUser.state}`;
                            if (currentUser.zipCode) userAddress += ` ${currentUser.zipCode}`;
                        } else if (currentUser.city) {
                            userAddress = `${currentUser.city}, ${currentUser.state}`;
                        } else if (currentUser.zipCode) {
                            userAddress = `${currentUser.zipCode}, ${currentUser.state}`;
                        }
                        
                        console.log(`Flying to user's address: ${userAddress}`);
                        
                        // Geocode the user's address and fly there
                        const addressCoords = await geocodeLocation(userAddress);
                        console.log(`Address geocoding result:`, addressCoords);
                        if (addressCoords) {
                            console.log(`Flying to address coordinates: ${addressCoords.lat}, ${addressCoords.lng} with zoom ${zoom}`);
                            mapInstance.setView([addressCoords.lat, addressCoords.lng], zoom);
                            console.log(`Map setView called for address successfully`);
                            
                            // Load district boundary if we have district info
                            if (boundaryManager && currentUser.district) {
                                console.log(`Loading district boundary: ${currentUser.state}-${currentUser.district}`);
                                boundaryManager.loadBoundary('district', currentUser.district, currentUser.state);
                            }
                        } else {
                            console.log('Address geocoding failed, using state center fallback');
                            // Fallback to state center
                            const stateCenter = await getStateCenterCoordinates(currentUser.state);
                            if (stateCenter) {
                                mapInstance.setView([stateCenter.lat, stateCenter.lng], zoom);
                            } else {
                                mapInstance.setView([37.8283, -98.5795], zoom);
                            }
                        }
                    } else {
                        console.log('ERROR: No user address info available - this should not happen for Local zoom!');
                        console.log('User address fields:', {
                            streetAddress: currentUser?.streetAddress,
                            city: currentUser?.city,
                            state: currentUser?.state,
                            zipCode: currentUser?.zipCode
                        });
                        // DO NOT fall back to US center for Local zoom - that's wrong!
                        console.error('Local zoom requested but no address data available');
                    }
                    break;
            }
        }
        
        function updateRadioButtonState(level) {
            // Update radio button to match current zoom level
            const radios = document.querySelectorAll('input[name="zoomLevel"]');
            radios.forEach(radio => {
                radio.checked = radio.value === level;
            });
        }

        // Helper function to get state center coordinates
        async function getStateCenterCoordinates(stateAbbr) {
            // State center coordinates (approximate geographic centers)
            const stateCenters = {
                'AL': { lat: 32.806671, lng: -86.791130 },
                'AK': { lat: 61.370716, lng: -152.404419 },
                'AZ': { lat: 33.729759, lng: -111.431221 },
                'AR': { lat: 34.969704, lng: -92.373123 },
                'CA': { lat: 36.116203, lng: -119.681564 },
                'CO': { lat: 39.059811, lng: -105.311104 },
                'CT': { lat: 41.597782, lng: -72.755371 },
                'DE': { lat: 39.318523, lng: -75.507141 },
                'FL': { lat: 27.766279, lng: -81.686783 },
                'GA': { lat: 33.040619, lng: -83.643074 },
                'HI': { lat: 21.094318, lng: -157.498337 },
                'ID': { lat: 44.240459, lng: -114.478828 },
                'IL': { lat: 40.349457, lng: -88.986137 },
                'IN': { lat: 39.849426, lng: -86.258278 },
                'IA': { lat: 42.011539, lng: -93.210526 },
                'KS': { lat: 38.526600, lng: -96.726486 },
                'KY': { lat: 37.668140, lng: -84.670067 },
                'LA': { lat: 31.169546, lng: -91.867805 },
                'ME': { lat: 44.693947, lng: -69.381927 },
                'MD': { lat: 39.063946, lng: -76.802101 },
                'MA': { lat: 42.230171, lng: -71.530106 },
                'MI': { lat: 43.326618, lng: -84.536095 },
                'MN': { lat: 45.694454, lng: -93.900192 },
                'MS': { lat: 32.741646, lng: -89.678696 },
                'MO': { lat: 38.456085, lng: -92.288368 },
                'MT': { lat: 47.097633, lng: -110.362566 },
                'NE': { lat: 41.492537, lng: -99.901813 },
                'NV': { lat: 38.313515, lng: -117.055374 },
                'NH': { lat: 43.452492, lng: -71.563896 },
                'NJ': { lat: 40.298904, lng: -74.521011 },
                'NM': { lat: 34.840515, lng: -106.248482 },
                'NY': { lat: 42.165726, lng: -74.948051 },
                'NC': { lat: 35.630066, lng: -79.806419 },
                'ND': { lat: 47.528912, lng: -99.784012 },
                'OH': { lat: 40.388783, lng: -82.764915 },
                'OK': { lat: 35.565342, lng: -96.928917 },
                'OR': { lat: 44.572021, lng: -122.070938 },
                'PA': { lat: 40.590752, lng: -77.209755 },
                'RI': { lat: 41.680893, lng: -71.51178 },
                'SC': { lat: 33.856892, lng: -80.945007 },
                'SD': { lat: 44.299782, lng: -99.438828 },
                'TN': { lat: 35.747845, lng: -86.692345 },
                'TX': { lat: 31.054487, lng: -97.563461 },
                'UT': { lat: 40.150032, lng: -111.862434 },
                'VT': { lat: 44.045876, lng: -72.710686 },
                'VA': { lat: 37.769337, lng: -78.169968 },
                'WA': { lat: 47.400902, lng: -121.490494 },
                'WV': { lat: 38.491226, lng: -80.954570 },
                'WI': { lat: 44.268543, lng: -89.616508 },
                'WY': { lat: 42.755966, lng: -107.302490 }
            };
            
            return stateCenters[stateAbbr.toUpperCase()] || null;
        }

        // Helper function to get district center coordinates
        async function getDistrictCenterCoordinates(stateAbbr, districtNumber) {
            try {
                // Try to fetch the district boundary data to calculate center
                const url = `https://theunitedstates.io/districts/cds/2012/${stateAbbr.toUpperCase()}-${districtNumber}/shape.geojson`;
                const response = await fetch(url);
                
                if (response.ok) {
                    const geojsonData = await response.json();
                    
                    // Calculate the center of the district from its geometry
                    const center = calculateGeometryCenter(geojsonData);
                    if (center) {
                        console.log(`District center calculated: ${center.lat}, ${center.lng}`);
                        return center;
                    }
                }
                
                console.warn(`Could not fetch district boundary for ${stateAbbr}-${districtNumber}`);
                return null;
            } catch (error) {
                console.error('Error getting district center:', error);
                return null;
            }
        }

        // Helper function to calculate the center of a GeoJSON geometry
        function calculateGeometryCenter(geojsonData) {
            try {
                if (!geojsonData.features || geojsonData.features.length === 0) {
                    return null;
                }
                
                let totalLat = 0;
                let totalLng = 0;
                let pointCount = 0;
                
                geojsonData.features.forEach(feature => {
                    if (feature.geometry.type === 'Polygon') {
                        const coordinates = feature.geometry.coordinates[0]; // First ring (exterior)
                        coordinates.forEach(coord => {
                            totalLng += coord[0];
                            totalLat += coord[1];
                            pointCount++;
                        });
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        feature.geometry.coordinates.forEach(polygon => {
                            const coordinates = polygon[0]; // First ring of each polygon
                            coordinates.forEach(coord => {
                                totalLng += coord[0];
                                totalLat += coord[1];
                                pointCount++;
                            });
                        });
                    }
                });
                
                if (pointCount > 0) {
                    return {
                        lat: totalLat / pointCount,
                        lng: totalLng / pointCount
                    };
                }
                
                return null;
            } catch (error) {
                console.error('Error calculating geometry center:', error);
                return null;
            }
        }

        // Initialize location input with user's address if available
        function updateLocationPlaceholder() {
            setTimeout(() => {
                if (currentUser && currentUser.city && currentUser.state) {
                    const locationInput = document.getElementById('locationInput');
                    if (locationInput) {
                        locationInput.placeholder = `${currentUser.city}, ${currentUser.state}`;
                    }
                }
            }, 100);
        }

        // Call when user data is loaded
        window.addEventListener('load', () => {
            setTimeout(updateLocationPlaceholder, 1000);
        });

        // Password validation and UI functions
        function togglePasswordVisibility(fieldId) {
            const field = document.getElementById(fieldId);
            const button = field.nextElementSibling;
            
            if (field.type === 'password') {
                field.type = 'text';
                button.textContent = 'üôà';
            } else {
                field.type = 'password';
                button.textContent = 'üëÅÔ∏è';
            }
        }

        function validatePassword(password) {
            const requirements = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password)
            };

            const isValid = Object.values(requirements).every(req => req);
            const hasContent = password.length > 0;
            
            // Show/hide requirements based on focus and content
            const reqContainer = document.getElementById('password-requirements');
            const statusIndicator = document.getElementById('password-status');
            
            if (hasContent && !isValid) {
                // Show detailed requirements when typing but not valid
                reqContainer.style.display = 'block';
                statusIndicator.style.display = 'none';
            } else if (isValid) {
                // Show green checkmark when valid, hide requirements
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'block';
            } else {
                // Hide both when empty
                reqContainer.style.display = 'none';
                statusIndicator.style.display = 'none';
            }

            // Update individual requirement indicators
            updateRequirement('req-length', requirements.length);
            updateRequirement('req-uppercase', requirements.uppercase);
            updateRequirement('req-lowercase', requirements.lowercase);
            updateRequirement('req-number', requirements.number);
            updateRequirement('req-special', requirements.special);

            return isValid;
        }

        function updateRequirement(elementId, met) {
            const element = document.getElementById(elementId);
            if (element) {
                if (met) {
                    element.classList.add('met');
                    element.textContent = element.textContent.replace('‚Ä¢ ', '');
                } else {
                    element.classList.remove('met');
                    if (!element.textContent.startsWith('‚Ä¢ ')) {
                        element.textContent = '‚Ä¢ ' + element.textContent.replace('‚úì ', '');
                    }
                }
            }
        }

        // Add real-time password validation
        document.addEventListener('DOMContentLoaded', function() {
            const passwordField = document.getElementById('registerPassword');
            if (passwordField) {
                passwordField.addEventListener('input', function() {
                    validatePassword(this.value);
                });
            }
        });

        // Debug hCaptcha loading
        function checkHCaptchaStatus() {
            const widget = document.getElementById('hcaptcha-register');
            const hasIframe = widget && widget.querySelector('iframe');
            const widgetId = widget ? widget.getAttribute('data-hcaptcha-widget-id') : null;
            let response = null;
            
            try {
                if (window.hcaptcha && window.hcaptcha.getResponse) {
                    if (widgetId) {
                        response = window.hcaptcha.getResponse(widgetId);
                    } else {
                        response = window.hcaptcha.getResponse();
                    }
                }
            } catch (error) {
                console.log('hCaptcha getResponse error:', error.message);
            }
            
            console.log('hCaptcha status:', {
                loaded: typeof window.hcaptcha !== 'undefined',
                widgetExists: widget !== null,
                hasIframe: hasIframe !== null,
                widgetId: widgetId,
                sitekey: document.querySelector('[data-sitekey]')?.getAttribute('data-sitekey'),
                currentResponse: response ? 'has response' : 'no response',
                responseLength: response ? response.length : 0,
                domain: window.location.hostname
            });
        }

        // Global hCaptcha callback function
        window.onHCaptchaCallback = function(token) {
            console.log('hCaptcha completed successfully!', { tokenLength: token ? token.length : 0 });
            // Store the token in a global variable for easy access
            window.hCaptchaToken = token;
        };

        // Check hCaptcha after page load (let it auto-render)
        window.addEventListener('load', function() {
            setTimeout(() => {
                checkHCaptchaStatus();
                // No manual rendering needed - hCaptcha script auto-renders widgets with data-sitekey
                console.log('Relying on hCaptcha auto-render via data-sitekey attribute');
            }, 2000);
        });

        // ========================================
        // Background Image Functionality
        // ========================================

        async function handleBackgroundImageSelect(input) {
            if (!input.files || !input.files[0]) return;

            const file = input.files[0];
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select a valid image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Please select an image smaller than 5MB');
                return;
            }

            try {
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('backgroundPreview');
                    if (preview) {
                        preview.style.backgroundImage = `url(${e.target.result})`;
                        preview.textContent = '';
                    }
                };
                reader.readAsDataURL(file);

                // Upload the image
                const formData = new FormData();
                formData.append('backgroundImage', file);

                const response = await apiCall('/users/background-image', {
                    method: 'POST',
                    body: formData,
                    skipContentType: true
                });

                if (response.ok) {
                    console.log('‚úÖ Background image uploaded successfully');
                    
                    // Update current user data
                    if (currentUser) {
                        currentUser.backgroundImage = response.data.backgroundImage;
                    }
                    
                    // Apply the background to current views
                    applyUserBackground(response.data.backgroundImage);
                    
                    // Show success message
                    showToast('Background image updated successfully!');
                    
                } else {
                    alert('Failed to upload background image: ' + (response.data?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Background image upload error:', error);
                alert('Failed to upload background image. Please try again.');
            }
        }

        async function removeBackgroundImage() {
            if (!confirm('Are you sure you want to remove your background image?')) {
                return;
            }

            try {
                const response = await apiCall('/users/background-image', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    console.log('‚úÖ Background image removed successfully');
                    
                    // Update current user data
                    if (currentUser) {
                        currentUser.backgroundImage = null;
                    }
                    
                    // Remove background from current views
                    applyUserBackground(null);
                    
                    // Update preview
                    const preview = document.getElementById('backgroundPreview');
                    if (preview) {
                        preview.style.backgroundImage = '';
                        preview.textContent = 'No background set';
                    }
                    
                    // Show success message
                    showToast('Background image removed successfully!');
                    
                } else {
                    alert('Failed to remove background image: ' + (response.data?.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Background image removal error:', error);
                alert('Failed to remove background image. Please try again.');
            }
        }

        function applyUserBackground(backgroundImageUrl) {
            // Apply to My Profile
            const myProfileElements = document.querySelectorAll('.my-profile');
            myProfileElements.forEach(element => {
                if (backgroundImageUrl) {
                    element.style.backgroundImage = `url(${backgroundImageUrl})`;
                    element.classList.add('has-background');
                } else {
                    element.style.backgroundImage = '';
                    element.classList.remove('has-background');
                }
            });

            // Apply to My Feed main content area (corrected per documentation)
            const myFeedContent = document.getElementById('myFeedPosts');
            if (myFeedContent) {
                if (backgroundImageUrl) {
                    myFeedContent.style.backgroundImage = `url(${backgroundImageUrl})`;
                    myFeedContent.classList.add('has-background');
                } else {
                    myFeedContent.style.backgroundImage = '';
                    myFeedContent.classList.remove('has-background');
                }
            }
        }

        function applyBackgroundForUser(user) {
            // Function to apply background when viewing another user's profile
            if (user && user.backgroundImage) {
                // Apply to user profile elements
                const profileElements = document.querySelectorAll('.user-profile, .profile-view');
                profileElements.forEach(element => {
                    element.style.backgroundImage = `url(${user.backgroundImage})`;
                    element.classList.add('has-background');
                });
            }
        }

        // Initialize background on app load
        function initializeUserBackground() {
            if (currentUser && currentUser.backgroundImage) {
                applyUserBackground(currentUser.backgroundImage);
            }
        }

        // Call this when user data is loaded
        window.addEventListener('userDataLoaded', initializeUserBackground);

        // ============================================================================
        // NOTIFICATION SYSTEM - Handles friend requests, likes, comments, etc.
        // ============================================================================
        
        let notificationsCache = [];
        let notificationDropdownOpen = false;

        // Simple toast notification function
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast-notification show';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        // Toggle notifications dropdown
        async function toggleNotifications() {
            if (!authToken) {
                alert('Please log in to view notifications');
                return;
            }

            const notificationDropdown = document.getElementById('notificationDropdown');
            
            if (!notificationDropdown) {
                // Create notification dropdown if it doesn't exist
                createNotificationDropdown();
            }
            
            if (notificationDropdownOpen) {
                closeNotifications();
            } else {
                await openNotifications();
            }
        }

        // Create notification dropdown HTML
        function createNotificationDropdown() {
            const notificationSection = document.getElementById('notificationSection');
            const dropdown = document.createElement('div');
            dropdown.id = 'notificationDropdown';
            dropdown.className = 'notification-dropdown';
            dropdown.style.cssText = `
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #ddd;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                width: 350px;
                max-height: 400px;
                overflow-y: auto;
                z-index: 1000;
                display: none;
            `;
            
            notificationSection.style.position = 'relative';
            notificationSection.appendChild(dropdown);
        }

        // Open notifications dropdown
        async function openNotifications() {
            notificationDropdownOpen = true;
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.style.display = 'block';
            dropdown.innerHTML = '<div style="padding: 1rem; text-align: center;">Loading notifications...</div>';
            
            try {
                await fetchNotifications();
                displayNotifications();
            } catch (error) {
                console.error('Error fetching notifications:', error);
                dropdown.innerHTML = '<div style="padding: 1rem; text-align: center; color: #d32f2f;">Failed to load notifications</div>';
            }
        }

        // Close notifications dropdown
        function closeNotifications() {
            notificationDropdownOpen = false;
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown) {
                dropdown.style.display = 'none';
            }
        }

        // Fetch notifications from API
        async function fetchNotifications() {
            const response = await apiCall('/notifications', {
                method: 'GET'
            });
            
            if (response.ok) {
                notificationsCache = response.data.notifications || [];
                updateNotificationBadge();
                return notificationsCache;
            } else {
                throw new Error('Failed to fetch notifications');
            }
        }

        // Display notifications in dropdown
        function displayNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            
            if (notificationsCache.length === 0) {
                dropdown.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #666;">
                        <span style="font-size: 2rem;">üîî</span>
                        <p>No notifications yet</p>
                    </div>
                `;
                return;
            }

            // üéØ OPTIMIZED: Add batch mark-all-read functionality
            const unreadNotifications = notificationsCache.filter(n => !n.read);
            const hasUnread = unreadNotifications.length > 0;
            
            let html = `
                <div style="padding: 1rem; border-bottom: 1px solid #eee; background: #f8f9fa; display: flex; justify-content: space-between; align-items: center;">
                    <h6 style="margin: 0; font-weight: bold;">Notifications</h6>
                    ${hasUnread ? `
                        <button onclick="markAllNotificationsRead()" 
                                style="padding: 0.25rem 0.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem;">
                            Mark All Read (${unreadNotifications.length})
                        </button>
                    ` : ''}
                </div>
                <div class="notifications-list">
            `;

            notificationsCache.forEach(notification => {
                const timeAgo = getTimeAgo(new Date(notification.createdAt));
                const isUnread = !notification.read;
                
                html += `
                    <div class="notification-item ${isUnread ? 'unread' : ''}" data-notification-id="${notification.id}" 
                         onclick="handleNotificationClick('${notification.id}', '${notification.type}')"
                         style="padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; ${isUnread ? 'background: #f0f7ff;' : ''} hover:background: #f5f5f5;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <div style="font-size: 1.5rem;">${getNotificationIcon(notification.type)}</div>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: ${isUnread ? 'bold' : 'normal'}; margin-bottom: 0.25rem;">
                                    ${getNotificationTitle(notification)}
                                </div>
                                <div style="font-size: 0.85rem; color: #666; overflow: hidden; text-overflow: ellipsis;">
                                    ${notification.message || ''}
                                </div>
                                <div style="font-size: 0.8rem; color: #999; margin-top: 0.25rem;">
                                    ${timeAgo}
                                </div>
                            </div>
                            ${isUnread ? '<div style="width: 8px; height: 8px; background: #1976d2; border-radius: 50%; flex-shrink: 0;"></div>' : ''}
                        </div>
                    </div>
                `;
            });

            html += '</div>';
            dropdown.innerHTML = html;
        }

        // Get notification icon based on type
        function getNotificationIcon(type) {
            const icons = {
                'friend_request': 'üë•',
                'friend_accepted': '‚úÖ',
                'post_like': '‚ù§Ô∏è',
                'post_comment': 'üí¨',
                'mention': 'üè∑Ô∏è',
                'follow': 'üë§',
                'system': '‚öôÔ∏è',
                'admin_message': 'üõ°Ô∏è',
                'ADMIN_MESSAGE': 'üõ°Ô∏è'
            };
            return icons[type] || 'üîî';
        }

        // Get notification title based on type and content
        function getNotificationTitle(notification) {
            const data = notification.data || {};
            
            switch (notification.type) {
                case 'friend_request':
                    return `Friend request from ${data.senderName || 'someone'}`;
                case 'friend_accepted':
                    return `${data.accepterName || 'Someone'} accepted your friend request`;
                case 'post_like':
                    return `${data.likerName || 'Someone'} liked your post`;
                case 'post_comment':
                    return `${data.commenterName || 'Someone'} commented on your post`;
                case 'follow':
                    return `${data.followerName || 'Someone'} started following you`;
                case 'mention':
                    return `${data.mentionerName || 'Someone'} mentioned you`;
                case 'admin_message':
                case 'ADMIN_MESSAGE':
                    return `New message from site administrator`;
                default:
                    return notification.title || 'New notification';
            }
        }

        // üéØ OPTIMIZED: Batch mark all notifications as read (1 API call instead of N calls)
        async function markAllNotificationsRead() {
            try {
                const unreadNotifications = notificationsCache.filter(n => !n.read);
                if (unreadNotifications.length === 0) return;
                
                const notificationIds = unreadNotifications.map(n => n.id);
                
                // Use batch endpoint instead of individual calls
                const response = await apiCall('/notifications/mark-read-batch', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ notificationIds })
                });
                
                if (response.ok) {
                    // Update local cache
                    notificationsCache = notificationsCache.map(n => 
                        notificationIds.includes(n.id) ? { ...n, read: true } : n
                    );
                    
                    // Update UI
                    displayNotifications();
                    updateNotificationBadge();
                    
                    showToast(`${response.data.updatedCount} notifications marked as read`);
                } else {
                    showToast('Failed to mark notifications as read', 'error');
                }
            } catch (error) {
                console.error('Error marking all notifications as read:', error);
                showToast('Error marking notifications as read', 'error');
            }
        }

        // Handle notification click
        async function handleNotificationClick(notificationId, type) {
            // Mark as read
            try {
                await apiCall(`/notifications/${notificationId}/read`, {
                    method: 'PUT'
                });
                
                // Update UI
                const notificationItem = document.querySelector(`[data-notification-id="${notificationId}"]`);
                if (notificationItem) {
                    notificationItem.classList.remove('unread');
                    notificationItem.style.background = '';
                    notificationItem.style.fontWeight = 'normal';
                }
                
                // Update local cache
                notificationsCache = notificationsCache.map(n => 
                    n.id === notificationId ? { ...n, read: true } : n
                );
                
                // Update badge
                updateNotificationBadge();
                
            } catch (error) {
                console.error('Error marking notification as read:', error);
            }

            // Handle different notification types
            switch (type) {
                case 'friend_request':
                    // Open friend requests view
                    showFriendRequestsPanel();
                    break;
                case 'friend_accepted':
                    // Could open their profile or friends list
                    break;
                case 'post_like':
                case 'post_comment':
                    // Could open the specific post
                    break;
                case 'admin_message':
                case 'ADMIN_MESSAGE':
                    // Open My Profile on Messages tab
                    if (window.myProfile) {
                        showMyProfile();
                        setTimeout(() => {
                            window.myProfile.switchTab('messages');
                        }, 100);
                    }
                    break;
                // Add more cases as needed
            }
            
            closeNotifications();
        }

        // Update notification badge count
        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            
            const unreadCount = notificationsCache.filter(n => !n.read).length;
            
            if (unreadCount > 0) {
                badge.textContent = unreadCount > 99 ? '99+' : unreadCount;
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        // Update notification UI with new real-time notification
        function updateNotificationUI(notification) {
            console.log('üîî Updating notification UI with:', notification);
            
            // Add new notification to cache at the beginning (most recent first)
            if (!notificationsCache.find(n => n.id === notification.id)) {
                notificationsCache.unshift(notification);
            }
            
            // If notifications dropdown is open, refresh it
            const dropdown = document.getElementById('notificationDropdown');
            if (dropdown && dropdown.style.display !== 'none') {
                displayNotifications();
            }
            
            // Update badge count
            updateNotificationBadge();
        }

        // Show notification toast/popup (optional enhancement)
        function showNotificationToast(notification) {
            // Create simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: #4b5c09;
                color: white;
                padding: 1rem;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                max-width: 300px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            toast.innerHTML = `
                <div style="display: flex; align-items: center; gap: 0.5rem;">
                    <span style="font-size: 1.2rem;">üîî</span>
                    <div>
                        <div style="font-weight: bold; font-size: 0.9rem;">${notification.type}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9;">${notification.message}</div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after 4 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 4000);
        }

        // Initialize notifications when user logs in
        function initializeNotifications() {
            if (authToken) {
                fetchNotifications().catch(console.error);
                
                // Note: No polling - notifications refresh triggered by events
                // For future: Consider WebSocket/SSE for real-time notifications
            }
        }

        // Global functions for push-based message refresh
        window.triggerAdminRefresh = function() {
            console.log('üîÑ Triggering admin refresh...');
            // Refresh admin dashboard if profiles tab is active
            if (typeof loadCandidateProfiles === 'function' && 
                document.getElementById('profilesTab')?.classList.contains('active')) {
                loadCandidateProfiles();
            }
            // Refresh notifications
            if (authToken && typeof fetchNotifications === 'function') {
                fetchNotifications().catch(console.error);
            }
        };

        window.triggerCandidateRefresh = function(candidateId) {
            console.log('üîÑ Triggering candidate refresh for:', candidateId);
            // Refresh candidate messages if they're on messages tab
            if (window.myProfile && 
                window.myProfile.currentTab === 'messages' &&
                typeof window.myProfile.loadCandidateMessages === 'function') {
                window.myProfile.loadCandidateMessages();
            }
            // Refresh notifications
            if (authToken && typeof fetchNotifications === 'function') {
                fetchNotifications().catch(console.error);
            }
        };


        // Close notifications when clicking outside
        document.addEventListener('click', (event) => {
            if (notificationDropdownOpen) {
                const notificationSection = document.getElementById('notificationSection');
                if (notificationSection && !notificationSection.contains(event.target)) {
                    closeNotifications();
                }
            }
        });

        // ============================================================================
        // FRIEND REQUESTS PANEL - Shows pending friend requests for easy management
        // ============================================================================

        // Show friend requests panel
        async function showFriendRequestsPanel() {
            try {
                const response = await apiCall('/relationships/friend-requests/pending', {
                    method: 'GET'
                });

                if (response.ok) {
                    const requests = response.data.requests || [];
                    displayFriendRequestsPanel(requests);
                } else {
                    showToast('Failed to load friend requests');
                }
            } catch (error) {
                console.error('Error loading friend requests:', error);
                showToast('Error loading friend requests');
            }
        }

        // Display friend requests panel
        function displayFriendRequestsPanel(requests) {
            const mainContent = document.getElementById('mainContent');
            
            let html = `
                <div class="friend-requests-panel" style="padding: 2rem; max-width: 600px; margin: 0 auto;">
                    <div style="display: flex; align-items: center; margin-bottom: 2rem;">
                        <h2 style="margin: 0; flex: 1;">Friend Requests</h2>
                        <button onclick="showDefaultView()" style="background: #666; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                            Back to Feed
                        </button>
                    </div>
            `;

            if (requests.length === 0) {
                html += `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                        <h3>No Friend Requests</h3>
                        <p>You don't have any pending friend requests at the moment.</p>
                    </div>
                `;
            } else {
                html += '<div class="friend-requests-list">';
                
                requests.forEach(request => {
                    const user = request.user1Id === currentUser?.id ? request.user2 : request.user1;
                    html += `
                        <div class="friend-request-item" style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; display: flex; align-items: center; gap: 1rem;">
                            <div class="user-avatar" style="width: 60px; height: 60px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;">
                                ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                            </div>
                            <div style="flex: 1;">
                                <h4 style="margin: 0 0 0.25rem 0;">
                                    ${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}
                                </h4>
                                <p style="margin: 0; color: #666; font-size: 0.9rem;">@${user.username}</p>
                                <p style="margin: 0.5rem 0 0 0; color: #666; font-size: 0.85rem;">
                                    Sent ${getTimeAgo(new Date(request.createdAt))}
                                </p>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="handleFriendRequestAction('${user.id}', 'accept')" 
                                        style="background: #4b5c09; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                    Accept
                                </button>
                                <button onclick="handleFriendRequestAction('${user.id}', 'reject')" 
                                        style="background: #d32f2f; color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                                    Decline
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
            }

            html += '</div>';
            mainContent.innerHTML = html;
        }

        // Handle friend request actions (accept/reject)
        async function handleFriendRequestAction(userId, action) {
            try {
                let result;
                if (action === 'accept') {
                    result = await window.FriendUtils.acceptFriendRequest(userId);
                } else if (action === 'reject') {
                    result = await window.FriendUtils.rejectFriendRequest(userId);
                }

                if (result && result.success) {
                    // Refresh the friend requests panel
                    showFriendRequestsPanel();
                    
                    // Also refresh notifications to clear the friend request notification
                    if (window.initializeNotifications) {
                        initializeNotifications();
                    }
                }
            } catch (error) {
                console.error(`Error ${action}ing friend request:`, error);
                showToast(`Failed to ${action} friend request`);
            }
        }

        /**
         * FRIEND STATUS INDICATORS SYSTEM
         * Displays friend status throughout the site: posts, profiles, user lists
         */

        // Create friend status indicator badge
        function createFriendStatusBadge(userId, status, size = 'small') {
            if (!userId || userId === window.currentUser?.id) return '';
            
            const badgeStyles = {
                small: 'font-size: 0.7rem; padding: 0.15rem 0.4rem; margin-left: 0.25rem;',
                medium: 'font-size: 0.8rem; padding: 0.25rem 0.5rem; margin-left: 0.5rem;',
                large: 'font-size: 0.9rem; padding: 0.35rem 0.6rem; margin-left: 0.5rem;'
            };

            const statusConfig = {
                friends: {
                    icon: 'üë•',
                    text: 'Friend',
                    color: '#4b5c09',
                    bgColor: '#f0f8e0'
                },
                request_sent: {
                    icon: '‚è≥',
                    text: 'Request Sent',
                    color: '#666',
                    bgColor: '#f5f5f5'
                },
                request_received: {
                    icon: 'üì©',
                    text: 'Pending Request',
                    color: '#ff9800',
                    bgColor: '#fff3e0'
                },
                following: {
                    icon: 'üëÅÔ∏è',
                    text: 'Following',
                    color: '#1976d2',
                    bgColor: '#e3f2fd'
                }
            };

            const config = statusConfig[status];
            if (!config) return '';

            return `
                <span class="friend-status-badge friend-status-${status}" 
                      style="display: inline-block; background: ${config.bgColor}; color: ${config.color}; 
                             border-radius: 12px; ${badgeStyles[size]} font-weight: 500; border: 1px solid ${config.color}20;">
                    ${config.icon} ${config.text}
                </span>
            `;
        }

        // OPTIMIZED: Check friend status from cached data (NO API CALLS!)
        function getCachedRelationshipStatus(userId) {
            if (!window.userRelationships) {
                // Try to load from localStorage if not in memory
                const cached = localStorage.getItem('userRelationships');
                if (cached) {
                    window.userRelationships = JSON.parse(cached);
                } else {
                    return { isFriend: false, isFollowing: false, isFollower: false };
                }
            }

            return {
                isFriend: window.userRelationships.friends?.includes(userId) || false,
                requestSent: window.userRelationships.friendRequests?.sent?.includes(userId) || false,
                requestReceived: window.userRelationships.friendRequests?.received?.includes(userId) || false,
                isFollowing: window.userRelationships.following?.includes(userId) || false,
                isFollower: window.userRelationships.followers?.includes(userId) || false
                // TODO: Add isBlocked when blocking system is implemented
            };
        }

        // Add friend status indicators to post headers (NO API CALLS!)
        function addFriendStatusToPost(postElement, authorId) {
            if (!authorId || authorId === window.currentUser?.id) return;

            try {
                // Get status from CACHED data - instant, no API call!
                const status = getCachedRelationshipStatus(authorId);
                
                // Find the post header where we'll add the status
                const postHeader = postElement.querySelector('.post-header small');
                if (!postHeader) return;

                // Determine which status to show (priority: friend > follow > none)
                let displayStatus = null;
                if (status.isFriend) {
                    displayStatus = 'friends';
                } else if (status.requestSent) {
                    displayStatus = 'request_sent';
                } else if (status.requestReceived) {
                    displayStatus = 'request_received';
                } else if (status.isFollowing) {
                    displayStatus = 'following';
                }

                if (displayStatus) {
                    const badge = createFriendStatusBadge(authorId, displayStatus, 'small');
                    postHeader.insertAdjacentHTML('beforeend', badge);
                }
            } catch (error) {
                // Should never happen now since we're using cached data
                console.warn('Failed to add friend status to post:', error);
            }
        }

        // Enhanced post display with friend status indicators (NO API CALLS!)
        async function displayPostsWithFriendStatus(posts, containerId = 'postsFeed', appendMode = false) {
            // First display posts normally
            displayPostsFallback(posts, containerId, appendMode);
            
            // Then add friend status indicators
            const container = document.getElementById(containerId);
            if (!container) return;

            const postElements = container.querySelectorAll('.post-item');
            
            // Process all posts instantly - no API calls needed!
            const batchSize = 10;
            for (let i = 0; i < posts.length; i += batchSize) {
                const batch = posts.slice(i, i + batchSize);
                const promises = batch.map((post, index) => {
                    const postElement = postElements[i + index];
                    if (postElement && post.author) {
                        return addFriendStatusToPost(postElement, post.author.id);
                    }
                });
                
                await Promise.all(promises);
                
                // Small delay between batches to prevent API rate limiting
                if (i + batchSize < posts.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }

        // Create comprehensive user relationship display component
        async function createUserRelationshipDisplay(userId, size = 'medium', inline = false) {
            if (!userId || userId === window.currentUser?.id) return '';

            try {
                const status = await window.RelationshipUtils.getCombinedStatus(userId);
                
                const containerStyle = inline 
                    ? 'display: inline-flex; align-items: center; gap: 0.5rem;'
                    : 'display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;';

                let html = `<div class="user-relationship-display" style="${containerStyle}">`;

                // Friend status and button
                if (status.friend.isFriend) {
                    html += createFriendStatusBadge(userId, 'friends', size);
                    html += `<button onclick="window.FriendUtils.removeFriend('${userId}')" 
                                    class="btn btn-outline-danger btn-sm" style="margin-left: 0.5rem;">
                                Remove Friend
                             </button>`;
                } else if (status.friend.friendshipStatus === 'request_sent') {
                    html += createFriendStatusBadge(userId, 'request_sent', size);
                } else if (status.friend.friendshipStatus === 'request_received') {
                    html += createFriendStatusBadge(userId, 'request_received', size);
                    html += `<button onclick="window.FriendUtils.acceptFriendRequest('${userId}')" 
                                    class="btn btn-success btn-sm" style="margin-left: 0.5rem;">
                                Accept
                             </button>
                             <button onclick="window.FriendUtils.rejectFriendRequest('${userId}')" 
                                    class="btn btn-outline-secondary btn-sm">
                                Decline
                             </button>`;
                } else {
                    // No friend relationship - show add friend button
                    html += `<button onclick="window.FriendUtils.sendFriendRequest('${userId}')" 
                                    class="btn btn-outline-primary btn-sm">
                                Add Friend
                             </button>`;
                }

                // Follow status (if not friends)
                if (!status.friend.isFriend) {
                    if (status.follow.isFollowing) {
                        html += createFriendStatusBadge(userId, 'following', size);
                        html += `<button onclick="window.FollowUtils.unfollowUser('${userId}')" 
                                        class="btn btn-outline-secondary btn-sm" style="margin-left: 0.25rem;">
                                    Unfollow
                                 </button>`;
                    } else {
                        html += `<button onclick="window.FollowUtils.followUser('${userId}')" 
                                        class="btn btn-primary btn-sm" style="margin-left: 0.25rem;">
                                    Follow
                                 </button>`;
                    }
                }

                // Message button for friends
                if (status.friend.isFriend) {
                    html += `<button onclick="openMessageWith('${userId}')" 
                                    class="btn btn-outline-primary btn-sm" style="margin-left: 0.25rem;">
                                üí¨ Message
                             </button>`;
                }

                html += '</div>';
                return html;

            } catch (error) {
                console.warn('Failed to create user relationship display:', error);
                return '';
            }
        }

        // Add relationship display to user profiles
        async function addRelationshipDisplayToProfile(profileContainer, userId) {
            if (!profileContainer || !userId || userId === window.currentUser?.id) return;

            const relationshipHtml = await createUserRelationshipDisplay(userId, 'large', false);
            if (relationshipHtml) {
                profileContainer.insertAdjacentHTML('beforeend', relationshipHtml);
            }
        }

        // Add friend status to existing posts (NO API CALLS - uses cached data!)
        function addFriendStatusToExistingPosts(containerId, posts) {
            const container = document.getElementById(containerId);
            if (!container || !posts) return;

            const postElements = container.querySelectorAll('.post-item, [data-post-id]');
            
            // Process all posts instantly - no API calls or batching needed!
            posts.forEach((post, index) => {
                const postElement = postElements[index];
                if (postElement && post.author && post.author.id !== window.currentUser?.id) {
                    // Instantly add status from cached data
                    addFriendStatusToPost(postElement, post.author.id);
                }
            });
        }

        // Enhanced messaging system functions for friends
        async function showFriendsList() {
            const body = document.getElementById('messagesBody');
            
            body.innerHTML = `
                <div style="display: flex; align-items: center; padding: 1vh; border-bottom: 1px solid #eee; background: #f9f9f9; min-height: 2vh;">
                    <button onclick="backToConversations()" style="background: none; border: none; font-size: 1.2rem; cursor: pointer; margin-right: 0.5rem;">‚Üê</button>
                    <span style="font-weight: bold;">üë• Message Friends</span>
                </div>
                
                <div id="friendsListContainer" style="padding: 1rem;">
                    <div style="text-align: center; color: #666;">
                        <div style="margin: 2rem 0;">Loading friends...</div>
                    </div>
                </div>
            `;
            
            try {
                // Get friends list using the relationship API
                const response = await window.apiCall(`/relationships/${window.currentUser.id}/friends`);
                
                if (response.ok && response.data) {
                    displayFriendsForMessaging(response.data.friends || []);
                } else {
                    document.getElementById('friendsListContainer').innerHTML = `
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <p>Failed to load friends list</p>
                            <button onclick="showFriendsList()" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Retry
                            </button>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Failed to load friends for messaging:', error);
                document.getElementById('friendsListContainer').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <p>Error loading friends</p>
                        <button onclick="showFriendsList()" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Retry
                        </button>
                    </div>
                `;
            }
        }

        function displayFriendsForMessaging(friends) {
            const container = document.getElementById('friendsListContainer');
            
            if (friends.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                        <h3>No Friends Yet</h3>
                        <p>Add friends to start messaging them!</p>
                        <button onclick="document.getElementById('searchInput').focus(); backToConversations();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                            Find Friends
                        </button>
                    </div>
                `;
                return;
            }
            
            let html = '<div class="friends-list">';
            
            friends.forEach(friend => {
                const user = friend.user1Id === window.currentUser?.id ? friend.user2 : friend.user1;
                html += `
                    <div class="friend-item" onclick="openMessageWith('${user.id}')" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">
                        <div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; margin-right: 1rem;">
                            ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">
                                ${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">@${user.username}</div>
                        </div>
                        <div style="color: #4b5c09; font-size: 1.2rem;">üí¨</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function backToConversations() {
            loadConversations();
        }

        /**
         * FRIEND ACTIVITY & ONLINE STATUS SYSTEM
         * Shows when friends were last active and online indicators
         */

        // Create online status indicator
        function createOnlineStatusIndicator(lastActiveAt, size = 'small') {
            if (!lastActiveAt) return '';
            
            const now = new Date();
            const lastActive = new Date(lastActiveAt);
            const minutesAgo = Math.floor((now - lastActive) / (1000 * 60));
            
            let status, color, text;
            
            if (minutesAgo < 5) {
                status = 'online';
                color = '#4caf50';
                text = 'Online';
            } else if (minutesAgo < 30) {
                status = 'recent';
                color = '#ff9800';
                text = `${minutesAgo}m ago`;
            } else if (minutesAgo < 1440) { // Less than 24 hours
                const hoursAgo = Math.floor(minutesAgo / 60);
                status = 'away';
                color = '#666';
                text = `${hoursAgo}h ago`;
            } else {
                const daysAgo = Math.floor(minutesAgo / 1440);
                status = 'offline';
                color = '#ccc';
                text = `${daysAgo}d ago`;
            }
            
            const dotSize = size === 'small' ? '8px' : size === 'medium' ? '10px' : '12px';
            const fontSize = size === 'small' ? '0.7rem' : size === 'medium' ? '0.8rem' : '0.9rem';
            
            return `
                <span class="online-status online-status-${status}" style="display: inline-flex; align-items: center; font-size: ${fontSize}; color: ${color};">
                    <span style="width: ${dotSize}; height: ${dotSize}; background: ${color}; border-radius: 50%; margin-right: 0.25rem; display: inline-block;"></span>
                    ${text}
                </span>
            `;
        }

        // Enhanced friends list with activity status
        function displayFriendsForMessaging(friends) {
            const container = document.getElementById('friendsListContainer');
            
            if (friends.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üë•</div>
                        <h3>No Friends Yet</h3>
                        <p>Add friends to start messaging them!</p>
                        <button onclick="document.getElementById('searchInput').focus(); backToConversations();" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                            Find Friends
                        </button>
                    </div>
                `;
                return;
            }
            
            // Sort friends by activity (most recent first)
            const sortedFriends = friends.sort((a, b) => {
                const userA = a.user1Id === window.currentUser?.id ? a.user2 : a.user1;
                const userB = b.user1Id === window.currentUser?.id ? b.user2 : b.user1;
                
                const lastActiveA = userA.lastActiveAt ? new Date(userA.lastActiveAt) : new Date(0);
                const lastActiveB = userB.lastActiveAt ? new Date(userB.lastActiveAt) : new Date(0);
                
                return lastActiveB - lastActiveA;
            });
            
            let html = '<div class="friends-list">';
            
            sortedFriends.forEach(friend => {
                const user = friend.user1Id === window.currentUser?.id ? friend.user2 : friend.user1;
                const onlineStatus = createOnlineStatusIndicator(user.lastActiveAt, 'small');
                
                html += `
                    <div class="friend-item" onclick="openMessageWith('${user.id}')" style="display: flex; align-items: center; padding: 1rem; border-bottom: 1px solid #eee; cursor: pointer; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='#f5f5f5'" onmouseout="this.style.backgroundColor='white'">
                        <div class="user-avatar" style="width: 50px; height: 50px; border-radius: 50%; background: #4b5c09; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; margin-right: 1rem; position: relative;">
                            ${(user.firstName?.[0] || user.username[0]).toUpperCase()}
                            ${user.lastActiveAt && (new Date() - new Date(user.lastActiveAt)) < 300000 ? 
                                '<div style="position: absolute; bottom: -2px; right: -2px; width: 14px; height: 14px; background: #4caf50; border-radius: 50%; border: 2px solid white;"></div>' : 
                                ''}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; margin-bottom: 0.25rem;">
                                ${user.firstName ? `${user.firstName} ${user.lastName || ''}` : user.username}
                            </div>
                            <div style="color: #666; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                <span>@${user.username}</span>
                                ${onlineStatus}
                            </div>
                        </div>
                        <div style="color: #4b5c09; font-size: 1.2rem;">üí¨</div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // Enhanced friend status badges with activity indicators
        function createFriendStatusBadgeWithActivity(userId, status, lastActiveAt, size = 'small') {
            const baseBadge = createFriendStatusBadge(userId, status, size);
            if (!baseBadge || !lastActiveAt) return baseBadge;
            
            const onlineStatus = createOnlineStatusIndicator(lastActiveAt, 'small');
            return baseBadge + ' ' + onlineStatus;
        }

        // Enhanced user relationship display with activity status
        async function createUserRelationshipDisplayWithActivity(userId, size = 'medium', inline = false) {
            if (!userId || userId === window.currentUser?.id) return '';

            try {
                const [status, userProfile] = await Promise.all([
                    window.RelationshipUtils.getCombinedStatus(userId),
                    window.apiCall(`/users/profile/${userId}`)
                ]);
                
                const containerStyle = inline 
                    ? 'display: inline-flex; align-items: center; gap: 0.5rem;'
                    : 'display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem;';

                let html = `<div class="user-relationship-display" style="${containerStyle}">`;

                // Friend status and button
                if (status.friend.isFriend) {
                    html += createFriendStatusBadgeWithActivity(userId, 'friends', userProfile?.lastActiveAt, size);
                    html += `<button onclick="window.FriendUtils.removeFriend('${userId}')" 
                                    class="btn btn-outline-danger btn-sm" style="margin-left: 0.5rem;">
                                Remove Friend
                             </button>`;
                } else if (status.friend.friendshipStatus === 'request_sent') {
                    html += createFriendStatusBadge(userId, 'request_sent', size);
                } else if (status.friend.friendshipStatus === 'request_received') {
                    html += createFriendStatusBadge(userId, 'request_received', size);
                    html += `<button onclick="window.FriendUtils.acceptFriendRequest('${userId}')" 
                                    class="btn btn-success btn-sm" style="margin-left: 0.5rem;">
                                Accept
                             </button>
                             <button onclick="window.FriendUtils.rejectFriendRequest('${userId}')" 
                                    class="btn btn-outline-secondary btn-sm">
                                Decline
                             </button>`;
                } else {
                    // No friend relationship - show add friend button
                    html += `<button onclick="window.FriendUtils.sendFriendRequest('${userId}')" 
                                    class="btn btn-outline-primary btn-sm">
                                Add Friend
                             </button>`;
                }

                // Follow status (if not friends)
                if (!status.friend.isFriend) {
                    if (status.follow.isFollowing) {
                        html += createFriendStatusBadge(userId, 'following', size);
                        html += `<button onclick="window.FollowUtils.unfollowUser('${userId}')" 
                                        class="btn btn-outline-secondary btn-sm" style="margin-left: 0.25rem;">
                                    Unfollow
                                 </button>`;
                    } else {
                        html += `<button onclick="window.FollowUtils.followUser('${userId}')" 
                                        class="btn btn-primary btn-sm" style="margin-left: 0.25rem;">
                                    Follow
                                 </button>`;
                    }
                }

                // Message button for friends with activity status
                if (status.friend.isFriend) {
                    const onlineIndicator = userProfile?.lastActiveAt && (new Date() - new Date(userProfile.lastActiveAt)) < 300000 
                        ? ' üü¢' : '';
                    html += `<button onclick="openMessageWith('${userId}')" 
                                    class="btn btn-outline-primary btn-sm" style="margin-left: 0.25rem;">
                                üí¨ Message${onlineIndicator}
                             </button>`;
                }

                html += '</div>';
                return html;

            } catch (error) {
                console.warn('Failed to create user relationship display with activity:', error);
                return createUserRelationshipDisplay(userId, size, inline);
            }
        }

        // Update user activity (call this when user is active)
        async function updateUserActivity() {
            if (!window.authToken || !window.currentUser) return;
            
            try {
                await window.apiCall('/users/activity', {
                    method: 'POST',
                    body: JSON.stringify({ timestamp: new Date().toISOString() })
                });
            } catch (error) {
                // Silently fail - activity tracking is not critical
                console.debug('Failed to update user activity:', error);
            }
        }

        // Auto-update activity every 2 minutes when user is active
        let activityTimer = null;
        
        function startActivityTracking() {
            if (activityTimer) clearInterval(activityTimer);
            
            // Update immediately
            updateUserActivity();
            
            // Then update every 2 minutes
            activityTimer = setInterval(updateUserActivity, 120000);
            
            // Track user interactions
            ['click', 'keypress', 'scroll', 'mousemove'].forEach(event => {
                document.addEventListener(event, () => {
                    // Throttle to once per minute max
                    if (!window.lastActivityUpdate || (Date.now() - window.lastActivityUpdate) > 60000) {
                        window.lastActivityUpdate = Date.now();
                        updateUserActivity();
                    }
                }, { passive: true });
            });
        }

        // Integrated messaging system for friends
        async function openMessageWith(userId) {
            try {
                console.log('Opening message with friend:', userId);
                
                // Get user info first to have their username
                const userResponse = await window.apiCall(`/users/profile/${userId}`);
                if (!userResponse || !userResponse.username) {
                    showToast('Failed to load user information');
                    return;
                }
                
                const username = userResponse.username;
                
                // Check if they're actually friends first
                const friendStatus = await window.FriendUtils.getFriendStatus(userId);
                if (!friendStatus.isFriend) {
                    showToast('You can only message friends. Send a friend request first!');
                    return;
                }
                
                // Open the messages container if not already open
                const messagesContainer = document.getElementById('messagesContainer');
                if (messagesContainer.style.display === 'none' || !messagesContainer.style.display) {
                    messagesContainer.style.display = 'block';
                }
                
                // Start conversation with the friend
                await startConversationWithUser(userId, username);
                
                console.log(`‚úÖ Opened conversation with friend: ${username}`);
                
            } catch (error) {
                console.error('Failed to open message with friend:', error);
                showToast('Failed to open conversation');
            }
        }

        // Start activity tracking when user logs in
        window.addEventListener('load', () => {
            if (window.currentUser || window.authToken) {
                setTimeout(startActivityTracking, 2000);
            }
        });

        /**
         * CIVIC ORGANIZING SYSTEM
         * Petition creation, event organization, and civic engagement tools
         */

        // Core organizing functions
        function openCivicOrganizing() {
            if (!authToken) {
                showToast('Please log in to access organizing tools');
                return;
            }
            
            // Hide other main view systems when opening
            const electionsView = document.querySelector('.elections-main-view');
            if (electionsView) {
                electionsView.style.display = 'none';
            }
            
            const officialsView = document.querySelector('.officials-main-view');
            if (officialsView) {
                officialsView.style.display = 'none';
            }
            
            const candidatesView = document.querySelector('.candidates-main-view');
            if (candidatesView) {
                candidatesView.style.display = 'none';
            }
            
            // Hide other detail panels
            document.querySelectorAll('.detail-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Hide existing info panels
            document.querySelectorAll('.info-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            const container = document.getElementById('civicOrganizingContainer');
            container.style.display = 'flex';
            
            // Update sidebar state awareness
            updateCivicOrganizingForSidebarState();
            
            closeAllPanels(); // Close other panels
            showDefaultOrganizingView();
        }
        window.openCivicOrganizing = openCivicOrganizing; // Make globally accessible

        function closeCivicOrganizing() {
            document.getElementById('civicOrganizingContainer').style.display = 'none';
            showDefaultView();
        }
        
        function updateCivicOrganizingForSidebarState() {
            const sidebar = document.querySelector('#sidebar');
            const civicContainer = document.querySelector('.civic-organizing-container');
            
            if (sidebar && civicContainer) {
                const isExpanded = sidebar.classList.contains('expanded');
                civicContainer.classList.toggle('sidebar-expanded', isExpanded);
            }
        }
        
        // Setup sidebar monitoring for civic organizing
        function setupCivicOrganizingSidebarMonitoring() {
            const sidebar = document.querySelector('#sidebar');
            if (sidebar) {
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                            updateCivicOrganizingForSidebarState();
                        }
                    });
                });
                
                observer.observe(sidebar, {
                    attributes: true,
                    attributeFilter: ['class']
                });
            }
        }

        function showDefaultOrganizingView() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üèõÔ∏è</div>
                    <h3>Welcome to Civic Organizing</h3>
                    <p>Create petitions, organize events, and mobilize your community for positive change.</p>
                    <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                        <button onclick="showPetitionCreator()" style="padding: 1rem 2rem; background: #4b5c09; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            Start a Petition
                        </button>
                        <button onclick="showEventCreator()" style="padding: 1rem 2rem; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                            Organize an Event
                        </button>
                    </div>
                </div>
            `;
        }

        // Petition Creation System
        function showPetitionCreator() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div class="civic-form">
                    <h2 style="text-align: center; color: #4b5c09; margin-bottom: 2rem;">üìù Create a Petition</h2>
                    
                    <form id="petitionForm" onsubmit="submitPetition(event)">
                        <div class="form-group">
                            <label for="petitionType">Petition Type</label>
                            <select id="petitionType" required>
                                <option value="">Select petition type</option>
                                <option value="petition">Petition (Request Action)</option>
                                <option value="referendum">Referendum (Propose Policy)</option>
                            </select>
                            <div class="help-text">Petitions request action, referendums propose specific policy changes</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionTitle">Title</label>
                            <input type="text" id="petitionTitle" required maxlength="100" 
                                   placeholder="Clear, compelling title for your petition">
                            <div class="help-text">Keep it clear and action-oriented (max 100 characters)</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionDescription">Description</label>
                            <textarea id="petitionDescription" required maxlength="2000" 
                                      placeholder="Explain the issue, why it matters, and what action you're requesting..."></textarea>
                            <div class="help-text">Provide context and compelling reasons (max 2000 characters)</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionTarget">Target Officials/Organization</label>
                            <input type="text" id="petitionTarget" required 
                                   placeholder="e.g., Mayor Johnson, City Council, Department of Education">
                            <div class="help-text">Who has the power to act on this petition?</div>
                        </div>

                        <div class="form-group">
                            <label for="petitionCategory">Issue Category</label>
                            <select id="petitionCategory" required>
                                <option value="">Select category</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="environment">Environment</option>
                                <option value="transportation">Transportation</option>
                                <option value="housing">Housing</option>
                                <option value="public-safety">Public Safety</option>
                                <option value="economic-development">Economic Development</option>
                                <option value="civil-rights">Civil Rights</option>
                                <option value="government-reform">Government Reform</option>
                                <option value="local-issues">Local Issues</option>
                                <option value="other">Other</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="petitionScope">Geographic Scope</label>
                            <select id="petitionScope" required>
                                <option value="">Select scope</option>
                                <option value="neighborhood">Neighborhood</option>
                                <option value="city">City</option>
                                <option value="county">County</option>
                                <option value="state">State</option>
                                <option value="federal">Federal</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="signatureGoal">Signature Goal</label>
                            <select id="signatureGoal" required>
                                <option value="">Select goal</option>
                                <option value="100">100 signatures</option>
                                <option value="500">500 signatures</option>
                                <option value="1000">1,000 signatures</option>
                                <option value="5000">5,000 signatures</option>
                                <option value="10000">10,000 signatures</option>
                                <option value="custom">Custom amount</option>
                            </select>
                            <input type="number" id="customGoal" style="display: none; margin-top: 0.5rem;" 
                                   placeholder="Enter custom goal" min="1" max="1000000">
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="showDefaultOrganizingView()" 
                                    style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Create Petition
                            </button>
                        </div>
                    </form>
                </div>
            `;

            // Add custom goal toggle
            document.getElementById('signatureGoal').addEventListener('change', function() {
                const customInput = document.getElementById('customGoal');
                if (this.value === 'custom') {
                    customInput.style.display = 'block';
                    customInput.required = true;
                } else {
                    customInput.style.display = 'none';
                    customInput.required = false;
                }
            });
        }

        // Event Creation System
        function showEventCreator() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div class="civic-form">
                    <h2 style="text-align: center; color: #1976d2; margin-bottom: 2rem;">üìÖ Organize an Event</h2>
                    
                    <form id="eventForm" onsubmit="submitEvent(event)">
                        <div class="form-group">
                            <label for="eventType">Event Type</label>
                            <select id="eventType" required>
                                <option value="">Select event type</option>
                                <optgroup label="Electoral Events">
                                    <option value="voter-registration">Voter Registration Drive</option>
                                    <option value="candidate-forum">Candidate Forum</option>
                                    <option value="election-watch">Election Watch Party</option>
                                    <option value="poll-worker-training">Poll Worker Training</option>
                                </optgroup>
                                <optgroup label="Civic Engagement">
                                    <option value="town-hall">Town Hall</option>
                                    <option value="city-council">City Council Meeting</option>
                                    <option value="public-hearing">Public Hearing</option>
                                    <option value="community-forum">Community Forum</option>
                                </optgroup>
                                <optgroup label="Organizing Activities">
                                    <option value="petition-drive">Petition Signature Drive</option>
                                    <option value="volunteer-recruitment">Volunteer Recruitment</option>
                                    <option value="issue-education">Issue Education Session</option>
                                    <option value="community-service">Community Service</option>
                                </optgroup>
                                <optgroup label="Educational Events">
                                    <option value="civics-workshop">Civics Workshop</option>
                                    <option value="candidate-meetgreet">Candidate Meet & Greet</option>
                                    <option value="ballot-education">Ballot Measure Education</option>
                                    <option value="other">Other</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventTitle">Event Title</label>
                            <input type="text" id="eventTitle" required maxlength="100" 
                                   placeholder="Clear, descriptive title for your event">
                        </div>

                        <div class="form-group">
                            <label for="eventDescription">Description</label>
                            <textarea id="eventDescription" required maxlength="1500" 
                                      placeholder="Describe the event, agenda, speakers, and what attendees can expect..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="eventDate">Date</label>
                            <input type="date" id="eventDate" required min="${new Date().toISOString().split('T')[0]}">
                        </div>

                        <div class="form-group">
                            <label for="eventTime">Time</label>
                            <input type="time" id="eventTime" required>
                        </div>

                        <div class="form-group">
                            <label for="eventDuration">Duration (hours)</label>
                            <select id="eventDuration" required>
                                <option value="">Select duration</option>
                                <option value="0.5">30 minutes</option>
                                <option value="1">1 hour</option>
                                <option value="1.5">1.5 hours</option>
                                <option value="2">2 hours</option>
                                <option value="3">3 hours</option>
                                <option value="4">4 hours</option>
                                <option value="8">All day</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventLocation">Location</label>
                            <input type="text" id="eventLocation" required 
                                   placeholder="Address, venue name, or 'Online/Virtual'">
                            <div class="help-text">Include full address for in-person events</div>
                        </div>

                        <div class="form-group">
                            <label for="eventCapacity">Expected Attendance</label>
                            <select id="eventCapacity" required>
                                <option value="">Select expected size</option>
                                <option value="10">Small (5-15 people)</option>
                                <option value="25">Medium (15-50 people)</option>
                                <option value="75">Large (50-100 people)</option>
                                <option value="200">Very Large (100+ people)</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="eventCategory">Issue Focus</label>
                            <select id="eventCategory" required>
                                <option value="">Select primary focus</option>
                                <option value="general-civic">General Civic Engagement</option>
                                <option value="healthcare">Healthcare</option>
                                <option value="education">Education</option>
                                <option value="environment">Environment</option>
                                <option value="transportation">Transportation</option>
                                <option value="housing">Housing</option>
                                <option value="public-safety">Public Safety</option>
                                <option value="economic-development">Economic Development</option>
                                <option value="civil-rights">Civil Rights</option>
                                <option value="election-process">Election Process</option>
                            </select>
                        </div>

                        <div class="form-actions">
                            <button type="button" onclick="showDefaultOrganizingView()" 
                                    style="padding: 0.75rem 1.5rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Cancel
                            </button>
                            <button type="submit" 
                                    style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Create Event
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        // Petition and Event Submission Functions
        async function submitPetition(event) {
            event.preventDefault();
            
            // Map frontend values to backend enum values
            const categoryMap = {
                'healthcare': 'HEALTHCARE',
                'education': 'EDUCATION',
                'environment': 'ENVIRONMENT',
                'transportation': 'TRANSPORTATION',
                'housing': 'HOUSING',
                'public-safety': 'PUBLIC_SAFETY',
                'economic-development': 'ECONOMY',
                'civil-rights': 'CIVIL_RIGHTS',
                'government-reform': 'GOVERNMENT_REFORM',
                'local-issues': 'OTHER',
                'other': 'OTHER'
            };

            const scopeMap = {
                'neighborhood': 'LOCAL',
                'city': 'LOCAL',
                'county': 'COUNTY',
                'state': 'STATE',
                'federal': 'NATIONAL'
            };

            const targetOfficials = document.getElementById('petitionTarget').value
                .split(',')
                .map(official => official.trim())
                .filter(official => official.length > 0);

            const signatureGoal = document.getElementById('signatureGoal').value === 'custom' 
                ? parseInt(document.getElementById('customGoal').value)
                : parseInt(document.getElementById('signatureGoal').value);

            const formData = {
                title: document.getElementById('petitionTitle').value,
                description: document.getElementById('petitionDescription').value,
                petitionType: document.getElementById('petitionType').value.toUpperCase(),
                category: categoryMap[document.getElementById('petitionCategory').value],
                geographicScope: scopeMap[document.getElementById('petitionScope').value],
                targetOfficials: targetOfficials,
                signatureGoal: signatureGoal
            };

            try {
                const response = await apiCall('/civic/petitions', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.ok && response.data.success) {
                    showToast('Petition created successfully!');
                    showMyOrganizing(); // Show user's organizing activities
                } else {
                    const errorMsg = response.data?.error || 'Failed to create petition. Please try again.';
                    showToast(errorMsg);
                }
            } catch (error) {
                console.error('Error creating petition:', error);
                showToast('Network error. Please check your connection.');
            }
        }

        async function submitEvent(event) {
            event.preventDefault();
            
            // Map frontend values to backend enum values
            const eventTypeMap = {
                'voter-registration': 'VOTER_REGISTRATION',
                'candidate-forum': 'CANDIDATE_FORUM',
                'election-watch': 'COMMUNITY_MEETING',
                'poll-worker-training': 'WORKSHOP',
                'town-hall': 'TOWN_HALL',
                'city-council': 'COMMUNITY_MEETING',
                'public-hearing': 'COMMUNITY_MEETING',
                'community-forum': 'ISSUE_FORUM',
                'petition-drive': 'PETITION_DRIVE',
                'volunteer-recruitment': 'VOLUNTEER_DRIVE',
                'issue-education': 'EDUCATIONAL_SEMINAR',
                'community-service': 'OTHER',
                'civics-workshop': 'WORKSHOP',
                'candidate-meetgreet': 'COMMUNITY_MEETING',
                'ballot-education': 'EDUCATIONAL_SEMINAR',
                'other': 'OTHER'
            };

            const categoryMap = {
                'general-civic': 'CIVIC_ENGAGEMENT',
                'healthcare': 'ADVOCACY',
                'education': 'ADVOCACY',
                'environment': 'ADVOCACY',
                'transportation': 'ADVOCACY',
                'housing': 'ADVOCACY',
                'public-safety': 'ADVOCACY',
                'economic-development': 'ADVOCACY',
                'civil-rights': 'ADVOCACY',
                'election-process': 'ELECTORAL'
            };

            // Combine date and time
            const dateStr = document.getElementById('eventDate').value;
            const timeStr = document.getElementById('eventTime').value;
            const scheduledDate = new Date(`${dateStr}T${timeStr}`);

            // Calculate end date based on duration
            const duration = parseFloat(document.getElementById('eventDuration').value);
            const endDate = new Date(scheduledDate.getTime() + duration * 60 * 60 * 1000);

            const capacity = parseInt(document.getElementById('eventCapacity').value);

            const formData = {
                title: document.getElementById('eventTitle').value,
                description: document.getElementById('eventDescription').value,
                eventType: eventTypeMap[document.getElementById('eventType').value],
                category: categoryMap[document.getElementById('eventCategory').value] || 'CIVIC_ENGAGEMENT',
                scheduledDate: scheduledDate.toISOString(),
                endDate: endDate.toISOString(),
                location: {
                    address: document.getElementById('eventLocation').value,
                    city: currentUser?.city || 'Unknown',
                    state: currentUser?.state || 'Unknown'
                },
                capacity: capacity > 0 ? capacity : null,
                organizerInfo: {
                    name: currentUser?.firstName ? `${currentUser.firstName} ${currentUser.lastName || ''}`.trim() : currentUser?.username || 'Anonymous',
                    contact: currentUser?.email || 'Contact via platform',
                    organization: 'United We Rise Community'
                },
                rsvpRequired: false
            };

            try {
                const response = await apiCall('/civic/events', {
                    method: 'POST',
                    body: JSON.stringify(formData)
                });

                if (response.ok && response.data.success) {
                    showToast('Event created successfully!');
                    showMyOrganizing(); // Show user's organizing activities
                } else {
                    const errorMsg = response.data?.error || 'Failed to create event. Please try again.';
                    showToast(errorMsg);
                }
            } catch (error) {
                console.error('Error creating event:', error);
                showToast('Network error. Please check your connection.');
            }
        }

        // Civic Browser with Smart Filtering
        function showCivicBrowser() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #ff9800; margin-bottom: 2rem;">üîç Find Civic Events & Petitions</h2>
                    
                    <!-- Smart Filters -->
                    <div class="event-filters">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end;">
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">üìç Location</label>
                                <select id="locationFilter" onchange="updateCivicResults()">
                                    <option value="nearby">Near Me (25 miles)</option>
                                    <option value="city">My City</option>
                                    <option value="county">My County</option>
                                    <option value="state">My State</option>
                                    <option value="national">National</option>
                                    <option value="custom">Custom Location</option>
                                </select>
                            </div>
                            
                            <div id="customLocationDiv" style="display: none;">
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">Enter Location</label>
                                <input type="text" id="customLocation" placeholder="City, State or ZIP">
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">üìÖ When</label>
                                <select id="timeFilter" onchange="updateCivicResults()">
                                    <option value="upcoming">Upcoming</option>
                                    <option value="this-week">This Week</option>
                                    <option value="this-month">This Month</option>
                                    <option value="active">Active Petitions</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">üéØ Type</label>
                                <select id="typeFilter" onchange="updateCivicResults()">
                                    <option value="all">All Types</option>
                                    <option value="events">Events Only</option>
                                    <option value="petitions">Petitions Only</option>
                                    <option value="voter-registration">Voter Registration</option>
                                    <option value="town-halls">Town Halls</option>
                                    <option value="forums">Forums & Meetings</option>
                                </select>
                            </div>
                            
                            <div>
                                <label style="display: block; font-weight: bold; margin-bottom: 0.25rem;">üìã Issue</label>
                                <select id="issueFilter" onchange="updateCivicResults()">
                                    <option value="">All Issues</option>
                                    <option value="healthcare">Healthcare</option>
                                    <option value="education">Education</option>
                                    <option value="environment">Environment</option>
                                    <option value="transportation">Transportation</option>
                                    <option value="housing">Housing</option>
                                    <option value="public-safety">Public Safety</option>
                                    <option value="economic-development">Economic Development</option>
                                    <option value="civil-rights">Civil Rights</option>
                                    <option value="election-process">Elections</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Results Area -->
                    <div id="civicResults">
                        <div style="text-align: center; color: #666; padding: 2rem;">
                            <div style="margin-bottom: 1rem;">üîç Loading civic activities in your area...</div>
                        </div>
                    </div>
                </div>
            `;

            // Add custom location toggle
            document.getElementById('locationFilter').addEventListener('change', function() {
                const customDiv = document.getElementById('customLocationDiv');
                if (this.value === 'custom') {
                    customDiv.style.display = 'block';
                } else {
                    customDiv.style.display = 'none';
                }
                updateCivicResults();
            });

            // Load initial results
            updateCivicResults();
        }

        // Update civic results based on filters
        async function updateCivicResults() {
            const resultsDiv = document.getElementById('civicResults');
            if (!resultsDiv) return;

            resultsDiv.innerHTML = `
                <div style="text-align: center; color: #666; padding: 2rem;">
                    <div style="margin-bottom: 1rem;">üîç Searching...</div>
                </div>
            `;

            try {
                // Get filter values
                const filters = {
                    location: document.getElementById('locationFilter')?.value || 'nearby',
                    time: document.getElementById('timeFilter')?.value || 'upcoming',
                    type: document.getElementById('typeFilter')?.value || 'all',
                    issue: document.getElementById('issueFilter')?.value || ''
                };

                // Build API query
                const params = new URLSearchParams(filters);
                const response = await apiCall(`/civic/browse?${params.toString()}`);

                if (response.ok && response.data) {
                    displayCivicResults(response.data);
                } else {
                    // Show mock data for now since backend isn't implemented yet
                    displayMockCivicResults(filters);
                }
            } catch (error) {
                console.error('Error loading civic results:', error);
                displayMockCivicResults();
            }
        }

        // Display mock civic results (until backend is implemented)
        function displayMockCivicResults(filters = {}) {
            const resultsDiv = document.getElementById('civicResults');
            if (!resultsDiv) return;

            const mockEvents = [
                {
                    type: 'event',
                    eventType: 'town-hall',
                    title: 'Community Town Hall: Healthcare Access',
                    description: 'Join us for a community discussion about improving healthcare access in our district.',
                    date: '2025-08-20',
                    time: '19:00',
                    location: 'City Hall, 123 Main St',
                    organizer: 'Citizens for Healthcare',
                    attendees: 34,
                    category: 'healthcare'
                },
                {
                    type: 'petition',
                    title: 'Improve Public Transportation Funding',
                    description: 'We petition the city council to increase funding for public transportation to reduce traffic and pollution.',
                    signatures: 847,
                    goal: 1000,
                    target: 'City Council',
                    organizer: 'Green Transit Alliance',
                    category: 'transportation',
                    daysLeft: 12
                },
                {
                    type: 'event',
                    eventType: 'voter-registration',
                    title: 'Voter Registration Drive',
                    description: 'Help register new voters for the upcoming election. All volunteers welcome!',
                    date: '2025-08-18',
                    time: '10:00',
                    location: 'Community Center, 456 Oak Ave',
                    organizer: 'Democracy First',
                    attendees: 12,
                    category: 'election-process'
                }
            ];

            let html = '';
            
            mockEvents.forEach(item => {
                if (item.type === 'event') {
                    html += `
                        <div class="event-item">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="background: #1976d2; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                            üìÖ ${item.eventType.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase())}
                                        </span>
                                        <span style="color: #666; font-size: 0.9rem;">${item.category}</span>
                                    </div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #333;">${item.title}</h3>
                                    <p style="margin: 0 0 1rem 0; color: #666; line-height: 1.4;">${item.description}</p>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: #f9f9f9; border-radius: 6px;">
                                <div>
                                    <strong>üìÖ Date:</strong><br>
                                    ${new Date(item.date).toLocaleDateString()}
                                </div>
                                <div>
                                    <strong>‚è∞ Time:</strong><br>
                                    ${item.time}
                                </div>
                                <div>
                                    <strong>üìç Location:</strong><br>
                                    ${item.location}
                                </div>
                                <div>
                                    <strong>üë• Attending:</strong><br>
                                    ${item.attendees} people
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="color: #666; font-size: 0.9rem;">
                                    Organized by ${item.organizer}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="rsvpToEvent('${item.title}')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        RSVP
                                    </button>
                                    <button onclick="shareEvent('${item.title}')" style="padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                } else if (item.type === 'petition') {
                    const progress = (item.signatures / item.goal) * 100;
                    html += `
                        <div class="petition-item">
                            <div style="display: flex; justify-content: between; align-items: start; margin-bottom: 1rem;">
                                <div style="flex: 1;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                        <span style="background: #4b5c09; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                                            üìù Petition
                                        </span>
                                        <span style="color: #666; font-size: 0.9rem;">${item.category}</span>
                                    </div>
                                    <h3 style="margin: 0 0 0.5rem 0; color: #333;">${item.title}</h3>
                                    <p style="margin: 0 0 1rem 0; color: #666; line-height: 1.4;">${item.description}</p>
                                </div>
                            </div>
                            <div style="margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                    <span style="font-weight: bold;">${item.signatures.toLocaleString()} signatures</span>
                                    <span style="color: #666;">Goal: ${item.goal.toLocaleString()}</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <div style="text-align: center; color: #666; font-size: 0.9rem; margin-top: 0.5rem;">
                                    ${item.daysLeft} days left ‚Ä¢ ${(100 - progress).toFixed(0)}% to goal
                                </div>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div style="color: #666; font-size: 0.9rem;">
                                    Target: ${item.target} ‚Ä¢ By ${item.organizer}
                                </div>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="signPetition('${item.title}')" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Sign Petition
                                    </button>
                                    <button onclick="sharePetition('${item.title}')" style="padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        Share
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            });

            if (html === '') {
                html = `
                    <div style="text-align: center; color: #666; padding: 2rem;">
                        <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
                        <h3>No Results Found</h3>
                        <p>Try adjusting your filters or create your own event/petition!</p>
                        <div style="margin-top: 2rem;">
                            <button onclick="showPetitionCreator()" style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-right: 1rem;">
                                Start a Petition
                            </button>
                            <button onclick="showEventCreator()" style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                Organize an Event
                            </button>
                        </div>
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        // Show user's organizing activities
        function showMyOrganizing() {
            const content = document.getElementById('organizingContent');
            content.innerHTML = `
                <div style="max-width: 1000px; margin: 0 auto;">
                    <h2 style="text-align: center; color: #666; margin-bottom: 2rem;">üìä My Organizing Activities</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 2rem;">
                        <!-- My Petitions -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #4b5c09; margin-bottom: 1rem;">üìù My Petitions</h3>
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìù</div>
                                <p>You haven't created any petitions yet.</p>
                                <button onclick="showPetitionCreator()" style="padding: 0.75rem 1.5rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                    Create Your First Petition
                                </button>
                            </div>
                        </div>
                        
                        <!-- My Events -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #1976d2; margin-bottom: 1rem;">üìÖ My Events</h3>
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">üìÖ</div>
                                <p>You haven't organized any events yet.</p>
                                <button onclick="showEventCreator()" style="padding: 0.75rem 1.5rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                    Organize Your First Event
                                </button>
                            </div>
                        </div>
                        
                        <!-- My Participation -->
                        <div style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 1.5rem;">
                            <h3 style="color: #ff9800; margin-bottom: 1rem;">ü§ù My Participation</h3>
                            <div style="text-align: center; color: #666; padding: 2rem;">
                                <div style="font-size: 2rem; margin-bottom: 1rem;">ü§ù</div>
                                <p>Events you've RSVP'd to and petitions you've signed will appear here.</p>
                                <button onclick="showCivicBrowser()" style="padding: 0.75rem 1.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 1rem;">
                                    Find Events & Petitions
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Action functions (placeholders for now)
        function rsvpToEvent(eventTitle) {
            showToast(`RSVP'd to: ${eventTitle}`);
        }

        function shareEvent(eventTitle) {
            if (navigator.share) {
                navigator.share({
                    title: eventTitle,
                    text: `Join me at: ${eventTitle}`,
                    url: window.location.href
                });
            } else {
                showToast('Event sharing feature coming soon!');
            }
        }

        function signPetition(petitionTitle) {
            showToast(`Signed petition: ${petitionTitle}`);
        }

        function sharePetition(petitionTitle) {
            if (navigator.share) {
                navigator.share({
                    title: petitionTitle,
                    text: `Please sign this petition: ${petitionTitle}`,
                    url: window.location.href
                });
            } else {
                showToast('Petition sharing feature coming soon!');
            }
        }

    </script>
    <!-- Mobile Navigation -->
    <nav class="mobile-nav" style="display: none;">
        <a href="#" class="mobile-nav-item mobile-nav-feed active" onclick="showMobileFeed()">
            <div class="mobile-nav-icon">üè†</div>
            <div>Feed</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showMobileSearch()">
            <div class="mobile-nav-icon">üîç</div>
            <div>Search</div>
        </a>
        <a href="#" class="mobile-nav-item" onclick="showMobileMap()">
            <div class="mobile-nav-icon">üó∫Ô∏è</div>
            <div>Map</div>
        </a>
        <a href="#" class="mobile-nav-item mobile-nav-profile" onclick="showMobileProfile()">
            <div class="mobile-nav-icon">üë§</div>
            <div>Profile</div>
        </a>
        <a href="#" class="mobile-nav-item mobile-nav-messages" onclick="showMobileMessages()">
            <div class="mobile-nav-icon">üí¨</div>
            <div>Messages</div>
        </a>
    </nav>

    <!-- Mobile Map Close Button -->
    <button class="mobile-map-close" onclick="hideMobileMap()">‚úï Close Map</button>

    <!-- Civic Organizing System -->
    <div class="civic-organizing-container" id="civicOrganizingContainer" style="display: none;">
        <div class="organizing-header">
            <h3 style="margin: 0; color: #4b5c09;">üìã Civic Organizing</h3>
            <button onclick="closeCivicOrganizing()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
        </div>
        
        <!-- Organizing Navigation -->
        <div class="organizing-nav" style="padding: 1rem; border-bottom: 1px solid #eee; background: #f9f9f9;">
            <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                <button onclick="showPetitionCreator()" style="padding: 0.5rem 1rem; background: #4b5c09; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    üìù Create Petition
                </button>
                <button onclick="showEventCreator()" style="padding: 0.5rem 1rem; background: #1976d2; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    üìÖ Organize Event
                </button>
                <button onclick="showCivicBrowser()" style="padding: 0.5rem 1rem; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    üîç Find Events
                </button>
                <button onclick="showMyOrganizing()" style="padding: 0.5rem 1rem; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    üìä My Activities
                </button>
            </div>
        </div>
        
        <div class="organizing-content" id="organizingContent">
            <div style="text-align: center; color: #666; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üèõÔ∏è</div>
                <h3>Welcome to Civic Organizing</h3>
                <p>Create petitions, organize events, and mobilize your community for positive change.</p>
                <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                    <button onclick="showPetitionCreator()" style="padding: 1rem 2rem; background: #4b5c09; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Start a Petition
                    </button>
                    <button onclick="showEventCreator()" style="padding: 1rem 2rem; background: #1976d2; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem;">
                        Organize an Event
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Unified Authentication System -->
    <script src="js/unifiedAuth.js"></script>
</body>
</html>