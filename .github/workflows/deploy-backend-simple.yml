name: Build Backend Test

on:
  push:
    branches:
      - development
    paths:
      - 'backend/**'
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: backend/package-lock.json

      - name: Install dependencies
        run: |
          cd backend
          npm ci

      - name: Generate Prisma client
        run: |
          cd backend
          npx prisma generate

      - name: Build TypeScript
        run: |
          cd backend
          npm run build

      - name: Test Docker build
        run: |
          cd backend
          echo "Testing Docker build locally..."
          docker build -t test-backend .
          echo "Docker build successful!"

      - name: Verify Stripe integration
        run: |
          cd backend
          echo "Checking built files..."
          ls -la dist/
          ls -la dist/services/ | grep -i stripe && echo "✅ Stripe service found" || echo "❌ Stripe service missing"
          ls -la dist/routes/ | grep -i payment && echo "✅ Payment routes found" || echo "❌ Payment routes missing"
          
          echo "Checking package.json..."
          grep -i stripe package.json && echo "✅ Stripe dependency found" || echo "❌ Stripe dependency missing"

      - name: Test container startup
        run: |
          cd backend
          echo "Testing container startup..."
          docker run --name test-container -d -p 3001:3001 \
            -e NODE_ENV=test \
            -e DATABASE_URL="postgresql://test:test@localhost:5432/test" \
            test-backend
          
          sleep 10
          
          echo "Container logs:"
          docker logs test-container || true
          
          echo "Cleaning up..."
          docker stop test-container || true
          docker rm test-container || true