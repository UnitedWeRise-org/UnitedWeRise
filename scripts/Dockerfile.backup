FROM postgres:15-alpine

# Install required tools
RUN apk add --no-cache \
    aws-cli \
    curl \
    bash \
    dcron

# Create backup user
RUN adduser -D -s /bin/bash backup

# Create backup directory
RUN mkdir -p /backup && chown backup:backup /backup

# Copy backup scripts
COPY backup.sh /usr/local/bin/backup.sh
COPY restore.sh /usr/local/bin/restore.sh

# Make scripts executable
RUN chmod +x /usr/local/bin/backup.sh
RUN chmod +x /usr/local/bin/restore.sh

# Switch to backup user
USER backup

# Setup cron
RUN echo "${BACKUP_SCHEDULE:-0 2 * * *} /usr/local/bin/backup.sh" | crontab -

# Health check
HEALTHCHECK --interval=300s --timeout=30s --start-period=60s --retries=3 \
  CMD test -f /backup/last_backup_success || exit 1

# Start cron daemon
CMD ["crond", "-f", "-d", "8"]